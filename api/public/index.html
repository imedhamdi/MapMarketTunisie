<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description"
    content="MapMarket : trouvez des annonces pr√®s de chez vous sur une carte rapide et accessible.">
  <meta name="theme-color" content="#0f172a">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; img-src 'self' https://images.unsplash.com https://*.tile.openstreetmap.org https://tile.openstreetmap.org https://via.placeholder.com https://unpkg.com data:; style-src 'self' 'unsafe-inline' https://unpkg.com; script-src 'self' 'unsafe-inline' https://unpkg.com; connect-src 'self'; font-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'self'">
  <link rel="canonical" href="https://tondomaine.com/">
  <link rel="preconnect" href="https://images.unsplash.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png">
  <title>MapMarket ‚Äî Liste + Carte + Infini</title>
  <!-- Leaflet & MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <link rel="stylesheet" href="./css/tokens.css">
  <link rel="stylesheet" href="./css/app.css">
</head>

<body>
  <header class="header">
    <div class="container nav">
      <a class="brand" href="#">
        <svg class="pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0" />
          <circle cx="12" cy="10" r="3" />
        </svg>
        <b>MapMarket</b>
      </a>
      <nav class="nav-actions">
        <a class="nav-link" href="#" id="navMessages"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z" />
          </svg><span>Messages</span></a>
        <button class="nav-link pill" type="button" id="openFavs"><svg width="20" height="20" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
          </svg><span>Favoris</span><span class="badge" id="fav-count">0</span></button>
        <button class="cta" id="postBtn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14" />
            <path d="M12 5v14" />
          </svg><span class="hide-sm">D√©poser une annonce</span></button>
        <div class="header-user">
          <div class="avatar" id="avatar"></div>
          <div id="userMenu" class="user-menu" role="menu" aria-labelledby="avatar" hidden>
            <div class="user-menu__header">
              <img class="user-menu__avatar" src="/uploads/avatars/default.jpg" alt="">
              <div class="user-menu__id">
                <div class="user-menu__name" id="userMenuName">Utilisateur</div>
                <div class="user-menu__email" id="userMenuEmail">email@example.com</div>
              </div>
            </div>
            <button class="user-menu__item" type="button" role="menuitem" data-action="profile">
              <span class="icon">üë§</span>
              <span class="text">
                <strong>Mon Profil</strong>
                <small>Voir et modifier mes informations</small>
              </span>
            </button>
            <hr class="user-menu__sep">
            <button class="user-menu__item danger" type="button" role="menuitem" data-action="logout">
              <span class="icon">üö™</span>
              <span class="text">
                <strong>D√©connexion</strong>
                <small>Se d√©connecter de l‚Äôapplication</small>
              </span>
            </button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Trouvez ce que vous cherchez</h1>
      <p>Des milliers d'articles d'occasion pr√®s de chez vous</p>
    </section>

    <!-- Filters -->
    <section class="card filters-card" aria-label="Filtres">
      <div class="filters-header">
        <div class="filters-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <line x1="21" x2="14" y1="4" y2="4" />
            <line x1="10" x2="3" y1="4" y2="4" />
            <line x1="21" x2="12" y1="12" y2="12" />
            <line x1="8" x2="3" y1="12" y2="12" />
            <line x1="21" x2="16" y1="20" y2="20" />
            <line x1="12" x2="3" y1="20" y2="20" />
            <line x1="14" x2="14" y1="2" y2="6" />
            <line x1="8" x2="8" y1="10" y2="14" />
            <line x1="16" x2="16" y1="18" y2="22" />
          </svg>
          <div>
            <p class="filters-heading">Affiner votre recherche</p>
            <p class="filters-subheading">Filtrez par cat√©gorie, prix ou localisation</p>
          </div>
        </div>
        <button class="filters-reset" id="resetBtn" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="1 4 1 10 7 10" />
            <polyline points="23 20 23 14 17 14" />
            <path d="M20.49 9A9 9 0 0 0 5 5.55L1 10" />
            <path d="M3.51 15A9 9 0 0 0 19 18.45L23 14" />
          </svg>
          <span>R√©initialiser</span>
        </button>
      </div>
      <div class="filters-grid">
        <div class="filter-field filter-search">
          <label class="filter-label" for="search">Recherche globale</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.3-4.3" />
            </svg>
            <input id="search" type="search" placeholder="Titre, description, mots-cl√©s" autocomplete="off">
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="cat">Cat√©gorie</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7" rx="1" />
              <rect x="14" y="3" width="7" height="7" rx="1" />
              <rect x="14" y="14" width="7" height="7" rx="1" />
              <rect x="3" y="14" width="7" height="7" rx="1" />
            </svg>
            <select id="cat" title="Cat√©gories">
              <option value="">Toutes cat√©gories</option>
              <option value="immobilier">Immobilier</option>
              <option value="auto">Auto</option>
              <option value="mode">Mode</option>
              <option value="electroniques">High-Tech</option>
              <option value="pieces">Pi√®ces</option>
              <option value="loisirs">Loisirs</option>
            </select>
            <svg class="filter-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="etat">√âtat</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="4 14 8 10 12 14 16 10 20 14" />
              <polyline points="4 8 8 4 12 8 16 4 20 8" />
            </svg>
            <select id="etat" title="√âtat">
              <option value="">Tous √©tats</option>
              <option>Neuf</option>
              <option>Tr√®s bon √©tat</option>
              <option>Bon √©tat</option>
              <option>Correct</option>
            </select>
            <svg class="filter-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="sort">Tri</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h11" />
              <path d="M3 12h7" />
              <path d="M3 18h3" />
              <path d="m15 18 6-6-6-6" />
            </svg>
            <select id="sort" title="Tri">
              <option value="recent">Plus r√©cent</option>
              <option value="priceAsc">Prix croissant</option>
              <option value="priceDesc">Prix d√©croissant</option>
            </select>
            <svg class="filter-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="pmin">Prix minimum (‚Ç¨)</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 3v18" />
              <path d="M17 7H9.5a3.5 3.5 0 0 0 0 7H15a3.5 3.5 0 0 1 0 7H7" />
            </svg>
            <input id="pmin" type="number" min="0" inputmode="numeric" placeholder="Ex. 100">
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="pmax">Prix maximum (‚Ç¨)</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 3v18" />
              <path d="M17 7H9.5a3.5 3.5 0 0 0 0 7H15a3.5 3.5 0 0 1 0 7H7" />
            </svg>
            <input id="pmax" type="number" min="0" inputmode="numeric" placeholder="Ex. 500">
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="city">Ville</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0" />
              <circle cx="12" cy="10" r="3" />
            </svg>
            <input id="city" type="text" placeholder="Ex. Paris" autocomplete="off">
          </div>
        </div>
      </div>
    </section>

    <div style="display:flex;align-items:center;justify-content:space-between;margin:14px 2px 8px" class="muted"><span
        id="count">0 annonce</span>
      <div class="tabs" role="tablist">
        <div class="tab active" role="tab" aria-selected="true" id="tab-list"><svg width="16" height="16"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M3 12h.01" />
            <path d="M3 18h.01" />
            <path d="M3 6h.01" />
            <path d="M8 12h13" />
            <path d="M8 18h13" />
            <path d="M8 6h13" />
          </svg><span class="hide-sm">Liste</span></div>
        <div class="tab" role="tab" aria-selected="false" id="tab-map"><svg width="16" height="16" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M14.1 5.6a2 2 0 0 0 1.8 0l3.7-1.8a1 1 0 0 1 .9.8v12.8a1 1 0 0 1-.6.9l-4.6 2.3a2 2 0 0 1-1.8 0L8.3 18.5a2 2 0 0 0-1.8 0l-3.7 1.8A1 1 0 0 1 2 19.4V6.6a1 1 0 0 1 .6-.9l4.6-2.3a2 2 0 0 1 1.8 0z" />
            <path d="M15 5.8v15" />
            <path d="M9 3.2v15" />
          </svg><span class="hide-sm">Carte</span></div>
      </div>
    </div>

    <!-- Cards / Map views -->
    <div class="view-wrapper show-list" id="viewWrapper" aria-live="polite">
      <section class="results view" aria-hidden="false" aria-label="R√©sultats en liste">
        <div class="grid list-view" id="listView"></div>
      </section>
      <div class="view map-view" id="mapView" role="region" aria-labelledby="tab-map">
        <div id="map"></div>
        <div class="map-bottom-guard" aria-hidden="true"></div>
        <div class="map-fade-bottom" aria-hidden="true"></div>
        <!-- Geo Panel (overlay dans la map) -->
        <div class="geo-panel" id="geoPanel" aria-live="polite">
          <button class="geo-btn" id="geoLocateBtn" type="button" title="Me localiser" aria-live="polite"
            aria-busy="false" aria-expanded="false" aria-controls="geoDropdown">
            <span class="geo-ico" aria-hidden="true">üìç</span>
            <span class="geo-label">Me localiser</span>
            <span class="geo-spinner" aria-hidden="true"></span>
            <span class="geo-caret" id="geoCaretBtn">‚ñæ</span>
            <span class="geo-toast" id="geoToast" role="status" aria-live="polite" hidden>Position d√©tect√©e ‚úÖ</span>
          </button>

          <div class="geo-dropdown" id="geoDropdown" role="group" aria-label="Options de recherche par rayon" hidden>
            <div class="geo-row" id="geoRadiusRow">
              <label for="geoRadius" class="geo-caption">Rayon&nbsp;<span id="geoRadiusVal">10</span>&nbsp;km</label>
              <input id="geoRadius" class="geo-range" type="range" min="1" max="100" step="1" value="10"
                aria-label="Rayon de recherche en kilom√®tres">
            </div>
            <label class="geo-toggle">
              <input type="checkbox" id="geoRadiusEnabled" checked>
              <span>D√©sactiver la recherche par rayon</span>
            </label>
          </div>
        </div>
      </div>
    </div>
    <div id="sentinel"></div>
    <div class="loading" id="loading" style="display:none">Chargement‚Ä¶</div>
  </main>
  <nav class="bottom-nav" id="bottomNav" aria-label="Navigation mobile">
    <button class="bn-btn is-active" type="button" data-action="home" aria-pressed="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
        <path d="m3 11 9-8 9 8" />
        <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7" />
      </svg>
      <span class="bn-label">Accueil</span>
    </button>
    <button class="bn-btn" type="button" data-action="messages" aria-pressed="false">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
        <path
          d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8.5Z" />
      </svg>
      <span class="bn-label">Messages</span>
    </button>
    <button class="bn-cta" type="button" data-action="publish" aria-pressed="false">
      <span class="bn-cta-circle" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 5v14" />
          <path d="M5 12h14" />
        </svg>
      </span>
      <span class="bn-label">Publier</span>
    </button>
    <button class="bn-btn" type="button" data-action="favs" aria-pressed="false">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
        <path
          d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
      </svg>
      <span class="bn-label">Favoris</span>
    </button>
    <button class="bn-btn" type="button" data-action="profile" aria-pressed="false">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="7" r="4" />
        <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" />
      </svg>
      <span class="bn-label">Profil</span>
    </button>
  </nav>

  <!-- AUTH MODAL -->
  <div class="modal-backdrop auth-backdrop" id="authModal" aria-hidden="true">
    <div class="auth-dialog" id="authDialog" role="dialog" aria-modal="true" aria-labelledby="heroTitle">
      <div class="auth-hero">
        <div class="auth-header">
          <div class="auth-brand">
            <svg class="pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0" />
              <circle cx="12" cy="10" r="3" />
            </svg>
            <strong>MapMarket</strong>
          </div>
        </div>
        <div class="auth-hero-content">
          <h2 id="heroTitle">Bienvenue !</h2>
          <p id="heroSubtitle">Acc√©dez √† vos messages, favoris et alertes personnalis√©es</p>
        </div>
        <div class="auth-hero-illus" id="heroIcon">üìç</div>
      </div>
      <div class="auth-pane">
        <div class="auth-tabs" role="tablist">
          <div class="auth-indicator" id="tabIndicator"></div>
          <button class="auth-tab active" id="loginTab" type="button" role="tab" aria-selected="true">Se
            connecter</button>
          <button class="auth-tab" id="signupTab" type="button" role="tab" aria-selected="false">Cr√©er un
            compte</button>
        </div>

        <div class="auth-forms" id="formContainer">
          <form class="auth-form active" id="loginForm" autocomplete="on" novalidate>
            <div class="auth-group">
              <label class="auth-label" for="loginEmail">Adresse email</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="loginEmail" type="email" autocomplete="email"
                  placeholder="vous@exemple.fr" required>
              </div>
            </div>

            <div class="auth-group">
              <label class="auth-label" for="loginPassword">Mot de passe</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="loginPassword" type="password" autocomplete="current-password"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                <button type="button" class="password-toggle" data-target="loginPassword"
                  aria-label="Afficher ou masquer le mot de passe">üëÅ</button>
              </div>
            </div>

            <button type="submit" class="auth-submit" id="loginSubmit">Se connecter</button>

            <div class="auth-forgot">
              <button type="button" id="forgotTrigger">Mot de passe oubli√© ?</button>
            </div>
          </form>

          <form class="auth-form" id="signupForm" autocomplete="on" novalidate>
            <div class="auth-group">
              <label class="auth-label" for="signupName">Nom complet</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="signupName" type="text" autocomplete="name" placeholder="Jean Dupont"
                  required>
              </div>
            </div>

            <div class="auth-group">
              <label class="auth-label" for="signupEmail">Adresse email</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="signupEmail" type="email" autocomplete="email"
                  placeholder="vous@exemple.fr" required>
              </div>
            </div>

            <div class="auth-group">
              <label class="auth-label" for="signupPassword">Mot de passe</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="signupPassword" type="password" autocomplete="new-password"
                  placeholder="Minimum 8 caract√®res" minlength="8" required>
                <button type="button" class="password-toggle" data-target="signupPassword"
                  aria-label="Afficher ou masquer le mot de passe">üëÅ</button>
              </div>
            </div>

            <button type="submit" class="auth-submit" id="signupSubmit">Cr√©er mon compte</button>
          </form>

          <form class="auth-form" id="forgotForm" novalidate>
            <div class="auth-group">
              <label class="auth-label" for="forgotEmail">Adresse email</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="forgotEmail" type="email" autocomplete="email"
                  placeholder="vous@exemple.fr" required>
              </div>
            </div>

            <button type="submit" class="auth-submit" id="forgotSubmit">Envoyer le lien de r√©initialisation</button>

            <div class="auth-forgot">
              <button type="button" id="backToLogin">‚Üê Retour √† la connexion</button>
            </div>
          </form>
        </div>
        <div class="auth-feedback" id="authFeedback" aria-live="polite" aria-atomic="true"></div>

      </div>
      <button class="auth-close" id="closeAuth" aria-label="Fermer">‚úï</button>
    </div>
  </div>

  <!-- POST MODAL -->
  <div class="modal-backdrop post-backdrop" id="postModal" aria-hidden="true">
    <div class="post-dialog" id="postDialog" role="dialog" aria-modal="true" aria-labelledby="postTitle">
      <header class="post-header">
        <div class="post-title-group">
          <h2 id="postTitle">D√©poser une annonce</h2>
          <p class="post-subtitle">Partagez votre article en d√©taillant son √©tat, son prix et sa localisation.</p>
        </div>
        <button class="post-close" id="closePost" type="button" aria-label="Fermer">‚úï</button>
      </header>
      <form id="postForm" class="post-form" novalidate>
        <div class="post-content">
          <section class="post-section" aria-labelledby="postSectionMain">
            <header>
              <h3 id="postSectionMain">A. Infos principales</h3>
              <p class="hint">Soyez pr√©cis: marque, mod√®le, √©tat‚Ä¶</p>
            </header>
            <div class="post-grid">
              <div class="field">
                <label for="postTitleInput">Titre de l‚Äôannonce <span aria-hidden="true">*</span></label>
                <input type="text" id="postTitleInput" name="title" placeholder="Ex: Peugeot 208 2018 Diesel" required minlength="10" maxlength="80" autocomplete="off">
                <p class="field-hint">Entre 10 et 80 caract√®res.</p>
                <p class="field-error" data-error-for="postTitleInput"></p>
              </div>
              <div class="field">
                <label for="postCategory">Cat√©gorie <span aria-hidden="true">*</span></label>
                <select id="postCategory" name="category" required>
                  <option value="">S√©lectionnez</option>
                  <option value="immobilier">Immobilier</option>
                  <option value="auto">Auto</option>
                  <option value="mode">Mode</option>
                  <option value="electroniques">High-Tech</option>
                  <option value="pieces">Pi√®ces</option>
                  <option value="loisirs">Loisirs</option>
                </select>
                <p class="field-error" data-error-for="postCategory"></p>
              </div>
              <div class="field">
                <label for="postCondition">√âtat <span aria-hidden="true">*</span></label>
                <select id="postCondition" name="condition" required>
                  <option value="">S√©lectionnez</option>
                  <option value="new">Neuf</option>
                  <option value="very_good">Tr√®s bon √©tat</option>
                  <option value="good">Bon √©tat</option>
                  <option value="fair">Correct</option>
                </select>
                <p class="field-error" data-error-for="postCondition"></p>
              </div>
              <div class="field">
                <label for="postPrice">Prix (Dt) <span aria-hidden="true">*</span></label>
                <div class="price-input">
                  <input type="number" id="postPrice" name="price" required min="0.1" max="9999999" step="1" inputmode="decimal" placeholder="Ex: 2500">
                  <span class="currency">Dt</span>
                </div>
                <p class="field-error" data-error-for="postPrice"></p>
              </div>
            </div>
          </section>

          <section class="post-section" aria-labelledby="postSectionPhotos">
            <header>
              <h3 id="postSectionPhotos">B. Photos</h3>
              <p class="hint">Ajoutez jusqu‚Äô√† 10 photos nettes sous plusieurs angles.</p>
            </header>
            <div class="uploader" id="postUploader">
              <input type="file" id="postPhotos" name="photos" accept="image/jpeg,image/png,image/webp" multiple hidden>
              <label for="postPhotos" class="uploader-drop" tabindex="0">
                <span class="uploader-illustration">üì∏</span>
                <span class="uploader-text">
                  <strong>Glissez vos photos ici</strong>
                  <span class="uploader-hint">Formats jpg, png, webp ‚Äì 10 max (8 Mo max chacune).</span>
                </span>
              </label>
              <div class="uploader-list" id="postPhotosList" aria-live="polite"></div>
              <p class="field-error" data-error-for="postPhotos"></p>
            </div>
          </section>

          <section class="post-section" aria-labelledby="postSectionAttributes">
            <header>
              <h3 id="postSectionAttributes">C. Caract√©ristiques</h3>
              <p class="hint">Renseignez les informations sp√©cifiques √† votre cat√©gorie.</p>
            </header>
            <div id="postAttributes" class="post-grid"></div>
          </section>

          <section class="post-section" aria-labelledby="postSectionLocation">
            <header>
              <h3 id="postSectionLocation">D. Localisation</h3>
              <p class="hint">Indiquez l‚Äôemplacement pour des r√©sultats locaux pertinents.</p>
            </header>
            <div class="post-grid">
              <div class="field field-col">
                <label for="postAddress">Adresse <span aria-hidden="true">*</span></label>
                <input type="text" id="postAddress" name="locationText" placeholder="Ville / adresse‚Ä¶" autocomplete="off" required>
                <p class="field-error" data-error-for="postAddress"></p>
              </div>
            </div>
            <div class="map-wrapper">
              <div class="map-toolbar">
                <button type="button" class="map-btn" id="postUseLocation">üìç Utiliser ma position</button>
                <p class="map-hint">D√©placez le marqueur pour ajuster la position.</p>
              </div>
              <div id="postMap" class="post-map" role="application" aria-label="Carte de localisation"></div>
              <div class="map-coords">
                <div class="field">
                  <label for="postLat">Latitude <span aria-hidden="true">*</span></label>
                  <input type="number" id="postLat" name="latitude" step="0.000001" required>
                  <p class="field-error" data-error-for="postLat"></p>
                </div>
                <div class="field">
                  <label for="postLng">Longitude <span aria-hidden="true">*</span></label>
                  <input type="number" id="postLng" name="longitude" step="0.000001" required>
                  <p class="field-error" data-error-for="postLng"></p>
                </div>
              </div>
            </div>
          </section>

          <section class="post-section" aria-labelledby="postSectionDescription">
            <header>
              <h3 id="postSectionDescription">E. Description</h3>
              <p class="hint">D√©crivez l‚Äôarticle: √©tat r√©el, accessoires, facture, raison de la vente‚Ä¶</p>
            </header>
            <div class="field field-col">
              <label for="postDescription">Description <span aria-hidden="true">*</span></label>
              <textarea id="postDescription" name="description" rows="6" minlength="30" maxlength="2000" required placeholder="Donnez un maximum de d√©tails pour rassurer les acheteurs."></textarea>
              <div class="field-footer">
                <p class="field-hint">Minimum 30 caract√®res ¬∑ Maximum 2000 caract√®res.</p>
                <span id="postDescriptionCount" aria-live="polite">0 / 2000</span>
              </div>
              <p class="field-error" data-error-for="postDescription"></p>
            </div>
          </section>

          <div class="post-section post-section--draft" aria-live="polite" hidden id="postDraftBanner">
            <div class="draft-banner">
              <div class="draft-info">
                <strong>Brouillon retrouv√©</strong>
                <p>Vous aviez commenc√© une annonce. Voulez-vous la reprendre ?</p>
              </div>
              <div class="draft-actions">
                <button type="button" class="mm-btn" id="postDraftResume">Charger</button>
                <button type="button" class="mm-btn ghost" id="postDraftDiscard">Ignorer</button>
              </div>
            </div>
          </div>
        </div>

        <footer class="post-footer">
          <div class="footer-left">
            <button type="button" class="mm-btn ghost" id="postCancel">Annuler</button>
            <button type="button" class="mm-btn outline" id="postPreview">Pr√©visualiser</button>
            <button type="button" class="mm-btn ghost" id="postSaveDraft">Enregistrer le brouillon</button>
          </div>
          <div class="footer-right">
            <div class="post-status" id="postStatus" aria-live="polite"></div>
            <button type="submit" class="mm-btn primary" id="postSubmit">
              <span class="btn-label">Publier l‚Äôannonce</span>
              <span class="btn-spinner" aria-hidden="true"></span>
            </button>
          </div>
        </footer>
      </form>
    </div>
  </div>

  <!-- DETAILS MODAL -->
  <div class="modal-backdrop details-backdrop" id="detailsModal" aria-hidden="true">
    <div class="details-dialog" id="detailsDialog" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <button class="details-close" id="closeDetails" aria-label="Fermer">‚úï</button>

      <div class="details-media">
        <div class="details-carousel">
          <div class="carousel-track" id="detailsCarouselTrack"></div>
          <div class="carousel-nav">
            <button class="carousel-btn" id="detailsPrev" aria-label="Image pr√©c√©dente">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6" />
              </svg>
            </button>
            <button class="carousel-btn" id="detailsNext" aria-label="Image suivante">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6" />
              </svg>
            </button>
          </div>
          <div class="carousel-meta">
            <div class="carousel-counter" id="detailsImageCounter">1 / 1</div>
            <div class="carousel-dots" id="detailsCarouselDots"></div>
          </div>
          <div class="details-meta details-meta-category" role="group" aria-label="Cat√©gorie de l'annonce"></div>
          <div class="details-meta details-meta-stats" role="group" aria-label="Statistiques de l'annonce"></div>
        </div>
        <div class="details-skeleton" id="detailsSkeleton"></div>
      </div>

      <div class="details-body">
        <div class="details-hero-card">
          <div class="details-hero-info">
            <h2 id="detailsTitle">Titre</h2>
            <div class="details-meta" id="detailsMeta"></div>
          </div>
          <div class="details-price" id="detailsPrice"><strong>‚Äî</strong></div>
        </div>

        <div class="details-tags" id="detailsTags"></div>

        <section class="details-section">
          <h3>Description</h3>
          <p class="details-desc" id="detailsDesc"></p>
          <button class="details-readmore" id="detailsReadMore" type="button">Lire la suite</button>
        </section>

        <section class="details-section">
          <h3>Informations sur le vendeur</h3>
          <div class="seller-card-wrap" id="sellerCardWrap">
            <div class="seller-card" id="detailsSeller"></div>
            <div id="contactPopover" class="contact-popover" hidden role="dialog" aria-modal="true" aria-labelledby="cpTitle">
              <div class="contact-arrow" aria-hidden="true"></div>
              <header class="contact-header">
                <h3 id="cpTitle">Contacter le vendeur</h3>
                <button id="cpClose" class="icon-btn contact-close" type="button" aria-label="Fermer">‚úï</button>
              </header>
              <div class="contact-body">
                <textarea id="cpMessage" rows="3" maxlength="500"
                  placeholder="Bonjour, votre article est-il toujours disponible ? Puis-je venir le voir ce week-end ?"></textarea>
                <div class="cp-suggestions">
                  <button type="button" class="chip">Toujours dispo ?</button>
                  <button type="button" class="chip">Prix n√©gociable ?</button>
                  <button type="button" class="chip">Proposition RDV</button>
                </div>
                <p id="cpError" class="cp-error" role="alert" aria-live="assertive" hidden></p>
                <div class="contact-footer">
                  <span id="cpCounter" class="cp-counter" aria-live="polite">500</span>
                  <div class="cp-actions">
                    <button class="icon-btn ghost" id="cpCancel" type="button" aria-label="Annuler" title="Annuler">‚úï</button>
                    <button class="icon-btn primary" id="cpSend" type="button" aria-label="Envoyer" title="Envoyer">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M22 2L11 13" />
                        <path d="M22 2L15 22l-4-9-9-4Z" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <div class="details-actions">
          <button class="cta-outline" id="detailsSave" type="button" aria-label="Ajouter aux favoris">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path
                d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
            </svg>
            <span>Ajouter aux favoris</span>
          </button>
          <button class="cta-primary" id="detailsContact" type="button" aria-label="Contacter le vendeur">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M22 12h-4" />
              <path d="M2 12h4" />
              <path d="M12 2v4" />
              <path d="M12 22v-4" />
              <rect x="7" y="7" width="10" height="10" rx="2" />
            </svg>
            <span>Contacter</span>
          </button>
          <button class="cta-secondary" id="detailsVisit" type="button" aria-label="Voir sur la carte">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M12 19V6" />
              <path d="m5 12 7-7 7 7" />
            </svg>
            <span>Voir sur la carte</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="mm-confirm" id="confirmModal" hidden>
    <div class="mm-confirm__backdrop" data-action="dismiss"></div>
    <div class="mm-confirm__dialog" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="mm-confirm__icon" aria-hidden="true">üí≠</div>
      <div class="mm-confirm__copy">
        <h3 id="confirmTitle" class="mm-confirm__title">Confirmation</h3>
        <p id="confirmMessage" class="mm-confirm__message">√ätes-vous s√ªr ?</p>
      </div>
      <div class="mm-confirm__actions">
        <button type="button" class="mm-confirm__btn mm-confirm__btn--ghost" data-action="cancel">Annuler</button>
        <button type="button" class="mm-confirm__btn mm-confirm__btn--primary" data-action="confirm">Oui</button>
      </div>
    </div>
  </div>

  <div class="lightbox" id="imageLightbox" hidden>
    <div class="lightbox__backdrop" data-action="dismiss"></div>
    <div class="lightbox__dialog" role="dialog" aria-modal="true" aria-labelledby="lightboxTitle" tabindex="-1">
      <button type="button" class="lightbox__close" data-action="close" aria-label="Fermer l'image">‚úï</button>
      <div class="lightbox__stage">
        <button type="button" class="lightbox__nav lightbox__nav--prev" data-action="prev" aria-label="Image pr√©c√©dente">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6" />
          </svg>
        </button>
        <img id="lightboxImage" src="data:image/gif;base64,R0lGODlhAQABAAAAACw=" alt="" draggable="false">
        <button type="button" class="lightbox__nav lightbox__nav--next" data-action="next" aria-label="Image suivante">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6" />
          </svg>
        </button>
      </div>
      <div class="lightbox__footer">
        <span class="lightbox__title" id="lightboxTitle"></span>
        <span class="lightbox__counter" id="lightboxCounter"></span>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Action enregistr√©e</div>

  <!-- FAVORITES MODAL (UNIQUE) -->
  <div id="favOverlay" class="mm-overlay" hidden></div>
  <div id="favModal" class="mm-modal" role="dialog" aria-modal="true" aria-labelledby="favTitle" aria-hidden="true">
    <header class="mm-header">
      <div class="mm-header-row">
        <h2 id="favTitle">Favoris <span id="favSheetCount" class="mm-count">0</span></h2>
        <div class="mm-actions">
          <button id="clearAllFavs" class="mm-link danger" type="button">Tout retirer</button>
          <button id="closeFavs" class="mm-icon" aria-label="Fermer" type="button">‚úï</button>
        </div>
      </div>
      <div class="mm-toolbar">
        <div class="mm-search">
          <span class="mm-search-ico">üîé</span>
          <input id="favSearch" type="search" placeholder="Rechercher un favori‚Ä¶" autocomplete="off">
        </div>
        <div class="mm-filters">
          <select id="favSortBy" aria-label="Trier">
            <option value="recent">Plus r√©cent</option>
            <option value="price_asc">Prix croissant</option>
            <option value="price_desc">Prix d√©croissant</option>
            <option value="title_asc">Titre A‚ÜíZ</option>
          </select>
          <select id="favByCat" aria-label="Cat√©gorie (toutes)">
            <option value="">Toutes cat√©gories</option>
          </select>
        </div>
      </div>
    </header>
    <div id="favList" class="mm-grid" role="list"></div>
    <div id="favEmptyState" class="mm-empty" hidden>
      <div class="mm-empty-illu">üíó</div>
      <h3>Aucun favori pour l‚Äôinstant</h3>
      <p>Ajoutez des annonces √† vos favoris pour les retrouver ici.</p>
    </div>
  </div>

  <footer class="mm-footer" id="appFooter">
    <div class="mm-footer__grid">
      <div class="mm-footer__brand">
        <div class="mm-footer__logo">üìç <strong>MapMarket</strong></div>
        <p class="mm-footer__baseline">Trouvez, comparez et localisez les meilleures offres pr√®s de vous.</p>
      </div>

      <nav class="mm-footer__col" aria-label="Produits">
        <h3 class="mm-footer__title">Produits</h3>
        <ul class="mm-footer__links">
          <li><a href="#" data-nav="map">Carte</a></li>
          <li><a href="#" data-nav="list">Liste</a></li>
          <li><a href="#" data-nav="pro">Professionnels</a></li>
        </ul>
      </nav>

      <nav class="mm-footer__col" aria-label="L√©gal">
        <h3 class="mm-footer__title">L√©gal</h3>
        <ul class="mm-footer__links">
          <li><a href="#" data-legal="terms">Conditions d‚Äôutilisation</a></li>
          <li><a href="#" data-legal="privacy">Confidentialit√©</a></li>
          <li><a href="#" data-legal="cookies">Cookies</a></li>
        </ul>
      </nav>

      <div class="mm-footer__col">
        <h3 class="mm-footer__title">Restez inform√©</h3>
        <form id="newsletterForm" class="mm-news" novalidate>
          <label class="sr-only" for="newsletterEmail">Votre e-mail</label>
          <input id="newsletterEmail" class="mm-news__input" type="email" inputmode="email" placeholder="you@example.com" required>
          <button class="mm-news__btn" type="submit">S‚Äôinscrire</button>
          <p class="mm-footer__hint">En vous inscrivant, vous acceptez de recevoir nos actualit√©s. Consultez notre <a href="#"
              data-legal="privacy">Politique de confidentialit√©</a>.</p>
        </form>
      </div>
    </div>
    <div class="mm-footer__copy">¬© <span id="yearNow"></span> MapMarket. Tous droits r√©serv√©s.</div>
  </footer>

  <div id="legalModal" class="mm-modal mm-modal--legal" role="dialog" aria-modal="true" aria-labelledby="legalTitle"
    aria-describedby="legalBody" hidden>
    <div class="mm-modal__backdrop" data-close="true"></div>
    <div class="mm-modal__dialog" role="document">
      <header class="mm-modal__header">
        <h2 id="legalTitle" class="mm-modal__title">Titre</h2>
        <button class="mm-modal__close" type="button" aria-label="Fermer" data-close="true">‚úï</button>
      </header>
      <div id="legalBody" class="mm-modal__content" tabindex="0"></div>
      <footer class="mm-modal__footer">
        <button class="mm-btn" type="button" data-close="true">Fermer</button>
      </footer>
    </div>
  </div>

  <script>
    (() => {
    // ---------- DATA (mock + g√©oloc) ----------
    const cityPos = {
      'Montpellier': [43.611, 3.877], 'Paris': [48.8566, 2.3522], 'Lyon': [45.764, 4.8357],
      'Marseille': [43.2965, 5.3698], 'Toulouse': [43.6045, 1.4440], 'Lille': [50.6292, 3.0573]
    };

    function jitter([lat, lng]) { return [lat + (Math.random() - .5) * 0.08, lng + (Math.random() - .5) * 0.12]; }

    const cssVar = (name, fallback = '') => {
      const raw = getComputedStyle(document.documentElement).getPropertyValue(name);
      return raw ? raw.trim() : fallback;
    };

    const THEME = {
      favorite: cssVar('--color-favorite', '#ef4444')
    };

    const CATEGORY_CONFIG = [
      { slug: 'immobilier', label: 'Immobilier', icon: 'üè¢' },
      { slug: 'auto', label: 'Auto', icon: 'üöó' },
      { slug: 'mode', label: 'Mode', icon: 'üëó' },
      { slug: 'electroniques', label: 'High-Tech', icon: 'üíª' },
      { slug: 'pieces', label: 'Pi√®ces', icon: 'üîß' },
      { slug: 'loisirs', label: 'Loisirs', icon: 'üö≤' }
    ];
    const CATEGORY_LABELS = CATEGORY_CONFIG.reduce((acc, item) => {
      acc[item.slug] = item.label;
      return acc;
    }, {});
    const CATEGORY_ICONS = CATEGORY_CONFIG.reduce((acc, item) => {
      acc[item.slug] = item.icon;
      return acc;
    }, {});

    const CONDITION_LABELS = {
      new: 'Neuf',
      very_good: 'Tr√®s bon √©tat',
      good: 'Bon √©tat',
      fair: 'Correct'
    };

    function mapConditionToSlug(label) {
      if (!label) return '';
      const normalized = label.toString().toLowerCase();
      if (normalized.includes('neuf')) return 'new';
      if (normalized.includes('tr√®s bon')) return 'very_good';
      if (normalized.includes('bon')) return 'good';
      if (normalized.includes('correct')) return 'fair';
      return normalized;
    }

    const DEFAULT_IMAGE = 'https://via.placeholder.com/640x480?text=MapMarket';

    function capitalize(text = '') {
      if (!text) return '';
      return text.charAt(0).toUpperCase() + text.slice(1);
    }

    function getCategoryConfig(value) {
      if (!value) return null;
      const normalized = normalize(value);
      return CATEGORY_CONFIG.find((cat) => normalize(cat.slug) === normalized || normalize(cat.label) === normalized) || null;
    }

    function normalizeLabel(value, fallback) {
      if (!value) return fallback;
      const match = getCategoryConfig(value);
      if (match) return match.label;
      return fallback || capitalize(value.toString());
    }

    function mapCategoryLabelToSlug(label) {
      if (!label) return '';
      const match = getCategoryConfig(label);
      if (match) return match.slug;
      return normalize(label);
    }

    function populateCategorySelect(selectEl, { placeholderLabel = null, placeholderValue = '' } = {}) {
      if (!selectEl) return;
      const previousValue = selectEl.value;
      const fragment = document.createDocumentFragment();
      if (typeof placeholderLabel === 'string') {
        const placeholderOption = document.createElement('option');
        placeholderOption.value = placeholderValue;
        placeholderOption.textContent = placeholderLabel;
        fragment.appendChild(placeholderOption);
      }
      CATEGORY_CONFIG.forEach((item) => {
        const option = document.createElement('option');
        option.value = item.slug;
        option.textContent = item.label;
        fragment.appendChild(option);
      });
      selectEl.innerHTML = '';
      selectEl.appendChild(fragment);
      if (previousValue && selectEl.querySelector(`option[value="${previousValue}"]`)) {
        selectEl.value = previousValue;
      } else if (typeof placeholderLabel === 'string') {
        selectEl.value = placeholderValue;
      }
    }

    function buildChipsFromAttributes(category, attributes = {}) {
      const chips = [];
      const attr = attributes || {};
      switch (category) {
        case 'auto': {
          if (attr.year) chips.push(String(attr.year));
          if (attr.mileage != null) chips.push(`${Number(attr.mileage).toLocaleString('fr-FR')} km`);
          if (attr.fuel) chips.push(capitalize(attr.fuel));
          if (attr.gearbox) chips.push(capitalize(attr.gearbox));
          break;
        }
        case 'immobilier': {
          if (attr.surface) chips.push(`${attr.surface} m¬≤`);
          if (attr.rooms) chips.push(`${attr.rooms} pi√®ce${attr.rooms > 1 ? 's' : ''}`);
          if (attr.dpe) chips.push(`DPE ${attr.dpe}`);
          if (attr.furnished != null) chips.push(attr.furnished ? 'Meubl√©' : 'Non meubl√©');
          break;
        }
        case 'electroniques': {
          if (attr.brand) chips.push(capitalize(attr.brand));
          if (attr.storage) chips.push(`${attr.storage} Go`);
          if (attr.grade) chips.push(capitalize(attr.grade));
          break;
        }
        case 'pieces': {
          if (attr.compatible) chips.push(attr.compatible);
          if (attr.grade) chips.push(capitalize(attr.grade));
          if (attr.reference) chips.push(`Ref ${attr.reference}`);
          break;
        }
        case 'mode': {
          if (attr.brand) chips.push(capitalize(attr.brand));
          if (attr.size) chips.push(String(attr.size).toUpperCase());
          if (attr.gender) chips.push(capitalize(attr.gender));
          break;
        }
        case 'loisirs': {
          if (attr.activity) chips.push(capitalize(attr.activity));
          if (attr.brand) chips.push(capitalize(attr.brand));
          if (attr.model) chips.push(attr.model);
          break;
        }
        default:
          break;
      }
      return chips.slice(0, 3);
    }

    function mapAdFromApi(ad) {
      if (!ad) return null;
      const rawCategory = ad.category || '';
      const catSlug = mapCategoryLabelToSlug(rawCategory);
      const category = catSlug || rawCategory;
      const catLabel = normalizeLabel(category, 'Autres');
      const conditionLabel = CONDITION_LABELS[ad.condition] || capitalize(ad.condition || '');
      const locationText = ad.locationText?.trim() || 'Localisation √† pr√©ciser';
      const coordinates = Array.isArray(ad.location?.coordinates) ? ad.location.coordinates : null;
      const latlng = coordinates && coordinates.length === 2
        ? [Number(coordinates[1]), Number(coordinates[0])]
        : null;
      const cityGuess = locationText.split(',')[0].trim() || catLabel;
      const fallbackLatLng = cityPos[cityGuess] || cityPos[catLabel] || [36.8065, 10.1815];
      const images = Array.isArray(ad.images) && ad.images.length ? ad.images : [];
      const owner = ad.owner || {};
      let sellerAvatar = null;
      if (owner.avatarUrl) {
        sellerAvatar = owner.avatarUrl;
      } else if (owner.avatar && !String(owner.avatar).startsWith('data:')) {
        sellerAvatar = `/uploads/avatars/${owner.avatar}`;
      }
      const sellerMemberSince = owner.memberSince || owner.createdAt || ad.createdAt;
      let chips = buildChipsFromAttributes(category, ad.attributes);
      if (!chips.length) {
        chips = [catLabel, conditionLabel, fmtPrice(ad.price)];
      }

      return {
        id: String(ad._id),
        category,
        catSlug: category,
        cat: catLabel,
        condition: ad.condition,
        state: conditionLabel || '‚Äî',
        title: ad.title || 'Annonce MapMarket',
        desc: ad.description || '',
        price: Number(ad.price) || 0,
        city: cityGuess,
        locationText,
        latlng: latlng || fallbackLatLng,
        views: ad.views ?? 0,
        likes: ad.favoritesCount ?? 0,
        favorites: ad.favoritesCount ?? 0,
        date: ad.createdAt || ad.updatedAt || new Date().toISOString(),
        img: images[0] || DEFAULT_IMAGE,
        gallery: images.length ? images : [DEFAULT_IMAGE],
        attributes: ad.attributes || {},
        chips,
        sellerName: owner.name || owner.email || `Vendeur ${cityGuess}`,
        sellerEmail: owner.email || '',
        sellerAvatar,
        sellerMemberSince,
        sellerAnnouncements: owner.activeAds ?? null,
        ownerId: owner._id ? String(owner._id) : null
      };
    }

    function upsertAd(ad) {
      if (!ad) return;
      const id = String(ad.id);
      const index = allItems.findIndex((item) => String(item.id) === id);
      if (index === -1) {
        allItems.push(ad);
      } else {
        allItems[index] = ad;
      }
      filteredCache = filteredCache.map((item) => (String(item.id) === id ? ad : item));
      rebuildAllItemsIndex();
      syncAdStats(ad);
    }

    function syncAdStats(ad) {
      if (!ad) return;
      updateAdCardDisplay(ad);
      updateMarkerStats(ad);
      if (favStore.has(ad.id) && isFavModalOpen()) renderFavSheet();
      const detailsId = normalizeAdId(detailsDialog?.dataset?.itemId);
      if (detailsModal && detailsModal.style.display === 'flex' && detailsId && detailsId === normalizeAdId(ad.id)) {
        refreshOpenDetails(ad);
      }
    }

    function updateAdCardDisplay(ad) {
      if (!listView) return;
      const cards = listView.querySelectorAll(`.ad-content[data-id=\"${CSS.escape(String(ad.id))}\"]`);
      cards.forEach((card) => {
        const priceEl = card.querySelector('.price');
        if (priceEl) priceEl.textContent = fmtPrice(ad.price);
        const statsSpans = card.querySelectorAll('.stats .row');
        if (statsSpans[0]) statsSpans[0].innerHTML = `üëÅÔ∏è ${escapeHtml(ad.views ?? 0)}`;
        if (statsSpans[1]) statsSpans[1].innerHTML = `‚ù§ ${escapeHtml(ad.likes ?? ad.favorites ?? 0)}`;
      });
    }

    function updateMarkerStats(ad) {
      const marker = markerIndex.get(String(ad.id));
      if (!marker || !marker._item) return;
      marker._item.stats = {
        views: ad.views ?? 0,
        likes: ad.likes ?? ad.favorites ?? 0
      };
      marker._itemData = {
        ...marker._itemData,
        views: ad.views ?? 0,
        likes: ad.likes ?? ad.favorites ?? 0,
        stats: {
          views: ad.views ?? 0,
          likes: ad.likes ?? ad.favorites ?? 0
        }
      };
      if (hoverCard && hoverCard._sourceMarker === marker) {
        hoverCard.setContent(renderMiniCard(marker._item));
        hoverCard.update();
      }
    }

    const updateFavIcon = (node, isActive) => {
      if (!node) return;
      node.setAttribute('fill', isActive ? THEME.favorite : 'none');
      node.setAttribute('stroke', isActive ? THEME.favorite : 'currentColor');
    };

    let allItems = [];
    const allItemsIndex = new Map();
    function rebuildAllItemsIndex() {
      allItemsIndex.clear();
      allItems.forEach(item => {
        allItemsIndex.set(String(item.id), item);
      });
    }
    rebuildAllItemsIndex();

    const normalizeAdId = (value) => {
      if (value == null) return null;
      return String(value);
    };

    const favStore = (() => {
      let memory = new Set();
      return {
        values() {
          return Array.from(memory);
        },
        has(id) {
          const key = normalizeAdId(id);
          return key != null ? memory.has(key) : false;
        },
        size() {
          return memory.size;
        },
        add(id) {
          const key = normalizeAdId(id);
          if (key != null) memory.add(key);
        },
        delete(id) {
          const key = normalizeAdId(id);
          if (key != null) memory.delete(key);
        },
        clear() {
          memory.clear();
        },
        load(list = []) {
          memory = new Set(list.map(normalizeAdId).filter(Boolean));
        }
      };
    })();

    try {
      localStorage.removeItem('mm-favs');
    } catch (error) {
      // ignore cleanup errors
    }

    const getItemById = (id) => {
      const key = normalizeAdId(id);
      if (key == null) return null;
      return allItemsIndex.get(key) || allItems.find((item) => String(item.id) === key) || null;
    };
    const authStore = { get() { try { return JSON.parse(localStorage.getItem('mm-auth') || 'null') } catch { return null } }, set(v) { localStorage.setItem('mm-auth', JSON.stringify(v)) } };

    // ---------- UTIL ----------
    function categoryClass(cat) {
      const slug = mapCategoryLabelToSlug(cat);
      switch (slug) {
        case 'immobilier':
          return 'immobilier';
        case 'mode':
          return 'mode';
        case 'electroniques':
          return 'hitech';
        case 'auto':
          return 'auto';
        case 'pieces':
          return 'pieces';
        case 'loisirs':
          return 'loisirs';
        default:
          return 'maison';
      }
    }
    function fmtPrice(n) {
      const value = Number(n);
      if (Number.isNaN(value)) return '0 Dt';
      return fmtDT.format(value);
    }
    function buildOptimizedImage(url, width = 480, quality = 70) {
      if (!url) return '';
      try {
        const parsed = new URL(url, window.location.href);
        if (parsed.hostname.includes('images.unsplash.com')) {
          parsed.searchParams.set('auto', 'format');
          parsed.searchParams.set('fit', parsed.searchParams.get('fit') || 'crop');
          if (width) parsed.searchParams.set('w', String(width));
          if (quality) parsed.searchParams.set('q', String(quality));
          if (!parsed.searchParams.has('fm')) parsed.searchParams.set('fm', 'jpg');
          return parsed.toString();
        }
        return url;
      } catch {
        if (typeof url === 'string' && url.includes('images.unsplash.com')) {
          let result = url;
          if (width) {
            if (/w=\d+/.test(result)) result = result.replace(/w=\d+/g, `w=${width}`);
            else result += (result.includes('?') ? '&' : '?') + `w=${width}`;
          }
          if (quality) {
            if (/q=\d+/.test(result)) result = result.replace(/q=\d+/g, `q=${quality}`);
            else result += (result.includes('?') ? '&' : '?') + `q=${quality}`;
          }
          if (!/auto=/.test(result)) result += (result.includes('?') ? '&' : '?') + 'auto=format';
          if (!/fit=/.test(result)) result += (result.includes('?') ? '&' : '?') + 'fit=crop';
          if (!/fm=/.test(result)) result += (result.includes('?') ? '&' : '?') + 'fm=jpg';
          return result;
        }
        return url;
      }
    }
    function buildSrcSet(url, widths = [320, 480, 640], quality = 70) {
      return widths.map(w => `${buildOptimizedImage(url, w, quality)} ${w}w`).join(', ');
    }
    function formatDateLong(dateStr) {
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
    }
    function daysAgo(dateStr) { const d = new Date(dateStr); const diff = Math.max(1, Math.round((Date.now() - d) / 86400000)); return `il y a ${diff} jour${diff > 1 ? 's' : ''}`; }
    function normalize(s) { return (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }

    let scrollLockDepth = 0;
    function lockBodyScroll() {
      scrollLockDepth = Math.max(0, scrollLockDepth) + 1;
      document.body.classList.add('no-scroll', 'modal-open');
      document.body.style.overflow = 'hidden';
    }
    function unlockBodyScroll() {
      scrollLockDepth = Math.max(0, scrollLockDepth - 1);
      if (scrollLockDepth === 0) {
        document.body.classList.remove('no-scroll', 'modal-open');
        document.body.style.overflow = '';
      }
    }
    window.lockBodyScroll = lockBodyScroll;
    window.unlockBodyScroll = unlockBodyScroll;
    function isFavModalOpen() {
      const panel = document.getElementById('favModal');
      return !!(panel && panel.classList.contains('mm-open'));
    }

    // ---------- FILTERING ----------
    const search = document.getElementById('search');
    const cat = document.getElementById('cat');
    const etat = document.getElementById('etat');
    const sort = document.getElementById('sort');
    const pmin = document.getElementById('pmin');
    const pmax = document.getElementById('pmax');
    const city = document.getElementById('city');
    const resetBtn = document.getElementById('resetBtn');
    const viewState = { userAdjustedView: false };

    function getFiltered() {
      let list = allItems.slice();
      const q = normalize(search.value);
      if (q) list = list.filter(a => normalize(a.title + " " + a.desc).includes(q));
      if (cat.value) list = list.filter(a => (a.catSlug || mapCategoryLabelToSlug(a.cat)) === cat.value);
      if (etat.value) list = list.filter(a => a.state === etat.value);
      if (city.value) list = list.filter(a => normalize(a.city).includes(normalize(city.value)));
      const min = Number(pmin.value || 0), max = Number(pmax.value || Infinity);
      list = list.filter(a => a.price >= min && a.price <= max);
      if (sort.value === 'priceAsc') list.sort((a, b) => a.price - b.price);
      else if (sort.value === 'priceDesc') list.sort((a, b) => b.price - a.price);
      else list.sort((a, b) => new Date(b.date) - new Date(a.date));
      if (typeof window !== 'undefined' && typeof window.mmFilterByRadius === 'function') {
        list = window.mmFilterByRadius(list);
      }
      return list;
    }

    let filterReloadTimer = null;
    function scheduleAdsReload({ immediate = false } = {}) {
      if (filterReloadTimer) clearTimeout(filterReloadTimer);
      viewState.userAdjustedView = false;
      if (immediate) {
        loadAds({ filters: getFilterValues() });
        return;
      }
      filterReloadTimer = setTimeout(() => {
        loadAds({ filters: getFilterValues() });
      }, 400);
    }

    if (search) search.addEventListener('input', () => scheduleAdsReload({ immediate: false }));
    [cat, etat, sort, pmin, pmax, city].forEach(el => el?.addEventListener('change', () => scheduleAdsReload({ immediate: true })));
    [pmin, pmax, city].forEach(el => el?.addEventListener('input', () => scheduleAdsReload({ immediate: false })));

    resetBtn.addEventListener('click', () => {
      [search, cat, etat, sort, pmin, pmax, city].forEach(el => {
        if (!el) return;
        if (el.tagName === 'SELECT') el.selectedIndex = 0;
        else el.value = '';
      });
      viewState.userAdjustedView = false;
      loadAds({ filters: getFilterValues() });
    });

    // ---------- LIST RENDER + INFINITE ----------
    const listView = document.getElementById('listView');
    const count = document.getElementById('count');
    const favCount = document.getElementById('fav-count');
    const openFavsBtn = document.getElementById('openFavs');
    const navMessages = document.getElementById('navMessages');
    const sentinel = document.getElementById('sentinel');
    const loading = document.getElementById('loading');
    const favOverlay = document.getElementById('favOverlay');
    const favModal = document.getElementById('favModal');
    const favList = document.getElementById('favList');
    const favEmptyState = document.getElementById('favEmptyState');
    const favSheetCount = document.getElementById('favSheetCount');
    const favSearch = document.getElementById('favSearch');
    const favSortBy = document.getElementById('favSortBy');
    const favByCat = document.getElementById('favByCat');
    const clearAllFavsBtn = document.getElementById('clearAllFavs');
    const closeFavsBtn = document.getElementById('closeFavs');

    function updateFavBadge() {
      if (favCount) favCount.textContent = favStore.size();
    }

    function syncAllFavoriteButtons() {
      if (!listView) return;
      const activeSet = new Set(favStore.values().map(String));
      listView.querySelectorAll('.fav').forEach((btn) => {
        const id = btn.dataset.id;
        const isFav = activeSet.has(String(id));
        btn.setAttribute('aria-pressed', String(isFav));
        updateFavIcon(btn.querySelector('svg'), isFav);
      });
      if (detailsCurrentAd) {
        setDetailsSaveState(favStore.has(detailsCurrentAd.id));
      }
    }

    function applyFavoritesFromUser(user) {
      const favorites = Array.isArray(user?.favorites) ? user.favorites : [];
      favStore.load(favorites);
      updateFavBadge();
      syncAllFavoriteButtons();
      if (isFavModalOpen()) renderFavSheet();
    }

    let isLoadingAds = false;
    let pendingFilters = null;
    let currentFilters = {
      search: '',
      category: '',
      condition: '',
      minPrice: '',
      maxPrice: '',
      city: '',
      sort: 'recent'
    };

    function getFilterValues() {
      return {
        search: search?.value?.trim() || '',
        category: cat?.value || '',
        condition: etat?.value || '',
        minPrice: pmin?.value || '',
        maxPrice: pmax?.value || '',
        city: city?.value?.trim() || '',
        sort: sort?.value || 'recent'
      };
    }

    // ========== SKELETON LOADER ==========
    function createSkeletonCard() {
      return `
        <div class="skeleton-card">
          <div class="skeleton-card__media"></div>
          <div class="skeleton-card__body">
            <div class="skeleton-chip"></div>
            <div class="skeleton-price"></div>
            <div class="skeleton-title"></div>
            <div class="skeleton-meta">
              <div class="skeleton-meta-item"></div>
              <div class="skeleton-meta-item"></div>
            </div>
            <div class="skeleton-button"></div>
          </div>
        </div>
      `;
    }

    function showSkeletons(count = 6) {
      if (!listView) return;
      listView.innerHTML = Array(count).fill(createSkeletonCard()).join('');
    }

    function removeSkeletons(callback) {
      if (!listView) {
        if (callback) callback();
        return;
      }
      const skeletons = listView.querySelectorAll('.skeleton-card');
      if (skeletons.length === 0) {
        if (callback) callback();
        return;
      }
      skeletons.forEach(skeleton => skeleton.classList.add('fade-out'));
      setTimeout(() => {
        listView.innerHTML = '';
        if (callback) callback();
      }, 300);
    }


    async function loadAds({ filters = null, toastOnError = true } = {}) {
      if (isLoadingAds) {
        if (filters) pendingFilters = { ...filters };
        return;
      }
      isLoadingAds = true;
      try {
        if (loading) loading.hidden = false;
        
        // Afficher les skeletons pendant le chargement
        showSkeletons(6);
        
        if (filters) {
          currentFilters = { ...currentFilters, ...filters };
        }
        const params = new URLSearchParams();
        params.set('page', '1');
        params.set('limit', '200');
        if (currentFilters.search) params.set('search', currentFilters.search);
        if (currentFilters.category) params.set('category', mapCategoryLabelToSlug(currentFilters.category));
        if (currentFilters.condition) params.set('condition', mapConditionToSlug(currentFilters.condition));
        if (currentFilters.minPrice) params.set('minPrice', currentFilters.minPrice);
        if (currentFilters.maxPrice) params.set('maxPrice', currentFilters.maxPrice);
        if (currentFilters.city) params.set('city', currentFilters.city);
        if (currentFilters.sort) params.set('sort', currentFilters.sort);
        const response = await api.get(`/api/ads?${params.toString()}`);
        const items = Array.isArray(response?.data?.items) ? response.data.items : [];
        allItems = items.map(mapAdFromApi).filter(Boolean);
        rebuildAllItemsIndex();
        pagination.index = 0;
        filteredCache = [];
        
        // Retirer les skeletons avec animation avant d'afficher les vraies annonces
        removeSkeletons(() => {
          renderList(true);
          renderMap({ force: true, invalidate: true, autoFit: !viewState.userAdjustedView });
          syncAllFavoriteButtons();
          if (isFavModalOpen()) renderFavSheet();
        });
      } catch (error) {
        console.error('loadAds error', error);
        // Retirer les skeletons m√™me en cas d'erreur
        removeSkeletons();
        if (toastOnError) showToast(error?.message || 'Impossible de charger les annonces.');
      } finally {
        if (loading) loading.hidden = true;
        isLoadingAds = false;
        if (pendingFilters) {
          const nextFilters = pendingFilters;
          pendingFilters = null;
          loadAds({ filters: nextFilters, toastOnError });
        }
      }
    }

    const favoriteMutations = new Map();

    async function setFavoriteState(id, shouldAdd, { feedback = true } = {}) {
      const auth = authStore.get();
      const key = normalizeAdId(id);
      if (!key) return false;
      if (!auth) {
        showToast('Connectez-vous pour g√©rer vos favoris üîê');
        return false;
      }
      if (favoriteMutations.has(key)) return false;

      const previous = favStore.values();
      if (shouldAdd) favStore.add(key);
      else favStore.delete(key);
      updateFavBadge();
      syncFavoriteButtons(key, favStore.has(key));
      if (isFavModalOpen()) renderFavSheet();

      favoriteMutations.set(key, true);
      try {
        const response = await api.post('/api/users/me/favorites', { adId: key, action: shouldAdd ? 'add' : 'remove' });
        const favorites = response?.data?.favorites ?? [];
        favStore.load(favorites);
        updateFavBadge();
        syncAllFavoriteButtons();
        if (isFavModalOpen()) renderFavSheet();
        const currentUser = authStore.get();
        if (currentUser) {
          currentUser.favorites = favorites;
          authStore.set(currentUser);
        }
        adjustAdFavorites(key, shouldAdd ? 1 : -1);
        if (feedback) showToast(shouldAdd ? 'Ajout√© aux favoris' : 'Retir√© des favoris');
        return true;
      } catch (error) {
        favStore.load(previous);
        updateFavBadge();
        syncAllFavoriteButtons();
        if (isFavModalOpen()) renderFavSheet();
        const currentUser = authStore.get();
        if (currentUser) {
          currentUser.favorites = previous;
          authStore.set(currentUser);
        }
        showToast(extractAuthErrorMessage(error));
        if (error?.status === 401) {
          authStore.set(null);
          updateAuthUI();
          favStore.clear();
          updateFavBadge();
          syncAllFavoriteButtons();
          if (isFavModalOpen()) renderFavSheet();
        }
        return false;
      } finally {
        favoriteMutations.delete(key);
      }
    }

    function adjustAdFavorites(id, delta) {
      const ad = getItemById(id);
      if (!ad) return;
      const next = Math.max(0, (ad.likes ?? ad.favorites ?? 0) + delta);
      ad.likes = next;
      ad.favorites = next;
      upsertAd(ad);
    }

    if (favModal) {
      favModal._stickyOpen = false;
      favModal._favScrollTop = 0;
      favModal._lastSelectedFavId = null;
      favModal._lastSelectedCard = null;
    }

    navMessages?.addEventListener('click', (event) => {
      event.preventDefault();
      navMessages.removeAttribute('data-unread');
      showToast('Messagerie √† venir üí¨');
    });

    const pagination = { index: 0 }; const PAGE_SIZE = 12; let filteredCache = [];

    function getFavBaseItems() {
      return favStore.values()
        .map((id) => getItemById(id) || null)
        .filter(Boolean);
    }

    function refreshFavCategories(sourceItems) {
      if (!favByCat) return;
      const previous = favByCat.value;
      const cats = Array.from(new Set(sourceItems.map(it => it.cat || it.category).filter(Boolean))).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));
      favByCat.innerHTML = '<option value="">Toutes cat√©gories</option>' + cats.map(cat => `<option value="${cat}">${cat}</option>`).join('');
      if (previous && cats.includes(previous)) favByCat.value = previous;
    }

    function applyFavFilters(items) {
      let result = items.slice();
      if (favSearch && favSearch.value.trim()) {
        const q = normalize(favSearch.value);
        result = result.filter(item => normalize(`${item.title} ${item.city || ''} ${(item.cat || item.category || '')}`).includes(q));
      }
      if (favByCat && favByCat.value) {
        const catFilter = favByCat.value;
        result = result.filter(item => (item.cat || item.category || '') === catFilter);
      }
      if (favSortBy) {
        switch (favSortBy.value) {
          case 'price_asc':
            result.sort((a, b) => (a.price || 0) - (b.price || 0));
            break;
          case 'price_desc':
            result.sort((a, b) => (b.price || 0) - (a.price || 0));
            break;
          case 'title_asc':
            result.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            break;
          default:
            result.sort((a, b) => new Date(b.date || b.createdAt || 0) - new Date(a.date || a.createdAt || 0));
        }
      }
      return result;
    }

    function updateFavEmptyState(totalCount) {
      const isEmpty = totalCount === 0;
      if (favList) favList.hidden = isEmpty;
      if (favEmptyState) favEmptyState.hidden = !isEmpty;
    }

    function renderFavCard(item) {
      const priceLabel = typeof item.price === 'string' ? item.price : fmtPrice(item.price || 0);
      const imageSource = item.img || item.imageUrl || 'https://via.placeholder.com/640x480?text=Favori';
      const favThumb = buildOptimizedImage(imageSource, 480, 70);
      const favSrcSet = buildSrcSet(imageSource, [320, 480, 640], 70);
      return `
  <article class="mm-card" role="listitem" data-id="${String(item.id)}" tabindex="-1">
    <button class="mm-remove" aria-label="Retirer ce favori" data-id="${String(item.id)}" title="Retirer">‚úï</button>
    <div class="mm-thumb"><img src="${favThumb}" srcset="${favSrcSet}" sizes="(max-width: 520px) 90vw, 320px" alt="${item.title}" loading="lazy" decoding="async" width="320" height="240" style="aspect-ratio: 4 / 3; width: 100%; height: auto;"></div>
    <div class="mm-body">
      <div class="mm-title2">${item.title}</div>
      <div class="mm-meta"><span>${item.city || ''}</span><span class="mm-price">${priceLabel}</span></div>
    </div>
  </article>`;
    }

    function renderFavSheet() {
      if (!favList) return;
      const baseItems = getFavBaseItems();
      refreshFavCategories(baseItems);
      updateFavBadge();
      let items = applyFavFilters(baseItems);
      favList.classList.remove('mm-grid-filter-empty');
      updateFavEmptyState(baseItems.length);
      if (favSheetCount) favSheetCount.textContent = items.length;
      if (!baseItems.length) {
        favList.innerHTML = '';
        return;
      }
      if (!items.length) {
        favList.classList.add('mm-grid-filter-empty');
        favList.innerHTML = '<div class="mm-empty mm-empty-filter" role="status"><p>Aucun favori ne correspond aux crit√®res actuels.</p></div>';
        return;
      }
      favList.innerHTML = items.map(renderFavCard).join('');
      if (favModal?._stickyOpen && typeof favModal._favScrollTop === 'number') {
        requestAnimationFrame(() => {
          if (favList) {
            favList.scrollTop = favModal._favScrollTop || 0;
            if (favModal._lastSelectedFavId != null) {
              const candidate = favList.querySelector(`.mm-card[data-id="${favModal._lastSelectedFavId}"]`);
              if (candidate) favModal._lastSelectedCard = candidate;
            }
          }
        });
      }
    }

    function openFavSheet() {
      if (!favModal || !favOverlay) return;
      if (favModal.classList.contains('mm-open')) {
        renderFavSheet();
        return;
      }
      renderFavSheet();
      favOverlay.hidden = false;
      requestAnimationFrame(() => favOverlay.classList.add('active'));
      favModal.classList.add('mm-open');
      favModal.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
      if (favSearch) setTimeout(() => favSearch.focus(), 50);
      updateBottomNavState();
    }

    function closeFavSheet() {
      if (!favModal || !favOverlay) return;
      if (!favModal.classList.contains('mm-open')) return;
      favModal._stickyOpen = false;
      favModal._favScrollTop = 0;
      favModal._lastSelectedFavId = null;
      favModal._lastSelectedCard = null;
      favModal.classList.remove('mm-open');
      favModal.setAttribute('aria-hidden', 'true');
      favOverlay.classList.remove('active');
      setTimeout(() => { if (favOverlay && !favModal.classList.contains('mm-open')) favOverlay.hidden = true; }, 200);
      unlockBodyScroll();
      updateBottomNavState();
    }

    openFavsBtn?.addEventListener('click', openFavSheet);
    closeFavsBtn?.addEventListener('click', closeFavSheet);
    favOverlay?.addEventListener('click', (event) => { if (event.target === favOverlay) closeFavSheet(); });
    if (favSearch) favSearch.addEventListener('input', renderFavSheet);
    if (favSortBy) favSortBy.addEventListener('change', renderFavSheet);
    if (favByCat) favByCat.addEventListener('change', renderFavSheet);
    const confirmModal = document.getElementById('confirmModal');
    const confirmTitleEl = document.getElementById('confirmTitle');
    const confirmMessageEl = document.getElementById('confirmMessage');
    const confirmCancelBtn = confirmModal?.querySelector('[data-action="cancel"]');
    const confirmConfirmBtn = confirmModal?.querySelector('[data-action="confirm"]');
    const confirmBackdrop = confirmModal?.querySelector('[data-action="dismiss"]');
    let confirmLastFocus = null;
    let confirmActive = false;

    function showConfirmDialog({ title = 'Confirmation', message = '√ätes-vous s√ªr ?', confirmLabel = 'Confirmer', cancelLabel = 'Annuler' } = {}) {
      if (!confirmModal || !confirmCancelBtn || !confirmConfirmBtn || !confirmTitleEl || !confirmMessageEl) {
        return Promise.resolve(true);
      }
      return new Promise((resolve) => {
        confirmActive = true;
        confirmLastFocus = document.activeElement;
        confirmModal.hidden = false;
        confirmModal.classList.add('is-open');
        confirmModal.setAttribute('aria-hidden', 'false');
        confirmTitleEl.textContent = title;
        confirmMessageEl.textContent = message;
        confirmCancelBtn.textContent = cancelLabel;
        confirmConfirmBtn.textContent = confirmLabel;
        lockBodyScroll();

        const focusTarget = confirmConfirmBtn;
        setTimeout(() => focusTarget?.focus?.({ preventScroll: true }), 30);

        const cleanup = (result) => {
          if (!confirmActive) return;
          confirmActive = false;
          confirmModal.classList.remove('is-open');
          confirmModal.setAttribute('aria-hidden', 'true');
          confirmCancelBtn.removeEventListener('click', onCancel);
          confirmConfirmBtn.removeEventListener('click', onConfirm);
          confirmBackdrop?.removeEventListener('click', onBackdrop);
          document.removeEventListener('keydown', onKeyDown);
          setTimeout(() => { if (!confirmActive) confirmModal.hidden = true; }, 180);
          unlockBodyScroll();
          if (confirmLastFocus && typeof confirmLastFocus.focus === 'function') {
            confirmLastFocus.focus({ preventScroll: true });
          }
          resolve(result);
        };

        const onCancel = () => cleanup(false);
        const onConfirm = () => cleanup(true);
        const onBackdrop = (event) => {
          if (event?.target?.dataset?.action === 'dismiss') cleanup(false);
        };
        const onKeyDown = (event) => {
          if (event.key === 'Escape') {
            event.preventDefault();
            cleanup(false);
            return;
          }
          if (event.key === 'Tab') {
            const focusables = [confirmCancelBtn, confirmConfirmBtn].filter(Boolean);
            if (!focusables.length) return;
            const currentIndex = focusables.indexOf(document.activeElement);
            if (event.shiftKey) {
              if (currentIndex <= 0) {
                event.preventDefault();
                focusables[focusables.length - 1]?.focus?.({ preventScroll: true });
              }
            } else {
              if (currentIndex === focusables.length - 1) {
                event.preventDefault();
                focusables[0]?.focus?.({ preventScroll: true });
              }
            }
          }
        };

        confirmCancelBtn.addEventListener('click', onCancel);
        confirmConfirmBtn.addEventListener('click', onConfirm);
        confirmBackdrop?.addEventListener('click', onBackdrop);
        document.addEventListener('keydown', onKeyDown);
      });
    }

    clearAllFavsBtn?.addEventListener('click', async () => {
      const auth = authStore.get();
      if (!auth) {
        showToast('Connectez-vous pour g√©rer vos favoris üîê');
        return;
      }
      const ids = favStore.values();
      if (!ids.length) {
        showToast('Aucun favori √† retirer.');
        return;
      }
      const accepted = await showConfirmDialog({
        title: 'Vider vos favoris ?',
        message: 'Cette action retirera toutes les annonces de vos favoris. Vous pourrez les ajouter de nouveau plus tard.',
        confirmLabel: 'Tout retirer',
        cancelLabel: 'Annuler'
      });
      if (!accepted) return;
      let removedCount = 0;
      for (const id of ids) {
        const success = await setFavoriteState(id, false, { feedback: false });
        if (success) removedCount += 1;
      }
      updateFavBadge();
      syncAllFavoriteButtons();
      renderFavSheet();
      if (removedCount === ids.length) {
        showToast('Tous les favoris ont √©t√© retir√©s.');
      } else if (removedCount > 0) {
        showToast('Certains favoris n‚Äôont pas pu √™tre retir√©s.');
      }
    });
    favList?.addEventListener('scroll', () => {
      if (favModal?._stickyOpen) {
        favModal._favScrollTop = favList.scrollTop || 0;
      }
    });

    favList?.addEventListener('click', async (event) => {
      const removeBtn = event.target.closest('.mm-remove');
      if (removeBtn) {
        event.stopPropagation();
        const id = removeBtn.dataset.id;
        const success = await setFavoriteState(id, false, { feedback: false });
        if (success) {
          showToast('Retir√© des favoris');
        }
        return;
      }

      const heartBtn = event.target.closest('.mm-heart');
      if (heartBtn) {
        event.stopPropagation();
        const id = heartBtn.dataset.id;
        const success = await setFavoriteState(id, false, { feedback: false });
        if (success) {
          showToast('Retir√© des favoris');
        }
        return;
      }
      const card = event.target.closest('.mm-card');
      if (!card) return;
      const id = card.dataset.id;
      const ad = getItemById(id);
      if (ad) {
        if (favModal) {
          if (!favModal._stickyOpen) favModal._stickyOpen = true;
          if (favList) favModal._favScrollTop = favList.scrollTop || 0;
          favModal._lastSelectedFavId = normalizeAdId(id);
          favModal._lastSelectedCard = card;
        }
        openDetailsModal(ad);
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;
      const detailsOpen = detailsModal && detailsModal.classList.contains('active');
      if (favModal && favModal.classList.contains('mm-open') && !detailsOpen) {
        closeFavSheet();
      }
    });

    function renderChunk() {
      const start = pagination.index * PAGE_SIZE, end = start + PAGE_SIZE;
      const slice = filteredCache.slice(start, end);
      for (const a of slice) {
        const thumbSrc = buildOptimizedImage(a.img, 480, 70);
        const thumbSrcSet = buildSrcSet(a.img, [320, 480, 640], 70);
        const idKey = normalizeAdId(a.id);
        const isFav = favStore.has(idKey);
        const art = document.createElement('article'); art.className = 'ad';
        art.innerHTML = `
          <div class="ad-content" data-id="${String(a.id)}">
          <div class="thumb">
            <img width="370" height="278" loading="lazy" decoding="async" alt="${a.title}"
              src="${thumbSrc}"
              srcset="${thumbSrcSet}"
              sizes="(max-width: 480px) 90vw, 370px"
              style="aspect-ratio: 4 / 3; width: 100%; height: auto;" />
            <div class="grad"></div>
            <div class="cat ${categoryClass(a.catSlug || a.cat)}">${categorySymbol(a.catSlug || a.cat)} <span>${a.cat}</span></div>
            <div class="stats"><span class="row">üëÅÔ∏è ${a.views}</span><span class="row">‚ù§ ${a.likes}</span></div>
            <button class="fav" title="${isFav ? 'Retirer des favoris' : 'Ajouter aux favoris'}" aria-pressed="${isFav}" data-id="${String(a.id)}">
              <svg viewBox="0 0 24 24" fill="${isFav ? THEME.favorite : 'none'}" stroke="${isFav ? THEME.favorite : 'currentColor'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
            </button>
          </div>
          <div class="body">
            <div class="titleprice"><div class="title">${a.title}</div><div class="price">${fmtPrice(a.price)}</div></div>
            <div class="desc">${a.desc}</div>
            <div class="chips">${a.chips.map(c => `<span class="chip">${c}</span>`).join('')}</div>
            <div class="meta">
              <div class="loc"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0"/><circle cx="12" cy="10" r="3"/></svg><span>${a.city}</span></div>
              <span class="state">${a.state}</span>
            </div>
            <div class="time">${daysAgo(a.date)}</div>
          </div>
          </div>`; // ad-content wrapper
        listView.appendChild(art);
      }
      // bind favs for the newly added ones
      listView.querySelectorAll('.fav').forEach(btn => {
        if (btn._bound) return; btn._bound = true;
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const shouldAdd = !favStore.has(id);
          const success = await setFavoriteState(id, shouldAdd, { feedback: false });
          if (success) {
            if (shouldAdd) {
              triggerFavAnimation(btn);
              showToast('Ajout√© aux favoris');
            } else {
              showToast('Retir√© des favoris');
            }
          }
        });
      });
      pagination.index++;
    }

    function renderList(reset) {
      filteredCache = getFiltered();
      updateFavBadge();
      count.textContent = filteredCache.length + (filteredCache.length > 1 ? ' annonces trouv√©es' : ' annonce trouv√©e');
      if (reset) { listView.innerHTML = ''; pagination.index = 0; }
      renderChunk();
    }

    const io = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting && pagination.index * PAGE_SIZE < filteredCache.length) {
          loading.style.display = 'grid';
          setTimeout(() => { renderChunk(); loading.style.display = 'none'; }, 250);
        }
      })
    });
    io.observe(sentinel);

    // ---------- MAP (Leaflet + clusters) ----------
    const fmtDT = new Intl.NumberFormat('fr-TN', { style: 'currency', currency: 'TND', maximumFractionDigits: 0 });

    function escapeHtml(value = '') {
      return String(value).replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch]));
    }

    function escapeAttr(value = '') {
      return escapeHtml(value).replace(/\n/g, ' ');
    }

    function renderMiniCard(item) {
      const priceLabel = typeof item.price === 'number' ? fmtDT.format(item.price) : (item.price || '');
      const stats = item.stats || {};
      const viewLabel = Number.isFinite(stats.views) ? stats.views : null;
      const likeLabel = Number.isFinite(stats.likes) ? stats.likes : null;
      const statsMarkup = [
        viewLabel !== null ? `<span><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="none" stroke="currentColor" stroke-width="2" d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Zm11 3a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg>${escapeHtml(viewLabel)}</span>` : '',
        likeLabel !== null ? `<span><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>${escapeHtml(likeLabel)}</span>` : ''
      ].filter(Boolean).join('');
      const imageSource = item.imageUrl || 'https://via.placeholder.com/640x480?text=Annonce';
      return `
        <article class="ad-card" role="dialog" aria-label="Aper√ßu ${escapeAttr(item.title)}">
          <img class="ad-card__media" src="${escapeAttr(imageSource)}" alt="${escapeAttr(item.title)}" loading="lazy" decoding="async">
          <span class="ad-chip">${escapeHtml(item.category || 'Annonce')}</span>
          <span class="ad-price">${escapeHtml(String(priceLabel))}</span>
          <div class="ad-body">
            <h3 class="ad-title">${escapeHtml(item.title)}</h3>
            <div class="ad-meta">
              <span><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>${escapeHtml(item.city || '')}</span>
              ${statsMarkup}
            </div>
            <button class="ad-cta" type="button" data-action="open-details" data-id="${escapeAttr(item.id)}">Voir les d√©tails</button>
          </div>
        </article>
      `;
    }

    function computeHoverPlacement(marker) {
      if (!marker || !map) return null;
      const latlng = marker.getLatLng();
      if (!latlng) return null;
      const point = map.latLngToContainerPoint(latlng);
      const mapSize = map.getSize();
      if (!point || !mapSize) return null;
      const direction = point.y < (mapSize.y * 0.5) ? 'bottom' : 'top';
      const edgeThreshold = 160;
      const pushAmount = 80;
      let offsetX = 0;
      if (point.x < edgeThreshold) {
        offsetX = pushAmount;
      } else if ((mapSize.x - point.x) < edgeThreshold) {
        offsetX = -pushAmount;
      }
      const offsetY = direction === 'top' ? -12 : 12;
      return { latlng, direction, offset: [offsetX, offsetY] };
    }

    let hoverCard = null;
    let hoverCardCloseTimer = null;
    let hoverMapEventsBound = false;

    function ensureHoverCard(mapInstance) {
      if (!hoverCard && window.L) {
        hoverCard = L.tooltip({
          permanent: false,
          direction: 'top',
          className: 'ad-hovercard ad-enter',
          offset: [0, -12],
          interactive: true
        });
      }
      if (mapInstance && hoverCard && hoverCard._map && hoverCard._map !== mapInstance) {
        hoverCard.remove();
      }
      return hoverCard;
    }

    function setupHoverCardNode() {
      if (!hoverCard) return;
      const el = hoverCard.getElement();
      if (!el || el._hoverBound) return;
      el._hoverBound = true;
      const cancelClose = () => clearTimeout(hoverCardCloseTimer);
      const delayedClose = () => scheduleCloseHover();
      el.addEventListener('mouseenter', cancelClose);
      el.addEventListener('mouseleave', delayedClose);
      el.addEventListener('focusin', cancelClose);
      el.addEventListener('focusout', delayedClose);
      el.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          scheduleCloseHover(0);
          const sourceMarker = hoverCard?._sourceMarker;
          if (sourceMarker && sourceMarker.getElement) {
            sourceMarker.getElement().focus?.();
          }
        }
      });
      el.addEventListener('click', (event) => {
        const target = event.target.closest('[data-action="open-details"]');
        if (!target) return;
        const id = target.getAttribute('data-id');
        scheduleCloseHover(0);
        const sourceMarker = hoverCard?._sourceMarker;
        const data = sourceMarker?._itemData;
        if (data && data.id === id) {
          openDetailsById(id, data);
        } else if (id) {
          openDetailsById(id);
        }
      });
    }

    function scheduleCloseHover(delay = 160) {
      clearTimeout(hoverCardCloseTimer);
      hoverCardCloseTimer = setTimeout(() => {
        if (hoverCard && hoverCard._map) {
          hoverCard._sourceMarker = null;
          hoverCard.remove();
        }
      }, delay);
    }

    function openHoverFor(marker) {
      if (!marker || !map) return;
      const data = marker._item;
      if (!data) return;
      const tooltip = ensureHoverCard(map);
      if (!tooltip) return;
      const placement = computeHoverPlacement(marker);
      if (!placement) return;
      clearTimeout(hoverCardCloseTimer);
      tooltip._sourceMarker = marker;
      tooltip.options.direction = placement.direction;
      tooltip.options.offset = placement.offset;
      tooltip.setLatLng(placement.latlng);
      tooltip.setContent(renderMiniCard(data));
      if (!tooltip._map) {
        tooltip.addTo(map);
      }
      tooltip.update();
      const el = tooltip.getElement();
      if (el) {
        el.classList.remove('ad-enter-active');
        el.classList.remove('ad-enter');
        void el.offsetWidth;
        el.classList.add('ad-enter');
      }
      requestAnimationFrame(() => {
        const node = tooltip.getElement();
        if (!node) return;
        node.classList.remove('ad-enter');
        node.classList.add('ad-enter-active');
        setupHoverCardNode();
      });
    }

    function updateHoverPlacement(marker) {
      if (!hoverCard || !hoverCard._map || !marker || marker !== hoverCard._sourceMarker) return;
      const placement = computeHoverPlacement(marker);
      if (!placement) return;
      hoverCard.options.direction = placement.direction;
      hoverCard.options.offset = placement.offset;
      hoverCard.setLatLng(placement.latlng);
      hoverCard.update();
    }

    function handleMarkerDetails(marker) {
      const data = marker?._itemData;
      if (data && data.id) {
        openDetailsById(data.id, data);
      } else if (marker?._item && marker._item.id) {
        openDetailsById(marker._item.id);
      }
    }

    function bindHoverCard(marker) {
      if (!marker || marker._hoverBound || typeof marker.getAllChildMarkers === 'function') return;
      marker._hoverBound = true;
      marker.options.keyboard = true;
      marker.on('mouseover', () => openHoverFor(marker));
      marker.on('mouseout', () => scheduleCloseHover());
      marker.on('focus', () => openHoverFor(marker));
      marker.on('blur', () => scheduleCloseHover());
      marker.on('remove', () => {
        if (hoverCard && hoverCard._sourceMarker === marker) {
          scheduleCloseHover(0);
        }
      });
      marker.on('click', (event) => {
        const pointerType = event?.originalEvent?.pointerType;
        if (pointerType === 'touch' || pointerType === 'pen') {
          const now = Date.now();
          if (!marker._lastTap || (now - marker._lastTap) > 500) {
            marker._lastTap = now;
            openHoverFor(marker);
            event.originalEvent?.stopPropagation?.();
            event.originalEvent?.preventDefault?.();
          } else {
            marker._lastTap = 0;
            scheduleCloseHover(0);
            handleMarkerDetails(marker);
          }
          return;
        }
        scheduleCloseHover(0);
        handleMarkerDetails(marker);
      });
    }

    document.addEventListener('pointerdown', (event) => {
      if (!hoverCard || !hoverCard._map) return;
      const tooltipEl = hoverCard.getElement();
      if (!tooltipEl) return;
      const markerEl = hoverCard._sourceMarker?.getElement?.();
      if (tooltipEl.contains(event.target)) return;
      if (markerEl && markerEl.contains(event.target)) return;
      scheduleCloseHover(0);
    }, { capture: true });

    const MARKER_CLUSTER_SRC = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js';
    let markerClusterScriptPromise = null;
    function loadMarkerClusterScript() {
      if (window.L && window.L.MarkerClusterGroup) return Promise.resolve();
      if (markerClusterScriptPromise) return markerClusterScriptPromise;
      markerClusterScriptPromise = new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${MARKER_CLUSTER_SRC}"]`);
        if (existing && existing.hasAttribute('data-loaded')) {
          resolve();
          return;
        }
        const script = existing || document.createElement('script');
        script.src = MARKER_CLUSTER_SRC;
        script.defer = true;
        script.crossOrigin = 'anonymous';
        script.onload = () => {
          script.setAttribute('data-loaded', 'true');
          resolve();
        };
        script.onerror = (err) => {
          markerClusterScriptPromise = null;
          reject(err);
        };
        if (!existing) document.head.appendChild(script);
      });
      return markerClusterScriptPromise;
    }

    function waitForLeaflet() {
      if (window.L) return Promise.resolve();
      return new Promise(resolve => {
        const check = () => {
          if (window.L) resolve();
          else requestAnimationFrame(check);
        };
        check();
      });
    }

    let currentView = 'list';
    let map, cluster;
    const markerIndex = new Map();
    async function ensureMap() {
      if (map) return map;
      await waitForLeaflet();
      try {
        await loadMarkerClusterScript();
      } catch (error) {
        return null;
      }
      if (!window.L) return null;
      map = L.map('map', { zoomControl: true, scrollWheelZoom: true }).setView([46.5, 2.3], 6);
      if (typeof window !== 'undefined') {
        window.map = map;
        window.__leafletMap = map;
        window.leafletMap = map;
      }
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' }).addTo(map);
      cluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        chunkedLoading: true,
        animate: false,
        animateAddingMarkers: false,
        spiderfyOnMaxZoom: true,
        iconCreateFunction: function (c) {
          const count = c.getChildCount();
          const size = count < 20 ? 'small' : count < 50 ? 'medium' : 'large';
          return new L.DivIcon({ html: `<div><span>${count}</span></div>`, className: `marker-cluster marker-cluster-${size}`, iconSize: new L.Point(40, 40) });
        }
      });
      map.addLayer(cluster);
      map.on('zoomstart movestart', () => { viewState.userAdjustedView = true; });
      if (!hoverMapEventsBound) {
        hoverMapEventsBound = true;
        const refreshHover = () => {
          if (hoverCard && hoverCard._map && hoverCard._sourceMarker) {
            updateHoverPlacement(hoverCard._sourceMarker);
          }
        };
        map.on('zoomstart', refreshHover);
        map.on('movestart', refreshHover);
        map.on('move', refreshHover);
        map.on('zoom', refreshHover);
        map.on('moveend', refreshHover);
        map.on('zoomend', refreshHover);
        map.on('resize', refreshHover);
        map.on('click', () => scheduleCloseHover(0));
      }
      requestAnimationFrame(() => map.invalidateSize());
      return map;
    }

    async function renderMap(options = {}) {
      const { force = false, invalidate = false, autoFit = false } = options;
      if (!map && !force && currentView !== 'map') return;
      const instance = await ensureMap();
      if (!instance || !cluster) return;
      cluster.clearLayers();
      markerIndex.clear();
      const list = getFiltered();
      list.forEach(a => {
        if (!Array.isArray(a.latlng) || a.latlng.length !== 2 || a.latlng.some(v => Number.isNaN(Number(v)))) return;
        const marker = L.marker(a.latlng, { title: a.title, keyboard: true });
        const hoverData = {
          id: a.id,
          title: a.title,
          city: a.city,
          price: a.price,
          imageUrl: buildOptimizedImage(a.img, 480, 70),
          category: a.cat || a.category,
          stats: { views: a.views ?? 0, likes: a.likes ?? 0 }
        };
        marker._item = hoverData;
        marker._itemData = a;
        markerIndex.set(String(a.id), marker);
        bindHoverCard(marker);
        cluster.addLayer(marker);
      });
      if (invalidate) instance.invalidateSize();
      if (list.length && (autoFit || !viewState.userAdjustedView)) {
        instance.fitBounds(L.latLngBounds(list.map(x => x.latlng)).pad(0.2));
      }
    }

    function bounceMarker(marker) {
      if (!marker) return;
      const el = marker.getElement?.();
      if (!el) return;
      if (prefersReducedMotion.matches) return;
      el.classList.remove('mm-bounce');
      void el.offsetWidth;
      el.classList.add('mm-bounce');
      setTimeout(() => el.classList.remove('mm-bounce'), 800);
    }

    function focusMarkerById(id, attempt = 0) {
      const marker = markerIndex.get(String(id));
      if (!marker) {
        if (attempt < 8) setTimeout(() => focusMarkerById(id, attempt + 1), 150);
        return;
      }
      if (!map || !cluster) {
        if (attempt < 8) setTimeout(() => focusMarkerById(id, attempt + 1), 120);
        return;
      }
      if (!marker.__parent && attempt < 8) {
        setTimeout(() => focusMarkerById(id, attempt + 1), 150);
        return;
      }
      const latlng = marker.getLatLng();
      if (!latlng) return;
      const mapHasBounds = typeof map.getBounds === 'function';
      const maxZoom = typeof map.getMaxZoom === 'function' ? map.getMaxZoom() : (map.options && typeof map.options.maxZoom === 'number' ? map.options.maxZoom : 18);
      const preferredZoom = Math.max(map.getZoom(), Math.min(16, maxZoom));
      const targetZoom = Math.min(maxZoom, preferredZoom);

      const revealMarker = () => {
        openHoverFor(marker);
        setTimeout(() => bounceMarker(marker), prefersReducedMotion.matches ? 0 : 120);
      };

      const needsPan = !mapHasBounds || !map.getBounds().pad(0.05).contains(latlng);
      const needsZoom = map.getZoom() < targetZoom;
      if (needsPan || needsZoom) {
        const finish = () => {
          map.off('moveend', finish);
          revealMarker();
        };
        map.once('moveend', finish);
        const animationOptions = { animate: !prefersReducedMotion.matches };
        if (typeof map.flyTo === 'function' && !prefersReducedMotion.matches) {
          map.flyTo(latlng, targetZoom, { duration: 0.6 });
        } else {
          map.setView(latlng, targetZoom, animationOptions);
        }
      } else {
        revealMarker();
      }
    }

    // ---------- VIEW SWITCHER (Liste / Carte) ----------
    const viewWrapper = document.getElementById('viewWrapper');
    const mapView = document.getElementById('mapView');
    const tabList = document.getElementById('tab-list');
    const tabMap = document.getElementById('tab-map');
    const mapEl = document.getElementById('map');
    const prefersReducedMotion = (typeof window !== 'undefined' && typeof window.matchMedia === 'function')
      ? window.matchMedia('(prefers-reduced-motion: reduce)')
      : { matches: false };
    let isTransitioning = false;

    if (listView) listView.setAttribute('aria-hidden', 'false');
    if (mapView) mapView.setAttribute('aria-hidden', 'true');

    function focusTab(tabEl) {
      if (!tabEl || typeof tabEl.focus !== 'function') return;
      tabEl.focus({ preventScroll: true });
    }

    function updateViewTabs(state) {
      const isMap = state === 'map';
      if (tabList) {
        tabList.classList.toggle('active', !isMap);
        tabList.setAttribute('aria-selected', String(!isMap));
      }
      if (tabMap) {
        tabMap.classList.toggle('active', isMap);
        tabMap.setAttribute('aria-selected', String(isMap));
      }
    }

    function updateAriaState(state) {
      const isMap = state === 'map';
      if (listView) listView.setAttribute('aria-hidden', String(isMap));
      if (mapView) mapView.setAttribute('aria-hidden', String(!isMap));
    }

    function setWrapperTargetHeight(targetEl) {
      if (!viewWrapper || !targetEl) return;
      const rect = targetEl.getBoundingClientRect();
      const scrollHeight = targetEl.scrollHeight || rect.height;
      const height = Math.max(Math.ceil(scrollHeight || 0), Math.ceil(rect.height || 0));
      if (height > 0) {
        viewWrapper.style.setProperty('--vw-target-h', `${height}px`);
      } else {
        viewWrapper.style.removeProperty('--vw-target-h');
      }
    }

    function finalizeTransition() {
      if (!viewWrapper) return;
      viewWrapper.classList.remove('is-animating');
      viewWrapper.style.removeProperty('--vw-target-h');
      isTransitioning = false;
      if (currentView === 'map') {
        renderMap({ force: true, invalidate: true, autoFit: !viewState.userAdjustedView });
        requestAnimationFrame(() => {
          if (map && typeof map.invalidateSize === 'function') {
            map.invalidateSize();
          }
        });
      }
    }

    function showMapView() {
      animateTo('map', { skipSameStateFocus: true });
    }

    function animateTo(state, opts = {}) {
      const targetState = state === 'map' ? 'map' : 'list';
      if (!viewWrapper || !listView || !mapView) return;
      if (targetState === currentView) {
        if (!opts.skipSameStateFocus) {
          focusTab(targetState === 'map' ? tabMap : tabList);
        }
        return;
      }
      if (isTransitioning && !prefersReducedMotion.matches) return;
      isTransitioning = !prefersReducedMotion.matches;
      setWrapperTargetHeight(targetState === 'map' ? mapView : listView);
      viewWrapper.classList.add('is-animating');
      viewWrapper.classList.toggle('show-map', targetState === 'map');
      viewWrapper.classList.toggle('show-list', targetState !== 'map');
      currentView = targetState;
      updateViewTabs(targetState);
      updateAriaState(targetState);
      if (targetState === 'map') {
        ensureMap().then((instance) => {
          renderMap({ force: true, invalidate: true, autoFit: !viewState.userAdjustedView });
          requestAnimationFrame(() => {
            if (instance && typeof instance.invalidateSize === 'function') {
              instance.invalidateSize();
            } else if (map && typeof map.invalidateSize === 'function') {
              map.invalidateSize();
            }
          });
        });
        if (!opts.skipSameStateFocus) focusTab(tabMap);
      } else {
        if (!opts.skipSameStateFocus) focusTab(tabList);
      }
      if (prefersReducedMotion.matches) {
        requestAnimationFrame(() => finalizeTransition());
      }
    }

    if (viewWrapper) {
      viewWrapper.classList.toggle('show-map', currentView === 'map');
      viewWrapper.classList.toggle('show-list', currentView !== 'map');
      viewWrapper.addEventListener('transitionend', (event) => {
        if (prefersReducedMotion.matches) return;
        if (event.propertyName !== 'transform') return;
        if (!event.target.classList.contains('view')) return;
        finalizeTransition();
      });
      viewWrapper.addEventListener('transitioncancel', () => {
        finalizeTransition();
      });
    }

    if (tabList) {
      tabList.addEventListener('click', () => animateTo('list'));
      tabList.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          animateTo('list');
        }
      });
    }
    if (tabMap) {
      tabMap.addEventListener('click', () => animateTo('map'));
      tabMap.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          animateTo('map');
        }
      });
    }

    updateViewTabs(currentView);
    updateAriaState(currentView);

    let mapObscureCount = 0;
    function obscureMap() {
      if (!mapEl) return;
      mapObscureCount = Math.max(0, mapObscureCount) + 1;
      mapEl.classList.add('is-obscured');
    }
    function restoreMap() {
      if (!mapEl) return;
      mapObscureCount = Math.max(0, mapObscureCount - 1);
      if (mapObscureCount === 0) {
        mapEl.classList.remove('is-obscured');
      }
    }

    (function () {
      const getMap = () => {
        if (typeof map !== 'undefined' && map) return map;
        if (typeof window !== 'undefined') {
          return window.map || window.__leafletMap || window.leafletMap || null;
        }
        return null;
      };

      const geo = {
        active: false,
        lat: null,
        lng: null,
        radiusKm: 10,
        marker: null,
        circle: null,
        radiusEnabled: true
      };
      const panel = document.getElementById('geoPanel');
      const btn = document.getElementById('geoLocateBtn');
      const caret = document.getElementById('geoCaretBtn');
      const dropdown = document.getElementById('geoDropdown');
      const radiusRow = document.getElementById('geoRadiusRow');
      const range = document.getElementById('geoRadius');
      const val = document.getElementById('geoRadiusVal');
      const toggle = document.getElementById('geoRadiusEnabled');
      const toast = document.getElementById('geoToast');
      let toastTimer = null;
      let toastHideTimer = null;

      if (!panel || !btn || !caret || !dropdown || !range || !toggle) return;

      if (typeof window !== 'undefined') {
        if (typeof window.getFiltered !== 'function' && typeof getFiltered === 'function') {
          window.getFiltered = (...args) => getFiltered(...args);
        }
        if (typeof window.renderList !== 'function' && typeof renderList === 'function') {
          window.renderList = (...args) => renderList(...args);
        }
        if (typeof window.renderMap !== 'function' && typeof renderMap === 'function') {
          window.renderMap = (...args) => renderMap(...args);
        }
      }

      function distKm(a, b) {
        const R = 6371;
        const toRad = (x) => x * Math.PI / 180;
        const dLat = toRad(b.lat - a.lat);
        const dLng = toRad(b.lng - a.lng);
        const sa = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) * Math.sin(dLng / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(sa));
      }

      function showGeoToast(message, duration = 1600) {
        if (!toast) return;
        if (toastTimer) {
          clearTimeout(toastTimer);
          toastTimer = null;
        }
        if (toastHideTimer) {
          clearTimeout(toastHideTimer);
          toastHideTimer = null;
        }
        toast.textContent = message;
        toast.hidden = false;
        toast.setAttribute('aria-hidden', 'false');
        btn.classList.remove('show-toast');
        // Force reflow to restart transition when message changes quickly
        void btn.offsetWidth;
        btn.classList.add('show-toast');
        toastTimer = window.setTimeout(() => {
          btn.classList.remove('show-toast');
          toastHideTimer = window.setTimeout(() => {
            toast.hidden = true;
            toast.setAttribute('aria-hidden', 'true');
            toastHideTimer = null;
          }, 200);
          toastTimer = null;
        }, duration);
      }

      function updateRadiusLabel() {
        if (val) {
          val.textContent = geo.radiusKm;
        }
      }

      function syncRangeDisabledState(enabled) {
        range.disabled = !enabled;
        if (radiusRow) {
          radiusRow.classList.toggle('is-disabled', !enabled);
        }
      }

      function removeCircle() {
        if (geo.circle && typeof geo.circle.remove === 'function') {
          geo.circle.remove();
        }
        geo.circle = null;
      }

      function upsertLayers(mapInstance) {
        if (!mapInstance || geo.lat == null || geo.lng == null) return;
        const latlng = [geo.lat, geo.lng];
        if (!geo.marker) {
          geo.marker = L.marker(latlng, {
            icon: L.divIcon({ className: 'geo-user', iconSize: [22, 22], iconAnchor: [11, 11] })
          }).addTo(mapInstance);
        } else {
          geo.marker.setLatLng(latlng);
        }
        if (geo.radiusEnabled) {
          const meters = geo.radiusKm * 1000;
          if (!geo.circle) {
            geo.circle = L.circle(latlng, { radius: meters, interactive: false, className: 'geo-radius' });
            geo.circle.addTo(mapInstance);
          } else {
            geo.circle.setLatLng(latlng).setRadius(meters);
            if (typeof mapInstance.hasLayer === 'function' && !mapInstance.hasLayer(geo.circle)) {
              geo.circle.addTo(mapInstance);
            }
          }
        } else {
          removeCircle();
        }
      }

      function fitToRadius(mapInstance) {
        if (!mapInstance || !geo.circle) return;
        mapInstance.flyToBounds(geo.circle.getBounds(), { duration: 0.8, padding: [30, 30] });
        if (typeof viewState === 'object' && viewState) {
          viewState.userAdjustedView = true;
        }
      }

      function focusOnUser(mapInstance) {
        if (!mapInstance || geo.lat == null || geo.lng == null) return;
        const zoom = typeof mapInstance.getZoom === 'function' ? mapInstance.getZoom() : 13;
        mapInstance.flyTo([geo.lat, geo.lng], zoom, { duration: 0.8 });
        if (typeof viewState === 'object' && viewState) {
          viewState.userAdjustedView = true;
        }
      }

      function rerenderAll() {
        if (typeof window.renderList === 'function') window.renderList(true);
        else if (typeof renderList === 'function') renderList(true);
        if (typeof window.renderMap === 'function') window.renderMap({ autoFit: false });
        else if (typeof renderMap === 'function') renderMap({ autoFit: false });
      }

      function applyRadius(options = {}) {
        if (!geo.active) return;
        const { reFit = true, mapInstance: providedMap } = options;
        const mapInstance = providedMap || getMap();
        if (!mapInstance) {
          rerenderAll();
          return;
        }
        upsertLayers(mapInstance);
        if (reFit) {
          if (geo.radiusEnabled) {
            fitToRadius(mapInstance);
          } else {
            focusOnUser(mapInstance);
          }
        }
        rerenderAll();
      }

      function setRadius(value, options = {}) {
        const next = Number(value);
        const clamped = Number.isFinite(next) ? Math.min(100, Math.max(1, next)) : geo.radiusKm;
        geo.radiusKm = clamped;
        if (!options.skipInputSync) {
          range.value = String(clamped);
        }
        updateRadiusLabel();
        if (!options.silent) {
          applyRadius({ reFit: options.reFit !== false });
        }
      }

      const setDropdown = (open) => {
        dropdown.hidden = !open;
        btn.setAttribute('aria-expanded', String(open));
        caret.setAttribute('aria-expanded', String(open));
      };

      const setCaretDisabled = (disabled) => {
        caret.setAttribute('aria-disabled', String(disabled));
        caret.setAttribute('data-disabled', disabled ? 'true' : 'false');
        caret.tabIndex = disabled ? -1 : 0;
      };

      const isCaretDisabled = () => caret.getAttribute('data-disabled') === 'true';

      caret.addEventListener('click', (event) => {
        if (isCaretDisabled()) return;
        event.preventDefault();
        event.stopPropagation();
        const willOpen = dropdown.hidden;
        setDropdown(willOpen);
      });

      caret.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          caret.click();
        }
      });

      document.addEventListener('click', (event) => {
        if (dropdown.hidden) return;
        if (!panel.contains(event.target)) {
          setDropdown(false);
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !dropdown.hidden) {
          setDropdown(false);
        }
      });

      range.addEventListener('input', () => {
        const value = Number(range.value);
        setRadius(value);
        if (toggle.checked && typeof window.mmSetRadius === 'function') {
          window.mmSetRadius(value);
        }
      });

      toggle.addEventListener('change', () => {
        const enabled = toggle.checked;
        geo.radiusEnabled = enabled;
        syncRangeDisabledState(enabled);
        applyRadius({ reFit: enabled });
        if (typeof window.mmEnableRadiusFilter === 'function') {
          window.mmEnableRadiusFilter(enabled);
        }
      });

      function resetButtonState() {
        btn.setAttribute('aria-busy', 'false');
        btn.disabled = false;
        setCaretDisabled(false);
      }

      async function startLocate() {
        if (btn.getAttribute('aria-busy') === 'true') return;
        setDropdown(false);
        btn.setAttribute('aria-busy', 'true');
        btn.disabled = true;
        setCaretDisabled(true);

        if (!('geolocation' in navigator)) {
          showGeoToast('G√©oloc indisponible');
          resetButtonState();
          return;
        }

        let mapInstance = getMap();
        if (!mapInstance && typeof ensureMap === 'function') {
          mapInstance = await ensureMap();
        }
        if (!mapInstance) {
          showGeoToast('Carte indisponible');
          resetButtonState();
          return;
        }

        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 });
          });
          const { latitude, longitude } = position.coords;
          geo.active = true;
          geo.lat = latitude;
          geo.lng = longitude;
          geo.radiusEnabled = toggle.checked;
          updateRadiusLabel();
          syncRangeDisabledState(geo.radiusEnabled);
          applyRadius({ reFit: true, mapInstance });
          if (typeof window.mmSetRadius === 'function') {
            window.mmSetRadius(geo.radiusKm);
          }
          if (typeof window.mmEnableRadiusFilter === 'function') {
            window.mmEnableRadiusFilter(geo.radiusEnabled);
          }
          if (typeof window.mmOnLocate === 'function') {
            window.mmOnLocate([latitude, longitude]);
          }
          showGeoToast('Position d√©tect√©e ‚úÖ');
          requestAnimationFrame(() => mapInstance.invalidateSize?.());
        } catch (error) {
          console.warn('Geolocation error', error);
          showGeoToast('Impossible d\'obtenir la position');
        } finally {
          resetButtonState();
        }
      }

      btn.addEventListener('click', (event) => {
        if (event.target instanceof Element && event.target.closest('#geoCaretBtn')) return;
        startLocate();
      });

      geo.radiusKm = Number(range.value) || geo.radiusKm;
      geo.radiusEnabled = toggle.checked;
      updateRadiusLabel();
      syncRangeDisabledState(geo.radiusEnabled);
      setDropdown(false);
      resetButtonState();

      window.mmFilterByRadius = function (items) {
        if (!geo.active || !geo.radiusEnabled || geo.lat == null || geo.lng == null) return items;
        const origin = { lat: geo.lat, lng: geo.lng };
        const radius = geo.radiusKm;
        return items.filter((item) => {
          const source = item.latlng || item.coords || (item.lat != null && item.lng != null ? { lat: item.lat, lng: item.lng } : null);
          if (!source) return false;
          const point = Array.isArray(source) ? { lat: source[0], lng: source[1] } : { lat: source.lat, lng: source.lng };
          return distKm(origin, point) <= radius;
        });
      };

      if (typeof window.getFiltered === 'function' && !window.__geoPatched) {
        const base = window.getFiltered;
        window.getFiltered = function (...args) {
          return window.mmFilterByRadius(base(...args));
        };
        window.__geoPatched = true;
      }
    })();

    // ---------- AUTH MODAL ----------
    const authModal = document.getElementById('authModal');
    const authDialog = document.getElementById('authDialog');
    const closeAuth = document.getElementById('closeAuth');
    const postBtn = document.getElementById('postBtn');
    const loginTab = document.getElementById('loginTab');
    const signupTab = document.getElementById('signupTab');
    const tabIndicator = document.getElementById('tabIndicator');
    const formContainer = document.getElementById('formContainer');
    const authFeedback = document.getElementById('authFeedback');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const forgotForm = document.getElementById('forgotForm');
    const heroTitle = document.getElementById('heroTitle');
    const heroSubtitle = document.getElementById('heroSubtitle');
    const heroIcon = document.getElementById('heroIcon');
    const forgotTrigger = document.getElementById('forgotTrigger');
    const backToLogin = document.getElementById('backToLogin');
    const passwordToggles = document.querySelectorAll('.password-toggle');
    const bottomNav = document.getElementById('bottomNav');
    const bottomNavButtons = bottomNav ? Array.from(bottomNav.querySelectorAll('.bn-btn')) : [];

    const API_BASE = window.API_BASE || window.location.origin;

    function buildApiUrl(path) {
      if (!path) return API_BASE;
      if (/^https?:\/\//i.test(path)) return path;
      const normalizedBase = API_BASE.endsWith('/') ? API_BASE.slice(0, -1) : API_BASE;
      const normalizedPath = path.startsWith('/') ? path : `/${path}`;
      return `${normalizedBase}${normalizedPath}`;
    }

    async function apiRequest(path, { method = 'GET', body, headers = {} } = {}) {
      const isFormData = body instanceof FormData;
      let response;
      try {
        response = await fetch(buildApiUrl(path), {
          method,
          credentials: 'include',
          headers: isFormData
            ? headers
            : {
                'Content-Type': 'application/json',
                ...headers
              },
          body: body ? (isFormData ? body : JSON.stringify(body)) : undefined
        });
      } catch (networkError) {
        const error = new Error('Serveur injoignable. V√©rifiez votre connexion.');
        error.code = 'NETWORK_ERROR';
        error.cause = networkError;
        throw error;
      }

      let payload = null;
      try {
        payload = await response.json();
      } catch {
        payload = null;
      }

      if (!response.ok) {
        const message = payload?.message || `Erreur HTTP ${response.status}`;
        const error = new Error(message);
        error.status = response.status;
        error.code = payload?.code || 'HTTP_ERROR';
        error.payload = payload;
        throw error;
      }

      return payload;
    }

    const api = {
      get: (path, options) => apiRequest(path, { ...(options || {}), method: 'GET' }),
      post: (path, body, options) => apiRequest(path, { ...(options || {}), method: 'POST', body }),
      patch: (path, body, options) => apiRequest(path, { ...(options || {}), method: 'PATCH', body }),
      del: (path, options) => apiRequest(path, { ...(options || {}), method: 'DELETE' })
    };

    function setAuthFeedback(message = '', type = 'info') {
      if (!authFeedback) return;
      authFeedback.textContent = '';
      authFeedback.removeAttribute('data-type');
      authFeedback.classList.remove('is-visible');
      if (!message) {
        scheduleAuthMeasure();
        return;
      }
      const icon = document.createElement('span');
      icon.className = 'auth-feedback-icon';
      icon.setAttribute('aria-hidden', 'true');
      const iconMap = {
        success: '‚úì',
        error: '‚ö†',
        info: '‚Ñπ'
      };
      icon.textContent = iconMap[type] || iconMap.info;
      const text = document.createElement('span');
      text.className = 'auth-feedback-message';
      text.textContent = message;
      authFeedback.append(icon, text);
      authFeedback.dataset.type = type;
      authFeedback.classList.add('is-visible');
      authFeedback.classList.remove('auth-feedback-pop');
      void authFeedback.offsetWidth;
      authFeedback.classList.add('auth-feedback-pop');
      authFeedback.addEventListener('animationend', () => authFeedback.classList.remove('auth-feedback-pop'), { once: true });
      scheduleAuthMeasure();
    }

    function clearAuthFeedback() {
      if (!authFeedback) return;
      authFeedback.textContent = '';
      authFeedback.removeAttribute('data-type');
      authFeedback.classList.remove('is-visible');
      scheduleAuthMeasure();
    }

    function extractAuthErrorMessage(error) {
      if (!error) return 'Une erreur est survenue.';
      if (error.payload?.message) return error.payload.message;
      if (error.message) return error.message;
      return 'Une erreur est survenue.';
    }

    function updateBottomNavState() {
      if (!bottomNavButtons.length) return;
      const isMapActive = !!(viewWrapper && viewWrapper.classList.contains('show-map'));
      const favPanelOpen = typeof isFavModalOpen === 'function' ? isFavModalOpen() : false;
      bottomNavButtons.forEach((btn) => {
        const action = btn.dataset.action;
        let pressed = false;
        if (action === 'home') pressed = !isMapActive;
        else if (action === 'favs') pressed = favPanelOpen;
        btn.setAttribute('aria-pressed', String(pressed));
        btn.classList.toggle('is-active', pressed);
      });
    }

    if (bottomNav) {
      bottomNav.addEventListener('click', (event) => {
        const button = event.target.closest('button');
        if (!button || !bottomNav.contains(button)) return;
        const action = button.dataset.action;
        switch (action) {
          case 'home':
            animateTo('list');
            window.scrollTo({ top: 0, behavior: prefersReducedMotion.matches ? 'auto' : 'smooth' });
            break;
          case 'messages':
            if (navMessages) navMessages.click();
            break;
          case 'publish':
            if (postBtn) postBtn.click();
            break;
          case 'favs':
            if (openFavsBtn) openFavsBtn.click();
            break;
          case 'profile': {
            const avatarBtn = document.querySelector('#avatar button');
            if (avatarBtn) avatarBtn.click();
            break;
          }
          default:
            break;
        }
        requestAnimationFrame(updateBottomNavState);
      });
    }

    const bottomNavObserver = viewWrapper && typeof MutationObserver !== 'undefined'
      ? new MutationObserver(updateBottomNavState)
      : null;
    if (bottomNavObserver) {
      bottomNavObserver.observe(viewWrapper, { attributes: true, attributeFilter: ['class'] });
    }

    updateBottomNavState();

    const AUTH_FOCUSABLE_SELECTOR = 'a[href], area[href], input:not([disabled]):not([type="hidden"]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, [tabindex]:not([tabindex="-1"]), [contenteditable="true"]';
    let authLastFocus = null;
    let authTrapActive = false;

    function getAuthFocusableElements() {
      if (!authDialog) return [];
      const candidates = Array.from(authDialog.querySelectorAll(AUTH_FOCUSABLE_SELECTOR));
      return candidates.filter(el => {
        if (el.closest('[aria-hidden="true"]')) return false;
        if (el.hasAttribute('disabled')) return false;
        const rect = el.getBoundingClientRect();
        return rect.width > 0 || rect.height > 0;
      });
    }

    function handleAuthKeydown(event) {
      if (!authTrapActive || event.key !== 'Tab') return;
      const focusables = getAuthFocusableElements();
      if (!focusables.length) return;
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      const active = document.activeElement;
      if (event.shiftKey) {
        if (active === first || !authDialog.contains(active)) {
          event.preventDefault();
          last.focus();
        }
      } else {
        if (active === last) {
          event.preventDefault();
          first.focus();
        }
      }
    }

    function handleAuthFocusIn(event) {
      if (!authTrapActive || !authDialog || !authModal?.classList.contains('active')) return;
      if (!authDialog.contains(event.target)) {
        const focusables = getAuthFocusableElements();
        if (focusables.length) focusables[0].focus();
      }
    }

    function activateAuthFocusTrap() {
      if (authTrapActive || !authDialog) return;
      authTrapActive = true;
      document.addEventListener('keydown', handleAuthKeydown, true);
      document.addEventListener('focusin', handleAuthFocusIn);
    }

    function deactivateAuthFocusTrap() {
      if (!authTrapActive) return;
      document.removeEventListener('keydown', handleAuthKeydown, true);
      document.removeEventListener('focusin', handleAuthFocusIn);
      authTrapActive = false;
    }

    const forms = { login: loginForm, signup: signupForm, forgot: forgotForm };
    let currentTab = 'login';

    const heroCopy = {
      login: { title: 'Bienvenue !', subtitle: "Acc√©dez √† vos messages, favoris et alertes personnalis√©es", icon: 'üìç' },
      signup: { title: 'Rejoignez-nous !', subtitle: 'Cr√©ez votre compte et d√©couvrez toutes les fonctionnalit√©s', icon: 'üöÄ' },
      forgot: { title: 'Mot de passe oubli√© ?', subtitle: 'Pas de souci, nous allons vous aider √† r√©cup√©rer votre compte', icon: 'üîë' }
    };

    const avatarIcons = {
      auth: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>`,
      profile: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`
    };

    function updateUserMenuIdentity(auth) {
      const nameEl = document.getElementById('userMenuName');
      const emailEl = document.getElementById('userMenuEmail');
      const avatarImgs = document.querySelectorAll('.user-menu__avatar, #userMenuButton .avatar-img');
      if (nameEl) nameEl.textContent = auth?.name || 'Utilisateur';
      if (emailEl) emailEl.textContent = auth?.email || '';
      const avatarSrc = auth?.avatar || '';
      if (avatarSrc) {
        avatarImgs.forEach((img) => {
          if (img) img.src = avatarSrc;
        });
      } else {
        avatarImgs.forEach((img) => {
          if (img) img.src = '/uploads/avatars/default.jpg';
        });
      }
    }

    function initUserMenu(auth) {
      const button = document.getElementById('userMenuButton');
      const menu = document.getElementById('userMenu');
      if (!button || !menu) return;

      menu.dataset.open = 'false';
      menu.hidden = true;
      button.setAttribute('aria-expanded', 'false');

      if (auth) {
        updateUserMenuIdentity(auth);
      }

      let isOpen = false;

      const handleDocumentClick = (event) => {
        if (menu.contains(event.target) || button.contains(event.target)) return;
        closeMenu();
      };

      const handleKeydown = (event) => {
        if (!isOpen) return;
        const activeElement = document.activeElement;
        const items = getMenuItems();
        switch (event.key) {
          case 'Escape':
            event.preventDefault();
            closeMenu({ restoreFocus: true });
            break;
          case 'ArrowDown':
            event.preventDefault();
            focusNextItem(activeElement, 1);
            break;
          case 'ArrowUp':
            event.preventDefault();
            focusNextItem(activeElement, -1);
            break;
          case 'Home':
            event.preventDefault();
            focusFirstItem();
            break;
          case 'End':
            event.preventDefault();
            focusLastItem();
            break;
          case 'Enter':
          case ' ':
            if (items.includes(activeElement)) {
              event.preventDefault();
              handleMenuAction(activeElement.dataset.action);
            }
            break;
          default:
            break;
        }
      };

      function openMenu() {
        if (isOpen) return;
        isOpen = true;
        menu.hidden = false;
        requestAnimationFrame(() => {
          menu.dataset.open = 'true';
        });
        button.setAttribute('aria-expanded', 'true');
        document.addEventListener('click', handleDocumentClick, { capture: true });
        document.addEventListener('keydown', handleKeydown);
        focusFirstItem();
      }

      function closeMenu({ restoreFocus = false } = {}) {
        if (!isOpen) return;
        isOpen = false;
        menu.dataset.open = 'false';
        button.setAttribute('aria-expanded', 'false');
        setTimeout(() => {
          if (!isOpen) {
            menu.hidden = true;
          }
        }, 180);
        document.removeEventListener('click', handleDocumentClick, { capture: true });
        document.removeEventListener('keydown', handleKeydown);
        if (restoreFocus) button.focus();
      }

      function getMenuItems() {
        return Array.from(menu.querySelectorAll('[role="menuitem"]'));
      }

      function focusFirstItem() {
        const items = getMenuItems();
        if (items.length) items[0].focus({ preventScroll: true });
      }

      function focusLastItem() {
        const items = getMenuItems();
        if (items.length) items[items.length - 1].focus({ preventScroll: true });
      }

      function focusNextItem(current, direction = 1) {
        const items = getMenuItems();
        if (!items.length) return;
        const currentIndex = items.indexOf(current);
        const nextIndex = currentIndex === -1 ? 0 : (currentIndex + direction + items.length) % items.length;
        items[nextIndex].focus({ preventScroll: true });
      }

      async function performLogout() {
        try {
          await api.post('/api/auth/logout');
        } catch (error) {
          console.error('Logout error', error);
        } finally {
          authStore.set(null);
          updateAuthUI();
          favStore.clear();
          updateFavBadge();
          syncAllFavoriteButtons();
          if (isFavModalOpen()) renderFavSheet();
          setAuthFeedback('D√©connect√©', 'info');
          if (typeof showToast === 'function') showToast('D√©connect√©');
        }
        closeMenu({ restoreFocus: true });
      }

      function handleMenuAction(action) {
        if (!action) return;
        switch (action) {
          case 'logout':
            performLogout();
            break;
          case 'profile':
            closeMenu({ restoreFocus: true });
            if (typeof showToast === 'function') showToast('Section profil en pr√©paration ‚ú®');
            break;
          default:
            break;
        }
      }

      function toggleMenu(event) {
        if (event) event.preventDefault();
        if (isOpen) closeMenu();
        else openMenu();
      }

      if (button.__menuToggleHandler) {
        button.removeEventListener('click', button.__menuToggleHandler);
      }
      button.__menuToggleHandler = toggleMenu;
      button.addEventListener('click', button.__menuToggleHandler);

      if (button.__menuKeyHandler) {
        button.removeEventListener('keydown', button.__menuKeyHandler);
      }
      button.__menuKeyHandler = (event) => {
        if (event.key === 'ArrowDown' || event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          openMenu();
        }
      };
      button.addEventListener('keydown', button.__menuKeyHandler);

      if (menu.__handlerClick) {
        menu.removeEventListener('click', menu.__handlerClick);
      }
      menu.__handlerClick = (event) => {
        const item = event.target.closest('[data-action]');
        if (!item) return;
        handleMenuAction(item.dataset.action);
      };
      menu.addEventListener('click', menu.__handlerClick);

      button.__closeUserMenu = closeMenu;
    }

    function renderAvatar(auth) {
      const avatar = document.getElementById('avatar');
      const userMenu = document.getElementById('userMenu');
      if (!avatar) return;
      avatar.innerHTML = '';
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'avatar-btn';

      if (auth) {
        button.id = 'userMenuButton';
        button.setAttribute('aria-haspopup', 'menu');
        button.setAttribute('aria-expanded', 'false');
        button.setAttribute('aria-controls', 'userMenu');
        button.classList.add('is-auth');
        button.setAttribute('title', auth.name || auth.email || 'Profil connect√©');
        button.setAttribute('aria-label', auth.name ? `Menu de ${auth.name}` : 'Menu utilisateur connect√©');
        const avatarSrc = auth.avatar || '';
        if (avatarSrc) {
          const img = document.createElement('img');
          img.className = 'avatar-img';
          img.src = avatarSrc;
          img.alt = auth.name || auth.email || 'Avatar';
          button.appendChild(img);
        } else {
          const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          icon.setAttribute('viewBox', '0 0 24 24');
          icon.setAttribute('aria-hidden', 'true');
          icon.classList.add('avatar-icon');
          icon.innerHTML = '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>';
          button.appendChild(icon);
        }
        const chevron = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        chevron.setAttribute('viewBox', '0 0 24 24');
        chevron.setAttribute('aria-hidden', 'true');
        chevron.classList.add('chevron');
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M7 10l5 5 5-5');
        chevron.appendChild(path);
        button.appendChild(chevron);
        avatar.title = auth.name || auth.email || 'Compte connect√©';
        avatar.appendChild(button);
        initUserMenu(auth);
      } else {
        button.classList.add('needs-auth');
        button.setAttribute('aria-label', 'Se connecter ou cr√©er un compte');
        button.innerHTML = avatarIcons.auth;
        avatar.title = 'Se connecter ou cr√©er un compte';
        button.addEventListener('click', () => openAuth());
        avatar.appendChild(button);
        if (userMenu) {
          userMenu.dataset.open = 'false';
          userMenu.hidden = true;
        }
      }
    }

    let authMeasureRaf = null;

    function scheduleAuthMeasure() {
      if (authMeasureRaf) cancelAnimationFrame(authMeasureRaf);
      authMeasureRaf = requestAnimationFrame(() => {
        authMeasureRaf = null;
        measureAuthHeight();
      });
    }

    function measureAuthHeight() {
      if (!formContainer) return;
      const formsList = Array.from(formContainer.querySelectorAll('.auth-form'));
      if (!formsList.length) return;
      const previousHeight = formContainer.style.height;
      formContainer.style.height = 'auto';
      let maxHeight = formContainer.scrollHeight;
      formsList.forEach(form => {
        const wasActive = form.classList.contains('active');
        const prevStyles = {
          visibility: form.style.visibility,
          display: form.style.display,
          position: form.style.position,
          transform: form.style.transform
        };
        if (!wasActive) {
          form.style.visibility = 'hidden';
          form.style.display = 'flex';
          form.style.position = 'static';
          form.style.transform = 'none';
        }
        const formHeight = form.scrollHeight;
        if (formHeight > maxHeight) maxHeight = formHeight;
        if (!wasActive) {
          form.style.visibility = prevStyles.visibility;
          form.style.display = prevStyles.display;
          form.style.position = prevStyles.position;
          form.style.transform = prevStyles.transform;
        }
      });
      if (maxHeight) formContainer.style.height = `${Math.ceil(maxHeight)}px`;
      else formContainer.style.height = previousHeight;
    }

    scheduleAuthMeasure();
    window.addEventListener('resize', scheduleAuthMeasure);

    function openAuth(focusId = 'loginEmail') {
      switchTab('login', { instant: true, force: true, resetSuccess: true });
      clearFeedback();
      if (!authModal) return;
      authLastFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
      authModal.classList.add('active');
      authModal.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
      obscureMap();
      activateAuthFocusTrap();
      setTimeout(() => {
        const target = document.getElementById(focusId) || getAuthFocusableElements()[0] || null;
        if (target) target.focus();
      }, 220);
    }

    function closeAuthFn() {
      if (!authModal) return;
      authModal.classList.remove('active');
      authModal.setAttribute('aria-hidden', 'true');
      deactivateAuthFocusTrap();
      restoreMap();
      unlockBodyScroll();
      if (authLastFocus && typeof authLastFocus.focus === 'function' && authLastFocus.isConnected !== false) {
        setTimeout(() => {
          authLastFocus.focus();
          authLastFocus = null;
        }, 0);
      } else {
        authLastFocus = null;
      }
      setTimeout(() => {
        resetAuthForms();
      }, 360);
    }

    function resetAuthForms() {
      [loginForm, signupForm, forgotForm].forEach(form => form.reset());
      clearFeedback();
      Object.values(forms).forEach(form => form.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right'));
      loginForm.classList.add('active');
      currentTab = 'login';
      updateTabUI('login');
      updateHeroContent('login');
      scheduleAuthMeasure();
    }

    function clearFieldErrors() {
      formContainer.querySelectorAll('.form-error').forEach(el => el.remove());
      formContainer.querySelectorAll('.auth-input').forEach(inp => inp.classList.remove('error'));
      scheduleAuthMeasure();
    }

    function clearSuccessMessage() {
      clearAuthFeedback();
    }

    function clearFeedback() {
      clearFieldErrors();
      clearSuccessMessage();
    }

    function switchTab(tab, options = {}) {
      const targetForm = forms[tab];
      if (!targetForm) return;
      if (!options.force && tab === currentTab) return;

      const prevForm = forms[currentTab];
      clearFieldErrors();
      if (options.resetSuccess) clearSuccessMessage();

      updateTabUI(tab);
      updateHeroContent(tab);

      if (options.instant || !prevForm || prevForm === targetForm) {
        Object.values(forms).forEach(form => form.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right'));
        targetForm.classList.add('active');
        currentTab = tab;
        scheduleAuthMeasure();
        return;
      }

      const { out: outClass, in: inClass } = getSlideDirection(currentTab, tab);
      prevForm.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
      targetForm.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');

      prevForm.classList.add(outClass);
      setTimeout(() => {
        prevForm.classList.remove('active', outClass);
        targetForm.classList.add('active', inClass);
        requestAnimationFrame(() => targetForm.classList.remove(inClass));
        scheduleAuthMeasure();
      }, 200);

      currentTab = tab;
      scheduleAuthMeasure();
    }

    function updateTabUI(tab) {
      loginTab.classList.toggle('active', tab === 'login');
      signupTab.classList.toggle('active', tab === 'signup');
      if (tab === 'signup') {
        tabIndicator.classList.add('signup');
        tabIndicator.classList.remove('hidden');
      } else if (tab === 'login') {
        tabIndicator.classList.remove('signup', 'hidden');
      } else {
        tabIndicator.classList.add('hidden');
        tabIndicator.classList.remove('signup');
      }
    }

    function updateHeroContent(tab) {
      const copy = heroCopy[tab] || heroCopy.login;
      heroTitle.textContent = copy.title;
      heroSubtitle.textContent = copy.subtitle;
      heroIcon.textContent = copy.icon;
    }

    function getSlideDirection(from, to) {
      const order = ['login', 'signup', 'forgot'];
      const fromIndex = order.indexOf(from);
      const toIndex = order.indexOf(to);
      if (fromIndex === -1 || toIndex === -1) {
        return { out: 'slide-out-left', in: 'slide-in-right' };
      }
      return toIndex > fromIndex ? { out: 'slide-out-left', in: 'slide-in-right' } : { out: 'slide-out-right', in: 'slide-in-left' };
    }

    function validateForm(form) {
      let valid = true;
      const signupPassword = document.getElementById('signupPassword');
      form.querySelectorAll('.auth-input').forEach(input => {
        const value = input.value.trim();
        if (input.hasAttribute('required') && !value) {
          showFieldError(input, 'Ce champ est requis');
          valid = false;
          return;
        }
        if (input.type === 'email' && value && !isValidEmail(value)) {
          showFieldError(input, 'Adresse email invalide');
          valid = false;
          return;
        }
        if (input.id === 'signupPassword' && value && value.length < 8) {
          showFieldError(input, 'Minimum 8 caract√®res');
          valid = false;
        }
      });
      return valid;
    }

    function showFieldError(input, message) {
      const wrapper = input.closest('.auth-input-wrapper');
      if (!wrapper) return;
      const error = document.createElement('div');
      error.className = 'form-error';
      error.textContent = message;
      input.classList.add('error');
      wrapper.appendChild(error);
      scheduleAuthMeasure();
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function setLoading(button, isLoading) {
      if (!button) return;
      if (!button.dataset.label) button.dataset.label = button.textContent.trim();
      if (isLoading) {
        button.classList.add('loading');
        button.textContent = '';
      } else {
        button.classList.remove('loading');
        button.textContent = button.dataset.label || 'Continuer';
      }
    }

    function showSuccess(message) {
      setAuthFeedback(message, 'success');
    }

    function togglePassword(id) {
      const input = document.getElementById(id);
      if (!input) return;
      input.type = input.type === 'password' ? 'text' : 'password';
      const toggle = Array.from(passwordToggles).find(btn => btn.dataset.target === id);
      if (toggle) toggle.textContent = input.type === 'password' ? 'üëÅ' : 'üôà';
    }

    loginTab.addEventListener('click', () => switchTab('login', { force: true, resetSuccess: true }));
    signupTab.addEventListener('click', () => switchTab('signup', { force: true, resetSuccess: true }));

    if (forgotTrigger) {
      forgotTrigger.addEventListener('click', () => {
        switchTab('forgot', { force: true, resetSuccess: true });
        setTimeout(() => {
          const forgotInput = document.getElementById('forgotEmail');
          if (forgotInput) forgotInput.focus();
        }, 220);
      });
    }

    if (backToLogin) {
      backToLogin.addEventListener('click', () => {
        switchTab('login', { force: true, resetSuccess: true });
        setTimeout(() => {
          const loginInput = document.getElementById('loginEmail');
          if (loginInput) loginInput.focus();
        }, 220);
      });
    }

    passwordToggles.forEach(btn => btn.addEventListener('click', () => togglePassword(btn.dataset.target)));

    closeAuth.addEventListener('click', closeAuthFn);
    authModal.addEventListener('click', (e) => { if (e.target === authModal) closeAuthFn(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && authModal.classList.contains('active')) closeAuthFn(); });

    loginForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      clearFieldErrors();
      clearAuthFeedback();
      if (!validateForm(loginForm)) return;
      const button = document.getElementById('loginSubmit');
      setLoading(button, true);
      try {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const response = await api.post('/api/auth/login', { email, password });
        const user = response?.data?.user || null;
        if (user) {
          authStore.set(user);
          applyFavoritesFromUser(user);
        } else {
          authStore.set(null);
          favStore.clear();
          updateFavBadge();
          syncAllFavoriteButtons();
          if (isFavModalOpen()) renderFavSheet();
        }
        updateAuthUI();
        const firstName = user?.name ? user.name.trim().split(/\s+/)[0] : '';
      const successMessage = firstName ? `Bienvenue ${firstName} ! Vous √™tes maintenant connect√©.` : 'Connexion r√©ussie ! Vous √™tes maintenant connect√©.';
      setAuthFeedback(successMessage, 'success');
        showToast('Connexion r√©ussie');
        setTimeout(() => closeAuthFn(), 1200);
      } catch (error) {
        setAuthFeedback(extractAuthErrorMessage(error), 'error');
      } finally {
        setLoading(button, false);
      }
    });

    signupForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      clearFieldErrors();
      clearAuthFeedback();
      if (!validateForm(signupForm)) return;
      const button = document.getElementById('signupSubmit');
      setLoading(button, true);
      try {
        const name = document.getElementById('signupName').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const password = document.getElementById('signupPassword').value;
        const response = await api.post('/api/auth/signup', { name, email, password });
        const user = response?.data?.user || null;
        if (user) {
          authStore.set(user);
          applyFavoritesFromUser(user);
        } else {
          authStore.set(null);
          favStore.clear();
          updateFavBadge();
          syncAllFavoriteButtons();
          if (isFavModalOpen()) renderFavSheet();
        }
        updateAuthUI();
        setAuthFeedback(response?.message || 'Compte cr√©√©. Bienvenue üëã', 'success');
        showToast('Compte cr√©√© et connect√©');
        switchTab('login', { force: true, resetSuccess: false, instant: true });
        setTimeout(() => {
          const loginInput = document.getElementById('loginEmail');
          if (loginInput) loginInput.focus();
        }, 220);
        setTimeout(() => closeAuthFn(), 1400);
      } catch (error) {
        setAuthFeedback(extractAuthErrorMessage(error), 'error');
      } finally {
        setLoading(button, false);
      }
    });

    forgotForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      clearFieldErrors();
      clearAuthFeedback();
      if (!validateForm(forgotForm)) return;
      const button = document.getElementById('forgotSubmit');
      setLoading(button, true);
      try {
        const email = document.getElementById('forgotEmail').value.trim();
        const response = await api.post('/api/auth/forgot-password', { email });
        setAuthFeedback(response?.message || 'Si un compte existe, un lien a √©t√© envoy√©.', 'success');
        showToast('Email de r√©initialisation envoy√©');
        switchTab('login', { force: true, resetSuccess: false, instant: false });
        setTimeout(() => {
          const loginInput = document.getElementById('loginEmail');
          if (loginInput) loginInput.focus();
        }, 360);
      } catch (error) {
        setAuthFeedback(extractAuthErrorMessage(error), 'error');
      } finally {
        setLoading(button, false);
      }
    });

    function updateAuthUI() {
      const auth = authStore.get();
      renderAvatar(auth);
    }

    async function hydrateAuthFromSession() {
      try {
        const response = await api.get('/api/auth/me');
        const user = response?.data?.user || null;
        if (user) {
          authStore.set(user);
          applyFavoritesFromUser(user);
        } else {
          authStore.set(null);
          favStore.clear();
          updateFavBadge();
          syncAllFavoriteButtons();
          if (isFavModalOpen()) renderFavSheet();
        }
      } catch (error) {
        authStore.set(null);
        favStore.clear();
        updateFavBadge();
        syncAllFavoriteButtons();
        if (isFavModalOpen()) renderFavSheet();
        if (error?.status && error.status !== 401) {
          console.warn('Synchronisation auth √©chou√©e', error);
        }
      } finally {
        updateAuthUI();
      }
    }

    // ---------- POST MODAL ----------
    const postModal = document.getElementById('postModal');
    const postDialog = document.getElementById('postDialog');
    const postForm = document.getElementById('postForm');
    const postTitleInput = document.getElementById('postTitleInput');
    const postCategory = document.getElementById('postCategory');
    const postCondition = document.getElementById('postCondition');
    const postPrice = document.getElementById('postPrice');
    const postPhotosInput = document.getElementById('postPhotos');
    const postPhotosList = document.getElementById('postPhotosList');
    const postAttributes = document.getElementById('postAttributes');
    const postAddress = document.getElementById('postAddress');
    const postLat = document.getElementById('postLat');
    const postLng = document.getElementById('postLng');
    const postDescription = document.getElementById('postDescription');
    const postDescriptionCount = document.getElementById('postDescriptionCount');
    const postUseLocation = document.getElementById('postUseLocation');
    const postStatus = document.getElementById('postStatus');
    const postCancel = document.getElementById('postCancel');
    const postSubmit = document.getElementById('postSubmit');
    const postPreview = document.getElementById('postPreview');
    const postSaveDraft = document.getElementById('postSaveDraft');
    const postDraftBanner = document.getElementById('postDraftBanner');
    const postDraftResume = document.getElementById('postDraftResume');
    const postDraftDiscard = document.getElementById('postDraftDiscard');
    const closePostBtn = document.getElementById('closePost');
    const postUploader = document.getElementById('postUploader');

    populateCategorySelect(cat, { placeholderLabel: 'Toutes cat√©gories', placeholderValue: '' });
    populateCategorySelect(postCategory, { placeholderLabel: 'S√©lectionnez', placeholderValue: '' });

    const DRAFT_STORAGE_KEY = 'mm-new-ad-draft-v1';
    const MAX_IMAGES = 10;
    const MAX_IMAGE_SIZE = 8 * 1024 * 1024;

    const categoryDefinitions = {
      auto: {
        fields: [
          { id: 'year', label: 'Ann√©e', type: 'number', min: 1980, max: new Date().getFullYear(), required: true },
          { id: 'mileage', label: 'Kilom√©trage', type: 'number', min: 0, max: 500000, required: true },
          { id: 'fuel', label: 'Carburant', type: 'select', options: ['essence', 'diesel', 'hybride', 'electrique', 'gpl'], required: true },
          { id: 'gearbox', label: 'Bo√Æte de vitesses', type: 'select', options: ['manuelle', 'automatique'], required: true }
        ]
      },
      immobilier: {
        fields: [
          { id: 'surface', label: 'Surface (m¬≤)', type: 'number', min: 5, max: 1000, required: true },
          { id: 'rooms', label: 'Nombre de pi√®ces', type: 'number', min: 1, max: 20, required: true },
          { id: 'dpe', label: 'DPE', type: 'select', options: ['A', 'B', 'C', 'D', 'E', 'F', 'G'], required: true },
          { id: 'furnished', label: 'Meubl√©', type: 'boolean', required: false },
          { id: 'floor', label: '√âtage', type: 'number', min: 0, max: 50, required: false }
        ]
      },
      electroniques: {
        fields: [
          { id: 'storage', label: 'Stockage (Go)', type: 'number', min: 1, max: 4096, required: true },
          { id: 'brand', label: 'Marque', type: 'text', required: true },
          { id: 'grade', label: 'Grade', type: 'select', options: ['neuf', 'comme neuf', 'tr√®s bon', 'bon', 'correct'], required: true }
        ]
      },
      pieces: {
        fields: [
          { id: 'compatible', label: 'Compatible avec', type: 'text', required: true },
          { id: 'grade', label: '√âtat', type: 'select', options: ['neuf', 'comme neuf', 'tr√®s bon', 'bon', 'correct'], required: true },
          { id: 'reference', label: 'R√©f√©rence', type: 'text', required: false }
        ]
      },
      mode: {
        fields: [
          { id: 'gender', label: 'Genre', type: 'select', options: ['femme', 'homme', 'enfant', 'mixte'], required: true },
          { id: 'size', label: 'Taille', type: 'select', options: ['XS', 'S', 'M', 'L', 'XL', 'XXL'], required: false },
          { id: 'brand', label: 'Marque', type: 'text', required: false }
        ]
      },
      loisirs: {
        fields: [
          { id: 'activity', label: 'Activit√©', type: 'select', options: ['v√©lo', 'trottinette', 'plein air', 'sport', 'autre'], required: false },
          { id: 'brand', label: 'Marque', type: 'text', required: false },
          { id: 'model', label: 'Mod√®le', type: 'text', required: false }
        ]
      }
    };

    let postPhotos = [];
    let postMapInstance = null;
    let postMapMarker = null;
    let postDraftLoaded = false;
    let postDraftTimer = null;
    let postIsSubmitting = false;

    function setPostModalHidden(hidden) {
      if (!postModal) return;
      postModal.setAttribute('aria-hidden', hidden ? 'true' : 'false');
      document.body.classList.toggle('modal-open', !hidden);
      if (hidden) {
        unlockBodyScroll();
      } else {
        lockBodyScroll();
      }
    }

    function openPostModal() {
      const auth = authStore.get();
      if (!auth) {
        showToast('Connectez-vous pour d√©poser une annonce üîê');
        openAuth();
        return;
      }
      rebuildAllItemsIndex();
      setPostModalHidden(false);
      postForm.reset();
      clearAllFieldErrors(postForm);
      postPhotos = [];
      renderPhotoList();
      postStatus.textContent = '';
      postDraftLoaded = false;
      postDraftBanner.hidden = true;
      initPostMap();
      buildAttributesForm(postCategory.value);
      const draft = loadDraft();
      if (draft) {
        postDraftBanner.hidden = false;
      }
      postTitleInput.focus({ preventScroll: true });
      updateDescriptionCount();
    }

    function closePostModal({ reset = false } = {}) {
      setPostModalHidden(true);
      if (reset) {
        postForm.reset();
        postPhotos = [];
        renderPhotoList();
        postStatus.textContent = '';
      }
    }

    function clearAllFieldErrors(scope) {
      scope.querySelectorAll('.field-error').forEach((el) => (el.textContent = ''));
      scope.querySelectorAll('[aria-invalid="true"]').forEach((el) => el.removeAttribute('aria-invalid'));
    }

    function setFieldError(id, message) {
      const field = typeof id === 'string' ? document.getElementById(id) : id;
      if (!field) return;
      const errorEl = postForm.querySelector(`.field-error[data-error-for="${field.id}"]`);
      if (errorEl) errorEl.textContent = message || '';
      if (message) field.setAttribute('aria-invalid', 'true');
      else field.removeAttribute('aria-invalid');
    }

    function renderPhotoList() {
      if (!postPhotosList) return;
      postPhotosList.innerHTML = '';
      if (!postPhotos.length) return;
      postPhotos.forEach((entry, index) => {
        const item = document.createElement('div');
        item.className = 'uploader-item';
        item.draggable = true;
        item.dataset.index = String(index);
        item.innerHTML = `
          <img src="${entry.preview}" alt="Photo ${index + 1}">
          <button type="button" class="uploader-remove" data-index="${index}" aria-label="Supprimer la photo">‚úï</button>
        `;
        item.addEventListener('dragstart', handlePhotoDragStart);
        item.addEventListener('dragover', handlePhotoDragOver);
        item.addEventListener('drop', handlePhotoDrop);
        postPhotosList.appendChild(item);
      });
    }

    let dragPhotoIndex = null;
    function handlePhotoDragStart(event) {
      dragPhotoIndex = Number(event.currentTarget.dataset.index);
      event.dataTransfer.effectAllowed = 'move';
    }

    function handlePhotoDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
    }

    function handlePhotoDrop(event) {
      event.preventDefault();
      const targetIndex = Number(event.currentTarget.dataset.index);
      if (Number.isNaN(dragPhotoIndex) || Number.isNaN(targetIndex) || dragPhotoIndex === targetIndex) return;
      const reordered = [...postPhotos];
      const [moved] = reordered.splice(dragPhotoIndex, 1);
      reordered.splice(targetIndex, 0, moved);
      postPhotos = reordered;
      renderPhotoList();
      queueDraftSave();
    }

    function buildAttributesForm(category) {
      if (!postAttributes) return;
      postAttributes.innerHTML = '';
      const def = categoryDefinitions[category];
      if (!def) return;
      def.fields.forEach((field) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'field';
        wrapper.dataset.attribute = field.id;
        const label = document.createElement('label');
        label.setAttribute('for', `attr-${field.id}`);
        label.textContent = `${field.label}${field.required ? ' *' : ''}`;
        wrapper.appendChild(label);
        let input;
        if (field.type === 'select') {
          input = document.createElement('select');
          input.id = `attr-${field.id}`;
          input.name = `attr_${field.id}`;
          input.innerHTML = `<option value="">S√©lectionnez</option>` + field.options.map((opt) => `<option value="${opt}">${opt.charAt(0).toUpperCase() + opt.slice(1)}</option>`).join('');
        } else if (field.type === 'boolean') {
          input = document.createElement('select');
          input.id = `attr-${field.id}`;
          input.name = `attr_${field.id}`;
          input.innerHTML = '<option value="">S√©lectionnez</option><option value="true">Oui</option><option value="false">Non</option>';
        } else {
          input = document.createElement('input');
          input.id = `attr-${field.id}`;
          input.name = `attr_${field.id}`;
          input.type = field.type === 'number' ? 'number' : 'text';
          if (field.min != null) input.min = field.min;
          if (field.max != null) input.max = field.max;
        }
        if (field.required) input.required = true;
        wrapper.appendChild(input);
        const error = document.createElement('p');
        error.className = 'field-error';
        error.dataset.errorFor = input.id;
        wrapper.appendChild(error);
        postAttributes.appendChild(wrapper);
        input.addEventListener('input', queueDraftSave);
      });
    }

    function updateDescriptionCount() {
      if (!postDescription || !postDescriptionCount) return;
      postDescriptionCount.textContent = `${postDescription.value.length} / 2000`;
    }

    function validatePostForm() {
      clearAllFieldErrors(postForm);
      let valid = true;
      const title = postTitleInput.value.trim();
      if (title.length < 10 || title.length > 80) {
        setFieldError('postTitleInput', 'Le titre doit contenir entre 10 et 80 caract√®res.');
        valid = false;
      }
      if (!postCategory.value) {
        setFieldError('postCategory', 'S√©lectionnez une cat√©gorie.');
        valid = false;
      }
      if (!postCondition.value) {
        setFieldError('postCondition', 'S√©lectionnez l‚Äô√©tat de l‚Äôarticle.');
        valid = false;
      }
      const priceValue = Number(postPrice.value);
      if (!postPrice.value || Number.isNaN(priceValue) || priceValue < 0.1 || priceValue > 9999999) {
        setFieldError('postPrice', 'Indiquez un prix valide (0.1 √† 9 999 999).');
        valid = false;
      }
      if (!postPhotos.length) {
        setFieldError('postPhotos', 'Ajoutez au moins une photo.');
        valid = false;
      }
      const def = categoryDefinitions[postCategory.value];
      if (def) {
        def.fields.forEach((field) => {
          const input = document.getElementById(`attr-${field.id}`);
          if (!input) return;
          let error = '';
          const value = input.value.trim();
          if (field.required && !value) {
            error = 'Champ requis';
          } else if (field.type === 'number' && value) {
            const num = Number(value);
            if (Number.isNaN(num)) error = 'Valeur num√©rique invalide';
            if (field.min != null && num < field.min) error = `Minimum ${field.min}`;
            if (field.max != null && num > field.max) error = `Maximum ${field.max}`;
          }
          if (error) {
            setFieldError(input.id, error);
            valid = false;
          }
        });
      }
      if (!postAddress.value.trim()) {
        setFieldError('postAddress', 'Indiquez une adresse.');
        valid = false;
      }
      const lat = Number(postLat.value);
      const lng = Number(postLng.value);
      if (Number.isNaN(lat) || lat < -90 || lat > 90) {
        setFieldError('postLat', 'Latitude invalide.');
        valid = false;
      }
      if (Number.isNaN(lng) || lng < -180 || lng > 180) {
        setFieldError('postLng', 'Longitude invalide.');
        valid = false;
      }
      if (postDescription.value.trim().length < 30) {
        setFieldError('postDescription', 'La description doit contenir au moins 30 caract√®res.');
        valid = false;
      }
      if (!valid) {
        const firstError = postForm.querySelector('[aria-invalid="true"]');
        if (firstError) firstError.focus({ preventScroll: false });
      }
      return valid;
    }

    function collectPostPayload() {
      const attributes = {};
      const def = categoryDefinitions[postCategory.value];
      if (def) {
        def.fields.forEach((field) => {
          const input = document.getElementById(`attr-${field.id}`);
          if (!input) return;
          if (field.type === 'number') {
            attributes[field.id] = input.value ? Number(input.value) : null;
          } else if (field.type === 'boolean') {
            attributes[field.id] = input.value === '' ? null : input.value === 'true';
          } else {
            attributes[field.id] = input.value.trim() || null;
          }
        });
      }
      return {
        title: postTitleInput.value.trim(),
        category: postCategory.value,
        condition: postCondition.value,
        price: Number(postPrice.value),
        description: postDescription.value.trim(),
        locationText: postAddress.value.trim(),
        latitude: Number(postLat.value),
        longitude: Number(postLng.value),
        attributes,
        images: postPhotos.map((file) => file.preview)
      };
    }

    function saveDraft(data) {
      try {
        localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify({ ...data, timestamp: Date.now() }));
      } catch (error) {
        console.warn('Impossible de sauvegarder le brouillon', error);
      }
    }

    function loadDraft() {
      try {
        const raw = localStorage.getItem(DRAFT_STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (error) {
        console.warn('Impossible de charger le brouillon', error);
        return null;
      }
    }

    function discardDraft() {
      try {
        localStorage.removeItem(DRAFT_STORAGE_KEY);
      } catch (error) {
        console.warn('Impossible de supprimer le brouillon', error);
      }
    }

    function restoreDraft(draft) {
      if (!draft) return;
      if (draft.title) postTitleInput.value = draft.title;
      if (draft.category) {
        postCategory.value = draft.category;
        buildAttributesForm(draft.category);
      }
      if (draft.condition) postCondition.value = draft.condition;
      if (draft.price) postPrice.value = draft.price;
      if (draft.description) postDescription.value = draft.description;
      if (draft.locationText) postAddress.value = draft.locationText;
      if (draft.latitude) postLat.value = draft.latitude;
      if (draft.longitude) postLng.value = draft.longitude;
      if (draft.attributes && typeof draft.attributes === 'object') {
        Object.entries(draft.attributes).forEach(([key, value]) => {
          const input = document.getElementById(`attr-${key}`);
          if (input) input.value = value ?? '';
        });
      }
      if (Array.isArray(draft.photos)) {
        postPhotos = draft.photos.map((photo) => ({ preview: photo, file: null }));
        renderPhotoList();
      }
      if (draft.latitude && draft.longitude) {
        updatePostMapMarker(draft.latitude, draft.longitude);
      }
      updateDescriptionCount();
    }

    function queueDraftSave() {
      if (postDraftTimer) clearTimeout(postDraftTimer);
      postDraftTimer = setTimeout(() => {
        if (postIsSubmitting) return;
        const payload = collectPostPayload();
        saveDraft({ ...payload, photos: postPhotos.map((p) => p.preview) });
      }, 1500);
    }

    function initPostMap() {
      const container = document.getElementById('postMap');
      if (!container) return;
      if (!postMapInstance) {
        postMapInstance = L.map('postMap', {
          center: [36.8065, 10.1815],
          zoom: 12,
          scrollWheelZoom: false
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap'
        }).addTo(postMapInstance);
        postMapMarker = L.marker(postMapInstance.getCenter(), { draggable: true }).addTo(postMapInstance);
        postMapMarker.on('move', ({ latlng }) => {
          postLat.value = latlng.lat.toFixed(6);
          postLng.value = latlng.lng.toFixed(6);
          queueDraftSave();
        });
        postMapInstance.on('click', ({ latlng }) => {
          postMapMarker.setLatLng(latlng);
          postLat.value = latlng.lat.toFixed(6);
          postLng.value = latlng.lng.toFixed(6);
          queueDraftSave();
        });
      }
      setTimeout(() => {
        postMapInstance.invalidateSize();
      }, 200);
    }

    function updatePostMapMarker(lat, lng) {
      if (!postMapInstance || !postMapMarker) return;
      const latNum = Number(lat);
      const lngNum = Number(lng);
      if (Number.isNaN(latNum) || Number.isNaN(lngNum)) return;
      postMapMarker.setLatLng([latNum, lngNum]);
      postMapInstance.setView([latNum, lngNum], Math.max(postMapInstance.getZoom(), 12));
    }

    async function requestUserLocation() {
      if (!navigator.geolocation) {
        showToast('G√©olocalisation non support√©e');
        return;
      }
      postUseLocation.disabled = true;
      postUseLocation.textContent = 'Recherche‚Ä¶';
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000 });
        });
        const { latitude, longitude } = position.coords;
        postLat.value = latitude.toFixed(6);
        postLng.value = longitude.toFixed(6);
        updatePostMapMarker(latitude, longitude);
        showToast('Position d√©tect√©e ‚úÖ');
        queueDraftSave();
      } catch (error) {
        console.warn('Geolocation error', error);
        showToast('Impossible d‚Äôobtenir la position');
      } finally {
        postUseLocation.disabled = false;
        postUseLocation.textContent = 'üìç Utiliser ma position';
      }
    }

    async function uploadImages(files) {
      const results = [];
      for (const file of files) {
        results.push({ url: file.preview, name: file.file?.name || 'image' });
      }
      return results;
    }

    async function submitPost(event) {
      event.preventDefault();
      if (postIsSubmitting) return;
      if (!validatePostForm()) return;
      postIsSubmitting = true;
      postSubmit.classList.add('loading');
      postStatus.textContent = 'Publication en cours‚Ä¶';

      try {
        const uploaded = await uploadImages(postPhotos);
        const payload = collectPostPayload();
        payload.images = uploaded.map((item) => item.url);
        if (payload.images.length === 0) {
          throw new Error('Ajoutez au moins une photo avant de publier.');
        }
        const response = await api.post('/api/ads', payload, { headers: { 'Content-Type': 'application/json' } });
        showToast(response?.message || 'Annonce publi√©e ‚úÖ');
        discardDraft();
        await loadAds({ toastOnError: false });
        closePostModal({ reset: true });
        postStatus.textContent = '';
      } catch (error) {
        console.error('Post error', error);
        const message = error?.payload?.message || error?.message || 'Impossible de publier l‚Äôannonce.';
        postStatus.textContent = message;
        showToast(message);
      } finally {
        postIsSubmitting = false;
        postSubmit.classList.remove('loading');
      }
    }

    postBtn?.addEventListener('click', () => openPostModal());
    closePostBtn?.addEventListener('click', () => closePostModal({ reset: false }));
    postCancel?.addEventListener('click', () => closePostModal({ reset: false }));
    postPreview?.addEventListener('click', () => {
      if (!validatePostForm()) return;
      const payload = collectPostPayload();
      console.table(payload);
      showToast('Pr√©visualisation disponible prochainement ‚ú®');
    });
    postSaveDraft?.addEventListener('click', () => {
      const payload = collectPostPayload();
      saveDraft({ ...payload, photos: postPhotos.map((p) => p.preview) });
      postStatus.textContent = 'Brouillon enregistr√© ‚úî';
      setTimeout(() => (postStatus.textContent = ''), 2000);
    });
    postForm?.addEventListener('submit', submitPost);

    postCategory?.addEventListener('change', () => {
      buildAttributesForm(postCategory.value);
      queueDraftSave();
    });
    [postTitleInput, postCondition, postPrice, postAddress, postLat, postLng].forEach((input) => {
      input?.addEventListener('input', () => {
        if (input === postLat || input === postLng) {
          updatePostMapMarker(postLat.value, postLng.value);
        }
        queueDraftSave();
      });
    });
    postDescription?.addEventListener('input', () => {
      updateDescriptionCount();
      queueDraftSave();
    });
    postPhotosInput?.addEventListener('change', async (event) => {
      setFieldError('postPhotos', '');
      const files = Array.from(event.target.files || []);
      if (!files.length) return;
      const remainingSlots = MAX_IMAGES - postPhotos.length;
      const selection = files.slice(0, remainingSlots);
      for (const file of selection) {
        if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
          showToast(`Format non support√©: ${file.name}`);
          continue;
        }
        if (file.size > MAX_IMAGE_SIZE) {
          showToast(`${file.name} d√©passe 8 Mo`);
          continue;
        }
        const preview = await readFilePreview(file);
        postPhotos.push({ file, preview });
      }
      renderPhotoList();
      queueDraftSave();
      postPhotosInput.value = '';
    });

    postPhotosList?.addEventListener('click', (event) => {
      const removeBtn = event.target.closest('.uploader-remove');
      if (!removeBtn) return;
      const index = Number(removeBtn.dataset.index);
      if (Number.isNaN(index)) return;
      postPhotos.splice(index, 1);
      renderPhotoList();
      queueDraftSave();
    });

    postUseLocation?.addEventListener('click', () => requestUserLocation());

    postModal?.addEventListener('click', (event) => {
      if (event.target === postModal) {
        closePostModal({ reset: false });
      }
    });

    postDialog?.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        event.preventDefault();
        closePostModal({ reset: false });
      }
    });

    postDraftResume?.addEventListener('click', () => {
      const draft = loadDraft();
      if (draft) {
        restoreDraft(draft);
        postDraftBanner.hidden = true;
        postDraftLoaded = true;
      }
    });

    postDraftDiscard?.addEventListener('click', () => {
      discardDraft();
      postDraftBanner.hidden = true;
    });

    async function readFilePreview(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ---------- DETAILS MODAL ----------
    const detailsModal = document.getElementById('detailsModal');
    const detailsDialog = document.getElementById('detailsDialog');
    const closeDetailsBtn = document.getElementById('closeDetails');
    const detailsCarouselTrack = document.getElementById('detailsCarouselTrack');
    const detailsCarouselDots = document.getElementById('detailsCarouselDots');
    const detailsPrev = document.getElementById('detailsPrev');
    const detailsNext = document.getElementById('detailsNext');
    const detailsImageCounter = document.getElementById('detailsImageCounter');
    const detailsSkeleton = document.getElementById('detailsSkeleton');
    const detailsTitleEl = document.getElementById('detailsTitle');
    const detailsPriceEl = document.getElementById('detailsPrice');
    const detailsMeta = document.getElementById('detailsMeta');
    const detailsDescEl = document.getElementById('detailsDesc');
    const detailsReadMore = document.getElementById('detailsReadMore');
    const detailsSeller = document.getElementById('detailsSeller');
    const detailsSave = document.getElementById('detailsSave');
    const detailsContact = document.getElementById('detailsContact');
    const contactPopover = document.getElementById('contactPopover');
    const contactAnchor = document.getElementById('sellerCardWrap');
    const contactMessage = document.getElementById('cpMessage');
    const contactCloseBtn = document.getElementById('cpClose');
    const contactCancelBtn = document.getElementById('cpCancel');
    const contactSendBtn = document.getElementById('cpSend');
    const contactCounter = document.getElementById('cpCounter');
    const contactError = document.getElementById('cpError');
    const contactSuggestions = contactPopover ? Array.from(contactPopover.querySelectorAll('.chip')) : [];
    const detailsVisitBtn = document.getElementById('detailsVisit');
    const detailsTags = document.getElementById('detailsTags');
    const detailsBodyEl = document.querySelector('.details-body');
    const imageLightbox = document.getElementById('imageLightbox');
    const lightboxDialog = imageLightbox?.querySelector('.lightbox__dialog');
    const lightboxImage = document.getElementById('lightboxImage');
    const lightboxTitleEl = document.getElementById('lightboxTitle');
    const lightboxCounterEl = document.getElementById('lightboxCounter');
    const lightboxPrev = imageLightbox?.querySelector('[data-action="prev"]');
    const lightboxNext = imageLightbox?.querySelector('[data-action="next"]');
    const lightboxCloseBtn = imageLightbox?.querySelector('[data-action="close"]');
    const lightboxBackdrop = imageLightbox?.querySelector('[data-action="dismiss"]');

    let detailsCurrentImages = [];
    let detailsCurrentIndex = 0;
    let detailsCurrentAd = null;
    let detailsDescFull = '';
    let detailsDescExpanded = false;
    let detailsSkeletonTimeout = null;
    let lightboxActive = false;
    let lightboxLastFocus = null;
    let contactPopoverTimer = null;
    let contactTrapActive = false;
    let contactLastFocus = null;
    let contactSending = false;
    let contactCooldownUntil = 0;
    const CONTACT_MAX_LENGTH = 500;
    const CONTACT_MIN_LENGTH = 12;
    const CONTACT_COOLDOWN_MS = 3000;
    const CONTACT_FOCUS_SELECTOR = 'button:not([disabled]), textarea:not([disabled]), [href], [tabindex]:not([tabindex="-1"])';

    function buildGallery(ad) {
      const sources = Array.isArray(ad.gallery) && ad.gallery.length ? ad.gallery : [ad.img];
      return sources.map((url, index) => buildOptimizedImage(url, index === 0 ? 960 : 1280, index === 0 ? 75 : 70));
    }

    function renderGallery(images, title) {
      if (detailsSkeletonTimeout) {
        clearTimeout(detailsSkeletonTimeout);
        detailsSkeletonTimeout = null;
      }
      detailsSkeleton.classList.add('active');
      detailsCarouselTrack.innerHTML = '';
      detailsCarouselDots.innerHTML = '';
      let firstLoaded = false;
      detailsSkeletonTimeout = setTimeout(() => {
        detailsSkeleton.classList.remove('active');
        detailsSkeletonTimeout = null;
      }, 1500);
      images.forEach((src, index) => {
        const slide = document.createElement('div');
        slide.className = 'carousel-slide';
        if (index === 0) slide.classList.add('active');
        slide.dataset.index = String(index);
        slide.setAttribute('role', 'button');
        slide.setAttribute('aria-label', `Agrandir l'image ${index + 1}`);
        slide.tabIndex = index === 0 ? 0 : -1;
        slide.addEventListener('click', () => openLightbox(index));
        slide.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ' || event.key === 'Spacebar') {
            event.preventDefault();
            openLightbox(index);
          }
        });
        const img = document.createElement('img');
        img.decoding = 'async';
        img.loading = index === 0 ? 'eager' : 'lazy';
        img.alt = `${title} - photo ${index + 1}`;
        img.src = buildOptimizedImage(src, index === 0 ? 960 : 1280, 75);
        img.srcset = buildSrcSet(src, [640, 960, 1280], 75);
        img.sizes = '(max-width: 768px) 92vw, min(640px, 60vw)';
        img.width = 960;
        img.height = 720;
        img.style.aspectRatio = '4 / 3';
        img.addEventListener('load', () => {
          if (!firstLoaded) {
            if (detailsSkeletonTimeout) {
              clearTimeout(detailsSkeletonTimeout);
              detailsSkeletonTimeout = null;
            }
            firstLoaded = true;
            detailsSkeleton.classList.remove('active');
          }
        });
        slide.appendChild(img);
        detailsCarouselTrack.appendChild(slide);

        const dot = document.createElement('button');
        dot.type = 'button';
        dot.className = 'carousel-dot';
        if (index === 0) dot.classList.add('active');
        dot.setAttribute('aria-label', `Voir l'image ${index + 1}`);
        dot.addEventListener('click', () => goToSlide(index));
        detailsCarouselDots.appendChild(dot);
      });
      if (!images.length) {
        if (detailsSkeletonTimeout) {
          clearTimeout(detailsSkeletonTimeout);
          detailsSkeletonTimeout = null;
        }
        detailsSkeleton.classList.remove('active');
      }
      updateCarouselUI();
    }

    function updateCarouselUI() {
      const slides = Array.from(detailsCarouselTrack.children);
      slides.forEach((slide, idx) => {
        const isActive = idx === detailsCurrentIndex;
        slide.classList.toggle('active', isActive);
        if (isActive) slide.setAttribute('tabindex', '0');
        else slide.setAttribute('tabindex', '-1');
      });
      const dots = Array.from(detailsCarouselDots.children);
      dots.forEach((dot, idx) => dot.classList.toggle('active', idx === detailsCurrentIndex));
      const total = detailsCurrentImages.length || 1;
      detailsImageCounter.textContent = `${Math.min(detailsCurrentIndex + 1, total)} / ${total}`;
      const multiple = detailsCurrentImages.length > 1;
      detailsPrev.style.visibility = multiple ? 'visible' : 'hidden';
      detailsNext.style.visibility = multiple ? 'visible' : 'hidden';
      detailsCarouselDots.style.display = multiple ? 'flex' : 'none';
    }

    function normalizeIndex(index, total) {
      if (!Number.isFinite(index) || total <= 0) return 0;
      const normalized = index % total;
      return (normalized + total) % total;
    }

    function changeSlide(delta) {
      if (!detailsCurrentImages.length) return;
      detailsCurrentIndex = normalizeIndex(detailsCurrentIndex + delta, detailsCurrentImages.length);
      updateCarouselUI();
    }

    function goToSlide(index) {
      if (!detailsCurrentImages.length) return;
      detailsCurrentIndex = normalizeIndex(index, detailsCurrentImages.length);
      updateCarouselUI();
    }

    function applyDetailsContent(ad, { replaceGallery = true, gallery: providedGallery = null } = {}) {
      if (!ad) return;
      const gallery = providedGallery ?? buildGallery(ad);
      const totalImages = gallery.length || 0;
      const wasLightboxActive = lightboxActive;

      detailsCurrentAd = ad;
      detailsDialog.dataset.itemId = String(ad.id ?? '');

      detailsTitleEl.textContent = ad.title;
      detailsPriceEl.innerHTML = `<strong>${fmtPrice(ad.price)}</strong>`;
      renderDetailsMeta(ad);
      updateDetailsStats(ad);
      renderDetailsTags(ad);
      const nextDesc = ad.desc || '';
      if (replaceGallery || nextDesc !== detailsDescFull) {
        setDetailsDescription(nextDesc);
      } else {
        updateDescription();
      }
      renderSeller(ad);

      if (detailsSave) {
        detailsSave.dataset.id = String(ad.id ?? '');
        setDetailsSaveState(favStore.has(ad.id));
      }

      if (replaceGallery) {
        detailsCurrentImages = gallery;
        detailsCurrentIndex = 0;
        renderGallery(gallery, ad.title);
      } else {
        const previousIndex = detailsCurrentIndex;
        detailsCurrentImages = gallery;
        const safeIndex = gallery.length ? normalizeIndex(previousIndex, gallery.length) : 0;
        detailsCurrentIndex = safeIndex;
        updateCarouselUI();
        if (wasLightboxActive) {
          updateLightboxView();
        } else if (lightboxTitleEl) {
          lightboxTitleEl.textContent = ad.title || 'Photo';
          if (lightboxCounterEl) {
            const displayTotal = gallery.length || 1;
            lightboxCounterEl.textContent = `${Math.min(detailsCurrentIndex + 1, displayTotal)}/${displayTotal}`;
          }
        }
      }

      if (lightboxImage && !wasLightboxActive) {
        const displayTotal = totalImages || 1;
        lightboxImage.alt = `${ad.title || 'Photo'} ‚Äî ${Math.min(detailsCurrentIndex + 1, displayTotal)} / ${displayTotal}`;
      }

      setDetailsLoading(false);
    }

    function refreshOpenDetails(ad) {
      if (!ad || !detailsModal || detailsModal.style.display !== 'flex') return;
      const currentId = normalizeAdId(detailsDialog?.dataset?.itemId);
      const nextId = normalizeAdId(ad.id);
      if (!currentId || currentId !== nextId) return;
      const nextGallery = buildGallery(ad);
      const shouldReplace = !arraysShallowEqual(detailsCurrentImages, nextGallery);
      applyDetailsContent(ad, { replaceGallery: shouldReplace, gallery: nextGallery });
    }

    function getLightboxFocusables() {
      if (!imageLightbox) return [];
      return Array.from(imageLightbox.querySelectorAll('button:not([disabled])')).filter(el => {
        if (!el) return false;
        if (typeof el.offsetParent === 'undefined') return true;
        return el.offsetParent !== null && el.tabIndex !== -1;
      });
    }

    function updateLightboxView() {
      if (!lightboxActive || !detailsCurrentImages.length || !lightboxImage) return;
      const total = detailsCurrentImages.length;
      const index = normalizeIndex(detailsCurrentIndex, total);
      detailsCurrentIndex = index;
      const baseSrc = detailsCurrentImages[index];
      const hdSrc = buildOptimizedImage(baseSrc, 1600, 82);
      const setImagePayload = () => {
        lightboxImage.src = hdSrc;
        lightboxImage.srcset = buildSrcSet(baseSrc, [1024, 1280, 1600, 1920], 82);
        lightboxImage.sizes = '(min-width: 1024px) 70vw, 92vw';
      };
      lightboxImage.removeAttribute('src');
      lightboxImage.removeAttribute('srcset');
      lightboxImage.removeAttribute('sizes');
      lightboxImage.alt = `${detailsCurrentAd?.title || 'Photo'} ‚Äî ${index + 1} / ${total}`;
      lightboxImage.style.cursor = total > 1 ? 'pointer' : 'default';
      if (lightboxTitleEl) {
        lightboxTitleEl.textContent = detailsCurrentAd?.title || 'Photo';
      }
      if (lightboxCounterEl) {
        lightboxCounterEl.textContent = `${index + 1}/${total}`;
      }
      requestAnimationFrame(setImagePayload);
      if (lightboxPrev) {
        const visible = total > 1;
        lightboxPrev.style.visibility = visible ? 'visible' : 'hidden';
        lightboxPrev.tabIndex = visible ? 0 : -1;
        lightboxPrev.setAttribute('aria-hidden', String(!visible));
        lightboxPrev.disabled = !visible;
      }
      if (lightboxNext) {
        const visible = total > 1;
        lightboxNext.style.visibility = visible ? 'visible' : 'hidden';
        lightboxNext.tabIndex = visible ? 0 : -1;
        lightboxNext.setAttribute('aria-hidden', String(!visible));
        lightboxNext.disabled = !visible;
      }
      if (lightboxDialog) {
        lightboxDialog.setAttribute('aria-label', detailsCurrentAd?.title || 'Image agrandie');
      }
      if (lightboxActive) {
        const slides = detailsCarouselTrack?.children;
        if (slides && slides[detailsCurrentIndex]) {
          lightboxLastFocus = slides[detailsCurrentIndex];
        }
      }
    }

    function openLightbox(index = 0) {
      if (!imageLightbox || !detailsCurrentImages.length) return;
      const targetIndex = normalizeIndex(Number.isFinite(index) ? index : 0, detailsCurrentImages.length);
      goToSlide(targetIndex);
      lightboxActive = true;
      lightboxLastFocus = document.activeElement;
      imageLightbox.hidden = false;
      imageLightbox.classList.add('is-open');
      imageLightbox.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
      updateLightboxView();
      requestAnimationFrame(() => lightboxDialog?.focus?.({ preventScroll: true }));
    }

    function closeLightbox(options = {}) {
      if (!lightboxActive || !imageLightbox) return;
      const { restoreFocus = true } = options;
      lightboxActive = false;
      detailsCurrentIndex = 0;
      imageLightbox.classList.remove('is-open');
      imageLightbox.setAttribute('aria-hidden', 'true');
      lightboxPrev?.blur();
      lightboxNext?.blur();
      lightboxCloseBtn?.blur();
      setTimeout(() => { if (!lightboxActive) imageLightbox.hidden = true; }, 200);
      unlockBodyScroll();
      updateCarouselUI();
      if (restoreFocus && lightboxLastFocus && typeof lightboxLastFocus.focus === 'function') {
        lightboxLastFocus.focus({ preventScroll: true });
      }
      lightboxLastFocus = null;
    }

    function categorySymbol(cat) {
      const slug = mapCategoryLabelToSlug(cat);
      return CATEGORY_ICONS[slug] || 'üì¶';
    }

    function renderDetailsMeta(ad) {
      const badges = [];
      badges.push(
        { class: 'location', text: ad.city || 'Localisation √† pr√©ciser' },
        { class: 'date', text: `Publi√©e le ${formatDateLong(ad.date)}` }
      );
      detailsMeta.innerHTML = badges.map((badge) => {
        return `<span class="details-meta-item ${badge.class} tag"><span class="label">${badge.text}</span></span>`;
      }).join('');
    }

    function setDetailsLoading(isLoading) {
      if (!detailsDialog) return;
      detailsDialog.classList.toggle('is-loading', Boolean(isLoading));
      if (isLoading) {
        detailsDialog.setAttribute('aria-busy', 'true');
      } else {
        detailsDialog.removeAttribute('aria-busy');
      }
      const interactive = [detailsSave, detailsContact, detailsVisitBtn, detailsReadMore];
      interactive.forEach((node) => {
        if (!node) return;
        if (isLoading) {
          node.setAttribute('disabled', '');
          node.setAttribute('aria-disabled', 'true');
        } else {
          node.removeAttribute('disabled');
          node.removeAttribute('aria-disabled');
        }
      });
      if (isLoading && detailsSave) {
        detailsSave.dataset.id = '';
      }
    }

    function showDetailsLoadingState(id = null) {
      if (detailsSkeletonTimeout) {
        clearTimeout(detailsSkeletonTimeout);
        detailsSkeletonTimeout = null;
      }
      setDetailsLoading(true);
      detailsCurrentAd = null;
      detailsCurrentImages = [];
      detailsCurrentIndex = 0;
      detailsSkeleton.classList.add('active');
      detailsCarouselTrack.innerHTML = '';
      detailsCarouselDots.innerHTML = '';
      detailsImageCounter.textContent = '‚Ä¶';
      if (lightboxImage) {
        lightboxImage.removeAttribute('src');
        lightboxImage.removeAttribute('srcset');
        lightboxImage.removeAttribute('sizes');
        lightboxImage.alt = '';
      }
      detailsDialog.dataset.itemId = id ? String(id) : '';
      detailsTitleEl.innerHTML = '<span class="skeleton-line skeleton-line--lg" aria-hidden="true"></span>';
      detailsPriceEl.innerHTML = '<span class="skeleton-pill skeleton-pill--lg" aria-hidden="true"></span>';
      detailsMeta.innerHTML = [
        '<span class="skeleton-pill skeleton-pill--md" aria-hidden="true"></span>',
        '<span class="skeleton-pill skeleton-pill--sm" aria-hidden="true"></span>'
      ].join('');
      detailsDescFull = '';
      detailsDescExpanded = false;
      detailsDescEl.innerHTML = [
        '<span class="skeleton-line" aria-hidden="true"></span>',
        '<span class="skeleton-line skeleton-line--sm" aria-hidden="true"></span>',
        '<span class="skeleton-line skeleton-line--sm" aria-hidden="true"></span>'
      ].join('');
      detailsReadMore.classList.remove('visible');
      detailsTags.style.display = 'none';
      detailsTags.innerHTML = '';
      detailsSeller.innerHTML = `
        <div class="seller-skeleton" aria-hidden="true">
          <span class="skeleton-avatar"></span>
          <div class="seller-skeleton__lines">
            <span class="skeleton-line skeleton-line--sm"></span>
            <span class="skeleton-line skeleton-line--xs"></span>
            <span class="skeleton-line skeleton-line--xs"></span>
          </div>
        </div>
      `;
      resetContactForm();
      if (contactPopover && !contactPopover.hasAttribute('hidden')) {
        closeContactPopover({ immediate: true, restoreFocus: false });
      }
      setContactLoading(false);
      if (detailsModal.style.display !== 'flex') {
        if (detailsModal) {
          const activeEl = document.activeElement;
          detailsModal._lastTrigger = activeEl instanceof HTMLElement ? activeEl : null;
        }
        detailsModal.style.display = 'flex';
        detailsModal.classList.add('active');
        detailsModal.setAttribute('aria-hidden', 'false');
        lockBodyScroll();
        obscureMap();
        if (favModal?._stickyOpen && favList) {
          favModal._favScrollTop = favList.scrollTop || favModal._favScrollTop || 0;
        }
        const focusTarget = closeDetailsBtn || detailsDialog;
        setTimeout(() => focusTarget?.focus?.({ preventScroll: true }), 40);
      }
      if (detailsBodyEl) {
        detailsBodyEl.scrollTo({ top: 0, left: 0, behavior: 'auto' });
      }
    }

    function arraysShallowEqual(a, b) {
      if (a === b) return true;
      if (!Array.isArray(a) || !Array.isArray(b)) return false;
      if (a.length !== b.length) return false;
      for (let i = 0; i < a.length; i += 1) {
        if (a[i] !== b[i]) return false;
      }
      return true;
    }

    function updateDetailsMeta(ad) {
      if (!detailsMeta) return;
      if (!ad) {
        detailsMeta.innerHTML = '';
        return;
      }
      renderDetailsMeta(ad);
    }

    function updateDetailsStats(ad) {
      const statsRoot = detailsDialog.querySelector('.details-meta.details-meta-stats');
      const categoryRoot = detailsDialog.querySelector('.details-meta.details-meta-category');
      
      // G√©rer la cat√©gorie (√† gauche)
      if (categoryRoot) {
        if (ad && ad.cat) {
          categoryRoot.innerHTML = `<div class="cat ${categoryClass(ad.catSlug || ad.cat)}">${categorySymbol(ad.catSlug || ad.cat)} <span>${ad.cat}</span></div>`;
          categoryRoot.style.display = 'inline-flex';
        } else {
          categoryRoot.innerHTML = '';
          categoryRoot.style.display = 'none';
        }
      }
      
      // G√©rer les stats (√† droite)
      if (!statsRoot) return;
      const stats = [];
      
      if (ad && typeof ad.views !== 'undefined') {
        stats.push(`<span class="details-meta-item views" aria-label="Nombre de vues"><span class="icon" aria-hidden="true">üëÅÔ∏è</span><span class="label"><strong class="count">${ad.views}</strong> vues</span></span>`);
      }
      const favCountValue = ad && (ad.likes ?? ad.favorites);
      if (typeof favCountValue !== 'undefined') {
        stats.push(`<span class="details-meta-item fav-meta" aria-label="Nombre de favoris"><span class="icon" aria-hidden="true">‚ù§Ô∏è</span><span class="label"><strong class="count">${favCountValue}</strong> favoris</span></span>`);
      }
      statsRoot.innerHTML = stats.join('');
    }

    function renderDetailsTags(ad) {
      const tags = Array.isArray(ad.chips) ? ad.chips : [];
      if (tags.length) {
        detailsTags.style.display = 'flex';
        detailsTags.innerHTML = tags.map(tag => `<span class="details-tag">${tag}</span>`).join('');
      } else {
        detailsTags.style.display = 'none';
        detailsTags.innerHTML = '';
      }
    }

    function setDetailsDescription(desc) {
      detailsDescFull = desc || 'Aucune description fournie pour cette annonce.';
      detailsDescExpanded = false;
      updateDescription();
    }

    function updateDescription() {
      const limit = 220;
      if (detailsDescFull.length > limit && !detailsDescExpanded) {
        detailsDescEl.textContent = detailsDescFull.slice(0, limit) + '‚Ä¶';
        detailsReadMore.classList.add('visible');
        detailsReadMore.textContent = 'Lire la suite';
      } else {
        detailsDescEl.textContent = detailsDescFull;
        if (detailsDescFull.length > limit) {
          detailsReadMore.classList.add('visible');
          detailsReadMore.textContent = 'R√©duire';
        } else {
          detailsReadMore.classList.remove('visible');
        }
      }
    }

    function renderSeller(ad) {
      const avatarBase = ad.sellerAvatar || ad.img || DEFAULT_IMAGE;
      const avatarThumb = buildOptimizedImage(avatarBase, 160, 60);
      const memberDate = ad.sellerMemberSince ? formatDateLong(ad.sellerMemberSince) : formatDateLong(ad.date);
      const activeCount = ad.sellerAnnouncements != null ? ad.sellerAnnouncements : Math.max(1, Math.round((ad.likes ?? 0) / 3));
      detailsSeller.innerHTML = `
        <img src="${avatarThumb}" alt="${ad.sellerName || 'Vendeur'}" loading="lazy" decoding="async" width="52" height="52" style="width:52px;height:52px;">
        <div class="seller-meta">
          <strong>${ad.sellerName || `Vendeur ${ad.city}`}</strong>
          <span>Membre depuis le ${memberDate}</span>
          <span>${activeCount} annonce(s) active(s)</span>
        </div>
      `;
    }

    function updateContactCounter() {
      if (!contactCounter || !contactMessage) return;
      const remaining = Math.max(0, CONTACT_MAX_LENGTH - contactMessage.value.length);
      contactCounter.textContent = String(remaining);
      contactCounter.classList.toggle('is-low', remaining <= 20);
    }

    function clearContactError() {
      if (!contactError) return;
      contactError.textContent = '';
      contactError.hidden = true;
    }

    function showContactError(message) {
      if (!contactError) return;
      contactError.textContent = message;
      contactError.hidden = false;
    }

    function autoSizeContactMessage({ reset = false } = {}) {
      if (!contactMessage) return;
      if (reset) {
        contactMessage.style.height = '';
        return;
      }
      contactMessage.style.height = 'auto';
      const next = Math.min(200, Math.max(54, contactMessage.scrollHeight));
      contactMessage.style.height = `${next}px`;
      updateContactPlacement();
      ensureContactVisibility();
    }

    function getContactFocusables() {
      if (!contactPopover || contactPopover.hasAttribute('hidden')) return [];
      const nodes = Array.from(contactPopover.querySelectorAll(CONTACT_FOCUS_SELECTOR));
      return nodes.filter((node) => {
        if (node.hasAttribute('disabled')) return false;
        if (node.getAttribute('aria-hidden') === 'true') return false;
        const rect = node.getBoundingClientRect();
        return rect.width > 0 || rect.height > 0;
      });
    }

    function updateContactPlacement() {
      if (!contactPopover || contactPopover.hasAttribute('hidden')) return;
      const anchorRect = contactAnchor?.getBoundingClientRect?.();
      const dialogRect = detailsDialog?.getBoundingClientRect?.();
      if (!anchorRect || !dialogRect) return;
      const popHeight = contactPopover.offsetHeight || 0;
      const spaceAbove = anchorRect.top - dialogRect.top;
      const spaceBelow = dialogRect.bottom - anchorRect.bottom;
      const needsBottom = popHeight + 28 > spaceAbove && spaceBelow > spaceAbove;
      contactPopover.classList.toggle('is-bottom', needsBottom);
    }

    function activateContactFocusTrap() {
      contactTrapActive = true;
    }

    function deactivateContactFocusTrap() {
      contactTrapActive = false;
    }

    function setContactLoading(isLoading) {
      if (!contactSendBtn) return;
      if (isLoading) {
        contactSending = true;
        contactSendBtn.classList.add('is-loading');
        contactSendBtn.setAttribute('disabled', '');
        contactCancelBtn?.setAttribute('disabled', '');
        contactCloseBtn?.setAttribute('disabled', '');
        contactMessage?.setAttribute('readonly', '');
        contactSuggestions.forEach(btn => btn.setAttribute('disabled', ''));
      } else {
        contactSending = false;
        contactSendBtn.classList.remove('is-loading');
        contactSendBtn.removeAttribute('disabled');
        contactCancelBtn?.removeAttribute('disabled');
        contactCloseBtn?.removeAttribute('disabled');
        contactMessage?.removeAttribute('readonly');
        contactSuggestions.forEach(btn => btn.removeAttribute('disabled'));
      }
    }

    function ensureContactVisibility() {
      if (!contactPopover || contactPopover.hasAttribute('hidden') || !detailsBodyEl) return;
      requestAnimationFrame(() => {
        const popRect = contactPopover.getBoundingClientRect();
        const dialogRect = detailsDialog?.getBoundingClientRect();
        if (!popRect || !dialogRect) return;
        const offsetTop = popRect.top - (dialogRect.top + 16);
        const offsetBottom = popRect.bottom - (dialogRect.bottom - 16);
        if (offsetTop < 0) {
          detailsBodyEl.scrollBy({ top: offsetTop - 12, behavior: prefersReducedMotion.matches ? 'auto' : 'smooth' });
        } else if (offsetBottom > 0) {
          detailsBodyEl.scrollBy({ top: offsetBottom + 12, behavior: prefersReducedMotion.matches ? 'auto' : 'smooth' });
        }
      });
    }

    function resetContactForm() {
      if (contactMessage) {
        contactMessage.value = '';
        autoSizeContactMessage({ reset: true });
      }
      updateContactCounter();
      clearContactError();
    }

    function openContactPopover() {
      if (!contactPopover) return;
      const auth = authStore.get();
      if (!auth) {
        // Ne pas ouvrir le modal d'auth : juste un feedback elegant
        showToast('Connectez-vous pour envoyer un message üîí');
        if (!contactPopover.hasAttribute('hidden')) {
          closeContactPopover({ immediate: true, restoreFocus: false });
        }
        return;
      }
      if (contactSending) return;
      if (Date.now() < contactCooldownUntil) {
        showToast('Un instant‚Ä¶ vous pourrez renvoyer un message dans quelques secondes.');
        return;
      }
      contactLastFocus = document.activeElement instanceof HTMLElement ? document.activeElement : detailsContact;
      if (contactPopoverTimer) {
        clearTimeout(contactPopoverTimer);
        contactPopoverTimer = null;
      }
      setContactLoading(false);
      contactPopover.setAttribute('aria-hidden', 'false');
      contactPopover.removeAttribute('hidden');
      contactPopover.classList.remove('closing');
      requestAnimationFrame(() => {
        updateContactPlacement();
        contactPopover.classList.add('open');
        activateContactFocusTrap();
        ensureContactVisibility();
      });
      clearContactError();
      updateContactCounter();
      autoSizeContactMessage();
      requestAnimationFrame(() => {
        updateContactPlacement();
        ensureContactVisibility();
        contactMessage?.focus?.({ preventScroll: true });
      });
    }

    function closeContactPopover({ restoreFocus = false, immediate = false } = {}) {
      if (!contactPopover || contactPopover.hasAttribute('hidden')) return;
      if (contactPopoverTimer) {
        clearTimeout(contactPopoverTimer);
        contactPopoverTimer = null;
      }
      deactivateContactFocusTrap();
      contactPopover.classList.remove('open', 'is-bottom');
      contactPopover.setAttribute('aria-hidden', 'true');
      setContactLoading(false);
      if (contactMessage) {
        contactMessage.removeAttribute('readonly');
        contactMessage.blur();
      }
      if (immediate) {
        contactPopover.setAttribute('hidden', '');
        autoSizeContactMessage({ reset: true });
      } else {
        contactPopoverTimer = window.setTimeout(() => {
          contactPopover?.setAttribute('hidden', '');
          contactPopoverTimer = null;
          autoSizeContactMessage({ reset: true });
        }, 220);
      }
      if (restoreFocus) {
        (detailsContact || contactLastFocus)?.focus?.({ preventScroll: true });
      }
      contactLastFocus = null;
      clearContactError();
    }

    function setDetailsSaveState(isFav) {
      detailsSave.classList.toggle('active', isFav);
      detailsSave.setAttribute('aria-pressed', String(isFav));
      detailsSave.setAttribute('title', isFav ? 'Retirer des favoris' : 'Ajouter aux favoris');
      const svg = detailsSave.querySelector('svg');
      const span = detailsSave.querySelector('span');
      const path = svg.querySelector('path');
      if (path) {
        path.setAttribute('fill', isFav ? 'currentColor' : 'none');
        path.setAttribute('stroke', 'currentColor');
      }
      span.textContent = isFav ? 'Retirer des favoris' : 'Ajouter aux favoris';
    }

    function syncFavoriteButtons(id, isFav) {
      const key = normalizeAdId(id);
      if (!key) return;
      listView.querySelectorAll(`.fav[data-id="${key}"]`).forEach(btn => {
        btn.setAttribute('aria-pressed', String(isFav));
        btn.setAttribute('title', isFav ? 'Retirer des favoris' : 'Ajouter aux favoris');
        const svg = btn.querySelector('svg');
        updateFavIcon(svg, isFav);
      });
      if (detailsCurrentAd && normalizeAdId(detailsCurrentAd.id) === key) {
        setDetailsSaveState(isFav);
      }
      updateFavBadge();
    }

    function openDetailsModal(adData) {
      if (!adData) return;
      const alreadyOpen = detailsModal && detailsModal.style.display === 'flex' && detailsModal.getAttribute('aria-hidden') === 'false';
      if (lightboxActive) closeLightbox({ restoreFocus: false });
      lightboxActive = false;
      if (detailsModal && !alreadyOpen) {
        const activeEl = document.activeElement;
        detailsModal._lastTrigger = activeEl instanceof HTMLElement ? activeEl : null;
      }
      resetContactForm();
      setContactLoading(false);
      if (contactPopover) {
        contactPopover.classList.remove('open');
        contactPopover.setAttribute('hidden', '');
        contactPopover.setAttribute('aria-hidden', 'true');
        contactPopoverTimer = null;
        deactivateContactFocusTrap();
      }
      if (lightboxImage) {
        lightboxImage.removeAttribute('src');
        lightboxImage.removeAttribute('srcset');
        lightboxImage.removeAttribute('sizes');
        lightboxImage.alt = '';
      }
      applyDetailsContent(adData, { replaceGallery: true });
      if (!alreadyOpen) {
        detailsModal.style.display = 'flex';
        detailsModal.classList.add('active');
        detailsModal.setAttribute('aria-hidden', 'false');
        lockBodyScroll();
        obscureMap();
        if (favModal?._stickyOpen && favList) {
          favModal._favScrollTop = favList.scrollTop || favModal._favScrollTop || 0;
        }
        const focusTarget = closeDetailsBtn || detailsDialog;
        setTimeout(() => focusTarget?.focus?.({ preventScroll: true }), 40);
      }
      if (detailsBodyEl) {
        detailsBodyEl.scrollTo({ top: 0, left: 0, behavior: 'auto' });
      }
    }

    function closeDetailsModal() {
      if (lightboxActive) closeLightbox({ restoreFocus: false });
      if (contactPopover) closeContactPopover({ immediate: true, restoreFocus: false });
      resetContactForm();
      setDetailsLoading(false);
      const stickyOpen = !!favModal?._stickyOpen;
      const stickyScrollTop = typeof favModal?._favScrollTop === 'number' ? favModal._favScrollTop : 0;
      const stickyId = favModal?._lastSelectedFavId ?? null;
      const stickyCard = favModal?._lastSelectedCard ?? null;
      const lastTrigger = detailsModal?._lastTrigger;
      detailsModal.style.display = 'none';
      detailsModal.classList.remove('active');
      detailsModal.setAttribute('aria-hidden', 'true');
      unlockBodyScroll();
      restoreMap();
      if (detailsSkeletonTimeout) {
        clearTimeout(detailsSkeletonTimeout);
        detailsSkeletonTimeout = null;
      }
      detailsCarouselTrack.innerHTML = '';
      detailsCarouselDots.innerHTML = '';
      detailsSkeleton.classList.remove('active');
      detailsCurrentImages = [];
      detailsCurrentIndex = 0;
      if (detailsPriceEl) {
        detailsPriceEl.innerHTML = '<strong>‚Äî</strong>';
      }
      if (stickyOpen) {
        requestAnimationFrame(() => {
          if (favList) {
            favList.scrollTop = stickyScrollTop || 0;
            let focusTarget = stickyCard && document.body.contains(stickyCard) ? stickyCard : null;
            if ((!focusTarget || !focusTarget.isConnected) && stickyId != null) {
              focusTarget = favList.querySelector(`.mm-card[data-id="${stickyId}"]`);
            }
            focusTarget?.focus?.({ preventScroll: true });
            if (!focusTarget && favList.firstElementChild instanceof HTMLElement) {
              favList.firstElementChild.focus({ preventScroll: true });
            }
          }
        });
      } else if (lastTrigger && typeof lastTrigger.focus === 'function') {
        requestAnimationFrame(() => lastTrigger.focus({ preventScroll: true }));
      }
      if (favModal) {
        if (stickyOpen) {
          favModal._lastSelectedCard = stickyCard && stickyCard.isConnected ? stickyCard : null;
        } else {
          favModal._lastSelectedCard = null;
          favModal._lastSelectedFavId = null;
          favModal._favScrollTop = 0;
        }
      }
      if (detailsModal) detailsModal._lastTrigger = null;
    }

    detailsPrev.addEventListener('click', () => {
      changeSlide(-1);
      if (lightboxActive) updateLightboxView();
    });
    detailsNext.addEventListener('click', () => {
      changeSlide(1);
      if (lightboxActive) updateLightboxView();
    });
    closeDetailsBtn.addEventListener('click', closeDetailsModal);
    detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) closeDetailsModal(); });
    lightboxPrev?.addEventListener('click', () => { changeSlide(-1); updateLightboxView(); });
    lightboxNext?.addEventListener('click', () => { changeSlide(1); updateLightboxView(); });
    lightboxCloseBtn?.addEventListener('click', () => closeLightbox());
    lightboxBackdrop?.addEventListener('click', () => closeLightbox());
    lightboxImage?.addEventListener('click', () => {
      if (!lightboxActive || detailsCurrentImages.length <= 1) return;
      changeSlide(1);
      updateLightboxView();
    });

    detailsSave.addEventListener('click', async () => {
      if (!detailsCurrentAd) return;
      const auth = authStore.get();
      if (!auth) {
        showToast('Connectez-vous pour ajouter des favoris üîê');
        return;
      }
      const id = detailsSave.dataset.id ?? detailsCurrentAd.id;
      const shouldAdd = !favStore.has(id);
      const success = await setFavoriteState(id, shouldAdd, { feedback: false });
      if (success) {
        if (shouldAdd) triggerFavAnimation(detailsSave);
        showToast(shouldAdd ? 'Ajout√© aux favoris' : 'Retir√© des favoris');
      }
    });

    if (detailsContact) {
      detailsContact.addEventListener('click', () => {
        if (!contactPopover) {
          showToast('Contact envoy√© au vendeur üì¨');
          return;
        }
        if (contactSending) return;
        if (contactPopover.hasAttribute('hidden')) {
          openContactPopover();
        } else {
          closeContactPopover({ restoreFocus: false });
        }
      });
    }

    contactCancelBtn?.addEventListener('click', () => {
      closeContactPopover({ restoreFocus: true });
    });

    contactCloseBtn?.addEventListener('click', () => {
      closeContactPopover({ restoreFocus: true });
    });

    contactSendBtn?.addEventListener('click', () => {
      sendContactMessage();
    });

    contactMessage?.addEventListener('input', () => {
      clearContactError();
      updateContactCounter();
      autoSizeContactMessage();
    });

    contactMessage?.addEventListener('keydown', (event) => {
      if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
        event.preventDefault();
        sendContactMessage();
      }
    });

    contactSuggestions.forEach((chip) => {
      chip.addEventListener('click', () => {
        if (!contactMessage || chip.hasAttribute('disabled')) return;
        const text = chip.textContent?.trim();
        if (!text) return;
        const needsSpace = contactMessage.value && !contactMessage.value.endsWith(' ');
        contactMessage.value = contactMessage.value.trimEnd();
        contactMessage.value = contactMessage.value
          ? `${contactMessage.value}${needsSpace ? ' ' : ''}${text}`
          : text;
        if (contactMessage.value.length > CONTACT_MAX_LENGTH) {
          contactMessage.value = contactMessage.value.slice(0, CONTACT_MAX_LENGTH);
        }
        updateContactCounter();
        autoSizeContactMessage();
        clearContactError();
        contactMessage.focus({ preventScroll: true });
        requestAnimationFrame(() => {
          const len = contactMessage.value.length;
          contactMessage.setSelectionRange(len, len);
        });
      });
    });

    async function sendContactMessage() {
      if (!contactPopover || contactPopover.hasAttribute('hidden')) return;
      if (!contactMessage) return;
      if (contactSending) return;
      if (!detailsCurrentAd) {
        showContactError('Annonce introuvable. Veuillez r√©essayer.');
        return;
      }
      if (Date.now() < contactCooldownUntil) {
        showContactError('Patientez encore un instant avant un nouvel envoi.');
        return;
      }
      const message = contactMessage.value.trim();
      if (message.length < CONTACT_MIN_LENGTH) {
        showContactError(`Votre message doit contenir au moins ${CONTACT_MIN_LENGTH} caract√®res.`);
        contactMessage.focus({ preventScroll: true });
        return;
      }
      clearContactError();
      setContactLoading(true);
      try {
        await sendContactRequest(detailsCurrentAd.id, message);
        contactCooldownUntil = Date.now() + CONTACT_COOLDOWN_MS;
        showToast('Message envoy√© ‚úÖ');
        if (navMessages) navMessages.setAttribute('data-unread', 'true');
        resetContactForm();
        closeContactPopover({ restoreFocus: true });
      } catch (error) {
        console.error(error);
        setContactLoading(false);
        showContactError('Une erreur est survenue. Merci de r√©essayer.');
        contactMessage.focus({ preventScroll: true });
      }
    }

    function sendContactRequest(adId, message) {
      const payload = { adId, message, sentAt: new Date().toISOString() };
      console.info('[contact] Simulated send', payload);
      const delay = prefersReducedMotion.matches ? 280 : 640 + Math.random() * 320;
      return new Promise((resolve) => {
        setTimeout(() => resolve({ ok: true }), delay);
      });
    }

    window.addEventListener('resize', () => {
      if (!contactPopover || contactPopover.hasAttribute('hidden')) return;
      autoSizeContactMessage();
      updateContactPlacement();
      ensureContactVisibility();
    });

    detailsVisitBtn.addEventListener('click', () => {
      if (!detailsCurrentAd) return;
      const id = detailsDialog?.dataset?.itemId || detailsCurrentAd.id;
      closeDetailsModal();
      animateTo('map', { skipSameStateFocus: true });
      setTimeout(async () => {
        const instance = await ensureMap();
        if (!instance) return;
        instance.invalidateSize();
        focusMarkerById(id);
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
          mapContainer.setAttribute('tabindex', '-1');
          mapContainer.focus({ preventScroll: false });
        }
      }, prefersReducedMotion.matches ? 80 : 220);
    });

    detailsReadMore.addEventListener('click', () => {
      detailsDescExpanded = !detailsDescExpanded;
      updateDescription();
    });

    document.addEventListener('keydown', (e) => {
      if (lightboxActive) {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeLightbox();
          return;
        }
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          changeSlide(1);
          updateLightboxView();
          return;
        }
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          changeSlide(-1);
          updateLightboxView();
          return;
        }
        if (e.key === 'Tab') {
          const focusables = getLightboxFocusables();
          if (!focusables.length) return;
          const activeEl = document.activeElement;
          const currentIndex = focusables.indexOf(activeEl);
          if (e.shiftKey) {
            if (currentIndex <= 0) {
              e.preventDefault();
              focusables[focusables.length - 1]?.focus?.({ preventScroll: true });
            }
          } else {
            if (currentIndex === focusables.length - 1) {
              e.preventDefault();
              focusables[0]?.focus?.({ preventScroll: true });
            }
          }
          return;
        }
      }
      if (detailsModal.style.display !== 'flex') return;
      if (contactTrapActive && e.key === 'Tab') {
        const focusables = getContactFocusables();
        if (!focusables.length) {
          e.preventDefault();
          return;
        }
        const activeEl = document.activeElement;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey) {
          if (activeEl === first || !contactPopover?.contains(activeEl)) {
            e.preventDefault();
            last?.focus?.({ preventScroll: true });
          }
        } else {
          if (activeEl === last || !contactPopover?.contains(activeEl)) {
            e.preventDefault();
            first?.focus?.({ preventScroll: true });
          }
        }
        return;
      }
      if (e.key === 'Escape' && contactPopover && !contactPopover.hasAttribute('hidden')) {
        e.preventDefault();
        closeContactPopover({ restoreFocus: true });
        return;
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        closeDetailsModal();
        return;
      }
      if (e.key === 'ArrowRight') changeSlide(1);
      if (e.key === 'ArrowLeft') changeSlide(-1);
    });

    async function openDetailsById(id, fallback = null) {
      const normalizedId = normalizeAdId(id);
      if (!normalizedId) return;
      let base = fallback || getItemById(normalizedId);
      let hasOpened = false;
      let openedWithSkeleton = false;
      if (base) {
        openDetailsModal(base);
        hasOpened = true;
      } else {
        showDetailsLoadingState(normalizedId);
        hasOpened = true;
        openedWithSkeleton = true;
      }
      const fetched = await fetchAdById(normalizedId);
      if (fetched) {
        if (hasOpened) {
          refreshOpenDetails(fetched);
        } else {
          openDetailsModal(fetched);
        }
        return;
      }
      if (!hasOpened || openedWithSkeleton) {
        closeDetailsModal();
        showToast('Annonce introuvable');
      }
    }

    async function fetchAdById(id) {
      try {
        const response = await api.get(`/api/ads/${id}`);
        if (response?.data?.ad) {
          const mapped = mapAdFromApi(response.data.ad);
          upsertAd(mapped);
          return mapped;
        }
      } catch (error) {
        console.error('fetchAdById error', error);
      }
      return null;
    }

    listView.addEventListener('click', (e) => {
      const adWrapper = e.target.closest('.ad-content');
      if (!adWrapper || e.target.closest('.fav')) return;
      const adId = adWrapper.dataset.id;
      openDetailsById(adId, getItemById(adId));
    });

    // ---------- FAVORITE ANIMATION ----------
    function triggerFavAnimation(buttonEl) {
      if (!buttonEl || buttonEl.classList.contains('animating')) return;

      buttonEl.classList.add('animating');

      // 1. Cr√©er le conteneur pour les particules
      let wrapper = buttonEl.querySelector('.fav-anim-wrapper');
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'fav-anim-wrapper';
        buttonEl.appendChild(wrapper);
      }
      wrapper.innerHTML = ''; // Vider les anciennes particules

      // 2. Cr√©er et animer les particules
      const particleCount = 7;
      const angleIncrement = (2 * Math.PI) / particleCount;
      const radius = 25; // Distance de dispersion

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'fav-particle';
        const angle = i * angleIncrement;
        // Calcul de la position finale pour l'animation
        const tx = `calc(-50% + ${radius * Math.cos(angle)}px)`;
        const ty = `calc(-50% + ${radius * Math.sin(angle)}px)`;
        particle.style.setProperty('--tx', tx);
        particle.style.setProperty('--ty', ty);
        wrapper.appendChild(particle);
      }

      // 3. Nettoyer apr√®s l'animation
      setTimeout(() => { buttonEl.classList.remove('animating'); if (wrapper) wrapper.innerHTML = ''; }, 600);
    }

    // ---------- TOAST ----------
    const toast = document.getElementById('toast');
    function showToast(msg) { toast.textContent = msg; toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 1800); }

    // ---------- FOOTER & LEGAL ----------
    (function footerAndLegal() {
      const footer = document.getElementById('appFooter');
      if (!footer) return;

      const yearEl = document.getElementById('yearNow');
      if (yearEl) yearEl.textContent = String(new Date().getFullYear());

      const newsletterForm = document.getElementById('newsletterForm');
      const newsletterEmail = document.getElementById('newsletterEmail');
      const newsletterBtn = newsletterForm?.querySelector('.mm-news__btn');
      if (newsletterForm) {
        newsletterForm.addEventListener('submit', (event) => {
          event.preventDefault();
          if (!newsletterEmail?.checkValidity()) {
            newsletterEmail?.reportValidity?.();
            newsletterEmail?.focus?.();
            return;
          }
          if (newsletterBtn) newsletterBtn.disabled = true;
          setTimeout(() => {
            showToast('Merci ! Vous recevrez prochainement nos actualit√©s.');
            newsletterForm.reset();
            if (newsletterBtn) newsletterBtn.disabled = false;
          }, 600);
        });
      }

      footer.querySelectorAll('[data-nav]').forEach((link) => {
        link.addEventListener('click', (event) => {
          event.preventDefault();
          const target = link.getAttribute('data-nav');
          if (target === 'map') {
            animateTo('map', { skipSameStateFocus: true });
          } else if (target === 'list') {
            animateTo('list', { skipSameStateFocus: true });
          } else {
            showToast('Fonctionnalit√© bient√¥t disponible ‚ú®');
          }
        });
      });

      const legalModal = document.getElementById('legalModal');
      const legalBody = document.getElementById('legalBody');
      const legalTitle = document.getElementById('legalTitle');
      const legalDialog = legalModal?.querySelector('.mm-modal__dialog');
      const focusSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
      let legalLastFocus = null;

      const legalContent = {
        terms: { title: 'Conditions d‚Äôutilisation', html: buildTermsHtml },
        privacy: { title: 'Politique de confidentialit√©', html: buildPrivacyHtml },
        cookies: { title: 'Politique relative aux cookies', html: buildCookiesHtml }
      };

      function getLegalFocusables() {
        if (!legalModal || legalModal.hidden) return [];
        const nodes = Array.from(legalModal.querySelectorAll(focusSelectors));
        return nodes.filter((el) => {
          if (el.hasAttribute('disabled')) return false;
          if (el.getAttribute('aria-hidden') === 'true') return false;
          if (el === legalDialog || el === legalBody) return true;
          return el.offsetParent !== null;
        });
      }

      function handleTrapKeydown(event) {
        if (!legalModal?.classList.contains('mm-open')) return;
        if (event.key === 'Escape') {
          event.preventDefault();
          closeLegalModal();
          return;
        }
        if (event.key !== 'Tab') return;
        const focusables = getLegalFocusables();
        if (!focusables.length) return;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (event.shiftKey) {
          if (document.activeElement === first || !focusables.includes(document.activeElement)) {
            event.preventDefault();
            last.focus({ preventScroll: true });
          }
        } else {
          if (document.activeElement === last) {
            event.preventDefault();
            first.focus({ preventScroll: true });
          }
        }
      }

      function openLegalModal(key) {
        if (!legalModal || !legalBody || !legalTitle) return;
        const data = legalContent[key];
        if (!data) return;
        const alreadyOpen = legalModal.classList.contains('mm-open') && !legalModal.hidden;
        legalBody.scrollTop = 0;
        legalTitle.textContent = data.title;
        legalBody.innerHTML = data.html();
        if (alreadyOpen) {
          requestAnimationFrame(() => {
            const focusables = getLegalFocusables();
            (focusables[0] || legalDialog)?.focus?.({ preventScroll: true });
          });
          return;
        }
        legalLastFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
        legalModal.hidden = false;
        legalModal.setAttribute('aria-hidden', 'false');
        lockBodyScroll();
        requestAnimationFrame(() => {
          legalModal.classList.add('mm-open');
          const focusables = getLegalFocusables();
          (focusables[0] || legalDialog)?.focus?.({ preventScroll: true });
        });
        document.addEventListener('keydown', handleTrapKeydown, true);
      }

      function closeLegalModal() {
        if (!legalModal || legalModal.hidden) return;
        legalModal.classList.remove('mm-open');
        legalModal.setAttribute('aria-hidden', 'true');
        document.removeEventListener('keydown', handleTrapKeydown, true);
        unlockBodyScroll();
        setTimeout(() => {
          legalModal.hidden = true;
          legalBody.scrollTop = 0;
          legalBody.innerHTML = '';
          if (legalLastFocus && typeof legalLastFocus.focus === 'function') {
            legalLastFocus.focus({ preventScroll: true });
          }
          legalLastFocus = null;
        }, 200);
      }

      legalModal?.addEventListener('click', (event) => {
        const closeTrigger = event.target.closest('[data-close]');
        if (closeTrigger) {
          event.preventDefault();
          closeLegalModal();
        }
      });

      legalBody?.addEventListener('click', (event) => {
        const link = event.target.closest('[data-legal]');
        if (!link) return;
        event.preventDefault();
        openLegalModal(link.getAttribute('data-legal'));
      });

      footer.addEventListener('click', (event) => {
        const link = event.target.closest('[data-legal]');
        if (!link) return;
        event.preventDefault();
        openLegalModal(link.getAttribute('data-legal'));
      });

      function buildTermsHtml() {
        const date = new Date().toLocaleDateString('fr-FR');
        return `
          <p><em>Derni√®re mise √† jour : ${date}</em></p>
          <h3>1. Objet</h3>
          <p>MapMarket est une plateforme permettant de rechercher, comparer et localiser des offres pr√®s de vous. Les pr√©sentes conditions r√©gissent l‚Äôacc√®s et l‚Äôutilisation du service.</p>
          <h3>2. Compte &amp; √©ligibilit√©</h3>
          <ul>
            <li>Vous devez avoir au moins 16 ans pour utiliser MapMarket.</li>
            <li>Vous √™tes responsable de la confidentialit√© de vos identifiants.</li>
            <li>Vous nous informez sans d√©lai de tout acc√®s non autoris√©.</li>
          </ul>
          <h3>3. Utilisation acceptable</h3>
          <ul>
            <li>Ne pas perturber ou contourner la s√©curit√© du service.</li>
            <li>Ne pas extraire massivement les donn√©es (scraping) sans autorisation √©crite.</li>
            <li>Respecter les lois applicables et les droits des tiers.</li>
          </ul>
          <h3>4. Contenus &amp; annonces</h3>
          <p>Les contenus publi√©s par des tiers (annonces, visuels, prix) engagent leurs auteurs. MapMarket peut retirer tout contenu illicite, trompeur ou contraire aux pr√©sentes.</p>
          <h3>5. Donn√©es &amp; confidentialit√©</h3>
          <p>Nous traitons vos donn√©es conform√©ment √† notre <a href="#" data-legal="privacy">Politique de confidentialit√©</a>.</p>
          <h3>6. Propri√©t√© intellectuelle</h3>
          <p>MapMarket et ses √©l√©ments sont prot√©g√©s. Toute reproduction non autoris√©e est interdite.</p>
          <h3>7. Disponibilit√© &amp; modification du service</h3>
          <p>Nous pouvons modifier ou interrompre tout ou partie du service pour maintenance, √©volution ou cas de force majeure.</p>
          <h3>8. Responsabilit√©</h3>
          <p>Le service est fourni ¬´ en l‚Äô√©tat ¬ª. MapMarket ne peut √™tre tenue responsable des pertes indirectes ou immat√©rielles r√©sultant de l‚Äôusage du service.</p>
          <h3>9. R√©siliation</h3>
          <p>Nous pouvons suspendre ou r√©silier l‚Äôacc√®s en cas de violation des pr√©sentes.</p>
          <h3>10. Droit applicable</h3>
          <p>Les pr√©sentes sont r√©gies par le droit fran√ßais. En cas de litige, comp√©tence des tribunaux de Paris, sous r√©serve de dispositions imp√©ratives.</p>
          <h3>11. Contact</h3>
          <p>Contact : <a href="mailto:support@mapmarket.app">support@mapmarket.app</a></p>
        `;
      }

      function buildPrivacyHtml() {
        const date = new Date().toLocaleDateString('fr-FR');
        return `
          <p><em>Derni√®re mise √† jour : ${date}</em></p>
          <h3>1. Responsable du traitement</h3>
          <p>MapMarket (√©diteur) est responsable du traitement des donn√©es collect√©es via l‚Äôapplication.</p>
          <h3>2. Donn√©es collect√©es</h3>
          <ul>
            <li>Donn√©es de compte : e-mail, nom (si fourni), pr√©f√©rences.</li>
            <li>Donn√©es d‚Äôusage : pages visit√©es, recherches, actions (logs).</li>
            <li>G√©olocalisation (si consentie) pour afficher des r√©sultats proches.</li>
            <li>Cookies et identifiants techniques (voir Politique cookies).</li>
          </ul>
          <h3>3. Finalit√©s</h3>
          <ul>
            <li>Fourniture du service, personnalisation des r√©sultats.</li>
            <li>Mesure d‚Äôaudience, pr√©vention de la fraude, s√©curit√©.</li>
            <li>Communication (newsletter si consentement).</li>
          </ul>
          <h3>4. Base l√©gale</h3>
          <p>Ex√©cution du contrat (service), int√©r√™t l√©gitime (s√©curit√©/analytics), consentement (newsletter, g√©olocalisation, cookies non essentiels).</p>
          <h3>5. Dur√©es de conservation</h3>
          <p>Donn√©es de compte : pendant l‚Äôutilisation + 3 ans d‚Äôarchivage limit√©. Logs : 12 mois max. Cookies : selon leur finalit√© (voir Politique cookies).</p>
          <h3>6. Partage</h3>
          <p>Prestataires (h√©bergement, e-mailing, analytics) dans l‚ÄôUE ou pays ad√©quats. Aucune vente de donn√©es.</p>
          <h3>7. Vos droits</h3>
          <p>Acc√®s, rectification, effacement, opposition, portabilit√©, limitation. Exercer : <a href="mailto:privacy@mapmarket.app">privacy@mapmarket.app</a>. Droit de r√©clamation : CNIL.</p>
          <h3>8. S√©curit√©</h3>
          <p>Mesures techniques et organisationnelles raisonnables (chiffrement en transit, contr√¥le d‚Äôacc√®s, sauvegardes).</p>
          <h3>9. Enfants</h3>
          <p>Service non destin√© aux moins de 16 ans.</p>
          <h3>10. Modifications</h3>
          <p>Nous pouvons mettre √† jour la pr√©sente politique ; en cas de changement significatif, une information appropri√©e est fournie.</p>
        `;
      }

      function buildCookiesHtml() {
        const date = new Date().toLocaleDateString('fr-FR');
        return `
          <p><em>Derni√®re mise √† jour : ${date}</em></p>
          <h3>1. Qu‚Äôest-ce qu‚Äôun cookie ?</h3>
          <p>Petit fichier texte d√©pos√© sur votre terminal pour reconna√Ætre votre navigateur, mesurer l‚Äôaudience et personnaliser l‚Äôexp√©rience.</p>
          <h3>2. Types de cookies utilis√©s</h3>
          <ul>
            <li>Strictement n√©cessaires : s√©curit√©, session, pr√©f√©rences techniques.</li>
            <li>Mesure d‚Äôaudience : statistiques agr√©g√©es (ex. pages vues).</li>
            <li>Fonctionnels : g√©olocalisation consentie, sauvegarde de filtres.</li>
            <li>Marketing (le cas √©ch√©ant) : uniquement avec consentement.</li>
          </ul>
          <h3>3. Gestion du consentement</h3>
          <p>Vous pouvez accepter ou refuser les cat√©gories non essentielles via le gestionnaire de consentement (banni√®re, param√®tres) et votre navigateur.</p>
          <h3>4. Dur√©es</h3>
          <p>De la session √† 13 mois selon la finalit√©. Les traceurs √©quivalents (localStorage/ID) suivent les m√™mes principes.</p>
          <h3>5. Param√®tres</h3>
          <p>Pour plus d‚Äôinformations ou exercer vos droits : <a href="mailto:privacy@mapmarket.app">privacy@mapmarket.app</a>.</p>
        `;
      }
    })();

    // ---------- INIT ----------
    const initialAuth = authStore.get();
    if (initialAuth) {
      applyFavoritesFromUser(initialAuth);
    }
    updateAuthUI();
    loadAds();
    hydrateAuthFromSession();
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => { });
      });
    }
    })();
  </script>
</body>
</html>
