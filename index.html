<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MapMarket — Liste + Carte + Infini</title>
  <!-- Leaflet & MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <style>
    :root {
      --primary: #ff4d6d;
      --primary-600: #ff5875;
      --primary-700: #ff3f62;
      --bg: #f6f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #111827;
      --border: #e5e7eb;
      --chip: #eff6ff;
      --chip-text: #1d4ed8;
      --shadow: 0 12px 26px rgba(0, 0, 0, .10);
      --glass: rgba(255, 255, 255, .6)
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", sans-serif;
      color: var(--text);
      background: var(--bg)
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 30;
      background: #fff;
      border-bottom: 1px solid var(--border);
      backdrop-filter: saturate(150%) blur(6px)
    }

    .container {
      max-width: 1120px;
      margin-inline: auto;
      padding: 0 20px
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit
    }

    .brand .pin {
      width: 28px;
      height: 28px;
      color: var(--primary)
    }

    .brand b {
      font-size: 20px
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 14px
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      color: #374151;
      text-decoration: none
    }

    button.nav-link {
      background: none;
      border: none;
      font: inherit;
      color: inherit;
      cursor: pointer;
    }

    .nav-link:hover {
      background: #f3f4f6
    }

    .pill {
      position: relative
    }

    .pill .badge {
      position: absolute;
      right: -6px;
      top: -6px;
      min-width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--primary);
      color: #fff;
      font-size: 11px;
      display: grid;
      place-items: center;
      padding: 0 6px;
      box-shadow: 0 6px 16px rgba(255, 77, 109, .35)
    }

    .cta {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-weight: 650;
      cursor: pointer;
      box-shadow: 0 8px 22px rgba(255, 77, 109, .35)
    }

    .cta:hover {
      filter: brightness(1.03)
    }

    .avatar {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
    }

    .avatar-btn {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform .25s ease, box-shadow .25s ease, background .25s ease;
      color: #fff;
    }

    .avatar-btn svg {
      width: 22px;
      height: 22px;
    }

    .avatar-btn.needs-auth {
      background: #f3f4f6;
      color: var(--primary);
      border: 1px solid var(--border);
      box-shadow: 0 4px 14px rgba(15, 23, 42, .12);
    }

    .avatar-btn.needs-auth:hover {
      background: #fff;
      transform: translateY(-1px);
    }

    .avatar-btn.is-auth {
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      box-shadow: 0 10px 26px rgba(255, 77, 109, .35);
    }

    .avatar-btn.is-auth:hover {
      transform: translateY(-1px);
    }

    .avatar-btn:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 3px;
    }

    /* Hero */
    .hero {
      padding: 24px 0 4px;
      text-align: center
    }

    .hero h1 {
      font-size: 36px;
      line-height: 1.1;
      margin: 0 0 10px
    }

    .hero p {
      color: #6b7280;
      margin: 0
    }

    /* Filters card */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
    }

    .filters-card {
      padding: 26px 28px 30px;
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, .18);
      background: linear-gradient(140deg, rgba(255, 255, 255, .96) 0%, rgba(245, 246, 250, .92) 100%);
      box-shadow: 0 26px 48px rgba(15, 23, 42, .08);
      backdrop-filter: blur(18px);
    }

    .filters-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 22px;
    }

    .filters-title {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .filters-title svg {
      width: 36px;
      height: 36px;
      padding: 8px;
      border-radius: 12px;
      background: rgba(255, 77, 109, .12);
      color: var(--primary);
    }

    .filters-heading {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .filters-subheading {
      margin: 2px 0 0;
      color: #6b7280;
      font-size: 13px;
    }

    .filters-reset {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .35);
      background: rgba(255, 255, 255, .6);
      color: #374151;
      font-weight: 600;
      cursor: pointer;
      transition: all .25s ease;
      backdrop-filter: blur(12px);
    }

    .filters-reset svg {
      width: 16px;
      height: 16px;
    }

    .filters-reset:hover {
      border-color: rgba(255, 77, 109, .4);
      color: var(--primary);
      box-shadow: 0 8px 24px rgba(255, 77, 109, .18);
    }

    .filters-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .filter-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      font-weight: 600;
      font-size: 13px;
      color: #4b5563;
      letter-spacing: .01em;
    }

    .filter-control {
      position: relative;
      display: flex;
      align-items: center;
      height: 48px;
      border-radius: 14px;
      background: rgba(255, 255, 255, .92);
      border: 1px solid rgba(148, 163, 184, .28);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, .6), 0 6px 18px rgba(15, 23, 42, .06);
      transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
    }

    .filter-control:focus-within {
      border-color: rgba(255, 77, 109, .6);
      box-shadow: 0 10px 30px rgba(255, 77, 109, .18), inset 0 1px 0 rgba(255, 255, 255, .8);
      transform: translateY(-1px);
    }

    .filter-control input,
    .filter-control select {
      width: 100%;
      height: 100%;
      border: none;
      background: transparent;
      padding: 0 16px 0 44px;
      font: inherit;
      color: var(--text);
    }

    .filter-control select {
      appearance: none;
      padding-right: 42px;
      cursor: pointer;
    }

    .filter-control input::placeholder {
      color: #9ca3af;
    }

    .filter-icon {
      position: absolute;
      left: 16px;
      width: 18px;
      height: 18px;
      color: #a1a9b8;
      pointer-events: none;
    }

    .filter-chevron {
      position: absolute;
      right: 16px;
      width: 16px;
      height: 16px;
      color: #a1a9b8;
      pointer-events: none;
    }

    .filter-search {
      grid-column: span 2;
    }

    @media (max-width: 1024px) {
      .filter-search {
        grid-column: span 1;
      }
    }

    @media (max-width: 640px) {
      .filters-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .filters-reset {
        width: 100%;
        justify-content: center;
      }
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      justify-content: flex-start;
      margin: 16px 0
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer
    }

    .tab.active {
      box-shadow: 0 2px 8px rgba(0, 0, 0, .06)
    }

    /* Grid & Map */
    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(4, 1fr)
    }

    @media (max-width:1180px) {
      .grid {
        grid-template-columns: repeat(3, 1fr)
      }
    }

    @media (max-width:880px) {
      .grid {
        grid-template-columns: repeat(2, 1fr)
      }
    }

    @media (max-width:560px) {
      .grid {
        grid-template-columns: 1fr
      }
    }

    #map {
      height: 560px;
      border: 1px solid var(--border);
      border-radius: 16px;
      display: none
    }

    /* Card item */
    .ad {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: box-shadow .25s
    }

    .ad:hover {
      box-shadow: var(--shadow)
    }

    .thumb {
      position: relative;
      aspect-ratio: 4/3;
      background: #eef
    }

    .thumb img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover
    }

    .grad {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, .45), transparent 60%)
    }

    .cat {
      position: absolute;
      left: 10px;
      top: 10px;
      color: #fff;
      font-weight: 700;
      font-size: 13px;
      border-radius: 999px;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .immobilier {
      background: linear-gradient(135deg, #6366f1, #818cf8)
    }

    .mode {
      background: linear-gradient(135deg, #ec4899, #f472b6)
    }

    .hitech {
      background: linear-gradient(135deg, #8b5cf6, #a78bfa)
    }

    .auto {
      background: linear-gradient(135deg, #f59e0b, #f97316)
    }

    .maison {
      background: linear-gradient(135deg, #10b981, #34d399)
    }

    .fav {
      position: absolute;
      right: 10px;
      top: 10px;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .9);
      backdrop-filter: blur(4px);
      display: grid;
      place-items: center;
      box-shadow: 0 10px 18px rgba(0, 0, 0, .14);
      border: none;
      cursor: pointer
    }

    .fav svg {
      width: 18px;
      height: 18px;
      color: #374151
    }

    .body {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .titleprice {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      justify-content: space-between
    }

    .title {
      font-weight: 700;
      font-size: 16px;
      line-height: 1.2
    }

    .price {
      color: var(--primary);
      font-weight: 800;
      font-size: 18px;
      white-space: nowrap
    }

    .desc {
      color: #4b5563;
      font-size: 13px;
      line-height: 1.4;
      /* Ajout pour tronquer le texte */
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px
    }

    .chip {
      background: var(--chip);
      border: 1px solid #bfdbfe;
      color: var(--chip-text);
      border-radius: 999px;
      font-size: 12px;
      padding: 4px 10px
    }

    .meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      color: #374151
    }

    .loc {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0
    }

    .loc svg {
      width: 14px;
      height: 14px
    }

    .state {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      white-space: nowrap
    }

    .stats {
      display: flex;
      gap: 12px;
      color: #6b7280;
    }
    .thumb .stats {
      position: absolute;
      bottom: 10px;
      right: 10px;
      color: #fff;
      text-shadow: 0 1px 3px rgba(0,0,0,.3);
    }

    .time {
      margin-top: -4px;
      color: #6b7280;
      font-size: 12px
    }

    /* Infinite loader */
    #sentinel {
      height: 1px
    }

    .loading {
      display: grid;
      place-items: center;
      margin: 16px 0;
      color: var(--muted)
    }

    /* Modal base */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, .55);
      backdrop-filter: blur(6px);
      z-index: 50;
    }

    .modal {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 24px 48px rgba(15, 23, 42, .28);
      overflow: hidden;
    }

    .modal .pane {
      padding: 22px;
    }

    /* Auth modal */
    .auth-backdrop {
      display: flex;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .4s cubic-bezier(.4, 0, .2, 1), visibility 0s .4s;
    }

    .auth-backdrop.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transition: opacity .4s cubic-bezier(.4, 0, .2, 1), visibility 0s;
    }

    .auth-dialog {
      position: relative;
      background: #fff;
      border-radius: 24px;
      overflow: hidden;
      width: min(900px, 94vw);
      min-height: 600px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      transform: scale(.92) translateY(40px);
      opacity: 0;
      transition: transform .4s cubic-bezier(.4, 0, .2, 1), opacity .4s cubic-bezier(.4, 0, .2, 1);
    }

    .auth-backdrop.active .auth-dialog {
      transform: scale(1) translateY(0);
      opacity: 1;
    }

    .auth-close {
      position: absolute;
      top: 24px;
      right: 24px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, .25);
      backdrop-filter: blur(6px);
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      transition: transform .3s ease, background .3s ease;
      z-index: 5;
    }

    .auth-close:hover {
      background: rgba(255, 255, 255, .38);
      transform: rotate(90deg);
    }

    .auth-hero {
      position: relative;
      background: linear-gradient(135deg, #ff4d6d 0%, #ff6b8a 100%);
      color: #fff;
      padding: 40px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      overflow: hidden;
    }

    .auth-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, .16) 0%, transparent 70%);
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0) rotate(0deg);
      }

      50% {
        transform: translateY(-18px) rotate(4deg);
      }
    }

    .auth-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
      z-index: 2;
    }

    .auth-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .auth-brand .pin {
      width: 32px;
      height: 32px;
      filter: drop-shadow(0 6px 16px rgba(0, 0, 0, .2));
    }

    .auth-brand strong {
      font-size: 24px;
      letter-spacing: -.4px;
    }

    .auth-hero-content {
      position: relative;
      z-index: 2;
    }

    .auth-hero-content h2 {
      font-size: 32px;
      font-weight: 700;
      margin: 0 0 12px 0;
      line-height: 1.2;
    }

    .auth-hero-content p {
      font-size: 16px;
      opacity: .9;
      margin: 0;
      line-height: 1.5;
    }

    .auth-hero-illus {
      position: relative;
      z-index: 2;
      font-size: 84px;
      text-align: center;
      opacity: .85;
      margin-top: 40px;
    }

    .auth-pane {
      padding: 40px;
      display: flex;
      flex-direction: column;
    }

    .auth-tabs {
      position: relative;
      display: flex;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 32px;
    }

    .auth-tab {
      flex: 1;
      background: transparent;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: color .3s ease;
      position: relative;
      z-index: 2;
      color: #4b5563;
    }

    .auth-tab.active {
      color: #ff4d6d;
    }

    .auth-indicator {
      position: absolute;
      top: 4px;
      left: 4px;
      width: calc(50% - 4px);
      height: calc(100% - 8px);
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(15, 23, 42, .12);
      transition: transform .3s cubic-bezier(.4, 0, .2, 1), opacity .2s ease;
    }

    .auth-indicator.signup {
      transform: translateX(100%);
    }

    .auth-indicator.hidden {
      opacity: 0;
    }

    .auth-forms {
      position: relative;
      overflow: hidden;
      min-height: 400px;
      flex: 1;
    }

    .auth-form {
      width: 100%;
      transition: transform .4s cubic-bezier(.4, 0, .2, 1), opacity .3s ease;
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      transform: translateX(20%);
      pointer-events: none;
      display: flex;
      flex-direction: column;
      gap: 18px;
      padding-right: 2px;
    }

    .auth-form.active {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }

    .auth-label {
      display: block;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .auth-input-wrapper {
      position: relative;
    }

    .auth-input {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      transition: border-color .3s ease, box-shadow .3s ease;
      background: #fff;
    }

    .auth-input:focus {
      outline: none;
      border-color: #ff4d6d;
      box-shadow: 0 0 0 3px rgba(255, 77, 109, .15);
    }

    .auth-input.error {
      border-color: #e53e3e;
      box-shadow: 0 0 0 3px rgba(229, 62, 62, .18);
    }

    .password-toggle {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: none;
      cursor: pointer;
      font-size: 18px;
      opacity: .6;
      transition: opacity .3s ease;
    }

    .password-toggle:hover {
      opacity: 1;
    }

    .auth-submit {
      width: 100%;
      background: linear-gradient(135deg, #ff4d6d 0%, #ff6b8a 100%);
      color: #fff;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform .3s ease, box-shadow .3s ease;
      margin-top: 6px;
      position: relative;
      overflow: hidden;
    }

    .auth-submit:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 28px rgba(255, 77, 109, .35);
    }

    .auth-submit:active {
      transform: translateY(0);
    }

    .auth-submit.loading {
      pointer-events: none;
      color: transparent;
    }

    .auth-submit.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid rgba(255, 255, 255, .4);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .auth-forgot {
      text-align: center;
      margin-top: 16px;
    }

    .auth-forgot button {
      background: none;
      border: none;
      color: #ff4d6d;
      cursor: pointer;
      font-weight: 600;
      text-decoration: underline;
    }

    .auth-demo {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      font-size: 12px;
      color: #718096;
      margin-top: 24px;
    }

    .auth-success {
      background: #f0fff4;
      border: 1px solid #9ae6b4;
      color: #22543d;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
    }

    .form-error {
      color: #e53e3e;
      font-size: 12px;
      margin-top: 6px;
    }

    .slide-out-left {
      transform: translateX(-100%) !important;
      opacity: 0 !important;
    }

    .slide-out-right {
      transform: translateX(100%) !important;
      opacity: 0 !important;
    }

    .slide-in-left {
      transform: translateX(-100%);
      opacity: 0;
    }

    .slide-in-right {
      transform: translateX(100%);
      opacity: 0;
    }

    @media (max-width: 768px) {
      .auth-dialog {
        grid-template-columns: 1fr;
        min-height: auto;
      }

      .auth-hero {
        padding: 32px;
        min-height: 220px;
      }

      .auth-pane {
        padding: 32px 28px;
      }

      .auth-forms {
        min-height: 360px;
      }

      .auth-hero-content h2 {
        font-size: 26px;
      }

      .auth-hero-illus {
        font-size: 62px;
        margin-top: 24px;
      }
    }

    /* Leaflet overrides + cluster style */
    .leaflet-container {
      font: inherit
    }

    .marker-cluster-small,
    .marker-cluster-medium,
    .marker-cluster-large {
      background: transparent
    }

    .marker-cluster div {
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      color: #fff;
      border: 2px solid #fff;
      box-shadow: 0 6px 16px rgba(255, 77, 109, .35);
    }

    .marker-cluster span {
      font-weight: 800
    }

    /* Toast */
    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      display: none;
      background: #111827;
      color: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      box-shadow: var(--shadow);
      z-index: 60
    }

    /* --- Animation Favoris --- */
    .fav-anim-wrapper {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      border-radius: inherit;
    }

    .fav-particle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: var(--primary);
      opacity: 0;
      /* L'animation est déclenchée par JS */
    }

    .fav.animating .fav-particle {
      animation: fav-burst 0.6s ease-out forwards;
    }

    .fav.animating svg,
    .cta-outline.animating svg {
      animation: fav-pop 0.6s cubic-bezier(0.25, 0.1, 0.25, 1.5) forwards;
    }

    @keyframes fav-pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.35); }
      100% { transform: scale(1); }
    }

    @keyframes fav-burst {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0.8;
      }
      100% {
        /* La translation finale est définie via une variable CSS par JS */
        transform: translate(var(--tx, -50%), var(--ty, -50%)) scale(0);
        opacity: 0;
      }
    }
    /* S'assure que le SVG a une transition douce pour le remplissage */
    .fav svg path, .details-actions .cta-outline svg path {
      transition: fill 0.2s ease;
    }
  </style>
  <!-- Styles pour le modal de détails -->
  <style>
    .details-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 28px 16px;
      background:
        radial-gradient(circle at 15% 20%, rgba(255, 77, 109, .12), transparent 60%),
        radial-gradient(circle at 85% 10%, rgba(14, 165, 233, .1), transparent 55%),
        rgba(15, 23, 42, .38);
      backdrop-filter: blur(12px);
      z-index: 70;
    }

    .details-backdrop.active {
      display: flex;
    }

    .details-dialog {
      position: relative;
      width: min(40vw, 700px);
      max-height: min(92vh, 820px);
      background: #ffffff;
      border-radius: 26px;
      overflow: hidden;
      box-shadow: 0 40px 80px rgba(15, 23, 42, .32);
      display: grid;
      grid-template-rows: auto 1fr;
      border: 1px solid rgba(226, 232, 240, .55);
      animation: modalIn .45s cubic-bezier(.2, .8, .2, 1);
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translateY(40px) scale(.96);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .details-close {
      position: absolute;
      top: 22px;
      right: 22px;
      width: 46px;
      height: 46px;
      border-radius: 16px;
      border: none;
      background: rgba(255, 255, 255, .9);
      box-shadow: 0 16px 32px rgba(15, 23, 42, .18);
      backdrop-filter: blur(14px);
      color: #111827;
      font-size: 22px;
      cursor: pointer;
      z-index: 5;
      transition: transform .28s ease, background .3s ease, color .3s ease;
    }

    .details-close:hover {
      transform: translateY(-1px) rotate(90deg);
      background: rgba(255, 77, 109, .14);
      color: var(--primary);
    }

    .details-media {
      position: relative;
      background: #f1f5f9;
      aspect-ratio: 16 / 9;
      overflow: hidden;
    }

    .details-carousel {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .carousel-track {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .carousel-slide {
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity .4s ease;
    }

    .carousel-slide.active {
      opacity: 1;
      z-index: 1;
    }

    .carousel-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .carousel-nav {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      transform: translateY(-50%);
      padding: 0 12px;
      pointer-events: none;
      z-index: 2;
    }

    .carousel-btn {
      width: 42px;
      height: 42px;
      border: none;
      border-radius: 999px;
      background: rgba(17, 24, 39, .55);
      color: #fff;
      display: grid;
      place-items: center;
      cursor: pointer;
      pointer-events: auto;
      transition: transform .2s ease, background .2s ease;
    }

    .carousel-btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 77, 109, .75);
    }

    .carousel-meta {
      position: absolute;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      z-index: 3;
    }

    .carousel-counter {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(17, 24, 39, .52);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
    }

    .carousel-dots {
      display: flex;
      gap: 8px;
    }

    .carousel-dot {
      width: 32px;
      height: 4px;
      border-radius: 999px;
      border: none;
      background: rgba(255, 255, 255, .45);
      cursor: pointer;
      transition: background .2s ease, transform .2s ease, width .2s ease;
    }

    .carousel-dot.active {
      width: 42px;
      background: var(--primary);
      transform: translateY(-1px);
    }

    .carousel-tools {
      position: absolute;
      right: 20px;
      bottom: 20px;
      display: flex;
      gap: 12px;
      z-index: 2;
    }

    .tool-btn {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      border: none;
      background: rgba(255, 255, 255, .9);
      box-shadow: 0 10px 24px rgba(15, 23, 42, .18);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform .2s ease, background .2s ease;
    }

    .tool-btn svg {
      width: 20px;
      height: 20px;
      color: #111827;
    }

    .tool-btn:hover {
      transform: translateY(-2px);
      background: rgba(255, 77, 109, .12);
    }

    .details-skeleton {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(110deg, rgba(236, 241, 247, .7) 25%, rgba(255, 255, 255, .9) 45%, rgba(236, 241, 247, .7) 65%);
      background-size: 200% 100%;
      border-radius: inherit;
      opacity: 0;
      transition: opacity .25s ease;
      z-index: 3;
    }

    .details-skeleton.active {
      opacity: 1;
      animation: shimmer 1.4s linear infinite;
    }

    .details-skeleton::after {
      content: '';
      position: absolute;
      inset: 30px;
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, .15);
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .details-body {
      padding: 32px 32px 34px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 26px;
      background: #fff;
    }

    .details-hero-card {
      display: flex;
      justify-content: space-between;
      gap: 28px;
      align-items: flex-start;
      border-bottom: 1px solid rgba(226, 232, 240, .8);
      padding-bottom: 22px;
    }

    .details-hero-info {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-width: min(70%, 520px);
    }

    .details-hero-info h2 {
      margin: 0;
      font-size: 30px;
      font-weight: 800;
      color: #0f172a;
    }

    .details-hero-info .cat {
      position: static;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 700;
      color: #fff;
      box-shadow: 0 12px 26px rgba(15, 23, 42, .18);
      margin-bottom: 0;
    }

    .details-hero-info .cat span {
      white-space: nowrap;
    }

    .details-price {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      min-width: 120px;
      box-shadow: 0 14px 30px rgba(255, 77, 109, .22);
    }

    .details-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 4px;
    }

    .details-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: .01em;
      background: rgba(241, 245, 249, .9);
      color: #475569;
      border: 1px solid rgba(226, 232, 240, .7);
    }

    .details-meta-item svg {
      width: 14px;
      height: 14px;
    }

    .details-meta-item .label {
      line-height: 1.2;
    }

    .details-meta-item.cat {
      background: rgba(255, 77, 109, .18);
      color: var(--primary);
      border-color: rgba(255, 77, 109, .22);
    }

    .details-meta-item.location {
      background: rgba(59, 130, 246, .16);
      color: #1d4ed8;
      border-color: rgba(59, 130, 246, .24);
    }

    .details-meta-item.date {
      background: rgba(129, 140, 248, .16);
      color: #4338ca;
      border-color: rgba(129, 140, 248, .24);
    }

    .details-meta-item.views {
      background: rgba(34, 197, 94, .16);
      color: #15803d;
      border-color: rgba(34, 197, 94, .26);
    }

    .details-meta-item.fav-meta {
      background: rgba(251, 191, 36, .18);
      color: #b45309;
      border-color: rgba(251, 191, 36, .28);
    }

    .details-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .details-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .details-tag {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(148, 163, 184, .16);
      color: #475569;
      font-size: 13px;
      font-weight: 600;
    }

    .details-section h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }

    .details-desc {
      color: #425066;
      line-height: 1.7;
      margin: 0;
      font-size: 15px;
    }

    .details-section:not(:last-of-type) {
      padding-bottom: 12px;
      border-bottom: 1px dashed rgba(226, 232, 240, .8);
    }

    .details-readmore {
      align-self: flex-start;
      border: none;
      background: none;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      display: none;
    }

    .details-readmore.visible {
      display: inline-flex;
    }

    .seller-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 18px;
      border-radius: 16px;
      background: rgba(248, 250, 252, .9);
      border: 1px solid rgba(226, 232, 240, .8);
      box-shadow: 0 12px 32px rgba(15, 23, 42, .08);
    }

    .seller-card img {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      object-fit: cover;
    }

    .seller-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      color: #4b5563;
    }

    .seller-meta strong {
      font-size: 15px;
      color: #0f172a;
    }

    .details-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-top: auto;
    }

    .details-actions button {
      flex: 1;
      min-width: 160px;
      height: 48px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: transform .2s ease, box-shadow .2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .details-actions button svg {
      width: 18px;
      height: 18px;
    }

    .cta-outline {
      background: rgba(255, 255, 255, .9);
      border: 1px solid rgba(148, 163, 184, .35);
      color: #1f2937;
    }

    .cta-outline.active {
      border-color: rgba(255, 77, 109, .5);
      color: var(--primary);
      box-shadow: 0 8px 20px rgba(255, 77, 109, .15);
    }

    .cta-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      color: #fff;
      box-shadow: 0 16px 34px rgba(255, 77, 109, .32);
    }

    .cta-secondary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      box-shadow: 0 16px 34px rgba(34, 197, 94, .28);
    }

    .details-actions button:hover {
      transform: translateY(-1px);
    }

    @media (max-width: 960px) {
      .details-dialog {
        width: min(70vw, 700px);
        max-height: 95vh;
      }

      .details-body {
        padding: 32px 20px 28px;
      }

      .details-hero-card {
        flex-direction: column;
        gap: 20px;
      }

      .details-price {
        align-items: flex-start;
      }
    }

    @media (max-width: 640px) {
      .details-dialog {
        border-radius: 20px;
        width: 92vw;
      }

      .carousel-nav {
        padding: 0 8px;
      }

      .carousel-btn {
        width: 36px;
        height: 36px;
      }

      .carousel-tools {
        bottom: 14px;
        right: 14px;
      }

      .details-actions {
        flex-direction: column;
      }

      .details-hero-card {
        padding: 20px;
      }

      .details-hero-info .cat {
        margin-bottom: 14px;
      }

      .details-price {
        width: 100%;
        gap: 8px;
        align-items: center;
      }
    }
  </style>
  <!-- Styles pour le panneau des favoris -->
  <style>
    :root {
      --mm-card: #ffffff;
      --mm-text: #111827;
      --mm-muted: #6b7280;
      --mm-ring: 0 10px 30px rgba(0, 0, 0, .12);
      --mm-blur: saturate(1.2) blur(6px);
      --mm-radius: 18px;
      --mm-ease: cubic-bezier(.22, .61, .36, 1);
    }

    .mm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(17, 25, 40, .45);
      backdrop-filter: var(--mm-blur);
      opacity: 0;
      transition: opacity .25s var(--mm-ease);
      z-index: 80;
      pointer-events: none;
    }

    .mm-overlay.mm-show {
      opacity: 1;
      pointer-events: auto;
    }

    .mm-modal {
      position: fixed;
      top: 0;
      bottom: 0;
      right: 0;
      width: min(720px, 100%);
      max-width: 100%;
      background: var(--mm-card);
      color: var(--mm-text);
      box-shadow: var(--mm-ring);
      border-left: 1px solid rgba(0, 0, 0, .06);
      transform: translateX(100%);
      opacity: 0;
      visibility: hidden;
      transition: transform .35s var(--mm-ease), opacity .35s var(--mm-ease), visibility 0s .35s;
      display: flex;
      flex-direction: column;
      z-index: 90;
    }

    .mm-modal.mm-open {
      transform: translateX(0);
      opacity: 1;
      visibility: visible;
      transition-delay: 0s;
    }

    @media (max-width: 768px) {
      .mm-modal {
        width: 100%;
        border-left: none;
      }
    }

    .mm-header {
      position: sticky;
      top: 0;
      z-index: 1;
      background: color-mix(in srgb, var(--mm-card) 95%, transparent);
      backdrop-filter: blur(8px);
      padding: 18px 18px 14px;
      border-bottom: 1px solid rgba(0, 0, 0, .06);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mm-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mm-title h2 {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 0;
    }

    .mm-counter {
      background: rgba(244, 63, 94, .09);
      color: #f43f5e;
      border: 1px solid rgba(244, 63, 94, .24);
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 600;
      font-size: .85rem;
    }

    .mm-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .mm-search {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 0, 0, .04);
      padding: 8px 10px;
      border-radius: 12px;
    }

    .mm-search svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      opacity: .55;
    }

    .mm-search input {
      flex: 1;
      border: 0;
      background: transparent;
      outline: none;
      font: inherit;
      color: inherit;
    }

    .mm-link {
      background: transparent;
      border: 0;
      color: #ef4444;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: 10px;
      cursor: pointer;
    }

    .mm-link:hover {
      background: rgba(239, 68, 68, .08);
    }

    .mm-icon {
      width: 34px;
      height: 34px;
      border: 0;
      border-radius: 10px;
      background: rgba(0, 0, 0, .05);
      display: grid;
      place-items: center;
      cursor: pointer;
    }

    .mm-icon svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      opacity: .75;
    }

    .mm-icon:hover {
      background: rgba(0, 0, 0, .08);
    }

    .mm-filters {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .mm-filters select,
    .mm-chip {
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, .08);
      background: rgba(0, 0, 0, .03);
      padding: 0 12px;
      font: inherit;
      color: inherit;
      cursor: pointer;
    }

    .mm-chip[aria-pressed="true"] {
      outline: 2px solid #3b82f6;
      background: rgba(59, 130, 246, .08);
    }

    .mm-grid {
      padding: 16px;
      display: grid;
      gap: 14px;
      grid-template-columns: 1fr;
      overflow: auto;
      overscroll-behavior: contain;
      flex: 1;
    }

    @media (min-width: 768px) {
      .mm-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .mm-card-item {
      list-style: none;
      border: 1px solid rgba(0, 0, 0, .06);
      border-radius: 16px;
      overflow: hidden;
      background: linear-gradient(180deg, rgba(255, 255, 255, .02), transparent);
      transition: transform .2s var(--mm-ease), box-shadow .2s var(--mm-ease), opacity .22s var(--mm-ease);
      animation: mm-enter .32s var(--mm-ease) both;
      cursor: pointer;
    }

    .mm-card-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, .08);
    }

    .mm-thumb {
      position: relative;
      aspect-ratio: 1/1;
      background: #e5e7eb;
    }

    .mm-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .mm-heart {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      display: grid;
      place-items: center;
      border-radius: 999px;
      background: rgba(255, 255, 255, .9);
      box-shadow: 0 6px 16px rgba(0, 0, 0, .12);
      cursor: pointer;
      border: none;
    }

    .mm-heart svg {
      width: 18px;
      height: 18px;
      transition: transform .18s var(--mm-ease);
      fill: #ef4452;
      stroke: #ef4452;
    }

    .mm-body {
      padding: 12px;
      display: grid;
      gap: 6px;
    }

    .mm-title2 {
      font-weight: 700;
      font-size: .98rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .mm-meta {
      display: flex;
      gap: 8px;
      align-items: center;
      color: var(--mm-muted);
      font-size: .85rem;
      flex-wrap: wrap;
    }

    .mm-price {
      margin-left: auto;
      font-weight: 700;
      color: #ef4444;
    }

    .mm-empty {
      padding: 48px 24px;
      text-align: center;
      display: grid;
      gap: 8px;
      place-items: center;
      margin: auto;
    }

    .mm-empty-illu {
      font-size: 48px;
    }

    .mm-cta-outline {
      border: 1px solid rgba(0, 0, 0, .12);
      background: transparent;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font: inherit;
      color: inherit;
      font-weight: 600;
    }

    @keyframes mm-enter {
      from {
        opacity: 0;
        transform: translateY(6px) scale(.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="container nav">
      <a class="brand" href="#">
        <svg class="pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0" />
          <circle cx="12" cy="10" r="3" />
        </svg>
        <b>MapMarket</b>
      </a>
      <nav class="nav-actions">
        <a class="nav-link" href="#"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z" />
          </svg><span>Messages</span></a>
        <button class="nav-link pill" type="button" id="openFavs"><svg width="20" height="20" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
          </svg><span>Favoris</span><span class="badge" id="fav-count">0</span></button>
        <button class="cta" id="postBtn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14" />
            <path d="M12 5v14" />
          </svg><span class="hide-sm">Déposer une annonce</span></button>
        <div class="avatar" id="avatar"></div>
      </nav>
    </div>
  </header>

  <main class="container" style="padding:20px 20px 60px">
    <section class="hero">
      <h1>Trouvez ce que vous cherchez</h1>
      <p>Des milliers d'articles d'occasion près de chez vous</p>
    </section>

    <!-- Filters -->
    <section class="card filters-card" aria-label="Filtres">
      <div class="filters-header">
        <div class="filters-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <line x1="21" x2="14" y1="4" y2="4" />
            <line x1="10" x2="3" y1="4" y2="4" />
            <line x1="21" x2="12" y1="12" y2="12" />
            <line x1="8" x2="3" y1="12" y2="12" />
            <line x1="21" x2="16" y1="20" y2="20" />
            <line x1="12" x2="3" y1="20" y2="20" />
            <line x1="14" x2="14" y1="2" y2="6" />
            <line x1="8" x2="8" y1="10" y2="14" />
            <line x1="16" x2="16" y1="18" y2="22" />
          </svg>
          <div>
            <p class="filters-heading">Affiner votre recherche</p>
            <p class="filters-subheading">Filtrez par catégorie, prix ou localisation</p>
          </div>
        </div>
        <button class="filters-reset" id="resetBtn" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="1 4 1 10 7 10" />
            <polyline points="23 20 23 14 17 14" />
            <path d="M20.49 9A9 9 0 0 0 5 5.55L1 10" />
            <path d="M3.51 15A9 9 0 0 0 19 18.45L23 14" />
          </svg>
          <span>Réinitialiser</span>
        </button>
      </div>
      <div class="filters-grid">
        <div class="filter-field filter-search">
          <label class="filter-label" for="search">Recherche globale</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.3-4.3" />
            </svg>
            <input id="search" type="search" placeholder="Titre, description, mots-clés" autocomplete="off" />
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="cat">Catégorie</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7" rx="1" />
              <rect x="14" y="3" width="7" height="7" rx="1" />
              <rect x="14" y="14" width="7" height="7" rx="1" />
              <rect x="3" y="14" width="7" height="7" rx="1" />
            </svg>
            <select id="cat" title="Catégories">
              <option value="">Toutes catégories</option>
              <option>Immobilier</option>
              <option>Mode</option>
              <option>High-Tech</option>
              <option>Auto</option>
              <option>Maison</option>
            </select>
            <svg class="filter-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="etat">État</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="4 14 8 10 12 14 16 10 20 14" />
              <polyline points="4 8 8 4 12 8 16 4 20 8" />
            </svg>
            <select id="etat" title="État">
              <option value="">Tous états</option>
              <option>Très bon état</option>
              <option>Bon état</option>
              <option>Neuf</option>
            </select>
            <svg class="filter-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="sort">Tri</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h11" />
              <path d="M3 12h7" />
              <path d="M3 18h3" />
              <path d="m15 18 6-6-6-6" />
            </svg>
            <select id="sort" title="Tri">
              <option value="recent">Plus récent</option>
              <option value="priceAsc">Prix croissant</option>
              <option value="priceDesc">Prix décroissant</option>
            </select>
            <svg class="filter-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="pmin">Prix minimum (€)</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 3v18" />
              <path d="M17 7H9.5a3.5 3.5 0 0 0 0 7H15a3.5 3.5 0 0 1 0 7H7" />
            </svg>
            <input id="pmin" type="number" min="0" inputmode="numeric" placeholder="Ex. 100" />
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="pmax">Prix maximum (€)</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 3v18" />
              <path d="M17 7H9.5a3.5 3.5 0 0 0 0 7H15a3.5 3.5 0 0 1 0 7H7" />
            </svg>
            <input id="pmax" type="number" min="0" inputmode="numeric" placeholder="Ex. 500" />
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="city">Ville</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0" />
              <circle cx="12" cy="10" r="3" />
            </svg>
            <input id="city" type="text" placeholder="Ex. Paris" autocomplete="off" />
          </div>
        </div>
      </div>
    </section>

    <div style="display:flex;align-items:center;justify-content:space-between;margin:14px 2px 8px" class="muted"><span
        id="count">0 annonce</span>
      <div class="tabs" role="tablist">
        <div class="tab active" role="tab" aria-selected="true" id="tab-list"><svg width="16" height="16"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M3 12h.01" />
            <path d="M3 18h.01" />
            <path d="M3 6h.01" />
            <path d="M8 12h13" />
            <path d="M8 18h13" />
            <path d="M8 6h13" />
          </svg><span class="hide-sm">Liste</span></div>
        <div class="tab" role="tab" aria-selected="false" id="tab-map"><svg width="16" height="16" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M14.1 5.6a2 2 0 0 0 1.8 0l3.7-1.8a1 1 0 0 1 .9.8v12.8a1 1 0 0 1-.6.9l-4.6 2.3a2 2 0 0 1-1.8 0L8.3 18.5a2 2 0 0 0-1.8 0l-3.7 1.8A1 1 0 0 1 2 19.4V6.6a1 1 0 0 1 .6-.9l4.6-2.3a2 2 0 0 1 1.8 0z" />
            <path d="M15 5.8v15" />
            <path d="M9 3.2v15" />
          </svg><span class="hide-sm">Carte</span></div>
      </div>
    </div>

    <!-- Cards grid -->
    <section class="grid" id="grid"></section>
    <div id="sentinel"></div>
    <div class="loading" id="loading" style="display:none">Chargement…</div>
    <div id="map"></div>
  </main>

  <!-- AUTH MODAL -->
  <div class="modal-backdrop auth-backdrop" id="authModal" aria-hidden="true">
    <div class="auth-dialog" id="authDialog" role="dialog" aria-modal="true" aria-labelledby="heroTitle">
      <div class="auth-hero">
        <div class="auth-header">
          <div class="auth-brand">
            <svg class="pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0" />
              <circle cx="12" cy="10" r="3" />
            </svg>
            <strong>MapMarket</strong>
          </div>
        </div>
        <div class="auth-hero-content">
          <h2 id="heroTitle">Bienvenue !</h2>
          <p id="heroSubtitle">Accédez à vos messages, favoris et alertes personnalisées</p>
        </div>
        <div class="auth-hero-illus" id="heroIcon">📍</div>
      </div>
      <div class="auth-pane">
        <div class="auth-tabs" role="tablist">
          <div class="auth-indicator" id="tabIndicator"></div>
          <button class="auth-tab active" id="loginTab" type="button" role="tab" aria-selected="true">Se connecter</button>
          <button class="auth-tab" id="signupTab" type="button" role="tab" aria-selected="false">Créer un compte</button>
        </div>

        <div class="auth-forms" id="formContainer">
          <form class="auth-form active" id="loginForm" autocomplete="on" novalidate>
            <div class="auth-group">
              <label class="auth-label" for="loginEmail">Adresse email</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="loginEmail" type="email" autocomplete="email" placeholder="vous@exemple.fr" required>
              </div>
            </div>

            <div class="auth-group">
              <label class="auth-label" for="loginPassword">Mot de passe</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="loginPassword" type="password" autocomplete="current-password" placeholder="••••••••" required>
                <button type="button" class="password-toggle" data-target="loginPassword" aria-label="Afficher ou masquer le mot de passe">👁</button>
              </div>
            </div>

            <button type="submit" class="auth-submit" id="loginSubmit">Se connecter</button>

            <div class="auth-forgot">
              <button type="button" id="forgotTrigger">Mot de passe oublié ?</button>
            </div>
          </form>

          <form class="auth-form" id="signupForm" autocomplete="on" novalidate>
            <div class="auth-group">
              <label class="auth-label" for="signupName">Nom complet</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="signupName" type="text" autocomplete="name" placeholder="Jean Dupont" required>
              </div>
            </div>

            <div class="auth-group">
              <label class="auth-label" for="signupEmail">Adresse email</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="signupEmail" type="email" autocomplete="email" placeholder="vous@exemple.fr" required>
              </div>
            </div>

            <div class="auth-group">
              <label class="auth-label" for="signupPassword">Mot de passe</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="signupPassword" type="password" autocomplete="new-password" placeholder="Minimum 8 caractères" minlength="8" required>
                <button type="button" class="password-toggle" data-target="signupPassword" aria-label="Afficher ou masquer le mot de passe">👁</button>
              </div>
            </div>

            <button type="submit" class="auth-submit" id="signupSubmit">Créer mon compte</button>
          </form>

          <form class="auth-form" id="forgotForm" novalidate>
            <div class="auth-group">
              <label class="auth-label" for="forgotEmail">Adresse email</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="forgotEmail" type="email" autocomplete="email" placeholder="vous@exemple.fr" required>
              </div>
            </div>

            <button type="submit" class="auth-submit" id="forgotSubmit">Envoyer le lien de réinitialisation</button>

            <div class="auth-forgot">
              <button type="button" id="backToLogin">← Retour à la connexion</button>
            </div>
          </form>
        </div>

      </div>
      <button class="auth-close" id="closeAuth" aria-label="Fermer">✕</button>
    </div>
  </div>

  <!-- DETAILS MODAL -->
  <div class="modal-backdrop details-backdrop" id="detailsModal" aria-hidden="true">
    <div class="details-dialog" id="detailsDialog" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <button class="details-close" id="closeDetails" aria-label="Fermer">✕</button>

      <div class="details-media">
        <div class="details-carousel">
          <div class="carousel-track" id="detailsCarouselTrack"></div>
          <div class="carousel-nav">
            <button class="carousel-btn" id="detailsPrev" aria-label="Image précédente">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6" />
              </svg>
            </button>
            <button class="carousel-btn" id="detailsNext" aria-label="Image suivante">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6" />
              </svg>
            </button>
          </div>
          <div class="carousel-meta">
            <div class="carousel-counter" id="detailsImageCounter">1 / 1</div>
            <div class="carousel-dots" id="detailsCarouselDots"></div>
          </div>
          <div class="carousel-tools">
            <button class="tool-btn" id="detailsDownload" aria-label="Télécharger l'image">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
            </button>
            <button class="tool-btn" id="detailsFullscreen" aria-label="Voir en plein écran">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M8 3H5a2 2 0 0 0-2 2v3" />
                <path d="M16 3h3a2 2 0 0 1 2 2v3" />
                <path d="M8 21H5a2 2 0 0 1-2-2v-3" />
                <path d="M16 21h3a2 2 0 0 0 2-2v-3" />
              </svg>
            </button>
          </div>
        </div>
        <div class="details-skeleton" id="detailsSkeleton"></div>
      </div>

      <div class="details-body">
        <div class="details-hero-card">
          <div class="details-hero-info">
            <h2 id="detailsTitle">Titre</h2>
            <div class="details-meta" id="detailsMeta"></div>
          </div>
          <div class="details-price" id="detailsPrice"><strong>—</strong></div>
        </div>

        <div class="details-tags" id="detailsTags"></div>

        <section class="details-section">
          <h3>Description</h3>
          <p class="details-desc" id="detailsDesc"></p>
          <button class="details-readmore" id="detailsReadMore" type="button">Lire la suite</button>
        </section>

        <section class="details-section">
          <h3>Informations sur le vendeur</h3>
          <div class="seller-card" id="detailsSeller"></div>
        </section>

        <div class="details-actions">
          <button class="cta-outline" id="detailsSave" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path
                d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
            </svg>
            <span>Ajouter aux favoris</span>
          </button>
          <button class="cta-primary" id="detailsContact" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M22 12h-4" />
              <path d="M2 12h4" />
              <path d="M12 2v4" />
              <path d="M12 22v-4" />
              <rect x="7" y="7" width="10" height="10" rx="2" />
            </svg>
            <span>Contacter</span>
          </button>
          <button class="cta-secondary" id="detailsVisit" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M12 19V6" />
              <path d="m5 12 7-7 7 7" />
            </svg>
            <span>Voir sur la carte</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Action enregistrée</div>

  <!-- FAVORITES MODAL -->
  <div class="mm-overlay" id="favOverlay"></div>
  <aside id="favModal" class="mm-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="favTitle">
    <header class="mm-header">
      <div class="mm-title">
        <h2 id="favTitle">Favoris</h2>
        <span id="favSheetCount" class="mm-counter">0</span>
      </div>

      <div class="mm-actions">
        <div class="mm-search">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z"></path>
          </svg>
          <input id="favSearch" type="search" placeholder="Rechercher un favori…">
        </div>
        <button id="clearAllFavs" class="mm-link">Tout retirer</button>
        <button id="closeFavs" class="mm-icon" aria-label="Fermer">
          <svg viewBox="0 0 24 24">
            <path d="M6 6l12 12M18 6L6 18"></path>
          </svg>
        </button>
      </div>

      <div class="mm-filters">
        <select id="favSortBy" aria-label="Trier">
          <option value="recent">Plus récent</option>
          <option value="price_asc">Prix ↑</option>
          <option value="price_desc">Prix ↓</option>
        </select>
        <select id="favByCat" aria-label="Catégorie"><option value="all">Toutes catégories</option></select>
        <button id="favMultiSelect" class="mm-chip" aria-pressed="false">Sélectionner</button>
      </div>
    </header>
    <div id="favList" class="mm-grid" role="list" hidden=""></div>
    <div id="favEmptyState" class="mm-empty" hidden>
      <div class="mm-empty-illu">💗</div>
      <h3>Aucun favori pour l’instant</h3>
      <p>Ajoutez des annonces à vos favoris pour les retrouver ici.</p>
      <button class="mm-cta-outline" id="favBrowse">Parcourir les annonces</button>
    </div>
  </aside>

  <script>
    // ---------- DATA (mock + géoloc) ----------
    const cityPos = {
      'Montpellier': [43.611, 3.877], 'Paris': [48.8566, 2.3522], 'Lyon': [45.764, 4.8357],
      'Marseille': [43.2965, 5.3698], 'Toulouse': [43.6045, 1.4440], 'Lille': [50.6292, 3.0573]
    };    

    function jitter([lat, lng]) { return [lat + (Math.random() - .5) * 0.08, lng + (Math.random() - .5) * 0.12]; }

    const allItemsData = [
      { id: 101, cat: 'Immobilier', title: 'Appartement T3 lumineux - Lyon 7e', price: 345000, desc: 'Superbe T3 de 75m² entièrement rénové en 2022. Traversant, avec balcon et vue dégagée. Proche des transports et commerces. Cave incluse.', chips: ['75 m²', '2 chambres', 'DPE C', 'Balcon'], city: 'Lyon', state: 'Très bon état', views: 245, likes: 28, date: '2025-10-12', img: 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?q=80&w=1470&auto=format&fit=crop' },
      { id: 102, cat: 'Auto', title: 'Renault Clio V - Faible kilométrage', price: 14800, desc: 'Clio 5 de 2021, finition Intens. Moteur essence TCe 90. Seulement 35 000 km. Entretien suivi chez Renault. Idéale jeune conducteur.', chips: ['Essence', 'Manuelle', '35 000 km', 'Crit\'Air 1'], city: 'Marseille', state: 'Très bon état', views: 180, likes: 15, date: '2025-10-11', img: 'https://images.unsplash.com/photo-1617469767050-14e523b0e8a3?q=80&w=1470&auto=format&fit=crop' },
      { id: 103, cat: 'High-Tech', title: 'MacBook Pro 13" M1 - 512Go', price: 950, desc: 'MacBook Pro 13 pouces de fin 2020 avec puce M1. 16Go de RAM, 512Go SSD. État impeccable, aucune rayure. Vendu avec boîte et chargeur d\'origine.', chips: ['16Go RAM', '512Go SSD', 'Puce M1'], city: 'Paris', state: 'Très bon état', views: 310, likes: 42, date: '2025-10-13', img: 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?q=80&w=1326&auto=format&fit=crop' },
      { id: 104, cat: 'Maison', title: 'Canapé d\'angle convertible gris', price: 450, desc: 'Grand canapé d\'angle 4 places, convertible en lit d\'appoint. Tissu gris chiné anti-taches. Acheté il y a 2 ans, très peu servi. Maison non-fumeur.', chips: ['4 places', 'Convertible', 'Coffre rangement'], city: 'Lille', state: 'Bon état', views: 95, likes: 8, date: '2025-10-09', img: 'https://images.unsplash.com/photo-1540574163024-5884b0b5b529?q=80&w=1470&auto=format&fit=crop' },
      { id: 105, cat: 'Mode', title: 'Sac à main en cuir de luxe', price: 280, desc: 'Magnifique sac à main d\'une grande marque française. Cuir de veau pleine fleur. Porté quelques fois, état comme neuf. Vendu avec son dust-bag.', chips: ['Cuir véritable', 'Marque de luxe', 'Vintage'], city: 'Toulouse', state: 'Très bon état', views: 150, likes: 25, date: '2025-10-10', img: 'https://images.unsplash.com/photo-1590739241625-0d407c2f1a2a?q=80&w=1470&auto=format&fit=crop' },
      { id: 106, cat: 'Immobilier', title: 'Studio meublé proche Comédie', price: 145000, desc: 'Idéal investisseur ou premier achat. Studio de 25m² entièrement meublé et équipé. Situé dans une rue calme à 5min à pied de la place de la Comédie.', chips: ['25 m²', 'Meublé', 'Centre-ville'], city: 'Montpellier', state: 'Bon état', views: 420, likes: 33, date: '2025-10-14', img: 'https://images.unsplash.com/photo-1600585152220-90363fe7e115?q=80&w=1470&auto=format&fit=crop' },
      { id: 107, cat: 'High-Tech', title: 'Appareil photo Sony A7 III', price: 1300, desc: 'Boîtier Sony Alpha 7 III en excellent état. Vendu avec son objectif de kit 28-70mm. Parfait pour se lancer dans la photo plein format. Moins de 15 000 déclenchements.', chips: ['Plein format', '4K', '15k déclench.'], city: 'Paris', state: 'Très bon état', views: 288, likes: 38, date: '2025-10-11', img: 'https://images.unsplash.com/photo-1512756290469-ec264b7fbf87?q=80&w=1352&auto=format&fit=crop' },
      { id: 108, cat: 'Maison', title: 'Table basse design en chêne massif', price: 180, desc: 'Table basse de style scandinave en chêne massif huilé. Dimensions : 120x70cm. Achetée chez Habitat. Quelques micro-rayures d\'usage mais très bel état général.', chips: ['Chêne massif', 'Design scandinave', 'Habitat'], city: 'Lyon', state: 'Bon état', views: 112, likes: 11, date: '2025-10-08', img: 'https://images.unsplash.com/photo-1611403579683-54e4a837498c?q=80&w=1470&auto=format&fit=crop' },
      { id: 109, cat: 'Auto', title: 'Volkswagen Golf 7 GTI Performance', price: 22500, desc: 'Golf 7 GTI phase 2, 245ch. Année 2018, 80 000 km. Boîte DSG7, Virtual Cockpit, toit ouvrant. Carnet d\'entretien complet. Temps de chauffe toujours respectés.', chips: ['245ch', 'DSG7', 'Toit ouvrant', '80 000 km'], city: 'Toulouse', state: 'Très bon état', views: 550, likes: 68, date: '2025-10-13', img: 'https://images.unsplash.com/photo-1616455579100-2ceaa4eb2d37?q=80&w=1528&auto=format&fit=crop' },
      { id: 110, cat: 'Mode', title: 'Baskets Nike Air Max 90 - Neuves', price: 90, desc: 'Paire de Nike Air Max 90, coloris "Infrared". Jamais portées, encore dans la boîte. Taille 43. Erreur de taille à l\'achat.', chips: ['Taille 43', 'Jamais portées', 'Coloris OG'], city: 'Lille', state: 'Neuf', views: 190, likes: 22, date: '2025-10-12', img: 'https://images.unsplash.com/photo-1587563871167-1df9c4010de1?q=80&w=1470&auto=format&fit=crop' }
    ];

    let allItems = allItemsData.map(it => ({ ...it, latlng: jitter(cityPos[it.city] || [46.2, 2.2]) }));

    // ---------- STATE ----------
    const favStore = { get() { try { return new Set(JSON.parse(localStorage.getItem('mm-favs') || '[]')); } catch { return new Set() } }, set(s) { localStorage.setItem('mm-favs', JSON.stringify([...s])) } };
    const authStore = { get() { try { return JSON.parse(localStorage.getItem('mm-auth') || 'null') } catch { return null } }, set(v) { localStorage.setItem('mm-auth', JSON.stringify(v)) } };

    // ---------- UTIL ----------
    function categoryClass(cat) { return cat === 'Immobilier' ? 'immobilier' : cat === 'Mode' ? 'mode' : cat === 'High-Tech' ? 'hitech' : cat === 'Auto' ? 'auto' : 'maison'; }
    function fmtPrice(n) { return (n >= 1000 ? n.toLocaleString('fr-FR') : n) + ' €'; }
    function formatDateLong(dateStr) {
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
    }
    function daysAgo(dateStr) { const d = new Date(dateStr); const diff = Math.max(1, Math.round((Date.now() - d) / 86400000)); return `il y a ${diff} jour${diff > 1 ? 's' : ''}`; }
    function normalize(s) { return (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }

    // ---------- FILTERING ----------
    const search = document.getElementById('search');
    const cat = document.getElementById('cat');
    const etat = document.getElementById('etat');
    const sort = document.getElementById('sort');
    const pmin = document.getElementById('pmin');
    const pmax = document.getElementById('pmax');
    const city = document.getElementById('city');
    const resetBtn = document.getElementById('resetBtn');

    function getFiltered() {
      let list = allItems.slice();
      const q = normalize(search.value);
      if (q) list = list.filter(a => normalize(a.title + " " + a.desc).includes(q));
      if (cat.value) list = list.filter(a => a.cat === cat.value);
      if (etat.value) list = list.filter(a => a.state === etat.value);
      if (city.value) list = list.filter(a => normalize(a.city).includes(normalize(city.value)));
      const min = Number(pmin.value || 0), max = Number(pmax.value || Infinity);
      list = list.filter(a => a.price >= min && a.price <= max);
      if (sort.value === 'priceAsc') list.sort((a, b) => a.price - b.price);
      else if (sort.value === 'priceDesc') list.sort((a, b) => b.price - a.price);
      else list.sort((a, b) => new Date(b.date) - new Date(a.date));
      return list;
    }

    [search, cat, etat, sort, pmin, pmax, city].forEach(el => el.addEventListener('input', () => { page = 0; renderList(true); renderMap(); }));
    resetBtn.addEventListener('click', () => { [search, cat, etat, sort, pmin, pmax, city].forEach(el => { if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = ''; }); page = 0; renderList(true); renderMap(); })

    // ---------- LIST RENDER + INFINITE ----------
    const grid = document.getElementById('grid');
    const count = document.getElementById('count');
    const favCount = document.getElementById('fav-count');
    const sentinel = document.getElementById('sentinel');
    const loading = document.getElementById('loading');

    let page = 0; const PAGE_SIZE = 12; let filteredCache = [];

    function renderChunk() {
      const favs = favStore.get();
      const start = page * PAGE_SIZE, end = start + PAGE_SIZE;
      const slice = filteredCache.slice(start, end);
      for (const a of slice) {
        const art = document.createElement('article'); art.className = 'ad';
        art.innerHTML = `
          <div class="ad-content" data-id="${a.id}">
          <div class="thumb">
            <img loading="lazy" decoding="async" alt="${a.title}" src="${a.img}"/>
            <div class="grad"></div>
            <div class="cat ${categoryClass(a.cat)}">${a.cat === 'Immobilier' ? '🏢' : a.cat === 'Mode' ? '👕' : a.cat === 'High-Tech' ? '💻' : a.cat === 'Auto' ? '🚗' : '🏠'} <span>${a.cat}</span></div>
            <div class="stats"><span class="row">👁️ ${a.views}</span><span class="row">❤ ${a.likes}</span></div>
            <button class="fav" title="Ajouter aux favoris" aria-pressed="${favs.has(a.id)}" data-id="${a.id}">
              <svg viewBox="0 0 24 24" fill="${favs.has(a.id) ? '#ef4444' : 'none'}" stroke="${favs.has(a.id) ? '#ef4444' : 'currentColor'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
            </button>
          </div>
          <div class="body">
            <div class="titleprice"><div class="title">${a.title}</div><div class="price">${fmtPrice(a.price)}</div></div>
            <div class="desc">${a.desc}</div>
            <div class="chips">${a.chips.map(c => `<span class="chip">${c}</span>`).join('')}</div>
            <div class="meta">
              <div class="loc"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0"/><circle cx="12" cy="10" r="3"/></svg><span>${a.city}</span></div>
              <span class="state">${a.state}</span>
            </div>
            <div class="time">${daysAgo(a.date)}</div>
          </div>
          </div>`; // ad-content wrapper
        grid.appendChild(art);
      }
      // bind favs for the newly added ones
      grid.querySelectorAll('.fav').forEach(btn => {
        if (btn._bound) return; btn._bound = true;
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const id = +btn.dataset.id; const s = favStore.get();
          const isAdding = !s.has(id);
          if (isAdding) {
            s.add(id); showToast('Ajouté aux favoris');
            triggerFavAnimation(btn); // Déclenche l'animation
          } else { s.delete(id); }

          favStore.set(s); favCount.textContent = s.size; btn.querySelector('svg').setAttribute('fill', s.has(id) ? '#ef4444' : 'none'); btn.querySelector('svg').setAttribute('stroke', s.has(id) ? '#ef4444' : 'currentColor');
        })
      })
      page++;
    }

    function renderList(reset) {
      filteredCache = getFiltered();
      favCount.textContent = favStore.get().size;
      count.textContent = filteredCache.length + (filteredCache.length > 1 ? ' annonces trouvées' : ' annonce trouvée');
      if (reset) { grid.innerHTML = ''; page = 0; }
      renderChunk();
    }

    const io = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting && page * PAGE_SIZE < filteredCache.length) {
          loading.style.display = 'grid';
          setTimeout(() => { renderChunk(); loading.style.display = 'none'; }, 250);
        }
      })
    });
    io.observe(sentinel);

    // ---------- MAP (Leaflet + clusters) ----------
    let map, cluster;
    function ensureMap() {
      if (map) return; // already created
      map = L.map('map', { zoomControl: true, scrollWheelZoom: true }).setView([46.5, 2.3], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(map);
      cluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        chunkedLoading: true,
        spiderfyOnMaxZoom: true,
        iconCreateFunction: function (c) {
          const count = c.getChildCount();
          const size = count < 20 ? 'small' : count < 50 ? 'medium' : 'large';
          return new L.DivIcon({ html: `<div><span>${count}</span></div>`, className: `marker-cluster marker-cluster-${size}`, iconSize: new L.Point(40, 40) });
        }
      });
      map.addLayer(cluster);
    }

    function renderMap() {
      ensureMap(); cluster.clearLayers();
      const list = getFiltered();
      list.forEach(a => {
        const m = L.marker(a.latlng, { title: a.title });
        m.on('click', () => openDetailsModal(a));
        cluster.addLayer(m);
      });
      if (list.length) { map.fitBounds(L.latLngBounds(list.map(x => x.latlng)).pad(0.2)); }
    }

    // ---------- TABS (Liste / Carte) ----------
    const tabList = document.getElementById('tab-list');
    const tabMap = document.getElementById('tab-map');
    const mapEl = document.getElementById('map');

    function showList() { tabList.classList.add('active'); tabMap.classList.remove('active'); grid.style.display = 'grid'; mapEl.style.display = 'none'; }
    function showMap() { tabMap.classList.add('active'); tabList.classList.remove('active'); grid.style.display = 'none'; mapEl.style.display = 'block'; setTimeout(() => { ensureMap(); map.invalidateSize(); renderMap(); }, 50); }

    tabList.addEventListener('click', showList);
    tabMap.addEventListener('click', showMap);

    // ---------- AUTH MODAL ----------
    const authModal = document.getElementById('authModal');
    const closeAuth = document.getElementById('closeAuth');
    const postBtn = document.getElementById('postBtn');
    const loginTab = document.getElementById('loginTab');
    const signupTab = document.getElementById('signupTab');
    const tabIndicator = document.getElementById('tabIndicator');
    const formContainer = document.getElementById('formContainer');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const forgotForm = document.getElementById('forgotForm');
    const heroTitle = document.getElementById('heroTitle');
    const heroSubtitle = document.getElementById('heroSubtitle');
    const heroIcon = document.getElementById('heroIcon');
    const forgotTrigger = document.getElementById('forgotTrigger');
    const backToLogin = document.getElementById('backToLogin');
    const passwordToggles = document.querySelectorAll('.password-toggle');

    const forms = { login: loginForm, signup: signupForm, forgot: forgotForm };
    let currentTab = 'login';

    const heroCopy = {
      login: { title: 'Bienvenue !', subtitle: "Accédez à vos messages, favoris et alertes personnalisées", icon: '📍' },
      signup: { title: 'Rejoignez-nous !', subtitle: 'Créez votre compte et découvrez toutes les fonctionnalités', icon: '🚀' },
      forgot: { title: 'Mot de passe oublié ?', subtitle: 'Pas de souci, nous allons vous aider à récupérer votre compte', icon: '🔑' }
    };

    const avatarIcons = {
      auth: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>`,
      profile: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`
    };

    function renderAvatar(auth) {
      const avatar = document.getElementById('avatar');
      if (!avatar) return;
      avatar.innerHTML = '';
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'avatar-btn';
      if (auth) {
        button.classList.add('is-auth');
        button.setAttribute('aria-label', auth.name ? `Profil de ${auth.name}` : 'Profil connecté');
        button.innerHTML = avatarIcons.profile;
        button.addEventListener('click', () => showToast('Espace compte bientôt disponible'));
        avatar.title = auth.name || auth.email || 'Compte connecté';
      } else {
        button.classList.add('needs-auth');
        button.setAttribute('aria-label', 'Se connecter ou créer un compte');
        button.innerHTML = avatarIcons.auth;
        button.addEventListener('click', () => openAuth());
        avatar.title = 'Se connecter ou créer un compte';
      }
      avatar.appendChild(button);
    }

    let authMeasureRaf = null;

    function scheduleAuthMeasure() {
      if (authMeasureRaf) cancelAnimationFrame(authMeasureRaf);
      authMeasureRaf = requestAnimationFrame(() => {
        authMeasureRaf = null;
        measureAuthHeight();
      });
    }

    function measureAuthHeight() {
      if (!formContainer) return;
      const formsList = Array.from(formContainer.querySelectorAll('.auth-form'));
      if (!formsList.length) return;
      const previousHeight = formContainer.style.height;
      formContainer.style.height = 'auto';
      let maxHeight = formContainer.scrollHeight;
      formsList.forEach(form => {
        const wasActive = form.classList.contains('active');
        const prevStyles = {
          visibility: form.style.visibility,
          display: form.style.display,
          position: form.style.position,
          transform: form.style.transform
        };
        if (!wasActive) {
          form.style.visibility = 'hidden';
          form.style.display = 'flex';
          form.style.position = 'static';
          form.style.transform = 'none';
        }
        const formHeight = form.scrollHeight;
        if (formHeight > maxHeight) maxHeight = formHeight;
        if (!wasActive) {
          form.style.visibility = prevStyles.visibility;
          form.style.display = prevStyles.display;
          form.style.position = prevStyles.position;
          form.style.transform = prevStyles.transform;
        }
      });
      if (maxHeight) formContainer.style.height = `${Math.ceil(maxHeight)}px`;
      else formContainer.style.height = previousHeight;
    }

    scheduleAuthMeasure();
    window.addEventListener('resize', scheduleAuthMeasure);

    function openAuth(focusId = 'loginEmail') {
      switchTab('login', { instant: true, force: true, resetSuccess: true });
      clearFeedback();
      authModal.classList.add('active');
      authModal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      setTimeout(() => {
        const target = document.getElementById(focusId);
        if (target) target.focus();
      }, 220);
    }

    function closeAuthFn() {
      authModal.classList.remove('active');
      authModal.setAttribute('aria-hidden', 'true');
      if (!detailsModal.classList.contains('active')) {
        document.body.style.overflow = '';
      }
      setTimeout(() => {
        resetAuthForms();
      }, 360);
    }

    function resetAuthForms() {
      [loginForm, signupForm, forgotForm].forEach(form => form.reset());
      clearFeedback();
      Object.values(forms).forEach(form => form.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right'));
      loginForm.classList.add('active');
      currentTab = 'login';
      updateTabUI('login');
      updateHeroContent('login');
      scheduleAuthMeasure();
    }

    function clearFieldErrors() {
      formContainer.querySelectorAll('.form-error').forEach(el => el.remove());
      formContainer.querySelectorAll('.auth-input').forEach(inp => inp.classList.remove('error'));
      scheduleAuthMeasure();
    }

    function clearSuccessMessage() {
      const success = formContainer.querySelector('.auth-success');
      if (success) {
        success.remove();
        scheduleAuthMeasure();
      }
    }

    function clearFeedback() {
      clearFieldErrors();
      clearSuccessMessage();
    }

    function switchTab(tab, options = {}) {
      const targetForm = forms[tab];
      if (!targetForm) return;
      if (!options.force && tab === currentTab) return;

      const prevForm = forms[currentTab];
      clearFieldErrors();
      if (options.resetSuccess) clearSuccessMessage();

      updateTabUI(tab);
      updateHeroContent(tab);

      if (options.instant || !prevForm || prevForm === targetForm) {
        Object.values(forms).forEach(form => form.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right'));
        targetForm.classList.add('active');
        currentTab = tab;
        scheduleAuthMeasure();
        return;
      }

      const { out: outClass, in: inClass } = getSlideDirection(currentTab, tab);
      prevForm.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
      targetForm.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');

      prevForm.classList.add(outClass);
      setTimeout(() => {
        prevForm.classList.remove('active', outClass);
        targetForm.classList.add('active', inClass);
        requestAnimationFrame(() => targetForm.classList.remove(inClass));
        scheduleAuthMeasure();
      }, 200);

      currentTab = tab;
      scheduleAuthMeasure();
    }

    function updateTabUI(tab) {
      loginTab.classList.toggle('active', tab === 'login');
      signupTab.classList.toggle('active', tab === 'signup');
      if (tab === 'signup') {
        tabIndicator.classList.add('signup');
        tabIndicator.classList.remove('hidden');
      } else if (tab === 'login') {
        tabIndicator.classList.remove('signup', 'hidden');
      } else {
        tabIndicator.classList.add('hidden');
        tabIndicator.classList.remove('signup');
      }
    }

    function updateHeroContent(tab) {
      const copy = heroCopy[tab] || heroCopy.login;
      heroTitle.textContent = copy.title;
      heroSubtitle.textContent = copy.subtitle;
      heroIcon.textContent = copy.icon;
    }

    function getSlideDirection(from, to) {
      const order = ['login', 'signup', 'forgot'];
      const fromIndex = order.indexOf(from);
      const toIndex = order.indexOf(to);
      if (fromIndex === -1 || toIndex === -1) {
        return { out: 'slide-out-left', in: 'slide-in-right' };
      }
      return toIndex > fromIndex ? { out: 'slide-out-left', in: 'slide-in-right' } : { out: 'slide-out-right', in: 'slide-in-left' };
    }

    function validateForm(form) {
      let valid = true;
      const signupPassword = document.getElementById('signupPassword');
      form.querySelectorAll('.auth-input').forEach(input => {
        const value = input.value.trim();
        if (input.hasAttribute('required') && !value) {
          showFieldError(input, 'Ce champ est requis');
          valid = false;
          return;
        }
        if (input.type === 'email' && value && !isValidEmail(value)) {
          showFieldError(input, 'Adresse email invalide');
          valid = false;
          return;
        }
        if (input.id === 'signupPassword' && value && value.length < 8) {
          showFieldError(input, 'Minimum 8 caractères');
          valid = false;
        }
      });
      return valid;
    }

    function showFieldError(input, message) {
      const wrapper = input.closest('.auth-input-wrapper');
      if (!wrapper) return;
      const error = document.createElement('div');
      error.className = 'form-error';
      error.textContent = message;
      input.classList.add('error');
      wrapper.appendChild(error);
      scheduleAuthMeasure();
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function setLoading(button, isLoading) {
      if (!button) return;
      if (!button.dataset.label) button.dataset.label = button.textContent.trim();
      if (isLoading) {
        button.classList.add('loading');
        button.textContent = '';
      } else {
        button.classList.remove('loading');
        button.textContent = button.dataset.label || 'Continuer';
      }
    }

    function showSuccess(message) {
      clearSuccessMessage();
      const banner = document.createElement('div');
      banner.className = 'auth-success';
      banner.textContent = message;
      const firstForm = formContainer.firstElementChild;
      if (firstForm) formContainer.insertBefore(banner, firstForm);
      else formContainer.appendChild(banner);
      setTimeout(() => {
        banner.remove();
        scheduleAuthMeasure();
      }, 3200);
      scheduleAuthMeasure();
    }

    function togglePassword(id) {
      const input = document.getElementById(id);
      if (!input) return;
      input.type = input.type === 'password' ? 'text' : 'password';
      const toggle = Array.from(passwordToggles).find(btn => btn.dataset.target === id);
      if (toggle) toggle.textContent = input.type === 'password' ? '👁' : '🙈';
    }

    loginTab.addEventListener('click', () => switchTab('login', { force: true, resetSuccess: true }));
    signupTab.addEventListener('click', () => switchTab('signup', { force: true, resetSuccess: true }));

    if (forgotTrigger) {
      forgotTrigger.addEventListener('click', () => {
        switchTab('forgot', { force: true, resetSuccess: true });
        setTimeout(() => {
          const forgotInput = document.getElementById('forgotEmail');
          if (forgotInput) forgotInput.focus();
        }, 220);
      });
    }

    if (backToLogin) {
      backToLogin.addEventListener('click', () => {
        switchTab('login', { force: true, resetSuccess: true });
        setTimeout(() => {
          const loginInput = document.getElementById('loginEmail');
          if (loginInput) loginInput.focus();
        }, 220);
      });
    }

    passwordToggles.forEach(btn => btn.addEventListener('click', () => togglePassword(btn.dataset.target)));

    closeAuth.addEventListener('click', closeAuthFn);
    authModal.addEventListener('click', (e) => { if (e.target === authModal) closeAuthFn(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && authModal.classList.contains('active')) closeAuthFn(); });

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      clearFieldErrors();
      if (!validateForm(loginForm)) return;
      const button = document.getElementById('loginSubmit');
      setLoading(button, true);
      setTimeout(() => {
        setLoading(button, false);
        showSuccess('Connexion réussie ! Redirection en cours...');
        authStore.set({ name: 'Vous', email: document.getElementById('loginEmail').value.trim() });
        updateAuthUI();
        showToast('Connecté !');
        setTimeout(() => closeAuthFn(), 1200);
      }, 1200);
    });

    signupForm.addEventListener('submit', (e) => {
      e.preventDefault();
      clearFieldErrors();
      if (!validateForm(signupForm)) return;
      const button = document.getElementById('signupSubmit');
      setLoading(button, true);
      setTimeout(() => {
        setLoading(button, false);
        showSuccess('Compte créé avec succès ! Vérifiez votre email.');
        authStore.set({ name: document.getElementById('signupName').value.trim(), email: document.getElementById('signupEmail').value.trim() });
        updateAuthUI();
        showToast('Compte créé et connecté');
        switchTab('login', { force: true, resetSuccess: false, instant: true });
        setTimeout(() => {
          const loginInput = document.getElementById('loginEmail');
          if (loginInput) loginInput.focus();
        }, 220);
        setTimeout(() => closeAuthFn(), 1400);
      }, 1500);
    });

    forgotForm.addEventListener('submit', (e) => {
      e.preventDefault();
      clearFieldErrors();
      if (!validateForm(forgotForm)) return;
      const button = document.getElementById('forgotSubmit');
      setLoading(button, true);
      setTimeout(() => {
        setLoading(button, false);
        showSuccess('Email de réinitialisation envoyé ! Vérifiez votre boîte de réception.');
        showToast('Email de réinitialisation envoyé');
        switchTab('login', { force: true, resetSuccess: false, instant: false });
        setTimeout(() => {
          const loginInput = document.getElementById('loginEmail');
          if (loginInput) loginInput.focus();
        }, 360);
      }, 1500);
    });

    postBtn.addEventListener('click', () => {
      showToast('Formulaire de dépôt à venir…');
    });

    function updateAuthUI() {
      const auth = authStore.get();
      renderAvatar(auth);
    }

    // ---------- DETAILS MODAL ----------
    const detailsModal = document.getElementById('detailsModal');
    const detailsDialog = document.getElementById('detailsDialog');
    const closeDetailsBtn = document.getElementById('closeDetails');
    const detailsCarouselTrack = document.getElementById('detailsCarouselTrack');
    const detailsCarouselDots = document.getElementById('detailsCarouselDots');
    const detailsPrev = document.getElementById('detailsPrev');
    const detailsNext = document.getElementById('detailsNext');
    const detailsImageCounter = document.getElementById('detailsImageCounter');
    const detailsDownload = document.getElementById('detailsDownload');
    const detailsFullscreen = document.getElementById('detailsFullscreen');
    const detailsSkeleton = document.getElementById('detailsSkeleton');
    const detailsTitleEl = document.getElementById('detailsTitle');
    const detailsPriceEl = document.getElementById('detailsPrice');
    const detailsMeta = document.getElementById('detailsMeta');
    const detailsDescEl = document.getElementById('detailsDesc');
    const detailsReadMore = document.getElementById('detailsReadMore');
    const detailsSeller = document.getElementById('detailsSeller');
    const detailsSave = document.getElementById('detailsSave');
    const detailsContact = document.getElementById('detailsContact');
    const detailsVisit = document.getElementById('detailsVisit');
    const detailsTags = document.getElementById('detailsTags');

    let detailsCurrentImages = [];
    let detailsCurrentIndex = 0;
    let detailsCurrentAd = null;
    let detailsDescFull = '';
    let detailsDescExpanded = false;
    let detailsSkeletonTimeout = null;

    const detailsIcons = {
      category: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h10"/></svg>`,
      location: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 5-5 10-9 12-4-2-9-7-9-12a9 9 0 0 1 18 0Z"/><circle cx="12" cy="10" r="3"/></svg>`,
      date: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
      views: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`,
      fav: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`
    };

    function buildGallery(ad) {
      if (Array.isArray(ad.gallery) && ad.gallery.length) return ad.gallery;
      const base = ad.img;
      const separator = base.includes('?') ? '&' : '?';
      return [
        base,
        `${base}${separator}auto=format&fit=crop&w=1400&q=85`,
        `${base}${separator}auto=format&fit=crop&w=1400&q=75&sat=90`
      ];
    }

    function renderGallery(images, title) {
      if (detailsSkeletonTimeout) {
        clearTimeout(detailsSkeletonTimeout);
        detailsSkeletonTimeout = null;
      }
      detailsSkeleton.classList.add('active');
      detailsCarouselTrack.innerHTML = '';
      detailsCarouselDots.innerHTML = '';
      let firstLoaded = false;
      detailsSkeletonTimeout = setTimeout(() => {
        detailsSkeleton.classList.remove('active');
        detailsSkeletonTimeout = null;
      }, 1500);
      images.forEach((src, index) => {
        const slide = document.createElement('div');
        slide.className = 'carousel-slide';
        if (index === 0) slide.classList.add('active');
        const img = document.createElement('img');
        img.decoding = 'async';
        img.loading = 'lazy';
        img.alt = `${title} - photo ${index + 1}`;
        img.src = src;
        img.addEventListener('load', () => {
          if (!firstLoaded) {
            if (detailsSkeletonTimeout) {
              clearTimeout(detailsSkeletonTimeout);
              detailsSkeletonTimeout = null;
            }
            firstLoaded = true;
            detailsSkeleton.classList.remove('active');
          }
        });
        slide.appendChild(img);
        detailsCarouselTrack.appendChild(slide);

        const dot = document.createElement('button');
        dot.type = 'button';
        dot.className = 'carousel-dot';
        if (index === 0) dot.classList.add('active');
        dot.setAttribute('aria-label', `Voir l'image ${index + 1}`);
        dot.addEventListener('click', () => goToSlide(index));
        detailsCarouselDots.appendChild(dot);
      });
      if (!images.length) {
        if (detailsSkeletonTimeout) {
          clearTimeout(detailsSkeletonTimeout);
          detailsSkeletonTimeout = null;
        }
        detailsSkeleton.classList.remove('active');
      }
      updateCarouselUI();
    }

    function updateCarouselUI() {
      const slides = Array.from(detailsCarouselTrack.children);
      slides.forEach((slide, idx) => slide.classList.toggle('active', idx === detailsCurrentIndex));
      const dots = Array.from(detailsCarouselDots.children);
      dots.forEach((dot, idx) => dot.classList.toggle('active', idx === detailsCurrentIndex));
      const total = detailsCurrentImages.length || 1;
      detailsImageCounter.textContent = `${Math.min(detailsCurrentIndex + 1, total)} / ${total}`;
      const multiple = detailsCurrentImages.length > 1;
      detailsPrev.style.visibility = multiple ? 'visible' : 'hidden';
      detailsNext.style.visibility = multiple ? 'visible' : 'hidden';
      detailsCarouselDots.style.display = multiple ? 'flex' : 'none';
    }

    function changeSlide(delta) {
      if (!detailsCurrentImages.length) return;
      detailsCurrentIndex = (detailsCurrentIndex + delta + detailsCurrentImages.length) % detailsCurrentImages.length;
      updateCarouselUI();
    }

    function goToSlide(index) {
      if (!detailsCurrentImages.length) return;
      detailsCurrentIndex = index % detailsCurrentImages.length;
      updateCarouselUI();
    }

    function categorySymbol(cat) {
      if (cat === 'Immobilier') return '🏢';
      if (cat === 'Mode') return '👕';
      if (cat === 'High-Tech') return '💻';
      if (cat === 'Auto') return '🚗';
      if (cat === 'Maison') return '🏠';
      return '📦';
    }

    function renderDetailsMeta(ad) {
      const badges = [];
      if (ad.cat) {
        badges.push({ type: 'cat', html: `<div class="cat ${categoryClass(ad.cat)}">${categorySymbol(ad.cat)} <span>${ad.cat}</span></div>` });
      }
      badges.push(
        { class: 'location', icon: detailsIcons.location, text: ad.city },
        { class: 'date', icon: detailsIcons.date, text: `Publiée le ${formatDateLong(ad.date)}` },
        { class: 'views', icon: detailsIcons.views, text: `${ad.views} vues` },
        { class: 'fav-meta', icon: detailsIcons.fav, text: `${ad.likes} favoris` }
      );
      detailsMeta.innerHTML = badges.map(b => {
        if (b.type === 'cat') return b.html;
        return `<span class="details-meta-item ${b.class}">${b.icon}<span class="label">${b.text}</span></span>`;
      }).join('');
    }

    function renderDetailsTags(ad) {
      const tags = Array.isArray(ad.chips) ? ad.chips : [];
      if (tags.length) {
        detailsTags.style.display = 'flex';
        detailsTags.innerHTML = tags.map(tag => `<span class="details-tag">${tag}</span>`).join('');
      } else {
        detailsTags.style.display = 'none';
        detailsTags.innerHTML = '';
      }
    }

    function setDetailsDescription(desc) {
      detailsDescFull = desc || 'Aucune description fournie pour cette annonce.';
      detailsDescExpanded = false;
      updateDescription();
    }

    function updateDescription() {
      const limit = 220;
      if (detailsDescFull.length > limit && !detailsDescExpanded) {
        detailsDescEl.textContent = detailsDescFull.slice(0, limit) + '…';
        detailsReadMore.classList.add('visible');
        detailsReadMore.textContent = 'Lire la suite';
      } else {
        detailsDescEl.textContent = detailsDescFull;
        if (detailsDescFull.length > limit) {
          detailsReadMore.classList.add('visible');
          detailsReadMore.textContent = 'Réduire';
        } else {
          detailsReadMore.classList.remove('visible');
        }
      }
    }

    function renderSeller(ad) {
      const avatarUrl = (ad.img || '').replace('w=1200', 'w=200').replace('q=80', 'q=60');
      const memberDate = formatDateLong(ad.date);
      detailsSeller.innerHTML = `
        <img src="${avatarUrl}" alt="Vendeur ${ad.city}">
        <div class="seller-meta">
          <strong>${ad.seller || `Vendeur ${ad.city}`}</strong>
          <span>Membre depuis le ${memberDate}</span>
          <span>${Math.max(1, Math.round(ad.likes / 3))} annonce(s) active(s)</span>
        </div>
      `;
    }

    function setDetailsSaveState(isFav) {
      detailsSave.classList.toggle('active', isFav);
      detailsSave.setAttribute('aria-pressed', String(isFav));
      const svg = detailsSave.querySelector('svg');
      const span = detailsSave.querySelector('span');
      const path = svg.querySelector('path');
      if (path) {
        path.setAttribute('fill', isFav ? 'currentColor' : 'none');
        path.setAttribute('stroke', 'currentColor');
      }
      span.textContent = isFav ? 'Retirer des favoris' : 'Ajouter aux favoris';
    }

    function syncFavoriteButtons(id, isFav) {
      grid.querySelectorAll(`.fav[data-id="${id}"]`).forEach(btn => {
        btn.setAttribute('aria-pressed', String(isFav));
        const svg = btn.querySelector('svg');
        svg.setAttribute('fill', isFav ? '#ef4444' : 'none');
        svg.setAttribute('stroke', isFav ? '#ef4444' : 'currentColor');
      });
      favCount.textContent = favStore.get().size;
    }

    function openDetailsModal(adData) {
      detailsCurrentAd = adData;
      detailsCurrentImages = buildGallery(adData);
      detailsCurrentIndex = 0;
      detailsTitleEl.textContent = adData.title;
      detailsPriceEl.innerHTML = `<strong>${fmtPrice(adData.price)}</strong>`;
      renderDetailsMeta(adData);
      renderDetailsTags(adData);
      setDetailsDescription(adData.desc);
      renderSeller(adData);
      renderGallery(detailsCurrentImages, adData.title);
      const favs = favStore.get();
      setDetailsSaveState(favs.has(adData.id));
      detailsSave.dataset.id = adData.id;

      detailsModal.style.display = 'flex';
      detailsModal.classList.add('active');
      detailsModal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closeDetailsModal() {
      detailsModal.style.display = 'none';
      detailsModal.classList.remove('active');
      detailsModal.setAttribute('aria-hidden', 'true');
      if (!authModal.classList.contains('active')) {
        document.body.style.overflow = '';
      }
      if (detailsSkeletonTimeout) {
        clearTimeout(detailsSkeletonTimeout);
        detailsSkeletonTimeout = null;
      }
      detailsCarouselTrack.innerHTML = '';
      detailsCarouselDots.innerHTML = '';
      detailsSkeleton.classList.remove('active');
      detailsCurrentImages = [];
      detailsCurrentIndex = 0;
      if (detailsPriceEl) {
        detailsPriceEl.innerHTML = '<strong>—</strong>';
      }
    }

    detailsPrev.addEventListener('click', () => changeSlide(-1));
    detailsNext.addEventListener('click', () => changeSlide(1));
    closeDetailsBtn.addEventListener('click', closeDetailsModal);
    detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) closeDetailsModal(); });

    detailsDownload.addEventListener('click', () => {
      if (!detailsCurrentImages.length) return;
      window.open(detailsCurrentImages[detailsCurrentIndex], '_blank', 'noopener');
      showToast('Ouverture de l’image...');
    });

    detailsFullscreen.addEventListener('click', () => {
      if (!detailsCurrentImages.length) return;
      window.open(detailsCurrentImages[detailsCurrentIndex], '_blank', 'noopener');
    });

    detailsSave.addEventListener('click', () => {
      if (!detailsCurrentAd) return;
      const id = detailsCurrentAd.id;
      const favs = favStore.get();
      const isFav = favs.has(id);
      if (isFav) {
        favs.delete(id);
        detailsSave.classList.remove('animating'); // Préparation pour future animation
        showToast('Retiré des favoris');
      } else {
        favs.add(id);
        triggerFavAnimation(detailsSave); // Déclenche l'animation
        showToast('Ajouté aux favoris');
      }
      favStore.set(favs);
      setDetailsSaveState(!isFav);
      syncFavoriteButtons(id, !isFav);
    });

    detailsContact.addEventListener('click', () => {
      showToast('Contact envoyé au vendeur 📬');
    });

    detailsVisit.addEventListener('click', () => {
      if (!detailsCurrentAd) return;
      closeDetailsModal();
      showMap();
      setTimeout(() => {
        ensureMap();
        if (map && detailsCurrentAd.latlng) {
          map.setView(detailsCurrentAd.latlng, 13, { animate: true });
        }
      }, 250);
    });

    detailsReadMore.addEventListener('click', () => {
      detailsDescExpanded = !detailsDescExpanded;
      updateDescription();
    });

    document.addEventListener('keydown', (e) => {
      if (detailsModal.style.display !== 'flex') return;
      if (e.key === 'Escape') closeDetailsModal();
      if (e.key === 'ArrowRight') changeSlide(1);
      if (e.key === 'ArrowLeft') changeSlide(-1);
    });

    grid.addEventListener('click', (e) => {
      const adWrapper = e.target.closest('.ad-content');
      if (!adWrapper || e.target.closest('.fav')) return;
      const adId = +adWrapper.dataset.id;
      const adData = allItems.find(item => item.id === adId);
      if (adData) openDetailsModal(adData);
    });

    // ---------- FAVORITES SHEET ----------
    const openFavsBtn = document.getElementById('openFavs');
    const closeFavsBtn = document.getElementById('closeFavs');
    const favModal = document.getElementById('favModal');
    const favOverlay = document.getElementById('favOverlay');
    const favList = document.getElementById('favList');
    const favSheetCount = document.getElementById('favSheetCount');
    const favEmptyState = document.getElementById('favEmptyState');
    const favSearch = document.getElementById('favSearch');
    const favSortBy = document.getElementById('favSortBy');
    const favByCat = document.getElementById('favByCat');
    const clearAllFavsBtn = document.getElementById('clearAllFavs');
    const favBrowseBtn = document.getElementById('favBrowse');

    function openFavSheet() {
      renderFavSheet();
      favModal.classList.add('mm-open');
      favOverlay.classList.add('mm-show');
      favModal.setAttribute('aria-hidden', 'false');
    }

    function closeFavSheet() {
      favModal.classList.remove('mm-open');
      favOverlay.classList.remove('mm-show');
      favModal.setAttribute('aria-hidden', 'true');
    }

    function renderFavSheet() {
      const favs = favStore.get();
      let items = allItems.filter(item => favs.has(item.id));

      // Filtering
      const query = normalize(favSearch.value);
      if (query) {
        items = items.filter(item => normalize(item.title).includes(query));
      }
      if (favByCat.value !== 'all') {
        items = items.filter(item => item.cat === favByCat.value);
      }

      // Sorting
      if (favSortBy.value === 'price_asc') {
        items.sort((a, b) => a.price - b.price);
      } else if (favSortBy.value === 'price_desc') {
        items.sort((a, b) => b.price - a.price);
      } else { // recent
        items.sort((a, b) => new Date(b.date) - new Date(a.date));
      }

      favSheetCount.textContent = items.length;
      favList.innerHTML = '';

      if (items.length === 0) {
        favList.hidden = true;
        favEmptyState.hidden = false;
      } else {
        favList.hidden = false;
        favEmptyState.hidden = true;
        items.forEach(item => {
          const card = document.createElement('li');
          card.className = 'mm-card-item';
          card.dataset.id = item.id;
          card.innerHTML = `
            <div class="mm-thumb">
              <img src="${item.img}" alt="${item.title}" loading="lazy">
              <button class="mm-heart" data-id="${item.id}" aria-label="Retirer des favoris">
                <svg viewBox="0 0 24 24"><path d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
              </button>
            </div>
            <div class="mm-body">
              <div class="mm-title2">${item.title}</div>
              <div class="mm-meta">
                <span>${item.city}</span>
                <span class="mm-price">${fmtPrice(item.price)}</span>
              </div>
            </div>
          `;
          card.querySelector('.mm-heart').addEventListener('click', (e) => {
            e.stopPropagation();
            const favs = favStore.get();
            favs.delete(item.id);
            favStore.set(favs);
            syncFavoriteButtons(item.id, false);
            renderFavSheet();
            showToast('Retiré des favoris.');
          });
          card.addEventListener('click', () => {
            openDetailsModal(item);
            closeFavSheet();
          });
          favList.appendChild(card);
        });
      }

      // Update category filter
      const uniqueCats = [...new Set(allItems.filter(it => favs.has(it.id)).map(it => it.cat))];
      const currentCatVal = favByCat.value;
      favByCat.innerHTML = '<option value="all">Toutes catégories</option>';
      uniqueCats.sort().forEach(cat => {
        favByCat.innerHTML += `<option value="${cat}">${cat}</option>`;
      });
      favByCat.value = uniqueCats.includes(currentCatVal) ? currentCatVal : 'all';
    }

    openFavsBtn.addEventListener('click', openFavSheet);
    closeFavsBtn.addEventListener('click', closeFavSheet);
    favOverlay.addEventListener('click', closeFavSheet);
    favBrowseBtn.addEventListener('click', closeFavSheet);
    [favSearch, favSortBy, favByCat].forEach(el => el.addEventListener('input', renderFavSheet));

    clearAllFavsBtn.addEventListener('click', () => {
      if (favStore.get().size > 0 && confirm('Voulez-vous vraiment retirer tous vos favoris ?')) {
        const idsToRemove = [...favStore.get()];
        favStore.set(new Set());
        idsToRemove.forEach(id => syncFavoriteButtons(id, false));
        renderFavSheet();
        showToast('Tous les favoris ont été retirés.');
      }
    });

    // ---------- FAVORITE ANIMATION ----------
    function triggerFavAnimation(buttonEl) {
      if (!buttonEl || buttonEl.classList.contains('animating')) return;

      buttonEl.classList.add('animating');

      // 1. Créer le conteneur pour les particules
      let wrapper = buttonEl.querySelector('.fav-anim-wrapper');
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'fav-anim-wrapper';
        buttonEl.appendChild(wrapper);
      }
      wrapper.innerHTML = ''; // Vider les anciennes particules

      // 2. Créer et animer les particules
      const particleCount = 7;
      const angleIncrement = (2 * Math.PI) / particleCount;
      const radius = 25; // Distance de dispersion

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'fav-particle';
        const angle = i * angleIncrement;
        // Calcul de la position finale pour l'animation
        const tx = `calc(-50% + ${radius * Math.cos(angle)}px)`;
        const ty = `calc(-50% + ${radius * Math.sin(angle)}px)`;
        particle.style.setProperty('--tx', tx);
        particle.style.setProperty('--ty', ty);
        wrapper.appendChild(particle);
      }

      // 3. Nettoyer après l'animation
      setTimeout(() => { buttonEl.classList.remove('animating'); if (wrapper) wrapper.innerHTML = ''; }, 600);
    }

    // ---------- TOAST ----------
    const toast = document.getElementById('toast');
    function showToast(msg) { toast.textContent = msg; toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 1800); }

    // ---------- INIT ----------
    renderList(true); updateAuthUI();
  </script>
</body>

</html>
