<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="MapMarket : trouvez des annonces près de chez vous sur une carte rapide et accessible.">
  <meta name="theme-color" content="#0f172a">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https://images.unsplash.com https://*.tile.openstreetmap.org https://tile.openstreetmap.org https://via.placeholder.com https://unpkg.com data:; style-src 'self' 'unsafe-inline' https://unpkg.com; script-src 'self' 'unsafe-inline' https://unpkg.com; connect-src 'self'; font-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'self'">
  <link rel="canonical" href="https://tondomaine.com/">
  <link rel="preconnect" href="https://images.unsplash.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png">
  <title>MapMarket — Liste + Carte + Infini</title>
  <!-- Leaflet & MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    :root {
      --primary: #ff4d6d;
      --primary-600: #ff5875;
      --primary-700: #ff3f62;
      --bg: #f6f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #111827;
      --border: #e5e7eb;
      --chip: #eff6ff;
      --chip-text: #1d4ed8;
      --shadow: 0 12px 26px rgba(0, 0, 0, .10);
      --glass: rgba(255, 255, 255, .6);
      --z-map: 100;
      --z-drawer: 1500;
      --z-modal-overlay: 2000;
      --z-modal: 2010;
      --z-toast: 3000;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", sans-serif;
      color: var(--text);
      background: var(--bg)
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 30;
      background: #fff;
      border-bottom: 1px solid var(--border);
      backdrop-filter: saturate(150%) blur(6px)
    }

    .container {
      max-width: 1120px;
      margin-inline: auto;
      padding: 0 20px
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit
    }

    .brand .pin {
      width: 28px;
      height: 28px;
      color: var(--primary)
    }

    .brand b {
      font-size: 20px
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 14px
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      color: #374151;
      text-decoration: none
    }

    button.nav-link {
      background: none;
      border: none;
      font: inherit;
      color: inherit;
      cursor: pointer;
    }

    .nav-link:hover {
      background: #f3f4f6
    }

    .pill {
      position: relative
    }

    .pill .badge {
      position: absolute;
      right: -6px;
      top: -6px;
      min-width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--primary);
      color: #fff;
      font-size: 11px;
      display: grid;
      place-items: center;
      padding: 0 6px;
      box-shadow: 0 6px 16px rgba(255, 77, 109, .35)
    }

    .cta {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-weight: 650;
      cursor: pointer;
      box-shadow: 0 8px 22px rgba(255, 77, 109, .35)
    }

    .cta:hover {
      filter: brightness(1.03)
    }

    .avatar {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
    }

    .avatar-btn {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform .25s ease, box-shadow .25s ease, background .25s ease;
      color: #fff;
    }

    .avatar-btn svg {
      width: 22px;
      height: 22px;
    }

    .avatar-btn.needs-auth {
      background: #f3f4f6;
      color: var(--primary);
      border: 1px solid var(--border);
      box-shadow: 0 4px 14px rgba(15, 23, 42, .12);
    }

    .avatar-btn.needs-auth:hover {
      background: #fff;
      transform: translateY(-1px);
    }

    .avatar-btn.is-auth {
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      box-shadow: 0 10px 26px rgba(255, 77, 109, .35);
    }

    .avatar-btn.is-auth:hover {
      transform: translateY(-1px);
    }

    .avatar-btn:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 3px;
    }

    /* Hero */
    .hero {
      padding: 24px 0 4px;
      text-align: center
    }

    .hero h1 {
      font-size: 36px;
      line-height: 1.1;
      margin: 0 0 10px
    }

    .hero p {
      color: #6b7280;
      margin: 0
    }

    /* Filters card */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
    }

    .filters-card {
      padding: 26px 28px 30px;
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, .18);
      background: linear-gradient(140deg, rgba(255, 255, 255, .96) 0%, rgba(245, 246, 250, .92) 100%);
      box-shadow: 0 26px 48px rgba(15, 23, 42, .08);
      backdrop-filter: blur(18px);
    }

    .filters-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 22px;
    }

    .filters-title {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .filters-title svg {
      width: 36px;
      height: 36px;
      padding: 8px;
      border-radius: 12px;
      background: rgba(255, 77, 109, .12);
      color: var(--primary);
    }

    .filters-heading {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .filters-subheading {
      margin: 2px 0 0;
      color: #6b7280;
      font-size: 13px;
    }

    .filters-reset {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .35);
      background: rgba(255, 255, 255, .6);
      color: #374151;
      font-weight: 600;
      cursor: pointer;
      transition: all .25s ease;
      backdrop-filter: blur(12px);
    }

    .filters-reset svg {
      width: 16px;
      height: 16px;
    }

    .filters-reset:hover {
      border-color: rgba(255, 77, 109, .4);
      color: var(--primary);
      box-shadow: 0 8px 24px rgba(255, 77, 109, .18);
    }

    .filters-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .filter-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      font-weight: 600;
      font-size: 13px;
      color: #4b5563;
      letter-spacing: .01em;
    }

    .filter-control {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 48px;
      background-color: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 8px 12px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .filter-control:focus-within {
      border: 1px solid var(--primary, #ff4d6d);
      box-shadow: 0 0 0 3px rgba(255, 77, 109, 0.15);
    }

    .filter-control input,
    .filter-control select {
      border: none;
      outline: none;
      flex: 1;
      font-size: 14px;
      background: transparent;
      color: var(--text, #333);
      border-radius: inherit;
      padding: 0 16px 0 32px;
    }

    .filter-control select {
      appearance: none;
      padding-right: 32px;
      cursor: pointer;
    }

    .filter-control input::placeholder {
      color: #9ca3af;
    }

    .filter-icon,
    .filter-chevron {
      flex-shrink: 0;
      color: #d43c58;
      opacity: 0.7;
    }

    .filter-control:hover {
      border-color: #ffa1b2;
    }

    .filter-icon {
      position: absolute;
      left: 16px;
      width: 18px;
      height: 18px;
      pointer-events: none;
    }

    .filter-chevron {
      position: absolute;
      right: 16px;
      width: 16px;
      height: 16px;
      pointer-events: none;
    }

    .filter-search {
      grid-column: span 2;
    }

    @media (max-width: 1024px) {
      .filter-search {
        grid-column: span 1;
      }
    }

    @media (max-width: 640px) {
      .filters-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .filters-reset {
        width: 100%;
        justify-content: center;
      }
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      justify-content: flex-start;
      margin: 16px 0
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer
    }

    .tab.active {
      box-shadow: 0 2px 8px rgba(0, 0, 0, .06)
    }

    /* Grid & Map */
    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(4, 1fr)
    }

    @media (max-width:1180px) {
      .grid {
        grid-template-columns: repeat(3, 1fr)
      }
    }

    @media (max-width:880px) {
      .grid {
        grid-template-columns: repeat(2, 1fr)
      }
    }

    @media (max-width:560px) {
      .grid {
        grid-template-columns: 1fr
      }
    }

    #map {
      height: 560px;
      border: 1px solid var(--border);
      border-radius: 16px;
      display: none
    }

    /* Card item */
    .ad {
      position: relative;
      overflow: hidden;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      transition: box-shadow .25s;
    }

    .ad::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      height: 3px;
      width: 0%;
      background-color: var(--primary);
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ad:hover::after {
      width: 100%;
    }

    .ad:hover {
      box-shadow: var(--shadow)
    }

    .thumb {
      position: relative;
      aspect-ratio: 4/3;
      background: #eef
    }

    .thumb img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover
    }

    .grad {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, .45), transparent 60%)
    }

    .cat {
      position: absolute;
      left: 10px;
      top: 10px;
      color: #fff;
      font-weight: 700;
      font-size: 13px;
      border-radius: 999px;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .immobilier {
      background: linear-gradient(135deg, #6366f1, #818cf8)
    }

    .mode {
      background: linear-gradient(135deg, #ec4899, #f472b6)
    }

    .hitech {
      background: linear-gradient(135deg, #8b5cf6, #a78bfa)
    }

    .auto {
      background: linear-gradient(135deg, #f59e0b, #f97316)
    }

    .maison {
      background: linear-gradient(135deg, #10b981, #34d399)
    }

    .fav {
      position: absolute;
      right: 10px;
      top: 10px;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .9);
      backdrop-filter: blur(4px);
      display: grid;
      place-items: center;
      box-shadow: 0 10px 18px rgba(0, 0, 0, .14);
      border: none;
      cursor: pointer
    }

    .fav svg {
      width: 18px;
      height: 18px;
      color: #374151
    }

    .body {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .titleprice {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      justify-content: space-between
    }

    .title {
      font-weight: 700;
      font-size: 16px;
      line-height: 1.2
    }

    .price {
      color: var(--primary);
      font-weight: 800;
      font-size: 18px;
      white-space: nowrap
    }

    .desc {
      color: #4b5563;
      font-size: 13px;
      line-height: 1.4;
      /* Ajout pour tronquer le texte */
      display: -webkit-box;
      --webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px
    }

    .chip {
      background: var(--chip);
      border: 1px solid #bfdbfe;
      color: var(--chip-text);
      border-radius: 999px;
      font-size: 12px;
      padding: 4px 10px
    }

    .meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      color: #374151
    }

    .loc {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0
    }

    .loc svg {
      width: 14px;
      height: 14px
    }

    .state {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      white-space: nowrap
    }

    .stats {
      display: flex;
      gap: 12px;
      color: #6b7280;
    }
    .thumb .stats {
      position: absolute;
      bottom: 10px;
      right: 10px;
      color: #fff;
      text-shadow: 0 1px 3px rgba(0,0,0,.3);
    }

    .time {
      margin-top: -4px;
      color: #6b7280;
      font-size: 12px
    }

    /* Infinite loader */
    #sentinel {
      height: 1px
    }

    .loading {
      display: grid;
      place-items: center;
      margin: 16px 0;
      color: var(--muted)
    }

    /* Modal base */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, .55);
      backdrop-filter: blur(6px);
      z-index: var(--z-modal-overlay);
    }

    .modal {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 24px 48px rgba(15, 23, 42, .28);
      overflow: hidden;
    }

    .modal .pane {
      padding: 22px;
    }

    /* Auth modal */
    .auth-backdrop {
      display: flex;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .4s cubic-bezier(.4, 0, .2, 1), visibility 0s .4s;
    }

    .auth-backdrop.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transition: opacity .4s cubic-bezier(.4, 0, .2, 1), visibility 0s;
    }

    .auth-dialog {
      position: relative;
      z-index: var(--z-modal);
      background: #fff;
      border-radius: 24px;
      overflow: hidden;
      width: min(900px, 94vw);
      min-height: 600px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      transform: scale(.92) translateY(40px);
      opacity: 0;
      transition: transform .4s cubic-bezier(.4, 0, .2, 1), opacity .4s cubic-bezier(.4, 0, .2, 1);
    }

    .auth-backdrop.active .auth-dialog {
      transform: scale(1) translateY(0);
      opacity: 1;
    }

    .auth-close {
      position: absolute;
      top: 24px;
      right: 24px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, .25);
      backdrop-filter: blur(6px);
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      transition: transform .3s ease, background .3s ease;
      z-index: 5;
    }

    .auth-close:hover {
      background: rgba(255, 255, 255, .38);
      transform: rotate(90deg);
    }

    .auth-hero {
      position: relative;
      background: linear-gradient(135deg, #ff4d6d 0%, #ff6b8a 100%);
      color: #fff;
      padding: 40px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      overflow: hidden;
    }

    .auth-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, .16) 0%, transparent 70%);
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0) rotate(0deg);
      }

      50% {
        transform: translateY(-18px) rotate(4deg);
      }
    }

    .auth-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
      z-index: 2;
    }

    .auth-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .auth-brand .pin {
      width: 32px;
      height: 32px;
      filter: drop-shadow(0 6px 16px rgba(0, 0, 0, .2));
    }

    .auth-brand strong {
      font-size: 24px;
      letter-spacing: -.4px;
    }

    .auth-hero-content {
      position: relative;
      z-index: 2;
    }

    .auth-hero-content h2 {
      font-size: 32px;
      font-weight: 700;
      margin: 0 0 12px 0;
      line-height: 1.2;
    }

    .auth-hero-content p {
      font-size: 16px;
      opacity: .9;
      margin: 0;
      line-height: 1.5;
    }

    .auth-hero-illus {
      position: relative;
      z-index: 2;
      font-size: 84px;
      text-align: center;
      opacity: .85;
      margin-top: 40px;
    }

    .auth-pane {
      padding: 40px;
      display: flex;
      flex-direction: column;
    }

    .auth-tabs {
      position: relative;
      display: flex;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 32px;
    }

    .auth-tab {
      flex: 1;
      background: transparent;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: color .3s ease;
      position: relative;
      z-index: 2;
      color: #4b5563;
    }

    .auth-tab.active {
      color: #ff4d6d;
    }

    .auth-indicator {
      position: absolute;
      top: 4px;
      left: 4px;
      width: calc(50% - 4px);
      height: calc(100% - 8px);
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(15, 23, 42, .12);
      transition: transform .3s cubic-bezier(.4, 0, .2, 1), opacity .2s ease;
    }

    .auth-indicator.signup {
      transform: translateX(100%);
    }

    .auth-indicator.hidden {
      opacity: 0;
    }

    .auth-forms {
      position: relative;
      overflow: hidden;
      min-height: 400px;
      flex: 1;
    }

    .auth-form {
      width: 100%;
      transition: transform .4s cubic-bezier(.4, 0, .2, 1), opacity .3s ease;
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      transform: translateX(20%);
      pointer-events: none;
      display: flex;
      flex-direction: column;
      gap: 18px;
      padding-right: 2px;
    }

    .auth-form.active {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }

    .auth-label {
      display: block;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .auth-input-wrapper {
      position: relative;
    }

    .auth-input {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      transition: border-color .3s ease, box-shadow .3s ease;
      background: #fff;
    }

    .auth-input:focus {
      outline: none;
      border-color: #ff4d6d;
      box-shadow: 0 0 0 3px rgba(255, 77, 109, .15);
    }

    .auth-input.error {
      border-color: #e53e3e;
      box-shadow: 0 0 0 3px rgba(229, 62, 62, .18);
    }

    .password-toggle {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: none;
      cursor: pointer;
      font-size: 18px;
      opacity: .6;
      transition: opacity .3s ease;
    }

    .password-toggle:hover {
      opacity: 1;
    }

    .auth-submit {
      width: 100%;
      background: linear-gradient(135deg, #ff4d6d 0%, #ff6b8a 100%);
      color: #fff;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform .3s ease, box-shadow .3s ease;
      margin-top: 6px;
      position: relative;
      overflow: hidden;
    }

    .auth-submit:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 28px rgba(255, 77, 109, .35);
    }

    .auth-submit:active {
      transform: translateY(0);
    }

    .auth-submit.loading {
      pointer-events: none;
      color: transparent;
    }

    .auth-submit.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid rgba(255, 255, 255, .4);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .auth-forgot {
      text-align: center;
      margin-top: 16px;
    }

    .auth-forgot button {
      background: none;
      border: none;
      color: #ff4d6d;
      cursor: pointer;
      font-weight: 600;
      text-decoration: underline;
    }

    .auth-demo {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      font-size: 12px;
      color: #718096;
      margin-top: 24px;
    }

    .auth-success {
      background: #f0fff4;
      border: 1px solid #9ae6b4;
      color: #22543d;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
    }

    .form-error {
      color: #e53e3e;
      font-size: 12px;
      margin-top: 6px;
    }

    .slide-out-left {
      transform: translateX(-100%) !important;
      opacity: 0 !important;
    }

    .slide-out-right {
      transform: translateX(100%) !important;
      opacity: 0 !important;
    }

    .slide-in-left {
      transform: translateX(-100%);
      opacity: 0;
    }

    .slide-in-right {
      transform: translateX(100%);
      opacity: 0;
    }

    @media (max-width: 768px) {
      .auth-dialog {
        grid-template-columns: 1fr;
        min-height: auto;
      }

      .auth-hero {
        padding: 32px;
        min-height: 220px;
      }

      .auth-pane {
        padding: 32px 28px;
      }

      .auth-forms {
        min-height: 360px;
      }

      .auth-hero-content h2 {
        font-size: 26px;
      }

      .auth-hero-illus {
        font-size: 62px;
        margin-top: 24px;
      }
    }

    /* Leaflet overrides + cluster style */
    .leaflet-container {
      font: inherit
    }

    .marker-cluster-small,
    .marker-cluster-medium,
    .marker-cluster-large {
      background: transparent
    }

    .marker-cluster div {
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      color: #fff;
      border: 2px solid #fff;
      box-shadow: 0 6px 16px rgba(255, 77, 109, .35);
    }

    .marker-cluster span {
      font-weight: 800
    }

    /* Toast */
    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      display: none;
      background: #111827;
      color: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      box-shadow: var(--shadow);
      z-index: var(--z-toast);
    }

    /* --- Animation Favoris --- */
    .fav-anim-wrapper {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      border-radius: inherit;
    }

    .fav-particle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: var(--primary);
      opacity: 0;
      /* L'animation est déclenchée par JS */
    }

    .fav.animating .fav-particle {
      animation: fav-burst 0.6s ease-out forwards;
    }

    .fav.animating svg,
    .cta-outline.animating svg {
      animation: fav-pop 0.6s cubic-bezier(0.25, 0.1, 0.25, 1.5) forwards;
    }

    @keyframes fav-pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.35); }
      100% { transform: scale(1); }
    }

    @keyframes fav-burst {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0.8;
      }
      100% {
        /* La translation finale est définie via une variable CSS par JS */
        transform: translate(var(--tx, -50%), var(--ty, -50%)) scale(0);
        opacity: 0;
      }
    }
    /* S'assure que le SVG a une transition douce pour le remplissage */
    .fav svg path, .details-actions .cta-outline svg path {
      transition: fill 0.2s ease;
    }
  </style>
  <style>
    [hidden] { display: none !important; }
    .no-scroll { overflow: hidden; }
    body.modal-open { overflow: hidden; }
    #map { position: relative; z-index: var(--z-map); }
    .leaflet-container { z-index: var(--z-map); }
    .leaflet-container .leaflet-top,
    .leaflet-container .leaflet-bottom { z-index: var(--z-map); }
    #map.is-obscured,
    .map-wrapper.is-obscured { pointer-events: none; }
    .mm-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, .45); backdrop-filter: saturate(120%) blur(2px); opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: var(--z-drawer); }
    .mm-overlay.active { opacity: 1; pointer-events: auto; }
    .mm-modal { position: fixed; top: 0; right: 0; height: 100dvh; width: min(720px, 92vw); max-width: 720px; background: #fff; box-shadow: -8px 0 24px rgba(16, 24, 40, .12); transform: translateX(110%); transition: transform .25s ease; display: flex; flex-direction: column; z-index: var(--z-drawer); overflow: hidden; }
    .mm-modal.mm-open { transform: translateX(0); }
    .mm-header { padding: 16px 20px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: #fff; z-index: 1; display: flex; flex-direction: column; gap: 12px; }
    .mm-header-row { display: flex; align-items: center; gap: 12px; }
    .mm-header h2 { font-size: 1.25rem; font-weight: 800; margin: 0; display: flex; align-items: center; gap: 6px; }
    .mm-count { font-weight: 700; color: #e11d48; }
    .mm-actions { margin-left: auto; display: flex; align-items: center; gap: 8px; }
    .mm-link { background: none; border: 0; color: #0a66c2; cursor: pointer; font-weight: 600; padding: 0; }
    .mm-link.danger { color: #e11d48; }
    .mm-icon { border: 0; background: #f3f4f6; width: 32px; height: 32px; border-radius: 999px; cursor: pointer; display: grid; place-items: center; font-size: 16px; }
    .mm-toolbar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .mm-search { position: relative; flex: 1 1 240px; }
    .mm-search input { width: 100%; height: 36px; border: 1px solid #e5e7eb; border-radius: 999px; padding: 0 12px 0 32px; outline: none; font: inherit; }
    .mm-search-ico { position: absolute; left: 10px; top: 8px; opacity: .6; pointer-events: none; }
    .mm-filters { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .mm-filters select { height: 36px; border: 1px solid #e5e7eb; border-radius: 10px; padding: 0 10px; background: #fff; font: inherit; }
    .mm-modal .mm-grid { display: grid; grid-template-columns: 1fr; gap: 16px; padding: 16px; overflow: auto; flex: 1 1 auto; scrollbar-gutter: stable both-edges; overscroll-behavior: contain; }
    .mm-modal .mm-grid.mm-grid-filter-empty { display: flex; align-items: center; justify-content: center; height: 100%; }
    @media (min-width: 860px) { .mm-modal .mm-grid { grid-template-columns: 1fr 1fr; } }
    .mm-card { position: relative; display: flex; flex-direction: column; justify-content: space-between; height: 320px; border-radius: 14px; background: #fff; overflow: hidden; box-shadow: 0 1px 0 rgba(16,24,40,.04), 0 1px 2px rgba(16,24,40,.06); transition: transform 0.2s ease, opacity 0.2s ease; border: 1px solid var(--border); }
    .mm-card:hover { box-shadow: 0 8px 22px rgba(15,23,42,.08); border-color: #dbe0e6; }
    .mm-thumb { flex: 0 0 auto; }
    .mm-thumb img { width: 100%; height: 200px; object-fit: cover; display: block; }
    .mm-body { flex: 1 0 auto; min-height: 120px; max-height: 120px; display: flex; flex-direction: column; justify-content: space-between; padding: 8px 14px; gap: 6px; }
    .mm-title2 { font-weight: 800; font-size: 1rem; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
    .mm-meta { display: flex; justify-content: space-between; align-items: center; padding-top: 6px; border-top: 1px solid #e5e7eb; font-size: .9rem; color: #6b7280; }
    .mm-price { margin-left: auto; font-weight: 700; color: #e11d48; }
    .mm-remove { position: absolute; top: 10px; right: 10px; width: 36px; height: 36px; border-radius: 999px; display: grid; place-items: center; cursor: pointer; border: 1px solid #f3d0d8; background: #fff; color: #e11d48; box-shadow: 0 6px 14px rgba(225, 29, 72, .15); }
    .mm-remove:hover { background: #fff0f3; border-color: #f7b4c1; }
    .mm-remove:focus-visible { outline: 2px solid #fda4af; outline-offset: 2px; }
    .mm-heart { display: none; }
    .mm-empty { flex: 1 1 auto; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px 20px; text-align: center; gap: 10px; color: #111; margin: 0 auto; width: 100%; max-width: 360px; }
    .mm-empty.mm-empty-filter { justify-content: center; min-height: 160px; }
    .mm-empty-illu { font-size: 38px; }
    .mm-card.added { opacity: 0; transform: scale(0.95); animation: fadeInCard 0.25s forwards; }
    @keyframes fadeInCard { to { opacity: 1; transform: scale(1); } }
  </style>
  <!-- Styles pour le modal de détails -->
  <style>
    .details-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 28px 16px;
      background:
        radial-gradient(circle at 15% 20%, rgba(255, 77, 109, .12), transparent 60%),
        radial-gradient(circle at 85% 10%, rgba(14, 165, 233, .1), transparent 55%),
        rgba(15, 23, 42, .38);
      backdrop-filter: blur(12px);
      z-index: var(--z-modal-overlay);
    }

    .details-backdrop.active {
      display: flex;
    }

    .details-dialog {
      position: relative;
      width: min(40vw, 700px);
      max-height: min(92vh, 820px);
      background: #ffffff;
      border-radius: 26px;
      overflow: hidden;
      box-shadow: 0 40px 80px rgba(15, 23, 42, .32);
      display: grid;
      grid-template-rows: auto 1fr;
      border: 1px solid rgba(226, 232, 240, .55);
      animation: modalIn .45s cubic-bezier(.2, .8, .2, 1);
      z-index: var(--z-modal);
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translateY(40px) scale(.96);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .details-close {
      position: absolute;
      top: 22px;
      right: 22px;
      width: 46px;
      height: 46px;
      border-radius: 16px;
      border: none;
      background: rgba(255, 255, 255, .9);
      box-shadow: 0 16px 32px rgba(15, 23, 42, .18);
      backdrop-filter: blur(14px);
      color: #111827;
      font-size: 22px;
      cursor: pointer;
      z-index: 5;
      transition: transform .28s ease, background .3s ease, color .3s ease;
    }

    .details-close:hover {
      transform: translateY(-1px) rotate(90deg);
      background: rgba(255, 77, 109, .14);
      color: var(--primary);
    }

    .details-media {
      position: relative;
      background: #f1f5f9;
      aspect-ratio: 16 / 9;
      overflow: hidden;
    }

    .details-carousel {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .carousel-track {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .carousel-slide {
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity .4s ease;
    }

    .carousel-slide.active {
      opacity: 1;
      z-index: 1;
    }

    .carousel-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .carousel-nav {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      transform: translateY(-50%);
      padding: 0 12px;
      pointer-events: none;
      z-index: 2;
    }

    .carousel-btn {
      width: 42px;
      height: 42px;
      border: none;
      border-radius: 999px;
      background: rgba(17, 24, 39, .55);
      color: #fff;
      display: grid;
      place-items: center;
      cursor: pointer;
      pointer-events: auto;
      transition: transform .2s ease, background .2s ease;
    }

    .carousel-btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 77, 109, .75);
    }

    .carousel-meta {
      position: absolute;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      z-index: 3;
    }

    .carousel-counter {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(17, 24, 39, .52);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
    }

    .carousel-dots {
      display: flex;
      gap: 8px;
    }

    .carousel-dot {
      width: 32px;
      height: 4px;
      border-radius: 999px;
      border: none;
      background: rgba(255, 255, 255, .45);
      cursor: pointer;
      transition: background .2s ease, transform .2s ease, width .2s ease;
    }

    .carousel-dot.active {
      width: 42px;
      background: var(--primary);
      transform: translateY(-1px);
    }

    .details-meta.details-meta-stats {
      position: absolute;
      right: 20px;
      bottom: 18px;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 8px 10px;
      background: #fff;
      border: 1px solid var(--border, #e5e7eb);
      border-radius: 999px;
      box-shadow: 0 1px 0 rgba(16, 24, 40, .04), 0 1px 2px rgba(16, 24, 40, .06);
      z-index: 3;
    }

    .details-meta.details-meta-stats .details-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: #111827;
      background: transparent;
      border: none;
      padding: 0;
      border-radius: 0;
    }

    .details-meta.details-meta-stats .details-meta-item .icon {
      line-height: 1;
      font-size: 16px;
    }

    .details-meta.details-meta-stats .details-meta-item .label {
      color: #374151;
    }

    .details-meta.details-meta-stats .details-meta-item.fav-meta .icon {
      filter: saturate(120%);
    }

    .details-meta.details-meta-stats .details-meta-item.views,
    .details-meta.details-meta-stats .details-meta-item.fav-meta {
      background: transparent;
      border: none;
      color: #111827;
    }

    .details-skeleton {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(110deg, rgba(236, 241, 247, .7) 25%, rgba(255, 255, 255, .9) 45%, rgba(236, 241, 247, .7) 65%);
      background-size: 200% 100%;
      border-radius: inherit;
      opacity: 0;
      transition: opacity .25s ease;
      z-index: 3;
    }

    .details-skeleton.active {
      opacity: 1;
      animation: shimmer 1.4s linear infinite;
    }

    .details-skeleton::after {
      content: '';
      position: absolute;
      inset: 30px;
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, .15);
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .details-body {
      padding: 32px 32px 34px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 26px;
      background: #fff;
    }

    .details-hero-card {
      display: flex;
      justify-content: space-between;
      gap: 28px;
      align-items: flex-start;
      border-bottom: 1px solid rgba(226, 232, 240, .8);
      padding-bottom: 22px;
    }

    .details-hero-info {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-width: min(70%, 520px);
    }

    .details-hero-info h2 {
      margin: 0;
      font-size: 30px;
      font-weight: 800;
      color: #0f172a;
    }

    .details-hero-info .cat {
      position: static;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 700;
      color: #fff;
      box-shadow: 0 12px 26px rgba(15, 23, 42, .18);
      margin-bottom: 0;
    }

    .details-hero-info .cat span {
      white-space: nowrap;
    }

    .details-price {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      min-width: 120px;
      box-shadow: 0 14px 30px rgba(255, 77, 109, .22);
    }

    .details-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 4px;
    }

    .details-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: .01em;
      background: rgba(241, 245, 249, .9);
      color: #475569;
      border: 1px solid rgba(226, 232, 240, .7);
    }

    .details-meta-item svg {
      width: 14px;
      height: 14px;
    }

    .details-meta-item .label {
      line-height: 1.2;
    }

    .details-meta-item.cat {
      background: rgba(255, 77, 109, .18);
      color: var(--primary);
      border-color: rgba(255, 77, 109, .22);
    }

    .details-meta-item.location {
      background: rgba(59, 130, 246, .16);
      color: #1d4ed8;
      border-color: rgba(59, 130, 246, .24);
    }

    .details-meta-item.date {
      background: rgba(129, 140, 248, .16);
      color: #4338ca;
      border-color: rgba(129, 140, 248, .24);
    }

    .details-meta-item.views {
      background: rgba(34, 197, 94, .16);
      color: #15803d;
      border-color: rgba(34, 197, 94, .26);
    }

    .details-meta-item.fav-meta {
      background: rgba(251, 191, 36, .18);
      color: #b45309;
      border-color: rgba(251, 191, 36, .28);
    }

    .details-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .details-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .details-tag {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(148, 163, 184, .16);
      color: #475569;
      font-size: 13px;
      font-weight: 600;
    }

    .details-section h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }

    .details-desc {
      color: #425066;
      line-height: 1.7;
      margin: 0;
      font-size: 15px;
    }

    .details-section:not(:last-of-type) {
      padding-bottom: 12px;
      border-bottom: 1px dashed rgba(226, 232, 240, .8);
    }

    .details-readmore {
      align-self: flex-start;
      border: none;
      background: none;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      display: none;
    }

    .details-readmore.visible {
      display: inline-flex;
    }

    .seller-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 18px;
      border-radius: 16px;
      background: rgba(248, 250, 252, .9);
      border: 1px solid rgba(226, 232, 240, .8);
      box-shadow: 0 12px 32px rgba(15, 23, 42, .08);
    }

    .seller-card img {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      object-fit: cover;
    }

    .seller-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      color: #4b5563;
    }

    .seller-meta strong {
      font-size: 15px;
      color: #0f172a;
    }

    .details-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-top: auto;
    }

    .details-actions button {
      flex: 1;
      min-width: 160px;
      height: 48px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: transform .2s ease, box-shadow .2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .details-actions button svg {
      width: 18px;
      height: 18px;
    }

    .cta-outline {
      background: rgba(255, 255, 255, .9);
      border: 1px solid rgba(148, 163, 184, .35);
      color: #1f2937;
    }

    .cta-outline.active {
      border-color: rgba(255, 77, 109, .5);
      color: var(--primary);
      box-shadow: 0 8px 20px rgba(255, 77, 109, .15);
    }

    .cta-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      color: #fff;
      box-shadow: 0 16px 34px rgba(255, 77, 109, .32);
    }

    .cta-secondary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      box-shadow: 0 16px 34px rgba(34, 197, 94, .28);
    }

    .details-actions button:hover {
      transform: translateY(-1px);
    }

    @media (max-width: 960px) {
      .details-dialog {
        width: min(70vw, 700px);
        max-height: 95vh;
      }

      .details-body {
        padding: 32px 20px 28px;
      }

      .details-hero-card {
        flex-direction: column;
        gap: 20px;
      }

      .details-price {
        align-items: flex-start;
      }
    }

    @media (max-width: 640px) {
      .details-dialog {
        border-radius: 20px;
        width: 92vw;
      }

      .carousel-nav {
        padding: 0 8px;
      }

      .carousel-btn {
        width: 36px;
        height: 36px;
      }

      .details-meta.details-meta-stats {
        right: 14px;
        bottom: 14px;
      }

      .details-actions {
        flex-direction: column;
      }

      .details-hero-card {
        padding: 20px;
      }

      .details-hero-info .cat {
        margin-bottom: 14px;
      }

      .details-price {
        width: 100%;
        gap: 8px;
        align-items: center;
      }
    }
  </style>
  
</head>

<body>
  <header class="header">
    <div class="container nav">
      <a class="brand" href="#">
        <svg class="pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0" />
          <circle cx="12" cy="10" r="3" />
        </svg>
        <b>MapMarket</b>
      </a>
      <nav class="nav-actions">
        <a class="nav-link" href="#"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z" />
          </svg><span>Messages</span></a>
        <button class="nav-link pill" type="button" id="openFavs"><svg width="20" height="20" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
          </svg><span>Favoris</span><span class="badge" id="fav-count">0</span></button>
        <button class="cta" id="postBtn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14" />
            <path d="M12 5v14" />
          </svg><span class="hide-sm">Déposer une annonce</span></button>
        <div class="avatar" id="avatar"></div>
      </nav>
    </div>
  </header>

  <main class="container" style="padding:20px 20px 60px">
    <section class="hero">
      <h1>Trouvez ce que vous cherchez</h1>
      <p>Des milliers d'articles d'occasion près de chez vous</p>
    </section>

    <!-- Filters -->
    <section class="card filters-card" aria-label="Filtres">
      <div class="filters-header">
        <div class="filters-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <line x1="21" x2="14" y1="4" y2="4" />
            <line x1="10" x2="3" y1="4" y2="4" />
            <line x1="21" x2="12" y1="12" y2="12" />
            <line x1="8" x2="3" y1="12" y2="12" />
            <line x1="21" x2="16" y1="20" y2="20" />
            <line x1="12" x2="3" y1="20" y2="20" />
            <line x1="14" x2="14" y1="2" y2="6" />
            <line x1="8" x2="8" y1="10" y2="14" />
            <line x1="16" x2="16" y1="18" y2="22" />
          </svg>
          <div>
            <p class="filters-heading">Affiner votre recherche</p>
            <p class="filters-subheading">Filtrez par catégorie, prix ou localisation</p>
          </div>
        </div>
        <button class="filters-reset" id="resetBtn" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="1 4 1 10 7 10" />
            <polyline points="23 20 23 14 17 14" />
            <path d="M20.49 9A9 9 0 0 0 5 5.55L1 10" />
            <path d="M3.51 15A9 9 0 0 0 19 18.45L23 14" />
          </svg>
          <span>Réinitialiser</span>
        </button>
      </div>
      <div class="filters-grid">
        <div class="filter-field filter-search">
          <label class="filter-label" for="search">Recherche globale</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.3-4.3" />
            </svg>
            <input id="search" type="search" placeholder="Titre, description, mots-clés" autocomplete="off" />
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="cat">Catégorie</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7" rx="1" />
              <rect x="14" y="3" width="7" height="7" rx="1" />
              <rect x="14" y="14" width="7" height="7" rx="1" />
              <rect x="3" y="14" width="7" height="7" rx="1" />
            </svg>
            <select id="cat" title="Catégories">
              <option value="">Toutes catégories</option>
              <option>Immobilier</option>
              <option>Mode</option>
              <option>High-Tech</option>
              <option>Auto</option>
              <option>Maison</option>
            </select>
            <svg class="filter-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="etat">État</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="4 14 8 10 12 14 16 10 20 14" />
              <polyline points="4 8 8 4 12 8 16 4 20 8" />
            </svg>
            <select id="etat" title="État">
              <option value="">Tous états</option>
              <option>Très bon état</option>
              <option>Bon état</option>
              <option>Neuf</option>
            </select>
            <svg class="filter-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="sort">Tri</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h11" />
              <path d="M3 12h7" />
              <path d="M3 18h3" />
              <path d="m15 18 6-6-6-6" />
            </svg>
            <select id="sort" title="Tri">
              <option value="recent">Plus récent</option>
              <option value="priceAsc">Prix croissant</option>
              <option value="priceDesc">Prix décroissant</option>
            </select>
            <svg class="filter-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="pmin">Prix minimum (€)</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 3v18" />
              <path d="M17 7H9.5a3.5 3.5 0 0 0 0 7H15a3.5 3.5 0 0 1 0 7H7" />
            </svg>
            <input id="pmin" type="number" min="0" inputmode="numeric" placeholder="Ex. 100" />
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="pmax">Prix maximum (€)</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 3v18" />
              <path d="M17 7H9.5a3.5 3.5 0 0 0 0 7H15a3.5 3.5 0 0 1 0 7H7" />
            </svg>
            <input id="pmax" type="number" min="0" inputmode="numeric" placeholder="Ex. 500" />
          </div>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="city">Ville</label>
          <div class="filter-control">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0" />
              <circle cx="12" cy="10" r="3" />
            </svg>
            <input id="city" type="text" placeholder="Ex. Paris" autocomplete="off" />
          </div>
        </div>
      </div>
    </section>

    <div style="display:flex;align-items:center;justify-content:space-between;margin:14px 2px 8px" class="muted"><span
        id="count">0 annonce</span>
      <div class="tabs" role="tablist">
        <div class="tab active" role="tab" aria-selected="true" id="tab-list"><svg width="16" height="16"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M3 12h.01" />
            <path d="M3 18h.01" />
            <path d="M3 6h.01" />
            <path d="M8 12h13" />
            <path d="M8 18h13" />
            <path d="M8 6h13" />
          </svg><span class="hide-sm">Liste</span></div>
        <div class="tab" role="tab" aria-selected="false" id="tab-map"><svg width="16" height="16" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M14.1 5.6a2 2 0 0 0 1.8 0l3.7-1.8a1 1 0 0 1 .9.8v12.8a1 1 0 0 1-.6.9l-4.6 2.3a2 2 0 0 1-1.8 0L8.3 18.5a2 2 0 0 0-1.8 0l-3.7 1.8A1 1 0 0 1 2 19.4V6.6a1 1 0 0 1 .6-.9l4.6-2.3a2 2 0 0 1 1.8 0z" />
            <path d="M15 5.8v15" />
            <path d="M9 3.2v15" />
          </svg><span class="hide-sm">Carte</span></div>
      </div>
    </div>

    <!-- Cards grid -->
    <section class="grid" id="grid"></section>
    <div id="sentinel"></div>
    <div class="loading" id="loading" style="display:none">Chargement…</div>
    <div id="map"></div>
  </main>

  <!-- AUTH MODAL -->
  <div class="modal-backdrop auth-backdrop" id="authModal" aria-hidden="true">
    <div class="auth-dialog" id="authDialog" role="dialog" aria-modal="true" aria-labelledby="heroTitle">
      <div class="auth-hero">
        <div class="auth-header">
          <div class="auth-brand">
            <svg class="pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0" />
              <circle cx="12" cy="10" r="3" />
            </svg>
            <strong>MapMarket</strong>
          </div>
        </div>
        <div class="auth-hero-content">
          <h2 id="heroTitle">Bienvenue !</h2>
          <p id="heroSubtitle">Accédez à vos messages, favoris et alertes personnalisées</p>
        </div>
        <div class="auth-hero-illus" id="heroIcon">📍</div>
      </div>
      <div class="auth-pane">
        <div class="auth-tabs" role="tablist">
          <div class="auth-indicator" id="tabIndicator"></div>
          <button class="auth-tab active" id="loginTab" type="button" role="tab" aria-selected="true">Se connecter</button>
          <button class="auth-tab" id="signupTab" type="button" role="tab" aria-selected="false">Créer un compte</button>
        </div>

        <div class="auth-forms" id="formContainer">
          <form class="auth-form active" id="loginForm" autocomplete="on" novalidate>
            <div class="auth-group">
              <label class="auth-label" for="loginEmail">Adresse email</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="loginEmail" type="email" autocomplete="email" placeholder="vous@exemple.fr" required>
              </div>
            </div>

            <div class="auth-group">
              <label class="auth-label" for="loginPassword">Mot de passe</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="loginPassword" type="password" autocomplete="current-password" placeholder="••••••••" required>
                <button type="button" class="password-toggle" data-target="loginPassword" aria-label="Afficher ou masquer le mot de passe">👁</button>
              </div>
            </div>

            <button type="submit" class="auth-submit" id="loginSubmit">Se connecter</button>

            <div class="auth-forgot">
              <button type="button" id="forgotTrigger">Mot de passe oublié ?</button>
            </div>
          </form>

          <form class="auth-form" id="signupForm" autocomplete="on" novalidate>
            <div class="auth-group">
              <label class="auth-label" for="signupName">Nom complet</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="signupName" type="text" autocomplete="name" placeholder="Jean Dupont" required>
              </div>
            </div>

            <div class="auth-group">
              <label class="auth-label" for="signupEmail">Adresse email</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="signupEmail" type="email" autocomplete="email" placeholder="vous@exemple.fr" required>
              </div>
            </div>

            <div class="auth-group">
              <label class="auth-label" for="signupPassword">Mot de passe</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="signupPassword" type="password" autocomplete="new-password" placeholder="Minimum 8 caractères" minlength="8" required>
                <button type="button" class="password-toggle" data-target="signupPassword" aria-label="Afficher ou masquer le mot de passe">👁</button>
              </div>
            </div>

            <button type="submit" class="auth-submit" id="signupSubmit">Créer mon compte</button>
          </form>

          <form class="auth-form" id="forgotForm" novalidate>
            <div class="auth-group">
              <label class="auth-label" for="forgotEmail">Adresse email</label>
              <div class="auth-input-wrapper">
                <input class="auth-input" id="forgotEmail" type="email" autocomplete="email" placeholder="vous@exemple.fr" required>
              </div>
            </div>

            <button type="submit" class="auth-submit" id="forgotSubmit">Envoyer le lien de réinitialisation</button>

            <div class="auth-forgot">
              <button type="button" id="backToLogin">← Retour à la connexion</button>
            </div>
          </form>
        </div>

      </div>
      <button class="auth-close" id="closeAuth" aria-label="Fermer">✕</button>
    </div>
  </div>

  <!-- DETAILS MODAL -->
  <div class="modal-backdrop details-backdrop" id="detailsModal" aria-hidden="true">
    <div class="details-dialog" id="detailsDialog" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <button class="details-close" id="closeDetails" aria-label="Fermer">✕</button>

      <div class="details-media">
        <div class="details-carousel">
          <div class="carousel-track" id="detailsCarouselTrack"></div>
          <div class="carousel-nav">
            <button class="carousel-btn" id="detailsPrev" aria-label="Image précédente">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6" />
              </svg>
            </button>
            <button class="carousel-btn" id="detailsNext" aria-label="Image suivante">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6" />
              </svg>
            </button>
          </div>
          <div class="carousel-meta">
            <div class="carousel-counter" id="detailsImageCounter">1 / 1</div>
            <div class="carousel-dots" id="detailsCarouselDots"></div>
          </div>
          <div class="details-meta details-meta-stats" role="group" aria-label="Statistiques de l'annonce">
            <span class="details-meta-item views" aria-label="Nombre de vues">
              <span class="icon" aria-hidden="true">👁️</span>
              <span class="label"><strong class="count" data-field="views">182</strong> vues</span>
            </span>
            <span class="details-meta-item fav-meta" aria-label="Nombre de favoris">
              <span class="icon" aria-hidden="true">❤️</span>
              <span class="label"><strong class="count" data-field="favorites">21</strong> favoris</span>
            </span>
          </div>
        </div>
        <div class="details-skeleton" id="detailsSkeleton"></div>
      </div>

      <div class="details-body">
        <div class="details-hero-card">
          <div class="details-hero-info">
            <h2 id="detailsTitle">Titre</h2>
            <div class="details-meta" id="detailsMeta"></div>
          </div>
          <div class="details-price" id="detailsPrice"><strong>—</strong></div>
        </div>

        <div class="details-tags" id="detailsTags"></div>

        <section class="details-section">
          <h3>Description</h3>
          <p class="details-desc" id="detailsDesc"></p>
          <button class="details-readmore" id="detailsReadMore" type="button">Lire la suite</button>
        </section>

        <section class="details-section">
          <h3>Informations sur le vendeur</h3>
          <div class="seller-card" id="detailsSeller"></div>
        </section>

        <div class="details-actions">
          <button class="cta-outline" id="detailsSave" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path
                d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
            </svg>
            <span>Ajouter aux favoris</span>
          </button>
          <button class="cta-primary" id="detailsContact" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M22 12h-4" />
              <path d="M2 12h4" />
              <path d="M12 2v4" />
              <path d="M12 22v-4" />
              <rect x="7" y="7" width="10" height="10" rx="2" />
            </svg>
            <span>Contacter</span>
          </button>
          <button class="cta-secondary" id="detailsVisit" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M12 19V6" />
              <path d="m5 12 7-7 7 7" />
            </svg>
            <span>Voir sur la carte</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Action enregistrée</div>

  <!-- FAVORITES MODAL (UNIQUE) -->
  <div id="favOverlay" class="mm-overlay" hidden></div>
  <aside id="favModal" class="mm-modal" role="dialog" aria-modal="true" aria-labelledby="favTitle" aria-hidden="true">
    <header class="mm-header">
      <div class="mm-header-row">
        <h2 id="favTitle">Favoris <span id="favSheetCount" class="mm-count">0</span></h2>
        <div class="mm-actions">
          <button id="clearAllFavs" class="mm-link danger" type="button">Tout retirer</button>
          <button id="closeFavs" class="mm-icon" aria-label="Fermer" type="button">✕</button>
        </div>
      </div>
      <div class="mm-toolbar">
        <div class="mm-search">
          <span class="mm-search-ico">🔎</span>
          <input id="favSearch" type="search" placeholder="Rechercher un favori…" autocomplete="off" />
        </div>
        <div class="mm-filters">
          <select id="favSortBy" aria-label="Trier">
            <option value="recent">Plus récent</option>
            <option value="price_asc">Prix croissant</option>
            <option value="price_desc">Prix décroissant</option>
            <option value="title_asc">Titre A→Z</option>
          </select>
          <select id="favByCat" aria-label="Catégorie (toutes)">
            <option value="">Toutes catégories</option>
          </select>
        </div>
      </div>
    </header>
    <div id="favList" class="mm-grid" role="list"></div>
    <div id="favEmptyState" class="mm-empty" hidden>
      <div class="mm-empty-illu">💗</div>
      <h3>Aucun favori pour l’instant</h3>
      <p>Ajoutez des annonces à vos favoris pour les retrouver ici.</p>
    </div>
  </aside>

  <script>
    // ---------- DATA (mock + géoloc) ----------
    const cityPos = {
      'Montpellier': [43.611, 3.877], 'Paris': [48.8566, 2.3522], 'Lyon': [45.764, 4.8357],
      'Marseille': [43.2965, 5.3698], 'Toulouse': [43.6045, 1.4440], 'Lille': [50.6292, 3.0573]
    };    

    function jitter([lat, lng]) { return [lat + (Math.random() - .5) * 0.08, lng + (Math.random() - .5) * 0.12]; }

    const allItemsData = [
  {
    "id": 201,
    "cat": "Immobilier",
    "title": "Loft industriel rénové - Lyon Croix-Rousse",
    "price": 485000,
    "desc": "Volume lumineux de 120 m² avec poutres apparentes, cuisine ouverte équipée et terrasse de 15 m². Copropriété entretenue, faibles charges.",
    "chips": [
      "120 m²",
      "3 pièces",
      "Terrasse"
    ],
    "city": "Lyon",
    "state": "Très bon état",
    "views": 182,
    "likes": 21,
    "date": "2025-01-18",
    "img": "https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1493663284031-b7e3aefcae8e?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1505691723518-36a5ac3be353?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 202,
    "cat": "Immobilier",
    "title": "Maison familiale 6 pièces - Bordeaux Caudéran",
    "price": 639000,
    "desc": "Maison de 165 m² sur parcelle de 480 m², 4 chambres, bureau, piscine chauffée et garage double. Commodités à pied, tram à 7 minutes.",
    "chips": [
      "165 m²",
      "4 chambres",
      "Piscine"
    ],
    "city": "Bordeaux",
    "state": "Excellent état",
    "views": 205,
    "likes": 34,
    "date": "2025-01-16",
    "img": "https://images.unsplash.com/photo-1493809842364-78817add7ffb?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1493663284031-b7e3aefcae8e?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1507089947368-19c1da9775ae?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1499951360447-b19be8fe80f5?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 203,
    "cat": "Immobilier",
    "title": "Studio meublé 28 m² - Paris Canal Saint-Martin",
    "price": 289000,
    "desc": "Idéal investisseur : studio traversant, cuisine séparée, salle d'eau rénovée, vendu meublé et équipé. Métro République à 3 minutes.",
    "chips": [
      "28 m²",
      "Meublé",
      "4e étage"
    ],
    "city": "Paris",
    "state": "Rénové",
    "views": 332,
    "likes": 42,
    "date": "2025-01-20",
    "img": "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1505691723518-36a5ac3be353?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1484154218962-a197022b5858?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1532323544230-7191fd51bc1b?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 204,
    "cat": "Immobilier",
    "title": "Chalet bois 5 pièces - Chamonix Les Bois",
    "price": 825000,
    "desc": "Chalet de 135 m² orienté sud, vue Mont-Blanc, 4 chambres, poêle scandinave et jardin arboré. Navette ski et commerces à proximité.",
    "chips": [
      "135 m²",
      "4 chambres",
      "Vue montagne"
    ],
    "city": "Chamonix",
    "state": "Très bon état",
    "views": 148,
    "likes": 29,
    "date": "2024-12-28",
    "img": "https://images.unsplash.com/photo-1512914890250-353c77d871ae?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1451976426598-a7593bd6d0b2?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1475948165652-1d106188ff24?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1514320291840-4e0cb04cdc29?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 205,
    "cat": "Auto",
    "title": "Tesla Model 3 Grande Autonomie 2022",
    "price": 42900,
    "desc": "Model 3 Dual Motor AWD, 38 000 km, carnet Tesla, Autopilot amélioré, garantie batterie 8 ans. Pneus hiver et câbles recharge fournis.",
    "chips": [
      "38 000 km",
      "Autopilot",
      "Dual Motor"
    ],
    "city": "Toulouse",
    "state": "Excellent état",
    "views": 198,
    "likes": 33,
    "date": "2025-01-12",
    "img": "https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1552519507-da3b142c6e3d?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1511390429071-3ae4351ca459?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1471479917193-f00955256257?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 206,
    "cat": "Auto",
    "title": "BMW Série 1 118d M Sport 2021",
    "price": 25990,
    "desc": "Diesel 150 ch, boîte auto 8 rapports, 52 000 km, pack M complet, entretien concession, pneus neufs janvier 2025.",
    "chips": [
      "52 000 km",
      "BVA8",
      "Pack M"
    ],
    "city": "Lille",
    "state": "Très bon état",
    "views": 176,
    "likes": 24,
    "date": "2025-01-09",
    "img": "https://images.unsplash.com/photo-1551816230-ef5deaed4a26?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1553440569-bcc63803a83d?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1549923746-c502d488b3ea?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1552519507-93d6c1b09805?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 207,
    "cat": "Auto",
    "title": "Volkswagen California Beach T6.1 2020",
    "price": 57900,
    "desc": "Van aménagé 4 couchages, 65 500 km, toit relevable électrique, chauffage stationnaire, révision VW 12/2024.",
    "chips": [
      "65 500 km",
      "4 couchages",
      "Toit relevable"
    ],
    "city": "Nantes",
    "state": "Très bon état",
    "views": 242,
    "likes": 41,
    "date": "2024-12-30",
    "img": "https://images.unsplash.com/photo-1517949908111-7220f23a2765?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1465446751832-9f11e2739c61?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1471479917193-f00955256257?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1470246973918-29a93221c455?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 208,
    "cat": "High-Tech",
    "title": "MacBook Pro 14\" M3 Pro - 1 To",
    "price": 2490,
    "desc": "Modèle 2023 gris sidéral, puce M3 Pro 12 cœurs, 18 Go RAM, SSD 1 To. Facture Apple Store, coque et AppleCare+ inclus.",
    "chips": [
      "Puissance M3 Pro",
      "18 Go RAM",
      "SSD 1 To"
    ],
    "city": "Paris",
    "state": "Comme neuf",
    "views": 314,
    "likes": 58,
    "date": "2025-01-07",
    "img": "https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1527430253228-e93688616381?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1517430816045-df4b7de11d1d?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1518773553398-650c184e0bb3?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 209,
    "cat": "High-Tech",
    "title": "Sony A7 IV + 24-70mm f/2.8 GM",
    "price": 3490,
    "desc": "Hybride plein format 33 MP, 22 000 déclenchements. Optique G Master, 3 batteries, cage SmallRig. Acheté FNAC 2023.",
    "chips": [
      "33 MP",
      "4K60",
      "Optique GM"
    ],
    "city": "Marseille",
    "state": "Excellent état",
    "views": 268,
    "likes": 47,
    "date": "2025-01-14",
    "img": "https://images.unsplash.com/photo-1514320291840-4e0cb04cdc29?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1497366754035-f200968a6e72?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1516728778615-2d590ea18506?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1471440671318-55bdbb772f93?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 210,
    "cat": "High-Tech",
    "title": "Setup gaming complet RTX 4080 Super",
    "price": 3690,
    "desc": "Tour NZXT i7-14700K, RTX 4080 Super, 32 Go DDR5, SSD 2 To, écran incurvé 34 pouces 165 Hz, clavier méca, souris wireless.",
    "chips": [
      "i7-14700K",
      "RTX 4080S",
      "Écran 34″"
    ],
    "city": "Rennes",
    "state": "Comme neuf",
    "views": 401,
    "likes": 62,
    "date": "2025-01-11",
    "img": "https://images.unsplash.com/photo-1511512578047-dfb367046420?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1510511459019-5dda7724fd87?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1498050108023-c5249f4df085?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1587202372775-98927f7ccfcd?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 211,
    "cat": "High-Tech",
    "title": "iPhone 15 Pro Max 256 Go - Bleu Titane",
    "price": 1320,
    "desc": "Acheté octobre 2024, garantie Apple en cours. Batterie 100 %, livré avec boîte, câble, AppleCare+ transférable et verre trempé.",
    "chips": [
      "256 Go",
      "AppleCare+",
      "Batterie 100 %"
    ],
    "city": "Nice",
    "state": "Comme neuf",
    "views": 355,
    "likes": 73,
    "date": "2025-01-15",
    "img": "https://images.unsplash.com/photo-1695048130329-4b631dccd880?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1695048026064-14f2b90e1091?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1695048026132-7cbdeb18f0bc?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1695048026259-06d9a14abe12?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 212,
    "cat": "Maison",
    "title": "Cuisine équipée complète - Schmidt 2022",
    "price": 6900,
    "desc": "Cuisine en L 3,60 m x 2,40 m, façades chêne clair + îlot, plan quartz, électroménager Siemens inclus (four vapeur, plaque induction, LV).",
    "chips": [
      "Quartz",
      "Électroménager Siemens",
      "2022"
    ],
    "city": "Strasbourg",
    "state": "Très bon état",
    "views": 119,
    "likes": 18,
    "date": "2024-12-22",
    "img": "https://images.unsplash.com/photo-1505691723518-36a5ac3be353?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1556912173-3bb406ef7e77?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1519710164239-da123dc03ef4?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 213,
    "cat": "Maison",
    "title": "Ensemble salon design - canapé + fauteuil + table",
    "price": 1890,
    "desc": "Set Made.com 2023 : canapé 3 places velours bleu, fauteuil assorti, table basse verre fumé. Maison non fumeur, aucun accroc.",
    "chips": [
      "Velours",
      "2023",
      "Excellent état"
    ],
    "city": "Montpellier",
    "state": "Excellent état",
    "views": 143,
    "likes": 26,
    "date": "2025-01-05",
    "img": "https://images.unsplash.com/photo-1519710164239-da123dc03ef4?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1505691723518-36a5ac3be353?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 214,
    "cat": "Maison",
    "title": "Lit bébé évolutif + commode Quax",
    "price": 420,
    "desc": "Lit évolutif 70x140 cm + commode 3 tiroirs Quax Moonshadow. Achetés neufs en 2023, vendus avec matelas latex traité anti-acariens.",
    "chips": [
      "70x140",
      "Matelas latex",
      "2023"
    ],
    "city": "Nantes",
    "state": "Très bon état",
    "views": 88,
    "likes": 15,
    "date": "2025-01-03",
    "img": "https://images.unsplash.com/photo-1616594039964-0c9c5edb126e?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1549187774-b4e9b0445b06?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=1600&q=75"
    ]
  },
  {
    "id": 215,
    "cat": "Maison",
    "title": "Robot tondeuse Husqvarna Automower 430X",
    "price": 1490,
    "desc": "Pour jardins jusqu'à 3200 m². Installation pro 2022, entretien annuel. Livré avec base, câbles, 2 jeux de lames. Parfait état.",
    "chips": [
      "Jusqu’à 3200 m²",
      "GPS",
      "Silencieux"
    ],
    "city": "Angers",
    "state": "Très bon état",
    "views": 97,
    "likes": 19,
    "date": "2024-12-18",
    "img": "https://images.unsplash.com/photo-1624022353893-c5d5e7593160?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1624009694643-dca3ad37d627?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1624009694846-73f45e15b8ff?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1624009695209-8efbea7f2a7b?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 216,
    "cat": "Mode",
    "title": "Veste Acne Studios Velocite oversized XS",
    "price": 780,
    "desc": "Veste motard shearling Acne Studios noir, taille XS oversize. Portée trois fois, vendue avec housse d'origine. Valeur boutique 1900 €.",
    "chips": [
      "Shearling",
      "Taille XS",
      "Quasi neuve"
    ],
    "city": "Paris",
    "state": "Comme neuf",
    "views": 167,
    "likes": 51,
    "date": "2025-01-13",
    "img": "https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1521570265162-6b51f6f7b86f?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1487412720507-e7ab37603c6f?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 217,
    "cat": "Mode",
    "title": "Lot sneakers collection Nike/Adidas - 6 paires",
    "price": 950,
    "desc": "Collection personnelle : Air Jordan 1 Obsidian, Nike Dunk Panda, Adidas Yeezy 350 V2, état proche du neuf, tailles 43-44.",
    "chips": [
      "6 paires",
      "Pointure 43-44",
      "Boîtes incluses"
    ],
    "city": "Lyon",
    "state": "Très bon état",
    "views": 289,
    "likes": 63,
    "date": "2025-01-04",
    "img": "https://images.unsplash.com/photo-1528701800489-20be3c00c1f5?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1523381210434-271e8be1f52b?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1519741497674-611481863552?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1549298916-b41d501d3772?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 218,
    "cat": "Mode",
    "title": "Robe de mariée Laure de Sagazan 2024",
    "price": 1750,
    "desc": "Modèle Chagall 2024, taille 38, portée une fois, nettoyée pressing spécialisé. Dentelle de Calais, ceinture en soie, voilage fourni.",
    "chips": [
      "Taille 38",
      "Nettoyée",
      "Collection 2024"
    ],
    "city": "Rennes",
    "state": "Comme neuf",
    "views": 124,
    "likes": 28,
    "date": "2024-12-26",
    "img": "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1524504388712-1be48574f0d1?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1520854221050-0f4caff449fb?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1520854221050-0f4caff449fb?auto=format&fit=crop&w=1600&q=70"
    ]
  },
  {
    "id": 219,
    "cat": "Mode",
    "title": "Montre Omega Speedmaster Professional 2021",
    "price": 5400,
    "desc": "Speedmaster Moonwatch calibre 3861, full set (boîte, cartes, NATO), achetée Bucherer 2021. Révision Omega 2024, bracelet acier neuf.",
    "chips": [
      "Calibre 3861",
      "Full set",
      "Révisée 2024"
    ],
    "city": "Strasbourg",
    "state": "Excellent état",
    "views": 212,
    "likes": 39,
    "date": "2025-01-02",
    "img": "https://images.unsplash.com/photo-1518544889280-9c61d6634830?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1524592094714-0f0654e20314?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1523170335258-f5ed11844a49?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1524592093325-113f59c8b0e2?auto=format&fit=crop&w=1600&q=80"
    ]
  },
  {
    "id": 220,
    "cat": "Mode",
    "title": "Sac Hermès Kelly 28 Retourne Gold",
    "price": 8900,
    "desc": "Kelly 28 cuir Togo Gold, garniture palladium, année 2022, porté occasionnellement, facture Hermès, dust bag, cadenas et bandoulière.",
    "chips": [
      "Kelly 28",
      "Cuir Togo",
      "Facture Hermès"
    ],
    "city": "Paris",
    "state": "Excellent état",
    "views": 178,
    "likes": 45,
    "date": "2024-12-15",
    "img": "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=1400&q=80",
    "gallery": [
      "https://images.unsplash.com/photo-1523381210434-271e8be1f52b?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1524504388712-1be48574f0d1?auto=format&fit=crop&w=1600&q=80",
      "https://images.unsplash.com/photo-1445205170230-053b83016050?auto=format&fit=crop&w=1600&q=80"
    ]
  }
];

    let allItems = allItemsData.map(it => ({ ...it, latlng: jitter(cityPos[it.city] || [46.2, 2.2]) }));

    // ---------- STATE ----------
    const favStore = { get() { try { return new Set(JSON.parse(localStorage.getItem('mm-favs') || '[]')); } catch { return new Set() } }, set(s) { localStorage.setItem('mm-favs', JSON.stringify([...s])) } };
    const authStore = { get() { try { return JSON.parse(localStorage.getItem('mm-auth') || 'null') } catch { return null } }, set(v) { localStorage.setItem('mm-auth', JSON.stringify(v)) } };

    // ---------- UTIL ----------
    function categoryClass(cat) { return cat === 'Immobilier' ? 'immobilier' : cat === 'Mode' ? 'mode' : cat === 'High-Tech' ? 'hitech' : cat === 'Auto' ? 'auto' : 'maison'; }
    function fmtPrice(n) { return (n >= 1000 ? n.toLocaleString('fr-FR') : n) + ' €'; }
    function buildOptimizedImage(url, width = 480, quality = 70) {
      if (!url) return '';
      try {
        const parsed = new URL(url, window.location.href);
        if (parsed.hostname.includes('images.unsplash.com')) {
          parsed.searchParams.set('auto', 'format');
          parsed.searchParams.set('fit', parsed.searchParams.get('fit') || 'crop');
          if (width) parsed.searchParams.set('w', String(width));
          if (quality) parsed.searchParams.set('q', String(quality));
          if (!parsed.searchParams.has('fm')) parsed.searchParams.set('fm', 'jpg');
          return parsed.toString();
        }
        return url;
      } catch {
        if (typeof url === 'string' && url.includes('images.unsplash.com')) {
          let result = url;
          if (width) {
            if (/w=\d+/.test(result)) result = result.replace(/w=\d+/g, `w=${width}`);
            else result += (result.includes('?') ? '&' : '?') + `w=${width}`;
          }
          if (quality) {
            if (/q=\d+/.test(result)) result = result.replace(/q=\d+/g, `q=${quality}`);
            else result += (result.includes('?') ? '&' : '?') + `q=${quality}`;
          }
          if (!/auto=/.test(result)) result += (result.includes('?') ? '&' : '?') + 'auto=format';
          if (!/fit=/.test(result)) result += (result.includes('?') ? '&' : '?') + 'fit=crop';
          if (!/fm=/.test(result)) result += (result.includes('?') ? '&' : '?') + 'fm=jpg';
          return result;
        }
        return url;
      }
    }
    function buildSrcSet(url, widths = [320, 480, 640], quality = 70) {
      return widths.map(w => `${buildOptimizedImage(url, w, quality)} ${w}w`).join(', ');
    }
    function formatDateLong(dateStr) {
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
    }
    function daysAgo(dateStr) { const d = new Date(dateStr); const diff = Math.max(1, Math.round((Date.now() - d) / 86400000)); return `il y a ${diff} jour${diff > 1 ? 's' : ''}`; }
    function normalize(s) { return (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }

    let scrollLockDepth = 0;
    function lockBodyScroll() {
      scrollLockDepth = Math.max(0, scrollLockDepth) + 1;
      document.body.classList.add('no-scroll', 'modal-open');
      document.body.style.overflow = 'hidden';
    }
    function unlockBodyScroll() {
      scrollLockDepth = Math.max(0, scrollLockDepth - 1);
      if (scrollLockDepth === 0) {
        document.body.classList.remove('no-scroll', 'modal-open');
        document.body.style.overflow = '';
      }
    }
    window.lockBodyScroll = lockBodyScroll;
    window.unlockBodyScroll = unlockBodyScroll;
    function isFavModalOpen() {
      const panel = document.getElementById('favModal');
      return !!(panel && panel.classList.contains('mm-open'));
    }

    // ---------- FILTERING ----------
    const search = document.getElementById('search');
    const cat = document.getElementById('cat');
    const etat = document.getElementById('etat');
    const sort = document.getElementById('sort');
    const pmin = document.getElementById('pmin');
    const pmax = document.getElementById('pmax');
    const city = document.getElementById('city');
    const resetBtn = document.getElementById('resetBtn');

    function getFiltered() {
      let list = allItems.slice();
      const q = normalize(search.value);
      if (q) list = list.filter(a => normalize(a.title + " " + a.desc).includes(q));
      if (cat.value) list = list.filter(a => a.cat === cat.value);
      if (etat.value) list = list.filter(a => a.state === etat.value);
      if (city.value) list = list.filter(a => normalize(a.city).includes(normalize(city.value)));
      const min = Number(pmin.value || 0), max = Number(pmax.value || Infinity);
      list = list.filter(a => a.price >= min && a.price <= max);
      if (sort.value === 'priceAsc') list.sort((a, b) => a.price - b.price);
      else if (sort.value === 'priceDesc') list.sort((a, b) => b.price - a.price);
      else list.sort((a, b) => new Date(b.date) - new Date(a.date));
      return list;
    }

    [search, cat, etat, sort, pmin, pmax, city].forEach(el => el.addEventListener('input', () => { page = 0; renderList(true); renderMap(); }));
    resetBtn.addEventListener('click', () => { [search, cat, etat, sort, pmin, pmax, city].forEach(el => { if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = ''; }); page = 0; renderList(true); renderMap(); })

    // ---------- LIST RENDER + INFINITE ----------
    const grid = document.getElementById('grid');
    const count = document.getElementById('count');
    const favCount = document.getElementById('fav-count');
    const openFavsBtn = document.getElementById('openFavs');
    const sentinel = document.getElementById('sentinel');
    const loading = document.getElementById('loading');
    const favOverlay = document.getElementById('favOverlay');
    const favModal = document.getElementById('favModal');
    const favList = document.getElementById('favList');
    const favEmptyState = document.getElementById('favEmptyState');
    const favSheetCount = document.getElementById('favSheetCount');
    const favSearch = document.getElementById('favSearch');
    const favSortBy = document.getElementById('favSortBy');
    const favByCat = document.getElementById('favByCat');
    const clearAllFavsBtn = document.getElementById('clearAllFavs');
    const closeFavsBtn = document.getElementById('closeFavs');

    let page = 0; const PAGE_SIZE = 12; let filteredCache = [];

    function getFavBaseItems() {
      const favs = favStore.get();
      const items = [];
      allItems.forEach(item => {
        if (favs.has(item.id)) items.push(item);
      });
      return items;
    }

    function refreshFavCategories(sourceItems) {
      if (!favByCat) return;
      const previous = favByCat.value;
      const cats = Array.from(new Set(sourceItems.map(it => it.cat || it.category).filter(Boolean))).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));
      favByCat.innerHTML = '<option value="">Toutes catégories</option>' + cats.map(cat => `<option value="${cat}">${cat}</option>`).join('');
      if (previous && cats.includes(previous)) favByCat.value = previous;
    }

    function applyFavFilters(items) {
      let result = items.slice();
      if (favSearch && favSearch.value.trim()) {
        const q = normalize(favSearch.value);
        result = result.filter(item => normalize(`${item.title} ${item.city || ''} ${(item.cat || item.category || '')}`).includes(q));
      }
      if (favByCat && favByCat.value) {
        const catFilter = favByCat.value;
        result = result.filter(item => (item.cat || item.category || '') === catFilter);
      }
      if (favSortBy) {
        switch (favSortBy.value) {
          case 'price_asc':
            result.sort((a, b) => (a.price || 0) - (b.price || 0));
            break;
          case 'price_desc':
            result.sort((a, b) => (b.price || 0) - (a.price || 0));
            break;
          case 'title_asc':
            result.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            break;
          default:
            result.sort((a, b) => new Date(b.date || b.createdAt || 0) - new Date(a.date || a.createdAt || 0));
        }
      }
      return result;
    }

    function updateFavEmptyState(totalCount) {
      const isEmpty = totalCount === 0;
      if (favList) favList.hidden = isEmpty;
      if (favEmptyState) favEmptyState.hidden = !isEmpty;
    }

    function renderFavCard(item) {
      const priceLabel = typeof item.price === 'string' ? item.price : fmtPrice(item.price || 0);
      const imageSource = item.img || item.imageUrl || 'https://via.placeholder.com/640x480?text=Favori';
      const favThumb = buildOptimizedImage(imageSource, 480, 70);
      const favSrcSet = buildSrcSet(imageSource, [320, 480, 640], 70);
      return `
  <article class="mm-card" role="listitem" data-id="${item.id}">
    <button class="mm-remove" aria-label="Retirer ce favori" data-id="${item.id}" title="Retirer">✕</button>
    <div class="mm-thumb"><img src="${favThumb}" srcset="${favSrcSet}" sizes="(max-width: 520px) 90vw, 320px" alt="${item.title}" loading="lazy" decoding="async" width="320" height="240" style="aspect-ratio: 4 / 3; width: 100%; height: auto;"></div>
    <div class="mm-body">
      <div class="mm-title2">${item.title}</div>
      <div class="mm-meta"><span>${item.city || ''}</span><span class="mm-price">${priceLabel}</span></div>
    </div>
  </article>`;
    }

    function renderFavSheet() {
      if (!favList) return;
      const baseItems = getFavBaseItems();
      refreshFavCategories(baseItems);
      if (favCount) favCount.textContent = baseItems.length;
      let items = applyFavFilters(baseItems);
      favList.classList.remove('mm-grid-filter-empty');
      updateFavEmptyState(baseItems.length);
      if (favSheetCount) favSheetCount.textContent = items.length;
      if (!baseItems.length) {
        favList.innerHTML = '';
        return;
      }
      if (!items.length) {
        favList.classList.add('mm-grid-filter-empty');
        favList.innerHTML = '<div class="mm-empty mm-empty-filter" role="status"><p>Aucun favori ne correspond aux critères actuels.</p></div>';
        return;
      }
      favList.innerHTML = items.map(renderFavCard).join('');
    }

    function openFavSheet() {
      if (!favModal || !favOverlay) return;
      if (favModal.classList.contains('mm-open')) {
        renderFavSheet();
        return;
      }
      renderFavSheet();
      favOverlay.hidden = false;
      requestAnimationFrame(() => favOverlay.classList.add('active'));
      favModal.classList.add('mm-open');
      favModal.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
      if (favSearch) setTimeout(() => favSearch.focus(), 50);
    }

    function closeFavSheet() {
      if (!favModal || !favOverlay) return;
      if (!favModal.classList.contains('mm-open')) return;
      favModal.classList.remove('mm-open');
      favModal.setAttribute('aria-hidden', 'true');
      favOverlay.classList.remove('active');
      setTimeout(() => { if (favOverlay && !favModal.classList.contains('mm-open')) favOverlay.hidden = true; }, 200);
      unlockBodyScroll();
    }

    openFavsBtn?.addEventListener('click', openFavSheet);
    closeFavsBtn?.addEventListener('click', closeFavSheet);
    favOverlay?.addEventListener('click', (event) => { if (event.target === favOverlay) closeFavSheet(); });
    if (favSearch) favSearch.addEventListener('input', renderFavSheet);
    if (favSortBy) favSortBy.addEventListener('change', renderFavSheet);
    if (favByCat) favByCat.addEventListener('change', renderFavSheet);
    clearAllFavsBtn?.addEventListener('click', () => {
      const favs = favStore.get();
      if (favs.size === 0) {
        showToast('Aucun favori à retirer.');
        return;
      }
      if (!confirm('Voulez-vous retirer tous vos favoris ?')) return;
      const ids = [...favs];
      favStore.set(new Set());
      if (favCount) favCount.textContent = 0;
      ids.forEach(id => syncFavoriteButtons(id, false));
      renderFavSheet();
      showToast('Tous les favoris ont été retirés.');
    });
    favList?.addEventListener('click', (event) => {
      const removeBtn = event.target.closest('.mm-remove');
      if (removeBtn) {
        event.stopPropagation();
        const id = Number(removeBtn.dataset.id);
        const favs = favStore.get();
        if (favs.has(id)) {
          favs.delete(id);
          favStore.set(favs);
          if (favCount) favCount.textContent = favs.size;
          syncFavoriteButtons(id, false);
          renderFavSheet();
          showToast('Retiré des favoris');
        }
        return;
      }

      const heartBtn = event.target.closest('.mm-heart');
      if (heartBtn) {
        event.stopPropagation();
        const id = Number(heartBtn.dataset.id);
        const favs = favStore.get();
        if (favs.has(id)) {
          favs.delete(id);
          favStore.set(favs);
          if (favCount) favCount.textContent = favs.size;
          syncFavoriteButtons(id, false);
          renderFavSheet();
          showToast('Retiré des favoris');
        }
        return;
      }
      const card = event.target.closest('.mm-card');
      if (!card) return;
      const id = Number(card.dataset.id);
      const ad = allItems.find(item => item.id === id);
      if (ad) {
        closeFavSheet();
        openDetailsModal(ad);
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && favModal && favModal.classList.contains('mm-open')) {
        closeFavSheet();
      }
    });

    function renderChunk() {
      const favs = favStore.get();
      const start = page * PAGE_SIZE, end = start + PAGE_SIZE;
      const slice = filteredCache.slice(start, end);
      for (const a of slice) {
        const thumbSrc = buildOptimizedImage(a.img, 480, 70);
        const thumbSrcSet = buildSrcSet(a.img, [320, 480, 640], 70);
        const art = document.createElement('article'); art.className = 'ad';
        art.innerHTML = `
          <div class="ad-content" data-id="${a.id}">
          <div class="thumb">
            <img width="370" height="278" loading="lazy" decoding="async" alt="${a.title}"
              src="${thumbSrc}"
              srcset="${thumbSrcSet}"
              sizes="(max-width: 480px) 90vw, 370px"
              style="aspect-ratio: 4 / 3; width: 100%; height: auto;" />
            <div class="grad"></div>
            <div class="cat ${categoryClass(a.cat)}">${a.cat === 'Immobilier' ? '🏢' : a.cat === 'Mode' ? '👕' : a.cat === 'High-Tech' ? '💻' : a.cat === 'Auto' ? '🚗' : '🏠'} <span>${a.cat}</span></div>
            <div class="stats"><span class="row">👁️ ${a.views}</span><span class="row">❤ ${a.likes}</span></div>
            <button class="fav" title="Ajouter aux favoris" aria-pressed="${favs.has(a.id)}" data-id="${a.id}">
              <svg viewBox="0 0 24 24" fill="${favs.has(a.id) ? '#ef4444' : 'none'}" stroke="${favs.has(a.id) ? '#ef4444' : 'currentColor'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
            </button>
          </div>
          <div class="body">
            <div class="titleprice"><div class="title">${a.title}</div><div class="price">${fmtPrice(a.price)}</div></div>
            <div class="desc">${a.desc}</div>
            <div class="chips">${a.chips.map(c => `<span class="chip">${c}</span>`).join('')}</div>
            <div class="meta">
              <div class="loc"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 5-5.54 10.2-7.4 11.8a1 1 0 0 1-1.2 0C9.54 20.2 4 15 4 10a8 8 0 0 1 16 0"/><circle cx="12" cy="10" r="3"/></svg><span>${a.city}</span></div>
              <span class="state">${a.state}</span>
            </div>
            <div class="time">${daysAgo(a.date)}</div>
          </div>
          </div>`; // ad-content wrapper
        grid.appendChild(art);
      }
      // bind favs for the newly added ones
      grid.querySelectorAll('.fav').forEach(btn => {
        if (btn._bound) return; btn._bound = true;
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const id = +btn.dataset.id; const s = favStore.get();
          const isAdding = !s.has(id);
          if (isAdding) {
            s.add(id); showToast('Ajouté aux favoris');
            triggerFavAnimation(btn); // Déclenche l'animation
          } else { s.delete(id); showToast('Retiré des favoris'); }

          favStore.set(s);
          if (favCount) favCount.textContent = s.size;
          btn.querySelector('svg').setAttribute('fill', s.has(id) ? '#ef4444' : 'none');
          btn.querySelector('svg').setAttribute('stroke', s.has(id) ? '#ef4444' : 'currentColor');
          if (isFavModalOpen()) renderFavSheet();
        })
      })
      page++;
    }

    function renderList(reset) {
      filteredCache = getFiltered();
      favCount.textContent = favStore.get().size;
      count.textContent = filteredCache.length + (filteredCache.length > 1 ? ' annonces trouvées' : ' annonce trouvée');
      if (reset) { grid.innerHTML = ''; page = 0; }
      renderChunk();
    }

    const io = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting && page * PAGE_SIZE < filteredCache.length) {
          loading.style.display = 'grid';
          setTimeout(() => { renderChunk(); loading.style.display = 'none'; }, 250);
        }
      })
    });
    io.observe(sentinel);

    // ---------- MAP (Leaflet + clusters) ----------
    const MARKER_CLUSTER_SRC = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js';
    let markerClusterScriptPromise = null;
    function loadMarkerClusterScript() {
      if (window.L && window.L.MarkerClusterGroup) return Promise.resolve();
      if (markerClusterScriptPromise) return markerClusterScriptPromise;
      markerClusterScriptPromise = new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${MARKER_CLUSTER_SRC}"]`);
        if (existing && existing.hasAttribute('data-loaded')) {
          resolve();
          return;
        }
        const script = existing || document.createElement('script');
        script.src = MARKER_CLUSTER_SRC;
        script.defer = true;
        script.crossOrigin = 'anonymous';
        script.onload = () => {
          script.setAttribute('data-loaded', 'true');
          resolve();
        };
        script.onerror = (err) => {
          markerClusterScriptPromise = null;
          reject(err);
        };
        if (!existing) document.head.appendChild(script);
      });
      return markerClusterScriptPromise;
    }

    function waitForLeaflet() {
      if (window.L) return Promise.resolve();
      return new Promise(resolve => {
        const check = () => {
          if (window.L) resolve();
          else requestAnimationFrame(check);
        };
        check();
      });
    }

    let map, cluster;
    async function ensureMap() {
      if (map) return map;
      await waitForLeaflet();
      try {
        await loadMarkerClusterScript();
      } catch (error) {
        return null;
      }
      if (!window.L) return null;
      map = L.map('map', { zoomControl: true, scrollWheelZoom: true }).setView([46.5, 2.3], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(map);
      cluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        chunkedLoading: true,
        spiderfyOnMaxZoom: true,
        iconCreateFunction: function (c) {
          const count = c.getChildCount();
          const size = count < 20 ? 'small' : count < 50 ? 'medium' : 'large';
          return new L.DivIcon({ html: `<div><span>${count}</span></div>`, className: `marker-cluster marker-cluster-${size}`, iconSize: new L.Point(40, 40) });
        }
      });
      map.addLayer(cluster);
      return map;
    }

    async function renderMap(options = {}) {
      if (!map && !options.force && typeof tabMap !== 'undefined' && tabMap && !tabMap.classList.contains('active')) return;
      const instance = await ensureMap();
      if (!instance || !cluster) return;
      cluster.clearLayers();
      const list = getFiltered();
      list.forEach(a => {
        const marker = L.marker(a.latlng, { title: a.title });
        marker.on('click', () => openDetailsModal(a));
        cluster.addLayer(marker);
      });
      if (options.invalidate) instance.invalidateSize();
      if (list.length) {
        instance.fitBounds(L.latLngBounds(list.map(x => x.latlng)).pad(0.2));
      }
    }

    // ---------- TABS (Liste / Carte) ----------
    const tabList = document.getElementById('tab-list');
    const tabMap = document.getElementById('tab-map');
    const mapEl = document.getElementById('map');
    let mapObscureCount = 0;
    function obscureMap() {
      if (!mapEl) return;
      mapObscureCount = Math.max(0, mapObscureCount) + 1;
      mapEl.classList.add('is-obscured');
    }
    function restoreMap() {
      if (!mapEl) return;
      mapObscureCount = Math.max(0, mapObscureCount - 1);
      if (mapObscureCount === 0) {
        mapEl.classList.remove('is-obscured');
      }
    }

    function showList() { tabList.classList.add('active'); tabMap.classList.remove('active'); grid.style.display = 'grid'; mapEl.style.display = 'none'; }
    function showMap() { tabMap.classList.add('active'); tabList.classList.remove('active'); grid.style.display = 'none'; mapEl.style.display = 'block'; setTimeout(() => { renderMap({ invalidate: true, force: true }); }, 50); }

    tabList.addEventListener('click', showList);
    tabMap.addEventListener('click', showMap);

    // ---------- AUTH MODAL ----------
    const authModal = document.getElementById('authModal');
    const authDialog = document.getElementById('authDialog');
    const closeAuth = document.getElementById('closeAuth');
    const postBtn = document.getElementById('postBtn');
    const loginTab = document.getElementById('loginTab');
    const signupTab = document.getElementById('signupTab');
    const tabIndicator = document.getElementById('tabIndicator');
    const formContainer = document.getElementById('formContainer');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const forgotForm = document.getElementById('forgotForm');
    const heroTitle = document.getElementById('heroTitle');
    const heroSubtitle = document.getElementById('heroSubtitle');
    const heroIcon = document.getElementById('heroIcon');
    const forgotTrigger = document.getElementById('forgotTrigger');
    const backToLogin = document.getElementById('backToLogin');
    const passwordToggles = document.querySelectorAll('.password-toggle');
    const AUTH_FOCUSABLE_SELECTOR = 'a[href], area[href], input:not([disabled]):not([type="hidden"]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, [tabindex]:not([tabindex="-1"]), [contenteditable="true"]';
    let authLastFocus = null;
    let authTrapActive = false;

    function getAuthFocusableElements() {
      if (!authDialog) return [];
      const candidates = Array.from(authDialog.querySelectorAll(AUTH_FOCUSABLE_SELECTOR));
      return candidates.filter(el => {
        if (el.closest('[aria-hidden="true"]')) return false;
        if (el.hasAttribute('disabled')) return false;
        const rect = el.getBoundingClientRect();
        return rect.width > 0 || rect.height > 0;
      });
    }

    function handleAuthKeydown(event) {
      if (!authTrapActive || event.key !== 'Tab') return;
      const focusables = getAuthFocusableElements();
      if (!focusables.length) return;
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      const active = document.activeElement;
      if (event.shiftKey) {
        if (active === first || !authDialog.contains(active)) {
          event.preventDefault();
          last.focus();
        }
      } else {
        if (active === last) {
          event.preventDefault();
          first.focus();
        }
      }
    }

    function handleAuthFocusIn(event) {
      if (!authTrapActive || !authDialog || !authModal?.classList.contains('active')) return;
      if (!authDialog.contains(event.target)) {
        const focusables = getAuthFocusableElements();
        if (focusables.length) focusables[0].focus();
      }
    }

    function activateAuthFocusTrap() {
      if (authTrapActive || !authDialog) return;
      authTrapActive = true;
      document.addEventListener('keydown', handleAuthKeydown, true);
      document.addEventListener('focusin', handleAuthFocusIn);
    }

    function deactivateAuthFocusTrap() {
      if (!authTrapActive) return;
      document.removeEventListener('keydown', handleAuthKeydown, true);
      document.removeEventListener('focusin', handleAuthFocusIn);
      authTrapActive = false;
    }

    const forms = { login: loginForm, signup: signupForm, forgot: forgotForm };
    let currentTab = 'login';

    const heroCopy = {
      login: { title: 'Bienvenue !', subtitle: "Accédez à vos messages, favoris et alertes personnalisées", icon: '📍' },
      signup: { title: 'Rejoignez-nous !', subtitle: 'Créez votre compte et découvrez toutes les fonctionnalités', icon: '🚀' },
      forgot: { title: 'Mot de passe oublié ?', subtitle: 'Pas de souci, nous allons vous aider à récupérer votre compte', icon: '🔑' }
    };

    const avatarIcons = {
      auth: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>`,
      profile: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`
    };

    function renderAvatar(auth) {
      const avatar = document.getElementById('avatar');
      if (!avatar) return;
      avatar.innerHTML = '';
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'avatar-btn';
      if (auth) {
        button.classList.add('is-auth');
        button.setAttribute('aria-label', auth.name ? `Profil de ${auth.name}` : 'Profil connecté');
        button.innerHTML = avatarIcons.profile;
        button.addEventListener('click', () => showToast('Espace compte bientôt disponible'));
        avatar.title = auth.name || auth.email || 'Compte connecté';
      } else {
        button.classList.add('needs-auth');
        button.setAttribute('aria-label', 'Se connecter ou créer un compte');
        button.innerHTML = avatarIcons.auth;
        button.addEventListener('click', () => openAuth());
        avatar.title = 'Se connecter ou créer un compte';
      }
      avatar.appendChild(button);
    }

    let authMeasureRaf = null;

    function scheduleAuthMeasure() {
      if (authMeasureRaf) cancelAnimationFrame(authMeasureRaf);
      authMeasureRaf = requestAnimationFrame(() => {
        authMeasureRaf = null;
        measureAuthHeight();
      });
    }

    function measureAuthHeight() {
      if (!formContainer) return;
      const formsList = Array.from(formContainer.querySelectorAll('.auth-form'));
      if (!formsList.length) return;
      const previousHeight = formContainer.style.height;
      formContainer.style.height = 'auto';
      let maxHeight = formContainer.scrollHeight;
      formsList.forEach(form => {
        const wasActive = form.classList.contains('active');
        const prevStyles = {
          visibility: form.style.visibility,
          display: form.style.display,
          position: form.style.position,
          transform: form.style.transform
        };
        if (!wasActive) {
          form.style.visibility = 'hidden';
          form.style.display = 'flex';
          form.style.position = 'static';
          form.style.transform = 'none';
        }
        const formHeight = form.scrollHeight;
        if (formHeight > maxHeight) maxHeight = formHeight;
        if (!wasActive) {
          form.style.visibility = prevStyles.visibility;
          form.style.display = prevStyles.display;
          form.style.position = prevStyles.position;
          form.style.transform = prevStyles.transform;
        }
      });
      if (maxHeight) formContainer.style.height = `${Math.ceil(maxHeight)}px`;
      else formContainer.style.height = previousHeight;
    }

    scheduleAuthMeasure();
    window.addEventListener('resize', scheduleAuthMeasure);

    function openAuth(focusId = 'loginEmail') {
      switchTab('login', { instant: true, force: true, resetSuccess: true });
      clearFeedback();
      if (!authModal) return;
      authLastFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
      authModal.classList.add('active');
      authModal.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
      obscureMap();
      activateAuthFocusTrap();
      setTimeout(() => {
        const target = document.getElementById(focusId) || getAuthFocusableElements()[0] || null;
        if (target) target.focus();
      }, 220);
    }

    function closeAuthFn() {
      if (!authModal) return;
      authModal.classList.remove('active');
      authModal.setAttribute('aria-hidden', 'true');
      deactivateAuthFocusTrap();
      restoreMap();
      unlockBodyScroll();
      if (authLastFocus && typeof authLastFocus.focus === 'function' && authLastFocus.isConnected !== false) {
        setTimeout(() => {
          authLastFocus.focus();
          authLastFocus = null;
        }, 0);
      } else {
        authLastFocus = null;
      }
      setTimeout(() => {
        resetAuthForms();
      }, 360);
    }

    function resetAuthForms() {
      [loginForm, signupForm, forgotForm].forEach(form => form.reset());
      clearFeedback();
      Object.values(forms).forEach(form => form.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right'));
      loginForm.classList.add('active');
      currentTab = 'login';
      updateTabUI('login');
      updateHeroContent('login');
      scheduleAuthMeasure();
    }

    function clearFieldErrors() {
      formContainer.querySelectorAll('.form-error').forEach(el => el.remove());
      formContainer.querySelectorAll('.auth-input').forEach(inp => inp.classList.remove('error'));
      scheduleAuthMeasure();
    }

    function clearSuccessMessage() {
      const success = formContainer.querySelector('.auth-success');
      if (success) {
        success.remove();
        scheduleAuthMeasure();
      }
    }

    function clearFeedback() {
      clearFieldErrors();
      clearSuccessMessage();
    }

    function switchTab(tab, options = {}) {
      const targetForm = forms[tab];
      if (!targetForm) return;
      if (!options.force && tab === currentTab) return;

      const prevForm = forms[currentTab];
      clearFieldErrors();
      if (options.resetSuccess) clearSuccessMessage();

      updateTabUI(tab);
      updateHeroContent(tab);

      if (options.instant || !prevForm || prevForm === targetForm) {
        Object.values(forms).forEach(form => form.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right'));
        targetForm.classList.add('active');
        currentTab = tab;
        scheduleAuthMeasure();
        return;
      }

      const { out: outClass, in: inClass } = getSlideDirection(currentTab, tab);
      prevForm.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
      targetForm.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');

      prevForm.classList.add(outClass);
      setTimeout(() => {
        prevForm.classList.remove('active', outClass);
        targetForm.classList.add('active', inClass);
        requestAnimationFrame(() => targetForm.classList.remove(inClass));
        scheduleAuthMeasure();
      }, 200);

      currentTab = tab;
      scheduleAuthMeasure();
    }

    function updateTabUI(tab) {
      loginTab.classList.toggle('active', tab === 'login');
      signupTab.classList.toggle('active', tab === 'signup');
      if (tab === 'signup') {
        tabIndicator.classList.add('signup');
        tabIndicator.classList.remove('hidden');
      } else if (tab === 'login') {
        tabIndicator.classList.remove('signup', 'hidden');
      } else {
        tabIndicator.classList.add('hidden');
        tabIndicator.classList.remove('signup');
      }
    }

    function updateHeroContent(tab) {
      const copy = heroCopy[tab] || heroCopy.login;
      heroTitle.textContent = copy.title;
      heroSubtitle.textContent = copy.subtitle;
      heroIcon.textContent = copy.icon;
    }

    function getSlideDirection(from, to) {
      const order = ['login', 'signup', 'forgot'];
      const fromIndex = order.indexOf(from);
      const toIndex = order.indexOf(to);
      if (fromIndex === -1 || toIndex === -1) {
        return { out: 'slide-out-left', in: 'slide-in-right' };
      }
      return toIndex > fromIndex ? { out: 'slide-out-left', in: 'slide-in-right' } : { out: 'slide-out-right', in: 'slide-in-left' };
    }

    function validateForm(form) {
      let valid = true;
      const signupPassword = document.getElementById('signupPassword');
      form.querySelectorAll('.auth-input').forEach(input => {
        const value = input.value.trim();
        if (input.hasAttribute('required') && !value) {
          showFieldError(input, 'Ce champ est requis');
          valid = false;
          return;
        }
        if (input.type === 'email' && value && !isValidEmail(value)) {
          showFieldError(input, 'Adresse email invalide');
          valid = false;
          return;
        }
        if (input.id === 'signupPassword' && value && value.length < 8) {
          showFieldError(input, 'Minimum 8 caractères');
          valid = false;
        }
      });
      return valid;
    }

    function showFieldError(input, message) {
      const wrapper = input.closest('.auth-input-wrapper');
      if (!wrapper) return;
      const error = document.createElement('div');
      error.className = 'form-error';
      error.textContent = message;
      input.classList.add('error');
      wrapper.appendChild(error);
      scheduleAuthMeasure();
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function setLoading(button, isLoading) {
      if (!button) return;
      if (!button.dataset.label) button.dataset.label = button.textContent.trim();
      if (isLoading) {
        button.classList.add('loading');
        button.textContent = '';
      } else {
        button.classList.remove('loading');
        button.textContent = button.dataset.label || 'Continuer';
      }
    }

    function showSuccess(message) {
      clearSuccessMessage();
      const banner = document.createElement('div');
      banner.className = 'auth-success';
      banner.textContent = message;
      const firstForm = formContainer.firstElementChild;
      if (firstForm) formContainer.insertBefore(banner, firstForm);
      else formContainer.appendChild(banner);
      setTimeout(() => {
        banner.remove();
        scheduleAuthMeasure();
      }, 3200);
      scheduleAuthMeasure();
    }

    function togglePassword(id) {
      const input = document.getElementById(id);
      if (!input) return;
      input.type = input.type === 'password' ? 'text' : 'password';
      const toggle = Array.from(passwordToggles).find(btn => btn.dataset.target === id);
      if (toggle) toggle.textContent = input.type === 'password' ? '👁' : '🙈';
    }

    loginTab.addEventListener('click', () => switchTab('login', { force: true, resetSuccess: true }));
    signupTab.addEventListener('click', () => switchTab('signup', { force: true, resetSuccess: true }));

    if (forgotTrigger) {
      forgotTrigger.addEventListener('click', () => {
        switchTab('forgot', { force: true, resetSuccess: true });
        setTimeout(() => {
          const forgotInput = document.getElementById('forgotEmail');
          if (forgotInput) forgotInput.focus();
        }, 220);
      });
    }

    if (backToLogin) {
      backToLogin.addEventListener('click', () => {
        switchTab('login', { force: true, resetSuccess: true });
        setTimeout(() => {
          const loginInput = document.getElementById('loginEmail');
          if (loginInput) loginInput.focus();
        }, 220);
      });
    }

    passwordToggles.forEach(btn => btn.addEventListener('click', () => togglePassword(btn.dataset.target)));

    closeAuth.addEventListener('click', closeAuthFn);
    authModal.addEventListener('click', (e) => { if (e.target === authModal) closeAuthFn(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && authModal.classList.contains('active')) closeAuthFn(); });

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      clearFieldErrors();
      if (!validateForm(loginForm)) return;
      const button = document.getElementById('loginSubmit');
      setLoading(button, true);
      setTimeout(() => {
        setLoading(button, false);
        showSuccess('Connexion réussie ! Redirection en cours...');
        authStore.set({ name: 'Vous', email: document.getElementById('loginEmail').value.trim() });
        updateAuthUI();
        showToast('Connecté !');
        setTimeout(() => closeAuthFn(), 1200);
      }, 1200);
    });

    signupForm.addEventListener('submit', (e) => {
      e.preventDefault();
      clearFieldErrors();
      if (!validateForm(signupForm)) return;
      const button = document.getElementById('signupSubmit');
      setLoading(button, true);
      setTimeout(() => {
        setLoading(button, false);
        showSuccess('Compte créé avec succès ! Vérifiez votre email.');
        authStore.set({ name: document.getElementById('signupName').value.trim(), email: document.getElementById('signupEmail').value.trim() });
        updateAuthUI();
        showToast('Compte créé et connecté');
        switchTab('login', { force: true, resetSuccess: false, instant: true });
        setTimeout(() => {
          const loginInput = document.getElementById('loginEmail');
          if (loginInput) loginInput.focus();
        }, 220);
        setTimeout(() => closeAuthFn(), 1400);
      }, 1500);
    });

    forgotForm.addEventListener('submit', (e) => {
      e.preventDefault();
      clearFieldErrors();
      if (!validateForm(forgotForm)) return;
      const button = document.getElementById('forgotSubmit');
      setLoading(button, true);
      setTimeout(() => {
        setLoading(button, false);
        showSuccess('Email de réinitialisation envoyé ! Vérifiez votre boîte de réception.');
        showToast('Email de réinitialisation envoyé');
        switchTab('login', { force: true, resetSuccess: false, instant: false });
        setTimeout(() => {
          const loginInput = document.getElementById('loginEmail');
          if (loginInput) loginInput.focus();
        }, 360);
      }, 1500);
    });

    postBtn.addEventListener('click', () => {
      showToast('Formulaire de dépôt à venir…');
    });

    function updateAuthUI() {
      const auth = authStore.get();
      renderAvatar(auth);
    }

    // ---------- DETAILS MODAL ----------
    const detailsModal = document.getElementById('detailsModal');
    const detailsDialog = document.getElementById('detailsDialog');
    const closeDetailsBtn = document.getElementById('closeDetails');
    const detailsCarouselTrack = document.getElementById('detailsCarouselTrack');
    const detailsCarouselDots = document.getElementById('detailsCarouselDots');
    const detailsPrev = document.getElementById('detailsPrev');
    const detailsNext = document.getElementById('detailsNext');
    const detailsImageCounter = document.getElementById('detailsImageCounter');
    const detailsSkeleton = document.getElementById('detailsSkeleton');
    const detailsTitleEl = document.getElementById('detailsTitle');
    const detailsPriceEl = document.getElementById('detailsPrice');
    const detailsMeta = document.getElementById('detailsMeta');
    const detailsDescEl = document.getElementById('detailsDesc');
    const detailsReadMore = document.getElementById('detailsReadMore');
    const detailsSeller = document.getElementById('detailsSeller');
    const detailsSave = document.getElementById('detailsSave');
    const detailsContact = document.getElementById('detailsContact');
    const detailsVisit = document.getElementById('detailsVisit');
    const detailsTags = document.getElementById('detailsTags');

    let detailsCurrentImages = [];
    let detailsCurrentIndex = 0;
    let detailsCurrentAd = null;
    let detailsDescFull = '';
    let detailsDescExpanded = false;
    let detailsSkeletonTimeout = null;

    const detailsIcons = {
      category: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h10"/></svg>`,
      location: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 5-5 10-9 12-4-2-9-7-9-12a9 9 0 0 1 18 0Z"/><circle cx="12" cy="10" r="3"/></svg>`,
      date: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
      views: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`,
      fav: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.5-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`
    };

    function buildGallery(ad) {
      const sources = Array.isArray(ad.gallery) && ad.gallery.length ? ad.gallery : [ad.img];
      return sources.map((url, index) => buildOptimizedImage(url, index === 0 ? 960 : 1280, index === 0 ? 75 : 70));
    }

    function renderGallery(images, title) {
      if (detailsSkeletonTimeout) {
        clearTimeout(detailsSkeletonTimeout);
        detailsSkeletonTimeout = null;
      }
      detailsSkeleton.classList.add('active');
      detailsCarouselTrack.innerHTML = '';
      detailsCarouselDots.innerHTML = '';
      let firstLoaded = false;
      detailsSkeletonTimeout = setTimeout(() => {
        detailsSkeleton.classList.remove('active');
        detailsSkeletonTimeout = null;
      }, 1500);
      images.forEach((src, index) => {
        const slide = document.createElement('div');
        slide.className = 'carousel-slide';
        if (index === 0) slide.classList.add('active');
        const img = document.createElement('img');
        img.decoding = 'async';
        img.loading = index === 0 ? 'eager' : 'lazy';
        img.alt = `${title} - photo ${index + 1}`;
        img.src = buildOptimizedImage(src, index === 0 ? 960 : 1280, 75);
        img.srcset = buildSrcSet(src, [640, 960, 1280], 75);
        img.sizes = '(max-width: 768px) 92vw, min(640px, 60vw)';
        img.width = 960;
        img.height = 720;
        img.style.aspectRatio = '4 / 3';
        img.addEventListener('load', () => {
          if (!firstLoaded) {
            if (detailsSkeletonTimeout) {
              clearTimeout(detailsSkeletonTimeout);
              detailsSkeletonTimeout = null;
            }
            firstLoaded = true;
            detailsSkeleton.classList.remove('active');
          }
        });
        slide.appendChild(img);
        detailsCarouselTrack.appendChild(slide);

        const dot = document.createElement('button');
        dot.type = 'button';
        dot.className = 'carousel-dot';
        if (index === 0) dot.classList.add('active');
        dot.setAttribute('aria-label', `Voir l'image ${index + 1}`);
        dot.addEventListener('click', () => goToSlide(index));
        detailsCarouselDots.appendChild(dot);
      });
      if (!images.length) {
        if (detailsSkeletonTimeout) {
          clearTimeout(detailsSkeletonTimeout);
          detailsSkeletonTimeout = null;
        }
        detailsSkeleton.classList.remove('active');
      }
      updateCarouselUI();
    }

    function updateCarouselUI() {
      const slides = Array.from(detailsCarouselTrack.children);
      slides.forEach((slide, idx) => slide.classList.toggle('active', idx === detailsCurrentIndex));
      const dots = Array.from(detailsCarouselDots.children);
      dots.forEach((dot, idx) => dot.classList.toggle('active', idx === detailsCurrentIndex));
      const total = detailsCurrentImages.length || 1;
      detailsImageCounter.textContent = `${Math.min(detailsCurrentIndex + 1, total)} / ${total}`;
      const multiple = detailsCurrentImages.length > 1;
      detailsPrev.style.visibility = multiple ? 'visible' : 'hidden';
      detailsNext.style.visibility = multiple ? 'visible' : 'hidden';
      detailsCarouselDots.style.display = multiple ? 'flex' : 'none';
    }

    function changeSlide(delta) {
      if (!detailsCurrentImages.length) return;
      detailsCurrentIndex = (detailsCurrentIndex + delta + detailsCurrentImages.length) % detailsCurrentImages.length;
      updateCarouselUI();
    }

    function goToSlide(index) {
      if (!detailsCurrentImages.length) return;
      detailsCurrentIndex = index % detailsCurrentImages.length;
      updateCarouselUI();
    }

    function categorySymbol(cat) {
      if (cat === 'Immobilier') return '🏢';
      if (cat === 'Mode') return '👕';
      if (cat === 'High-Tech') return '💻';
      if (cat === 'Auto') return '🚗';
      if (cat === 'Maison') return '🏠';
      return '📦';
    }

    function renderDetailsMeta(ad) {
      const badges = [];
      if (ad.cat) {
        badges.push({ type: 'cat', html: `<div class="cat ${categoryClass(ad.cat)}">${categorySymbol(ad.cat)} <span>${ad.cat}</span></div>` });
      }
      badges.push(
        { class: 'location', icon: detailsIcons.location, text: ad.city },
        { class: 'date', icon: detailsIcons.date, text: `Publiée le ${formatDateLong(ad.date)}` },
        { class: 'views', icon: detailsIcons.views, text: `${ad.views} vues` },
        { class: 'fav-meta', icon: detailsIcons.fav, text: `${ad.likes} favoris` }
      );
      detailsMeta.innerHTML = badges.map(b => {
        if (b.type === 'cat') return b.html;
        return `<span class="details-meta-item ${b.class}">${b.icon}<span class="label">${b.text}</span></span>`;
      }).join('');
    }

    function updateDetailsStats(ad) {
      const root = detailsDialog.querySelector('.details-meta.details-meta-stats');
      if (!root) return;
      const resolve = (field, fallback) => (ad && typeof ad[field] !== 'undefined' && ad[field] !== null) ? ad[field] : fallback;
      const viewsEl = root.querySelector('[data-field="views"]');
      const favsEl = root.querySelector('[data-field="favorites"]');
      if (viewsEl) viewsEl.textContent = resolve('views', 182);
      const favsValue = resolve('likes', resolve('favorites', 21));
      if (favsEl) favsEl.textContent = favsValue;
    }

    function renderDetailsTags(ad) {
      const tags = Array.isArray(ad.chips) ? ad.chips : [];
      if (tags.length) {
        detailsTags.style.display = 'flex';
        detailsTags.innerHTML = tags.map(tag => `<span class="details-tag">${tag}</span>`).join('');
      } else {
        detailsTags.style.display = 'none';
        detailsTags.innerHTML = '';
      }
    }

    function setDetailsDescription(desc) {
      detailsDescFull = desc || 'Aucune description fournie pour cette annonce.';
      detailsDescExpanded = false;
      updateDescription();
    }

    function updateDescription() {
      const limit = 220;
      if (detailsDescFull.length > limit && !detailsDescExpanded) {
        detailsDescEl.textContent = detailsDescFull.slice(0, limit) + '…';
        detailsReadMore.classList.add('visible');
        detailsReadMore.textContent = 'Lire la suite';
      } else {
        detailsDescEl.textContent = detailsDescFull;
        if (detailsDescFull.length > limit) {
          detailsReadMore.classList.add('visible');
          detailsReadMore.textContent = 'Réduire';
        } else {
          detailsReadMore.classList.remove('visible');
        }
      }
    }

    function renderSeller(ad) {
      const avatarBase = ad.img || '';
      const avatarThumb = buildOptimizedImage(avatarBase, 160, 60);
      const memberDate = formatDateLong(ad.date);
      detailsSeller.innerHTML = `
        <img src="${avatarThumb}" alt="Vendeur ${ad.city}" loading="lazy" decoding="async" width="52" height="52" style="width:52px;height:52px;">
        <div class="seller-meta">
          <strong>${ad.seller || `Vendeur ${ad.city}`}</strong>
          <span>Membre depuis le ${memberDate}</span>
          <span>${Math.max(1, Math.round(ad.likes / 3))} annonce(s) active(s)</span>
        </div>
      `;
    }

    function setDetailsSaveState(isFav) {
      detailsSave.classList.toggle('active', isFav);
      detailsSave.setAttribute('aria-pressed', String(isFav));
      const svg = detailsSave.querySelector('svg');
      const span = detailsSave.querySelector('span');
      const path = svg.querySelector('path');
      if (path) {
        path.setAttribute('fill', isFav ? 'currentColor' : 'none');
        path.setAttribute('stroke', 'currentColor');
      }
      span.textContent = isFav ? 'Retirer des favoris' : 'Ajouter aux favoris';
    }

    function syncFavoriteButtons(id, isFav) {
      grid.querySelectorAll(`.fav[data-id="${id}"]`).forEach(btn => {
        btn.setAttribute('aria-pressed', String(isFav));
        const svg = btn.querySelector('svg');
        svg.setAttribute('fill', isFav ? '#ef4444' : 'none');
        svg.setAttribute('stroke', isFav ? '#ef4444' : 'currentColor');
      });
      favCount.textContent = favStore.get().size;
    }

    function openDetailsModal(adData) {
      detailsCurrentAd = adData;
      detailsCurrentImages = buildGallery(adData);
      detailsCurrentIndex = 0;
      detailsTitleEl.textContent = adData.title;
      detailsPriceEl.innerHTML = `<strong>${fmtPrice(adData.price)}</strong>`;
      renderDetailsMeta(adData);
      updateDetailsStats(adData);
      renderDetailsTags(adData);
      setDetailsDescription(adData.desc);
      renderSeller(adData);
      renderGallery(detailsCurrentImages, adData.title);
      const favs = favStore.get();
      setDetailsSaveState(favs.has(adData.id));
      detailsSave.dataset.id = adData.id;

      detailsModal.style.display = 'flex';
      detailsModal.classList.add('active');
      detailsModal.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
      obscureMap();
    }

    function closeDetailsModal() {
      detailsModal.style.display = 'none';
      detailsModal.classList.remove('active');
      detailsModal.setAttribute('aria-hidden', 'true');
      unlockBodyScroll();
      restoreMap();
      if (detailsSkeletonTimeout) {
        clearTimeout(detailsSkeletonTimeout);
        detailsSkeletonTimeout = null;
      }
      detailsCarouselTrack.innerHTML = '';
      detailsCarouselDots.innerHTML = '';
      detailsSkeleton.classList.remove('active');
      detailsCurrentImages = [];
      detailsCurrentIndex = 0;
      if (detailsPriceEl) {
        detailsPriceEl.innerHTML = '<strong>—</strong>';
      }
    }

    detailsPrev.addEventListener('click', () => changeSlide(-1));
    detailsNext.addEventListener('click', () => changeSlide(1));
    closeDetailsBtn.addEventListener('click', closeDetailsModal);
    detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) closeDetailsModal(); });

    detailsSave.addEventListener('click', () => {
      if (!detailsCurrentAd) return;
      const id = detailsCurrentAd.id;
      const favs = favStore.get();
      const isFav = favs.has(id);
      if (isFav) {
        favs.delete(id);
        detailsSave.classList.remove('animating'); // Préparation pour future animation
        showToast('Retiré des favoris');
      } else {
        favs.add(id);
        triggerFavAnimation(detailsSave); // Déclenche l'animation
        showToast('Ajouté aux favoris');
      }
      favStore.set(favs);
      setDetailsSaveState(!isFav);
      syncFavoriteButtons(id, !isFav);
      if (isFavModalOpen()) renderFavSheet();
    });

    detailsContact.addEventListener('click', () => {
      showToast('Contact envoyé au vendeur 📬');
    });

    detailsVisit.addEventListener('click', () => {
      if (!detailsCurrentAd) return;
      closeDetailsModal();
      showMap();
      setTimeout(async () => {
        const instance = await ensureMap();
        if (instance && detailsCurrentAd.latlng) {
          instance.setView(detailsCurrentAd.latlng, 13, { animate: true });
        }
      }, 250);
    });

    detailsReadMore.addEventListener('click', () => {
      detailsDescExpanded = !detailsDescExpanded;
      updateDescription();
    });

    document.addEventListener('keydown', (e) => {
      if (detailsModal.style.display !== 'flex') return;
      if (e.key === 'Escape') closeDetailsModal();
      if (e.key === 'ArrowRight') changeSlide(1);
      if (e.key === 'ArrowLeft') changeSlide(-1);
    });

    grid.addEventListener('click', (e) => {
      const adWrapper = e.target.closest('.ad-content');
      if (!adWrapper || e.target.closest('.fav')) return;
      const adId = +adWrapper.dataset.id;
      const adData = allItems.find(item => item.id === adId);
      if (adData) openDetailsModal(adData);
    });

    // ---------- FAVORITE ANIMATION ----------
    function triggerFavAnimation(buttonEl) {
      if (!buttonEl || buttonEl.classList.contains('animating')) return;

      buttonEl.classList.add('animating');

      // 1. Créer le conteneur pour les particules
      let wrapper = buttonEl.querySelector('.fav-anim-wrapper');
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'fav-anim-wrapper';
        buttonEl.appendChild(wrapper);
      }
      wrapper.innerHTML = ''; // Vider les anciennes particules

      // 2. Créer et animer les particules
      const particleCount = 7;
      const angleIncrement = (2 * Math.PI) / particleCount;
      const radius = 25; // Distance de dispersion

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'fav-particle';
        const angle = i * angleIncrement;
        // Calcul de la position finale pour l'animation
        const tx = `calc(-50% + ${radius * Math.cos(angle)}px)`;
        const ty = `calc(-50% + ${radius * Math.sin(angle)}px)`;
        particle.style.setProperty('--tx', tx);
        particle.style.setProperty('--ty', ty);
        wrapper.appendChild(particle);
      }

      // 3. Nettoyer après l'animation
      setTimeout(() => { buttonEl.classList.remove('animating'); if (wrapper) wrapper.innerHTML = ''; }, 600);
    }

    // ---------- TOAST ----------
    const toast = document.getElementById('toast');
    function showToast(msg) { toast.textContent = msg; toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 1800); }

    // ---------- INIT ----------
    renderList(true); updateAuthUI();
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => { });
      });
    }
  </script>
</body>

</html>
